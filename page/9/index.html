<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://mindcons.cn/page/9/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://mindcons.cn"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-web/框架/Vue/Vue3.0/Vue3最佳实践" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time class="dt-published" datetime="2022-08-07T23:15:24.000Z" itemprop="datePublished">2022-08-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Vue/">Vue</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">Vue3最佳实践</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" data-id="cldol83j1008a3cx66m2fd7vl" data-title="Vue3最佳实践" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web/框架/Vue/Vue2.0/Vue2最佳实践" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time class="dt-published" datetime="2022-08-07T23:15:24.000Z" itemprop="datePublished">2022-08-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Vue/">Vue</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">Vue2最佳实践</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文主要是Vue2的最佳实践，Vue3特有的在单独的文章中列出</p>
</blockquote>
<h1 id="环境相关"><a href="#环境相关" class="headerlink" title="环境相关"></a>环境相关</h1><h2 id="node环境搭建"><a href="#node环境搭建" class="headerlink" title="node环境搭建"></a><code>node</code>环境搭建</h2><h3 id="单独安装nodejs"><a href="#单独安装nodejs" class="headerlink" title="单独安装nodejs"></a>单独安装<code>nodejs</code></h3><h4 id="linux环境"><a href="#linux环境" class="headerlink" title="linux环境"></a><code>linux</code>环境</h4><p>下载压缩包，若是<code>tar.xz</code>，以<code>tar -xf filename.tar.xz</code>命令解压</p>
<p>配置环境变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">在最下面Ins添加两行(注意安装路径)</span><br><span class="line"><span class="built_in">export</span> NODEJS=/opt/node/node-v10.15.3-linux-x64</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$NODEJS</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<h4 id="windows环境"><a href="#windows环境" class="headerlink" title="windows环境"></a><code>windows</code>环境</h4><ul>
<li><code>win8</code>及以上<ul>
<li>直接去官网上下载安装：<a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a></li>
</ul>
</li>
<li><code>win7</code><ul>
<li>有的<code>nodejs</code>版本不支持<code>win7</code>，在<code>win7</code>系统中执行<code>npm -v</code>时会有以下提示<code>This application is only supported on Windows 8.1, Windows Server 2012 R2, or higher.</code><br>下载<code>v12.16.2</code>及之前的版本即可：<a target="_blank" rel="noopener" href="https://nodejs.org/dist/v12.16.2/">https://nodejs.org/dist/v12.16.2/</a></li>
<li>建议升级系统</li>
</ul>
</li>
</ul>
<h3 id="nvm管理node"><a href="#nvm管理node" class="headerlink" title="nvm管理node"></a><code>nvm</code>管理<code>node</code></h3><p><code>NVM</code>是一个非常方便的<code>node</code>包管理工具，可以实现在<code>NodeJS</code> 各个不同版本之间自由的进行切换。</p>
<p>下面，介绍用<code>root</code>权限安装<code>NVM</code>工具。到2022年6月，<code>nvm</code>的最新版本为<code>v0.39</code>。</p>
<p><code>vite</code>依赖的<code>node</code>版本 <code>&gt;=</code> <code>12.0.0</code></p>
<p><code>nuxt3</code>依赖的<code>node</code>版本<code>&gt;=</code> <code>14.16.0</code></p>
<h4 id="安装nvm"><a href="#安装nvm" class="headerlink" title="安装nvm"></a>安装<code>nvm</code></h4><p>下载，可以打开链接查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/nvm-sh/nvm/archive/refs/tags/v0.39.1.tar.gz</span><br></pre></td></tr></table></figure>

<p>解压</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /root/.nvm</span><br><span class="line">tar -zxvf v0.39.1.tar.gz -C /root/.nvm</span><br></pre></td></tr></table></figure>

<p>配置环境，打开<code>~/.bashrc</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br></pre></td></tr></table></figure>

<p>在末尾添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nvm path env</span></span><br><span class="line"><span class="built_in">export</span> NVM_DIR=<span class="string">&quot;<span class="variable">$HOME</span>/.nvm/nvm-0.39.1&quot;</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="comment"># This loads nvm</span></span><br><span class="line">[ -s <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span> ] &amp;&amp; \. <span class="string">&quot;<span class="variable">$NVM_DIR</span>/bash_completion&quot;</span>  <span class="comment"># This loads nvm bash_completion</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>保存退出并使配置生效</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<h4 id="使用nvm管理node"><a href="#使用nvm管理node" class="headerlink" title="使用nvm管理node"></a>使用<code>nvm</code>管理<code>node</code></h4><p> 列出已经安装的版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>安装指定版本<code>nodejs</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm install 16.14.0</span><br></pre></td></tr></table></figure>

<p>卸载指定版本<code>nodejs</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm uninstall 16.14.0</span><br></pre></td></tr></table></figure>

<p>切换到其他版本<code>nodejs</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm use 14.17.3</span><br></pre></td></tr></table></figure>

<p>切换到<code>iojs</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm use iojs-v3.2.0</span><br></pre></td></tr></table></figure>

<h2 id="Vue-cli脚手架"><a href="#Vue-cli脚手架" class="headerlink" title="Vue/cli脚手架"></a><code>Vue/cli</code>脚手架</h2><h3 id="创建新项目"><a href="#创建新项目" class="headerlink" title="创建新项目"></a>创建新项目</h3><p>使用<code>nvm</code>装完<code>node</code>环境后，单独新建<code>project</code>文件夹安装<code>@vue/cli</code>包，然后在这文件夹下，使用<code>npx vue create project-name</code>进行每个项目的开发</p>
<ul>
<li>接口文档和<code>UI</code>设计稿</li>
<li>前端项目搭建<ul>
<li><code>nodejs</code></li>
<li>创建新目录并进入，习惯性的<code>npm init -y</code>一下，创建一个空的<code>package.json</code><ul>
<li>安装<code>vue-cli</code>：<code>npm i @vue/cli</code></li>
<li><code>20220511</code>默认安装的脚手架版本为<code>5.0.4</code></li>
<li>这个默认是安装在本地的，调用指令时需要使用<code>npx</code>前缀，如果是全局安装的则不需要</li>
</ul>
</li>
<li>创建<code>vue</code>项目：<code>npx vue create project-name</code>或<code>vue create project-name</code><ul>
<li>然后选择是<code>vue2</code>还是<code>vue3</code>的项目</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="新项目技术选型"><a href="#新项目技术选型" class="headerlink" title="新项目技术选型"></a>新项目技术选型</h3><blockquote>
<p>每个的写法（语法、配置）都不太一样</p>
</blockquote>
<ul>
<li>vue2+vueRouter+vueX+elementUI&#x2F;vantUI</li>
<li>vue3+vueRouter+vueX+elementPlus&#x2F;vantUI</li>
<li>vue3+Ts+vueRouter+Pinia+elementPlus&#x2F;vantUI</li>
</ul>
<h3 id="接手老项目"><a href="#接手老项目" class="headerlink" title="接手老项目"></a>接手老项目</h3><p>接手其他项目时，如果自己的<code>npm</code>版本，和创建<code>package-lock.json</code>的版本不一致，<code>npm i </code>可能会有问题。</p>
<p>最好是先安装<code>npx</code>，在了解接手的项目的node版本（node和npm绑定）是多少后，切换到一致的node版本，或者再尝试安装。</p>
<p>当然也存在node版本一致，但npm版本不一致的情况，可以新建<code>node</code>分支，在新建<code>node</code>分支上升级或降级<code>npm</code>版本，所以两者都要先了解清楚。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="配置代理"><a href="#配置代理" class="headerlink" title="配置代理"></a>配置代理</h3><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>使用<code>ajax</code>技术，发送请求可能会存在跨域问题</p>
<p>本机的浏览器是8080，直接向服务器5000请求数据是不行的，可以通过本机的服务器8080这个代理服务器发请求</p>
<p>服务器和服务器之间，发送请求是不存在跨域问题的，跨域问题只存在于浏览器端</p>
<p>那么怎么开启代理服务器呢？</p>
<ul>
<li><p>通过<code>nginx</code>配置代理服务器</p>
</li>
<li><p>通过<code>vue-cli</code>的配置项</p>
<ul>
<li><p>方式一：</p>
<p><code>vue.config.js</code></p>
<p>新增配置项<code>devServer</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">proxy</span>: <span class="string">&quot;http://localhost:5000&quot;</span> <span class="comment">//配置成最终要请求的服务器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>填写该配置项后，<code>vue-cli</code>会生成一个8080的服务器（和浏览器当前页面的端口一直），并且开发的<code>public</code>目录，对应着该服务器的资源目录，<code>ajax</code>的请求路径，要修改成代理服务的</p>
<p>优点：</p>
<ul>
<li>配置简单，请求资源直接发给前端即可</li>
</ul>
<p>存在的问题：</p>
<ul>
<li>不能配置多个代理服务器，不能灵活的控制请求是否走代理</li>
<li>如果请求路径和<code>public</code>目录资源存在重复，则会返回代理服务的的资源，请求不会转发</li>
</ul>
</li>
<li><p>方式二：</p>
<p><code>vue.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;/api&#x27;</span>: &#123; <span class="comment">// 表示请求前缀，发送`ajax`请求时，在端口号后添加该前缀，表示要通过代理服务器进行转发，并且该前缀，会作为请求路径发送给目标服务器</span></span><br><span class="line">            <span class="attr">target</span>: <span class="string">&#x27;&lt;url&gt;&#x27;</span>, <span class="comment">// 代理服务器的路径</span></span><br><span class="line">            <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;^/api&#x27;</span>: <span class="string">&#x27;&#x27;</span> <span class="comment">// 对路径进行匹配替换，将前缀替换为空字符串，如果真实的服务器有这个路径头，就不需要重写</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">ws</span>: <span class="literal">true</span>, <span class="comment">// 用于支持websocket</span></span><br><span class="line">            <span class="attr">changeOrigin</span>: <span class="literal">true</span> <span class="comment">// true配置项，会伪装代理服务的主机端口号，是localhost:5000。false配置项，代理服务器会如实告诉目标服务器自己的主机端口号，是localhost:8080</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;/foo&#x27;</span>: &#123;</span><br><span class="line">            <span class="attr">target</span>: <span class="string">&#x27;&lt;other_url&gt;&#x27;</span>,</span><br><span class="line">            <span class="attr">pathRewrite</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;^/foo&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优点：</p>
<ul>
<li>可以配置多个代理，且可以灵活的控制请求是否走代理</li>
</ul>
<p>缺点：</p>
<ul>
<li>配置略微繁琐，请求资源时必须加前缀</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h4><p>前端的页面是：<code>http://218.94.82.249:8091/#/analysisfiles</code></p>
<p>后台接口是：<code>http://218.94.82.249:8093/file_handing/upload</code></p>
<p>直接请求会报错跨域：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$axios</span></span><br><span class="line">    .<span class="title function_">post</span>(<span class="string">&quot;http://218.94.82.249:8093/file_handing/upload&quot;</span>, formData, &#123;</span><br><span class="line">      <span class="string">&quot;Content-type&quot;</span>: <span class="string">&quot;multipart/form-data&quot;</span>,</span><br><span class="line">    &#125;).<span class="title function_">then</span>()</span><br></pre></td></tr></table></figure>

<p><code>vue.config.js</code>配置<code>proxy</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; defineConfig &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@vue/cli-service&#x27;</span>)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">transpileDependencies</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">8091</span>,</span><br><span class="line">    <span class="attr">proxy</span>: <span class="string">&#x27;http://218.94.82.249:8093&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后将请求的接口改成<code>8091</code>（也可以直接只加路径）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$axios</span></span><br><span class="line">    .<span class="title function_">post</span>(<span class="string">&quot;http://218.94.82.249:8091/file_handing/upload&quot;</span>, formData, &#123;</span><br><span class="line">      <span class="string">&quot;Content-type&quot;</span>: <span class="string">&quot;multipart/form-data&quot;</span>,</span><br><span class="line">    &#125;).<span class="title function_">then</span>()</span><br></pre></td></tr></table></figure>

<p>如果是设置了隧道，前后端环境需要都在目标服务器上才行</p>
<h3 id="配置eslint"><a href="#配置eslint" class="headerlink" title="配置eslint"></a>配置<code>eslint</code></h3><h1 id="前端项目目录结构"><a href="#前端项目目录结构" class="headerlink" title="前端项目目录结构"></a>前端项目目录结构</h1><p>参照：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6930533407441027079">前端项目目录结构演变 - 掘金 (juejin.cn)</a></p>
<h2 id="目录结构一"><a href="#目录结构一" class="headerlink" title="目录结构一"></a>目录结构一</h2><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line">	src</span><br><span class="line">		main.js</span><br><span class="line">		router</span><br><span class="line">			router.js</span><br><span class="line">			hooks.js</span><br><span class="line">			permission.js</span><br><span class="line">		store</span><br><span class="line">			modules</span><br><span class="line">				moduleA</span><br><span class="line">				moduleB</span><br><span class="line">					state.js</span><br><span class="line">					actions.js</span><br><span class="line">					mutations.js</span><br><span class="line">					getters.js</span><br><span class="line">				index.js</span><br><span class="line">			index.js</span><br><span class="line">			action-types.js</span><br><span class="line">			mutation-types.js</span><br><span class="line">		utils</span><br><span class="line">	</span><br></pre></td></tr></table></figure>

<h3 id="src-main-js结构"><a href="#src-main-js结构" class="headerlink" title="src/main.js结构"></a><code>src/main.js</code>结构</h3><h4 id="vue相关依赖"><a href="#vue相关依赖" class="headerlink" title="vue相关依赖"></a><code>vue</code>相关依赖</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span> <span class="comment">// 引入的是node_moudules下的vue.runtime.js，去除了模板解析功能模块的（）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br></pre></td></tr></table></figure>

<p>其他依赖</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serviceworker的配置文件，pwa 离线缓存，会生成manifes + sw.js</span></span><br><span class="line"><span class="comment">// 生产环境做缓存用的，该文件中暴露了一些钩子，也可以自定义</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./registerServiceWorker&#x27;</span> </span><br></pre></td></tr></table></figure>



<h3 id="src-utils"><a href="#src-utils" class="headerlink" title="src/utils"></a><code>src/utils</code></h3><h4 id="loadable-js"><a href="#loadable-js" class="headerlink" title="loadable.js"></a><code>loadable.js</code></h4><p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/components-dynamic-async.html">动态组件 &amp; 异步组件</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">LoadingComponent</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/loading.vue&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">loadable</span> = (<span class="params">asyncFunc</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 最终切换的时候，会采用这个组件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">component</span> = (<span class="params"></span>) =&gt; (&#123;</span><br><span class="line">      <span class="comment">// 需要加载的组件 (应该是一个 `Promise` 对象)</span></span><br><span class="line">      <span class="attr">component</span>: <span class="title function_">asyncFunc</span>(),</span><br><span class="line">      <span class="comment">// 异步组件加载时使用的组件，只是为了增加loading效果</span></span><br><span class="line">      <span class="attr">loading</span>: <span class="title class_">LoadingComponent</span>,</span><br><span class="line">      <span class="comment">// 加载失败时使用的组件，可选</span></span><br><span class="line">      <span class="attr">error</span>: <span class="title class_">ErrorComponent</span>,</span><br><span class="line">      <span class="comment">// 展示加载时组件的延时时间。默认值是 200 (毫秒)，可选</span></span><br><span class="line">      <span class="attr">delay</span>: <span class="number">200</span>,</span><br><span class="line">      <span class="comment">// 如果提供了超时时间且组件加载也超时了，</span></span><br><span class="line">      <span class="comment">// 则使用加载失败时使用的组件。默认值是：`Infinity`，可选</span></span><br><span class="line">      <span class="attr">timeout</span>: <span class="number">3000</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// loadable执行完毕后，返回一个组件</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="title function_">render</span>(<span class="params">h</span>) &#123; <span class="comment">// createElement(App)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">h</span>(component)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路由切换，异步加载的loading</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> loadable</span><br></pre></td></tr></table></figure>

<p>使用第三库的<code>loading</code>，并封装成一个公共组件</p>
<p><code>component/loading.vue</code></p>
<p>异步组件加载处理</p>
<h4 id="debounce-js、-throttles-js"><a href="#debounce-js、-throttles-js" class="headerlink" title="_debounce.js、_throttles.js"></a><code>_debounce.js</code>、<code>_throttles.js</code></h4><p>防抖节流处理</p>
<h5 id="什么是防抖节流"><a href="#什么是防抖节流" class="headerlink" title="什么是防抖节流"></a>什么是防抖节流</h5><p>函数防抖（debounce） 是指在一定时间内，在动作被连续频繁触发的情况下，动作只会被执行一次，也就是说当调用动作过n毫秒后，才会执行该动作，若在这n毫秒内又调用此动作则将重新计算执行时间，所以短时间内的连续动作永远只会触发一次。</p>
<p>函数节流 是指一定时间内执行的操作只执行一次，也就是说即预先设定一个执行周期，当调用动作的时刻大于等于执行周期则执行该动作，然后进入下一个新周期，一个比较形象的例子是如果将水龙头拧紧直到水是以水滴的形式流出，那你会发现每隔一段时间，就会有一滴水流出。</p>
<p>函数节流（throttle）与 函数防抖（debounce）都是为了限制函数的执行频次，以优化函数触发频率过高导致的响应速度跟不上触发频率，出现延迟，假死或卡顿的现象。</p>
<p><strong>区别：</strong></p>
<p>防抖是将多次执行变成最后一次执行；而节流是将多次执行变为每隔一段时间执行一次。</p>
<p>那么它们各自的使用场景有哪些呢？<br><strong>防抖</strong></p>
<ul>
<li>短信验证码</li>
<li>提交表单</li>
<li>resize 事件</li>
<li>input 事件（当然也可以用节流，实现实时关键字查找）</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  请输入搜索的内容：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">_debounce</span>(<span class="params">fn, delay</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> customDelay = delay || <span class="number">200</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> timer;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> _this = <span class="variable language_">this</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> args = <span class="variable language_">arguments</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer);</span></span><br><span class="line"><span class="language-javascript">            timer = <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                timer = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                fn.<span class="title function_">apply</span>(_this, args);</span></span><br><span class="line"><span class="language-javascript">            &#125;, customDelay);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> myinput = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;input&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    myinput.<span class="property">oninput</span> = <span class="title function_">_debounce</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发送ajax请求&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;,<span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果：输入很多次，在结束输入后，1秒钟打印（发起<code>ajax</code>请求）</p>
<p><img src="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20220623145039201.png" alt="image-20220623145039201"></p>
<p><strong>节流</strong></p>
<ul>
<li>scroll 事件，单位时间后计算一次滚动位置</li>
<li>input 事件（上面提到过）</li>
<li>播放事件，计算进度条</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>我是计数器<span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span>&gt;</span>点我+1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">_throttle</span>(<span class="params">fn, interval</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> last;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> timer;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> custormInterval = interval || <span class="number">200</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> _this = <span class="variable language_">this</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> args = <span class="variable language_">arguments</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> now = +<span class="keyword">new</span> <span class="title class_">Date</span>()</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (last &amp;&amp; now - last &lt; custormInterval) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">clearTimeout</span>(timer)</span></span><br><span class="line"><span class="language-javascript">                timer = <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    last = now</span></span><br><span class="line"><span class="language-javascript">                    fn.<span class="title function_">apply</span>(_this, args)</span></span><br><span class="line"><span class="language-javascript">                &#125;, custormInterval)</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                last = now</span></span><br><span class="line"><span class="language-javascript">                fn.<span class="title function_">apply</span>(_this, args)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> span = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;span&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> button = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;button&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> count = <span class="number">0</span></span></span><br><span class="line"><span class="language-javascript">    button.<span class="property">onclick</span> = <span class="title function_">_throttle</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        count++</span></span><br><span class="line"><span class="language-javascript">        span.<span class="property">innerHTML</span> = count</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;执行&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    &#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>点的再快，也只会1秒执行一次</p>
<p><img src="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20220623162439774.png" alt="image-20220623162439774"></p>
<p>如果要自定义封装，需要了解闭包和定时器</p>
<h5 id="vue中自定义防抖节流"><a href="#vue中自定义防抖节流" class="headerlink" title="vue中自定义防抖节流"></a>vue中自定义防抖节流</h5><h6 id="函数封装"><a href="#函数封装" class="headerlink" title="函数封装"></a>函数封装</h6><p>写在utils文件夹下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 防抖</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">_debounce</span>(<span class="params">fn, delay</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> customDelay = delay || <span class="number">200</span></span><br><span class="line">    <span class="keyword">let</span> timer</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> _this = <span class="variable language_">this</span></span><br><span class="line">        <span class="keyword">let</span> args = <span class="variable language_">arguments</span></span><br><span class="line">        <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">        timer = <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            timer = <span class="literal">null</span></span><br><span class="line">            fn.<span class="title function_">apply</span>(_this, args)</span><br><span class="line">        &#125;, customDelay)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">_throttle</span>(<span class="params">fn, interval</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> last;</span><br><span class="line">    <span class="keyword">let</span> timer;</span><br><span class="line">    <span class="keyword">let</span> custormInterval = interval || <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> _this = <span class="variable language_">this</span></span><br><span class="line">        <span class="keyword">let</span> args = <span class="variable language_">arguments</span></span><br><span class="line">        <span class="keyword">let</span> now = +<span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        <span class="keyword">if</span> (last &amp;&amp; now - last &lt; custormInterval) &#123;</span><br><span class="line">            <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">            timer = <span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                last = now</span><br><span class="line">                fn.<span class="title function_">apply</span>(_this, args)</span><br><span class="line">            &#125;, custormInterval)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            last = now</span><br><span class="line">            fn.<span class="title function_">apply</span>(_this, args)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="在需要使用的组件中引用"><a href="#在需要使用的组件中引用" class="headerlink" title="在需要使用的组件中引用"></a>在需要使用的组件中引用</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#123; _debounce &#125; from &quot;...&quot;</span><br></pre></td></tr></table></figure>

<h6 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">methods: &#123;</span><br><span class="line">   // 改变场数</span><br><span class="line">   changefield: _debounce(function(_type, index, item) &#123;</span><br><span class="line">       // do something ...</span><br><span class="line">   &#125;, 200)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="防抖节流的第三方库"><a href="#防抖节流的第三方库" class="headerlink" title="防抖节流的第三方库"></a>防抖节流的第三方库</h5><ul>
<li><p><code>lodash</code></p>
<ul>
<li>防抖：<a target="_blank" rel="noopener" href="https://www.lodashjs.com/docs/lodash.debounce">https://www.lodashjs.com/docs/lodash.debounce</a></li>
<li>节流：<a target="_blank" rel="noopener" href="https://www.lodashjs.com/docs/lodash.throttle">https://www.lodashjs.com/docs/lodash.throttle</a></li>
</ul>
</li>
<li><p>注意：使用的时候不用再安装了，因为<code>vue-cli</code>等一些库都依赖<code>lodash</code>，之前都装过了，可以使用<code>npm ls lodash</code>查看，在 <code>pnpm </code>中使用方法是 <code>pnpm why lodash</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos atguigu_gmall_frontend]# npm ls lodash</span><br><span class="line">atguigu_gmall_frontend@0.1.0 /root/hh_git/code/atguigu_gmall/atguigu_gmall_frontend</span><br><span class="line">├─┬ @vue/cli-service@5.0.6</span><br><span class="line">│ ├─┬ html-webpack-plugin@5.5.0</span><br><span class="line">│ │ ├── lodash@4.17.21 deduped</span><br><span class="line">│ │ └─┬ pretty-error@4.0.0</span><br><span class="line">│ │   ├── lodash@4.17.21 deduped</span><br><span class="line">│ │   └─┬ renderkid@3.0.0</span><br><span class="line">│ │     └── lodash@4.17.21 deduped</span><br><span class="line">│ ├─┬ portfinder@1.0.28</span><br><span class="line">│ │ └─┬ async@2.6.4</span><br><span class="line">│ │   └── lodash@4.17.21 deduped</span><br><span class="line">│ └─┬ webpack-bundle-analyzer@4.5.0</span><br><span class="line">│   └── lodash@4.17.21 deduped</span><br><span class="line">├─┬ eslint-plugin-vue@8.7.1</span><br><span class="line">│ └─┬ vue-eslint-parser@8.3.0</span><br><span class="line">│   └── lodash@4.17.21 deduped</span><br><span class="line">└─┬ json-server@0.17.0</span><br><span class="line">  ├── lodash@4.17.21</span><br><span class="line">  └─┬ lowdb@1.0.0</span><br><span class="line">    └── lodash@4.17.21 deduped</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用</p>
<p>全量导入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">&#x27;lodash&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="attr">changeIndex</span>: _.<span class="title function_">throttle</span>(<span class="keyword">function</span> (<span class="params">index</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentIndex</span> = index</span><br><span class="line">    &#125;, <span class="number">50</span>)</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>按需导入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> throttle <span class="keyword">from</span> <span class="string">&#x27;lodash/throttle&#x27;</span> <span class="comment">// 底层是module.exports默认暴露的，就不用加小括号了（咋不是require咧）</span></span><br></pre></td></tr></table></figure>

<p>注意点：查看<code>node_modules</code>，<code>throttle.js</code>文件用到了<code>debounce.js</code></p>
<p>里面是有保存上下文<code>this</code>的，在使用的时候不能用箭头函数</p>
<p><code>debounce.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debounced</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> time = <span class="title function_">now</span>(),</span><br><span class="line">        isInvoking = <span class="title function_">shouldInvoke</span>(time);</span><br><span class="line"></span><br><span class="line">    lastArgs = <span class="variable language_">arguments</span>;</span><br><span class="line">    lastThis = <span class="variable language_">this</span>; <span class="comment">// 注意throttle在使用时，不能用箭头函数，否则this指向会出问题</span></span><br><span class="line">    lastCallTime = time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isInvoking) &#123;</span><br><span class="line">      <span class="keyword">if</span> (timerId === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">leadingEdge</span>(lastCallTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (maxing) &#123;</span><br><span class="line">        <span class="comment">// Handle invocations in a tight loop.</span></span><br><span class="line">        <span class="built_in">clearTimeout</span>(timerId);</span><br><span class="line">        timerId = <span class="built_in">setTimeout</span>(timerExpired, wait);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">invokeFunc</span>(lastCallTime);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timerId === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      timerId = <span class="built_in">setTimeout</span>(timerExpired, wait);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="src-styles"><a href="#src-styles" class="headerlink" title="src/styles"></a><code>src/styles</code></h3><p><code>/deep</code>的用法</p>
<h3 id="src-router"><a href="#src-router" class="headerlink" title="src/router"></a><code>src/router</code></h3><h4 id="router-js"><a href="#router-js" class="headerlink" title="router.js"></a><code>router.js</code></h4><h4 id="hooks-js"><a href="#hooks-js" class="headerlink" title="hooks.js"></a><code>hooks.js</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">impor store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="string">&#x27;clear_token&#x27;</span>: <span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// whiteList</span></span><br><span class="line">        store.<span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">CLEAR_TOKEN</span>) <span class="comment">// 清空取消请求的token，如果只希望某个页面切换时取消请求，单独放在组件卸载的生命周期钩子里即可</span></span><br><span class="line">        <span class="title function_">next</span>() <span class="comment">// vue3中支持await的写法</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;login_permission&#x27;</span>: <span class="keyword">async</span> (to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> needLogin = to.<span class="property">matched</span>.<span class="title function_">some</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">meta</span>.<span class="property">needLogin</span>)</span><br><span class="line">        <span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">hasPermission</span>) &#123;</span><br><span class="line">        	<span class="keyword">let</span> isLogin = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">`user/<span class="subst">$&#123;Types.VALIDATE&#125;</span>`</span>) <span class="comment">// 登录校验</span></span><br><span class="line">            <span class="keyword">if</span>(needLogin) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!isLogin) &#123;</span><br><span class="line">                    <span class="title function_">next</span>(<span class="string">&#x27;/login&#x27;</span>) <span class="comment">// 需要登录，但没登录</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                	<span class="title function_">next</span>() <span class="comment">// 需要登录，的确也登录了，正常走</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 不需要登录</span></span><br><span class="line">                <span class="keyword">if</span>(to.<span class="property">name</span> == <span class="string">&#x27;login&#x27;</span>) &#123; <span class="comment">// 访问的是登录页</span></span><br><span class="line">                	<span class="keyword">if</span>(!isLogin) &#123;</span><br><span class="line">                        <span class="title function_">next</span>() <span class="comment">// 如果没登录，正常访问登录页</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">next</span>(<span class="string">&#x27;/profile&#x27;</span>) <span class="comment">// 如果已经登录了，访问跳转到个人中心页</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">next</span>() <span class="comment">// 不需要登录，访问的是非登录页，正常放行</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果有权限</span></span><br><span class="line">            <span class="keyword">if</span> (to.<span class="property">name</span> = <span class="string">&#x27;/login&#x27;</span>) &#123;</span><br><span class="line">                <span class="title function_">next</span>(<span class="string">&#x27;/profile&#x27;</span>) <span class="comment">// 访问了登录页，跳转到个人中心</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">next</span>() <span class="comment">// 有权限，访问的是非登录页，正常放行</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 写在路由权限下面</span></span><br><span class="line">    <span class="string">&#x27;menu-permission&#x27;</span>: <span class="keyword">async</span> (to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 这里需要对菜单权限进行处理，动态的添加路由</span></span><br><span class="line">        <span class="keyword">if</span>(store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">hasPermission</span>) &#123; <span class="comment">// 要求用户登录才能拿取菜单的权限</span></span><br><span class="line">            <span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">menuPermission</span>) &#123; <span class="comment">// 没有菜单权限</span></span><br><span class="line">                <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">`user/<span class="subst">$&#123;Types.ADD_ROUTE&#125;</span>`</span>) <span class="comment">// 路由动态加载，此时组件是异步的</span></span><br><span class="line">                <span class="comment">// 我希望等待组件加载完毕后，再跳转过去</span></span><br><span class="line">                <span class="title function_">next</span>(&#123;...to, <span class="attr">replace</span>: <span class="literal">true</span>&#125;) <span class="comment">//让其再重新跳转一次（组件也ok了） hack 再跳一次的时候，菜单权限是有了的</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">next</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 用户没登录</span></span><br><span class="line">            <span class="title function_">next</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="permission-js"><a href="#permission-js" class="headerlink" title="permission.js"></a><code>permission.js</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [ <span class="comment">// 权限管理，要和后台一一对应</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;lesson-manager&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/lesson-manager&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;lesson&#x27;</span> <span class="comment">// 存放的值要和后端约定好</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;student-manager&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/student-manager&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;student&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;points&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/points&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;points&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;collect&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/collect&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;collect&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h1 id="资源导入"><a href="#资源导入" class="headerlink" title="资源导入"></a>资源导入</h1><h2 id="导入静态资源"><a href="#导入静态资源" class="headerlink" title="导入静态资源"></a>导入静态资源</h2><h3 id="导入第三方UI库"><a href="#导入第三方UI库" class="headerlink" title="导入第三方UI库"></a>导入第三方<code>UI</code>库</h3><h4 id="elementUI"><a href="#elementUI" class="headerlink" title="elementUI"></a><code>elementUI</code></h4><ul>
<li><code>vue2</code>项目</li>
<li>见《<code>vue2</code>基本使用》</li>
</ul>
<h4 id="elementPlus"><a href="#elementPlus" class="headerlink" title="elementPlus"></a><code>elementPlus</code></h4><ul>
<li><code>vue3</code>项目</li>
</ul>
<h4 id="vantUI"><a href="#vantUI" class="headerlink" title="vantUI"></a><code>vantUI</code></h4><ul>
<li><p>官网：<a target="_blank" rel="noopener" href="https://gitee.com/vant-contrib/vant/">https://gitee.com/vant-contrib/vant/</a></p>
</li>
<li><p>目前 Vant 官方提供了 <a target="_blank" rel="noopener" href="https://vant-contrib.gitee.io/vant/v2">Vue 2 版本</a>、<a target="_blank" rel="noopener" href="https://vant-contrib.gitee.io/vant">Vue 3 版本</a>和<a target="_blank" rel="noopener" href="http://vant-contrib.gitee.io/vant-weapp">微信小程序版本</a>，并由社区团队维护 <a href="https://gitee.com/link?target=https://github.com/3lang3/react-vant">React 版本</a>和<a href="https://gitee.com/link?target=https://github.com/ant-move/Vant-Aliapp">支付宝小程序版本</a>。</p>
</li>
<li><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Vue 3 项目，安装最新版 Vant：</span></span><br><span class="line">npm i vant -S</span><br><span class="line"></span><br><span class="line"><span class="comment"># Vue 2 项目，安装 Vant 2：</span></span><br><span class="line">npm i vant@latest-v2 -S</span><br></pre></td></tr></table></figure>
</li>
<li><p>引入</p>
<ul>
<li><p>自动按需引入（推荐）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ant-design/babel-plugin-import">babel-plugin-import</a> 是一款 babel 插件，它会在编译过程中将 import 的写法自动转换为按需引入的方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 安装插件</span><br><span class="line">npm i babel-plugin-<span class="keyword">import</span> -D</span><br><span class="line"><span class="comment">// 在.babelrc 中添加配置</span></span><br><span class="line"><span class="comment">// 注意：webpack 1 无需设置 libraryDirectory</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    [<span class="string">&quot;import&quot;</span>, &#123;</span><br><span class="line">      <span class="string">&quot;libraryName&quot;</span>: <span class="string">&quot;vant&quot;</span>,</span><br><span class="line">      <span class="string">&quot;libraryDirectory&quot;</span>: <span class="string">&quot;es&quot;</span>,</span><br><span class="line">      <span class="string">&quot;style&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于使用 babel7 的用户，可以在 babel.config.js 中配置</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    [<span class="string">&#x27;import&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">libraryName</span>: <span class="string">&#x27;vant&#x27;</span>,</span><br><span class="line">      <span class="attr">libraryDirectory</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">      <span class="attr">style</span>: <span class="literal">true</span></span><br><span class="line">    &#125;, <span class="string">&#x27;vant&#x27;</span>]</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 接着你可以在代码中直接引入 Vant 组件</span></span><br><span class="line"><span class="comment">// 插件会自动将代码转化为方式二中的按需引入形式</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vant&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tips: 如果你在使用 TypeScript，可以使用 ts-import-plugin 实现按需引入。</p>
</blockquote>
</li>
<li><p>在不使用插件的情况下，可以手动引入需要的组件。</p>
<p><code>main.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Button</span> <span class="keyword">from</span> <span class="string">&#x27;vant/lib/button&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;vant/lib/button/style&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>导入所有组件（不推荐）</p>
<p>Vant 支持一次性导入所有组件，引入所有组件会增加代码包体积，因此不推荐这种做法。</p>
<p><code>main.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vant</span> <span class="keyword">from</span> <span class="string">&#x27;vant&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;vant/lib/index.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vant</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tips: 配置按需引入后，将不允许直接导入所有组件。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>可以在<code>App.vue</code>的<code>#app</code>中覆盖<code>vant</code>的样式，也可以单独写个覆盖样式的文件在<code>main.js</code>中引入</p>
</li>
</ul>
<h3 id="导入图标库"><a href="#导入图标库" class="headerlink" title="导入图标库"></a>导入图标库</h3><ul>
<li>阿里图标字体，选好需要的字体后，可以直接要css中<code>@import url()</code>导入，并在入口文件中引入资源；商用时要注意</li>
<li><code>font awesome</code></li>
<li>自研图标</li>
</ul>
<h3 id="导入自定义工具库"><a href="#导入自定义工具库" class="headerlink" title="导入自定义工具库"></a>导入自定义工具库</h3><h3 id="第三方库的自定义封装"><a href="#第三方库的自定义封装" class="headerlink" title="第三方库的自定义封装"></a>第三方库的自定义封装</h3><h2 id="导入动态资源"><a href="#导入动态资源" class="headerlink" title="导入动态资源"></a>导入动态资源</h2><h3 id="导入scss变量"><a href="#导入scss变量" class="headerlink" title="导入scss变量"></a>导入<code>scss</code>变量</h3><p><code>src/assets/common.scss</code></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$color</span>: <span class="number">#fff</span>;</span><br><span class="line"><span class="variable">$background</span>: <span class="number">#2a3a3a</span>;</span><br></pre></td></tr></table></figure>

<p>无法在<code>main.js</code>入口文件中导入动态资源，如<code>src/assets/common.scss</code>中的<code>scss</code>变量，需要使用插件动态注入</p>
<p><code>vue.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">pluginOptions</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;style-resources-loader&#x27;</span>: &#123;</span><br><span class="line">            <span class="attr">preProcessor</span>: <span class="string">&#x27;scss&#x27;</span></span><br><span class="line">            <span class="attr">pattern</span>: [path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src/assets/common.scss&#x27;</span>)]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Vuex最佳实践"><a href="#Vuex最佳实践" class="headerlink" title="Vuex最佳实践"></a><code>Vuex</code>最佳实践</h1><p>目录：<code>root/src/store</code></p>
<h2 id="vuex模块化编码最佳实践"><a href="#vuex模块化编码最佳实践" class="headerlink" title="vuex模块化编码最佳实践"></a><code>vuex</code>模块化编码最佳实践</h2><h3 id="定义模块"><a href="#定义模块" class="headerlink" title="定义模块"></a>定义模块</h3><ul>
<li><p>不同模块都放在<code>store/modules</code>文件夹下</p>
<p><img src="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20220622110840708.png" alt="image-20220622110840708"></p>
</li>
<li><p>不同的模块每个<code>state</code>、<code>action</code>、<code>getters</code>和<code>mutation</code>都单独抽成一个<code>js</code>文件（放在一起代码太多时不好维护）</p>
<ul>
<li><p>为了便于识别，每个<code>state</code>或其它，命名前可以加模块名，如<code>homeState</code></p>
<p>如下形式，分别定义4个</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> homeState = &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> homeState</span><br></pre></td></tr></table></figure>

<p>后面使用<code>.default</code>属性获取文件导出内容时时，并不会用到<code>homeState</code>这个名字，也可以这样写</p>
<p><code>home/state.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时只能根据文件名和路径名，才能判断这个文件是干嘛的了</p>
</li>
<li><p>在<code>modules</code>同级目录，定义<code>index.js</code>整合所有的模块</p>
<ul>
<li><p>利用<code>webpack</code>中<code>require.context()</code>方法获取文件路径、利用<code>default</code>属性获取模块导出内容</p>
<p><code>moudles/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// require.context()方法时webpack内置方法，直接用</span></span><br><span class="line"><span class="keyword">const</span> files = <span class="built_in">require</span>.<span class="title function_">context</span>(<span class="string">&#x27;.&#x27;</span>, <span class="literal">true</span>, <span class="regexp">/\.js$/</span>) <span class="comment">// 搜索当前文件夹，及子文件夹中，以.js结尾的文件</span></span><br><span class="line"><span class="keyword">const</span> modules = &#123;&#125;</span><br><span class="line"><span class="comment">// keys()方法返回匹配的每个文件的相对路径，是个数组</span></span><br><span class="line">files.<span class="title function_">keys</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> path = key.<span class="title function_">replace</span>(<span class="regexp">/\.\/|\.js/g</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment">// 使用正则，把每个相对路径的 ./ 和.js 都替换成空字符串</span></span><br><span class="line">    <span class="comment">// path只剩下 home/state 这种和自身 index 了</span></span><br><span class="line">    <span class="keyword">if</span> (path == <span class="string">&#x27;index&#x27;</span>) <span class="keyword">return</span> <span class="comment">// 路径是自己则不做任何处理</span></span><br><span class="line">    <span class="keyword">let</span> [moduleName, type] = path.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (!modules[moduleName]) &#123;</span><br><span class="line">        modules[moduleName] = &#123;<span class="comment">// 开始构造导出对象</span></span><br><span class="line">            <span class="attr">namespaced</span>: <span class="literal">true</span> <span class="comment">// 构建命名空间配置 &#123;namespaced: true&#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构建state/getters/actions/mutations配置项</span></span><br><span class="line">    <span class="comment">// files()方法的返回值一个Module类型的对象，其default属性值，就是每个文件导出的结果值</span></span><br><span class="line">    modules[moduleName][type] = <span class="title function_">files</span>(key).<span class="property">default</span> <span class="comment">//最终的modules对象，就是包含了每个配置项的模块对象</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(modules)</span><br><span class="line">    <span class="comment">// moudles的打印结果 = &#123;</span></span><br><span class="line">    <span class="comment">//     home: &#123;</span></span><br><span class="line">    <span class="comment">//         namespaced: true,</span></span><br><span class="line">    <span class="comment">//         state:&#123;&#125;,</span></span><br><span class="line">    <span class="comment">//         getters:&#123;&#125;,</span></span><br><span class="line">    <span class="comment">//         actions:&#123;&#125;,</span></span><br><span class="line">    <span class="comment">//         mutations:&#123;&#125;</span></span><br><span class="line">    <span class="comment">//     &#125;,</span></span><br><span class="line">    <span class="comment">//     search: &#123;</span></span><br><span class="line">    <span class="comment">//         namespaced: true,</span></span><br><span class="line">    <span class="comment">//         state:&#123;&#125;,</span></span><br><span class="line">    <span class="comment">//         getters:&#123;&#125;,</span></span><br><span class="line">    <span class="comment">//         actions:&#123;&#125;,</span></span><br><span class="line">    <span class="comment">//         mutations:&#123;&#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 这个结果，和我们一开始学vuex模块化编码是一致的</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> modules;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>在公共的<code>index.js</code>中，解构赋值上面的<code>modules</code>对象，这样就不用一个一个导入一大堆模块了</p>
<ul>
<li>另外，<code>vue-router</code>中不建议使用使用批量导入的方式，因为没有一个明确的规范</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> modules <span class="keyword">from</span> <span class="string">&#x27;./modules/index.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">        ...modules</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>公共的状态在<code>store/index.js</code>中维护，如<code>websocket</code>等</p>
</li>
</ul>
<h3 id="使用createNamespacedHelpers简化map-写法"><a href="#使用createNamespacedHelpers简化map-写法" class="headerlink" title="使用createNamespacedHelpers简化map*写法"></a>使用<code>createNamespacedHelpers</code>简化<code>map*</code>写法</h3><p>取数的数量越多，这种写法越清爽，提交<code>actions</code>和<code>mutations</code>同理</p>
<p><code>test.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;createNamespacedHelpers&#125; from &#x27;vuex&#x27;;</span><br><span class="line"></span><br><span class="line">let mapsObj = createNamespacedHelpers(&#x27;home&#x27;) // 返回值是home模块对应的，mapState/mapGetters/mapActions/mapMutaions的一个对象</span><br><span class="line">let &#123;mapState: mapHomeState, mapActions: mapHomeActions&#125; = createNamespacedHelpers(&#x27;home&#x27;) // 取mapState，并重命名避免多个模块命名冲突</span><br><span class="line">let &#123;mapState: mapSearchState&#125; = createNamespacedHelpers(&#x27;search&#x27;)</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;TypeNav&quot;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    // this.$store.dispatch(&#x27;home/categoryList&#x27;)</span><br><span class="line">    console.log(mapHomeState([&#x27;message&#x27;]))</span><br><span class="line">    this.categoryList()</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    ...mapHomeState([&#x27;message&#x27;]) // 此时取值不用再指定第一个参数home模块名了，模板中可以直接使用&#123;&#123;message&#125;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    ...mapHomeActions([&#x27;categoryList&#x27;])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>store/modules/home/actions.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;reqCategoryList&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/home.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> homeActions = &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">categoryList</span>(<span class="params">&#123;commit&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> res = <span class="keyword">await</span> <span class="title function_">reqCategoryList</span>()</span><br><span class="line">        <span class="keyword">if</span>(res.<span class="property">code</span> == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> homeActions</span><br></pre></td></tr></table></figure>

<h3 id="actions和mutaions的types的统一管理"><a href="#actions和mutaions的types的统一管理" class="headerlink" title="actions和mutaions的types的统一管理"></a><code>actions</code>和<code>mutaion</code>s的<code>types</code>的统一管理</h3><p>上一小节我们是直接提交的<code>action</code>，如果数据太多的话，不太好管理命名</p>
<p>-根据需求创建<code>action-types.js</code>和<code>mutation-types.js</code></p>
<p>数据少的的话，都放在<code>mutation-types.js</code>里也不是不行</p>
<p><code>store/mutation-types.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的名字都列在这里</span></span><br><span class="line"><span class="comment">// actions</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_CATEGORYLIST</span> = <span class="string">&#x27;ACTION_CATEGORYLIST&#x27;</span> <span class="comment">// 常量都大写</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// mutations</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">MUTATION_CATEGORYLIST</span> = <span class="string">&#x27;MUTATION_CATEGORYLIST&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后在用到的子模块的<code>action.js</code>或<code>mutation.js</code>中导入</p>
<p><code>home/action.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;reqCategoryList&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/home.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> homeActions = &#123;</span><br><span class="line">    <span class="keyword">async</span> [<span class="title class_">Types</span>.<span class="property">ACTION_CATEGORYLIST</span>](&#123;commit&#125;) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = <span class="keyword">await</span> <span class="title function_">reqCategoryList</span>()</span><br><span class="line">        <span class="keyword">if</span>(result.<span class="property">code</span> == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">MUTATION_CATEGORYLIST</span>, result.<span class="property">data</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(result)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> homeActions</span><br></pre></td></tr></table></figure>

<p><code>home/mutation.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types&#x27;</span></span><br><span class="line"><span class="keyword">const</span> homeMutations = &#123;</span><br><span class="line">    [<span class="title class_">Types</span>.<span class="property">MUTATION_CATEGORYLIST</span>](state, categoryList) &#123;</span><br><span class="line">        state.<span class="property">categoryList</span> = categoryList</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> homeMutations</span><br></pre></td></tr></table></figure>

<p><code>home/state.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> homeState = &#123;</span><br><span class="line">    <span class="attr">categoryList</span>: [] <span class="comment">// 定义的数据类型，要和实际返回的数据类型保持一致</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> homeState</span><br></pre></td></tr></table></figure>



<p>在组件中使用</p>
<p><code>test.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">		&lt;h2&gt;</span><br><span class="line">            &#123;&#123;categoryList&#125;&#125;</span><br><span class="line">    	&lt;/h2&gt;        </span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;createNamespacedHelpers, mapState&#125; from &#x27;vuex&#x27;;</span><br><span class="line">import * as Types from &#x27;@/store/action-types.js&#x27;</span><br><span class="line">let mapsObj = createNamespacedHelpers(&#x27;home&#x27;)</span><br><span class="line">let &#123;mapState: mapHomeState, mapActions: mapHomeActions&#125; = createNamespacedHelpers(&#x27;home&#x27;) </span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;TypeNav&quot;,</span><br><span class="line">  mounted() &#123;</span><br><span class="line">    console.log(mapHomeState([&#x27;message&#x27;]))</span><br><span class="line">    // this[Types.ACTION_CATEGORYLIST]() // 注意写法</span><br><span class="line">    // 加一层判断，避免每次切换路由组件时都请求一遍接口</span><br><span class="line">    if(this.categoryList.length == 0) &#123; // 如果vuex中没有数据，再去重新请求（用户刷新页面会重新请求）</span><br><span class="line">        this[Types.ACTION_CATEGORYLIST]()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;</span><br><span class="line">    ...mapHomeState([&#x27;categoryList&#x27;])</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    ...mapHomeActions([Types.ACTION_CATEGORYLIST])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>看另外一个案例</p>
<p><code>index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div&gt;</span><br><span class="line">        &lt;HomeHeader v-model=&quot;currentCategory&quot;&gt;&lt;/HomeHeader&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import HomeHeader from &#x27;./home-header.vue&#x27;</span><br><span class="line">    import &#123;createNamespacedHelpers&#125; from &#x27;vuex&#x27;</span><br><span class="line">    import * as Types from &#x27;@/store/action-tpes&#x27;</span><br><span class="line">    // 这里拿到的都是home模块下的</span><br><span class="line">    let &#123;mapState,mapMutations&#125; = createNamespacedHelpers(&#x27;home&#x27;)</span><br><span class="line">    export default &#123;</span><br><span class="line">        methods: &#123;</span><br><span class="line">            ...mapMutations([Type.SET_CATEGORY])</span><br><span class="line">        &#125;,</span><br><span class="line">        computed: &#123;</span><br><span class="line">            ...mapState([&#x27;category&#x27;]),</span><br><span class="line">            currentCategory: &#123;</span><br><span class="line">                get() &#123; // 取值</span><br><span class="line">                    return this.category</span><br><span class="line">                &#125;,</span><br><span class="line">                set(value) &#123; // 修改状态</span><br><span class="line">                    this[Types.SET_CATEGORY](value)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<h1 id="VueRouter最佳实践"><a href="#VueRouter最佳实践" class="headerlink" title="VueRouter最佳实践"></a><code>VueRouter</code>最佳实践</h1><p>路由不建议自动生成，但可配置性太低（如批注、钩子）</p>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><p>见《vue2基本使用》</p>
<h2 id="异步组件"><a href="#异步组件" class="headerlink" title="异步组件"></a>异步组件</h2><p>除了首页用到的组件，其他组件都可以按需加载</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/lesson&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;lesson&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/lesson/index.vue&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>异步组件未加载时，会出现空白页</p>
<p>虽然可以使用<code>prefetch</code>让后续页面用到的先加载，但还是不太好，一般会加个<code>loading</code></p>
<p>在<code>router/index.js</code>中使用<code>src/utils/loadable.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> loadable <span class="keyword">from</span> <span class="string">&#x27;@/utils/loadable&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/lesson&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;lesson&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title function_">loadable</span>(<span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/lesson/index.vue&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="路由权限"><a href="#路由权限" class="headerlink" title="路由权限"></a>路由权限</h2><p><code>src/api/user.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;@/utils/axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">toLogin</span> = (<span class="params">data</span>) =&gt; axios.<span class="title function_">get</span>(<span class="string">&#x27;/usrer/login&#x27;</span>, data)</span><br><span class="line"><span class="comment">// 验证是否通过</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">validate</span> = (<span class="params"></span>) =&gt; axios.<span class="title function_">get</span>(<span class="string">&#x27;/user/validate&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>src/store/modules/user/state.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userState = &#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">token</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// jwt的方式</span></span><br><span class="line">    <span class="attr">hasPermission</span>: <span class="literal">false</span>, <span class="comment">// 权限有无</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">authList</span>: [], <span class="comment">// 菜单权限列表</span></span><br><span class="line">    <span class="attr">menuPermission</span>: <span class="literal">false</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="attr">btnPermission</span>: [<span class="string">&#x27;edit&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>] <span class="comment">// 按钮权限列表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userState</span><br></pre></td></tr></table></figure>

<p><code>src/store/action-types.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置用户信息 登录需要的</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">SET_LOGIN</span> = <span class="string">&#x27;SET_TOKEN&#x27;</span> <span class="comment">// 默认点击登录时，会调用一个action</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">SET_USER</span> = <span class="string">&#x27;SET_USER&#x27;</span> <span class="comment">// 更改存储状态的用户信息 mutation</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">SET_PERMISSION</span> = <span class="string">&#x27;SET_PERMISSION&#x27;</span> <span class="comment">// 更改权限的 mutation</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">VALIDATE</span> = <span class="string">&#x27;VALIDATE&#x27;</span> <span class="comment">// 页面一刷新，校验权限的，会调用一个action</span></span><br></pre></td></tr></table></figure>

<p><code>src/store/modules/user/actions.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;toLogin, validate&#125; <span class="keyword">from</span> <span class="string">&#x27;@/api/user.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> userActions = &#123;</span><br><span class="line">    <span class="keyword">async</span> [<span class="title class_">Types</span>.<span class="property">SET_USER</span>](&#123;commit&#125;, &#123;userInfo, has&#125;) &#123;</span><br><span class="line">        <span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">SET_USER</span>, userInfo)</span><br><span class="line">        <span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">SET_PERMISSION</span>, has) <span class="comment">// 标识登陆过了</span></span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> [<span class="title class_">Types</span>.<span class="property">SET_LOGIN</span>](&#123;dispatch&#125;, payload) &#123;</span><br><span class="line">        <span class="keyword">let</span> userInfo = <span class="keyword">await</span> <span class="title function_">toLogin</span>(payload) <span class="comment">// 假设后端返回的字段有username(String)/token(String)/authList(Array)[&#123;auth:&quot;points&quot;,name:&quot;积分查看&quot;,path:&quot;/profile/points&quot;&#125;,...]</span></span><br><span class="line">		<span class="title function_">dispatch</span>(<span class="title class_">Types</span>.<span class="property">SET_USER</span>, &#123;userInfo, <span class="attr">has</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> [<span class="title class_">Types</span>.<span class="property">VALIDATE</span>](&#123;commit&#125;, payload) &#123;</span><br><span class="line">        <span class="comment">// 此时需要看一下 用户是否登录过</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;key&#x27;</span>)) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// axios中增加token，传到后端，让后端验证去</span></span><br><span class="line">            <span class="comment">// 通过接口持久化vuex</span></span><br><span class="line">            <span class="keyword">let</span> userInfo = <span class="keyword">await</span> <span class="title function_">validate</span>() <span class="comment">// 校验是否登录过</span></span><br><span class="line">			<span class="title function_">dispatch</span>(<span class="title class_">Types</span>.<span class="property">SET_USER</span>, &#123;userInfo, <span class="attr">has</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span> <span class="comment">// 返回给路由钩子</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">			<span class="title function_">dispatch</span>(<span class="title class_">Types</span>.<span class="property">SET_USER</span>, &#123;<span class="attr">userInfo</span>: &#123;&#125;, <span class="attr">has</span>: <span class="literal">false</span>&#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userActions</span><br></pre></td></tr></table></figure>

<p><code>src/store/modules/user/mutations.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types.js&#x27;</span></span><br><span class="line"><span class="keyword">const</span> userMutations = &#123;</span><br><span class="line">    [<span class="title class_">Types</span>.<span class="property">SET_USER</span>](state, payload) &#123;</span><br><span class="line">        state.<span class="property">token</span> = payload.<span class="property">token</span></span><br><span class="line">        state.<span class="property">username</span> = payload.<span class="property">username</span></span><br><span class="line">        state.<span class="property">authList</span> = payload.<span class="property">authList</span></span><br><span class="line">        <span class="comment">// 也可以用解构赋值的写法</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// cookie / localStorage</span></span><br><span class="line">        <span class="keyword">if</span>(payload.<span class="property">token</span>) &#123; <span class="comment">// 登录完之后，存token到localStorage中</span></span><br><span class="line">            <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;token&#x27;</span>, payload.<span class="property">token</span>) <span class="comment">// 也可以用封装过的方法</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="title class_">Types</span>.<span class="property">SET_PERMISSION</span>](state, payload) &#123;</span><br><span class="line">        state.<span class="property">hasPermission</span> = payload</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userActions</span><br></pre></td></tr></table></figure>

<p><code>src/router/hooks.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">impor store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="string">&#x27;login_permission&#x27;</span>: <span class="keyword">async</span> (to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 用户是否需要登录才能访问的标识</span></span><br><span class="line">        <span class="keyword">let</span> needLogin = to.<span class="property">matched</span>.<span class="title function_">some</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">meta</span>.<span class="property">needLogin</span>)</span><br><span class="line">        <span class="comment">// 如果vuex中有值，我就认为你当前登录了</span></span><br><span class="line">        <span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">hasPermission</span>) &#123;</span><br><span class="line">            <span class="comment">// 返回了一个isLogin字段，表示用户是否登陆过了</span></span><br><span class="line">            <span class="comment">// loginWhiteList 可以做一个白名单</span></span><br><span class="line">        	<span class="keyword">let</span> isLogin = <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">`user/<span class="subst">$&#123;Types.VALIDATE&#125;</span>`</span>) <span class="comment">// 登录校验</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(needLogin) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!isLogin) &#123;</span><br><span class="line">                    <span class="title function_">next</span>(<span class="string">&#x27;/login&#x27;</span>) <span class="comment">// 需要登录，但没登录</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                	<span class="title function_">next</span>() <span class="comment">// 需要登录，的确也登录了，正常走</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// 不需要登录</span></span><br><span class="line">                <span class="keyword">if</span>(to.<span class="property">name</span> == <span class="string">&#x27;login&#x27;</span>) &#123; <span class="comment">// 访问的是登录页</span></span><br><span class="line">                	<span class="keyword">if</span>(!isLogin) &#123;</span><br><span class="line">                        <span class="title function_">next</span>() <span class="comment">// 如果没登录，正常访问登录页</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="title function_">next</span>(<span class="string">&#x27;/profile&#x27;</span>) <span class="comment">// 如果已经登录了，访问跳转到个人中心页</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="title function_">next</span>() <span class="comment">// 不需要登录，访问的是非登录页，正常放行</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果有权限</span></span><br><span class="line">            <span class="keyword">if</span> (to.<span class="property">name</span> = <span class="string">&#x27;/login&#x27;</span>) &#123;</span><br><span class="line">                <span class="title function_">next</span>(<span class="string">&#x27;/profile&#x27;</span>) <span class="comment">// 访问了登录页，跳转到个人中心</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">next</span>() <span class="comment">// 有权限，访问的是非登录页，正常放行</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有些页面不用登录也能访问，有些页面必须需要登录</p>
<p><code>src/router/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;lesson&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;lesson&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title function_">loadable</span>(<span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/lesson/index.vue&#x27;</span>)),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">needLogin</span>: <span class="literal">true</span> <span class="comment">// 必须要登录</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>登录页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    import * as Types from &#x27;@/store/action-types.js&#x27;</span><br><span class="line">    import FormSubmit from &#x27;@/components/form-submit&#x27;</span><br><span class="line">    import &#123;Dialog&#125; from &#x27;vant&#x27; // 全局引入的只能在template使用，如果要在script中使用，需要额外引入</span><br><span class="line">    import &#123;createNamespacedHelpers&#125; from &#x27;vuex&#x27;</span><br><span class="line">    let &#123;mapAcitons&#125; = createNamespacedHelpers(&#x27;user&#x27;)</span><br><span class="line">    export default &#123;</span><br><span class="line">        components: &#123;</span><br><span class="line">            FormSubmit</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            ...mapAcitons([Types.SET_LOGIN]),</span><br><span class="line">            async submit(values) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">	                await this[Types.SET_LOGIN](values)</span><br><span class="line">                    this.$router.push(&#x27;profile&#x27;)</span><br><span class="line">                &#125; catch(e) &#123;</span><br><span class="line">                    Dialog.alert(&#123;</span><br><span class="line">                        title: &#x27;登录失败&#x27;,</span><br><span class="line">                        messgae: e.data</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><code>views/profile/index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;profile&quot;&gt;</span><br><span class="line">        &lt;vant-nav-bar title=&quot;个人中心&quot;&gt;&lt;/vant-nav-bar&gt;</span><br><span class="line">        &lt;div class=&quot;profil-info&quot;&gt;</span><br><span class="line">            &lt;!-- 如果功能很多，记得用mapState --&gt;</span><br><span class="line">            &lt;template v-if=&quot;!$store.state.user.hasPermission&quot;&gt;</span><br><span class="line">                &lt;img src=&quot;@/assets/logo.png&quot;&gt;</span><br><span class="line">                &lt;van-button size=&quot;small&quot;&gt;登录&lt;/van-button&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">			&lt;template v-else&gt;</span><br><span class="line">				&lt;!-- 头像上传 --&gt;</span><br><span class="line">				&lt;img src=&quot;@/assets/logo.png&quot;&gt;</span><br><span class="line">				&lt;span&gt;&#123;&#123;$store.state.user.username&#125;&#125;&lt;/span&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">    	&lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>



<h2 id="菜单权限"><a href="#菜单权限" class="headerlink" title="菜单权限"></a>菜单权限</h2><p>后端有一个根据<code>username</code>返回不同<code>path</code>的接口</p>
<p>后台返回权限信息的接口：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">validate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;ctx, app&#125; = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> token = ctx.<span class="property">headers</span>.<span class="property">authorization</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> decoded = jwt.<span class="title function_">verify</span>(token, app.<span class="property">config</span>.<span class="property">privateKey</span>)</span><br><span class="line">        <span class="keyword">let</span> authList</span><br><span class="line">        <span class="keyword">if</span>(decoded.<span class="property">username</span> = <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            authList = [</span><br><span class="line">                &#123;<span class="attr">auth</span>: <span class="string">&#x27;lesson&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;课程管理&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/profile/lesson-manager&#x27;</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">auth</span>: <span class="string">&#x27;student&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;学员管理&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/profile/student-manager&#x27;</span>&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            authList = [</span><br><span class="line">                &#123;<span class="attr">auth</span>: <span class="string">&#x27;points&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;积分查看&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/profile/points&#x27;</span>&#125;,</span><br><span class="line">                &#123;<span class="attr">auth</span>: <span class="string">&#x27;collect&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;收藏列表&#x27;</span>, <span class="attr">path</span>: <span class="string">&#x27;/profile/collect&#x27;</span>&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">err</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">username</span>: decoded.<span class="property">username</span></span><br><span class="line">                <span class="comment">// ....</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述返回的<code>path</code>对应前台的动态路由</p>
<p>我们在<code>views/others</code>文件夹中创建这四个<code>vue</code>文件：<code>lesson-manager.vue</code>、<code>student-manager.vue</code>、<code>points.vue</code>、<code>collect.vue</code></p>
<p>由于是动态添加的，我们不能直接写到<code>router/index.js</code>中</p>
<p>新建<code>src/rotuer/permission.js</code>，该文件中专门放一些权限相关的路由</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [ <span class="comment">// 权限管理，要和后台一一对应</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;lesson-manager&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/lesson-manager&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;lesson&#x27;</span> <span class="comment">// 存放的值要和后端约定好</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;student-manager&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/student-manager&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;student&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;points&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/points&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;points&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;collect&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;@/views/others/collect&#x27;</span>),</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">auth</span>: <span class="string">&#x27;collect&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>在路由前置钩子里，还需要做一件事：根据菜单权限显示不同的动态组件</p>
<p><code>src/router/hooks.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">impor store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 写在路由权限下面</span></span><br><span class="line">    <span class="string">&#x27;menu-permission&#x27;</span>: <span class="keyword">async</span> (to, <span class="keyword">from</span>, next) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 这里需要对菜单权限进行处理，动态的添加路由</span></span><br><span class="line">        <span class="keyword">if</span>(store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">hasPermission</span>) &#123; <span class="comment">// 要求用户登录才能拿取菜单的权限</span></span><br><span class="line">            <span class="keyword">if</span>(!store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">menuPermission</span>) &#123; <span class="comment">// 没有菜单权限</span></span><br><span class="line">                <span class="keyword">await</span> store.<span class="title function_">dispatch</span>(<span class="string">`user/<span class="subst">$&#123;Types.ADD_ROUTE&#125;</span>`</span>) <span class="comment">// 路由动态加载，此时组件是异步的</span></span><br><span class="line">                <span class="comment">// 我希望等待组件加载完毕后，再跳转过去</span></span><br><span class="line">                <span class="title function_">next</span>(&#123;...to, <span class="attr">replace</span>: <span class="literal">true</span>&#125;) <span class="comment">//让其再重新跳转一次（组件也ok了） hack 再跳一次的时候，菜单权限是有了的</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">next</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 用户没登录</span></span><br><span class="line">            <span class="title function_">next</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/store/action-types.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ADD_ROUTE</span> = <span class="string">&#x27;ADD_ROUTE&#x27;</span> <span class="comment">// 动态添加路由 action</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">SET_MENU_PERMISSION</span> = <span class="string">&#x27;SET_MENU_PERMISSION&#x27;</span> <span class="comment">// mutation</span></span><br></pre></td></tr></table></figure>

<p><code>src/store/modules/user/mutations.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userMutations = &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    [<span class="title class_">Types</span>.<span class="property">SET_MENU_PERMISSION</span>](state, payload) &#123;</span><br><span class="line">        state.<span class="property">menuPermission</span> = payload</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userMutations</span><br></pre></td></tr></table></figure>

<p><code>src/store/modules/user/actions.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> per <span class="keyword">from</span> <span class="string">&#x27;@/router/permission.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;@/router&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">filterRouter</span> = (<span class="params">authList</span>) =&gt; &#123; <span class="comment">// 拿每个路由，看在不在权限列表中</span></span><br><span class="line">    <span class="comment">// 有很多种过滤的方式</span></span><br><span class="line">    <span class="comment">// 扁平化过滤，把tree展开，然后一层层过滤，性能更高一点</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 递归过滤</span></span><br><span class="line">    authList = authList.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">auth</span>)</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">filter</span>(<span class="params">per</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> result = per.<span class="title function_">filter</span>(<span class="function"><span class="params">route</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(authList.<span class="title function_">includes</span>(route.<span class="property">meta</span>.<span class="property">auth</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span>(router.<span class="property">children</span>) &#123; <span class="comment">// 嵌套路由，一般不会超过三层</span></span><br><span class="line">                    route.<span class="property">children</span> = <span class="title function_">filter</span>(route.<span class="property">children</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> route</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">filter</span>(per)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> userActions = &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">async</span> [<span class="title class_">Types</span>.<span class="property">ADD_ROUTE</span>](&#123;commit, dispatch, state&#125;, payload) &#123;</span><br><span class="line">        <span class="comment">// 添加路由（菜单）</span></span><br><span class="line">        <span class="comment">// 拿到路由（菜单）的权限再去添加路由</span></span><br><span class="line">        <span class="comment">// 路由（菜单）的权限在vuex中</span></span><br><span class="line">        <span class="keyword">let</span> authList = state.<span class="property">authList</span> <span class="comment">// 服务端返回的权限</span></span><br><span class="line">        <span class="comment">// 根据后台提供的权限，在前台自定义的权限中，进行过滤（复杂的话可能需要递归）</span></span><br><span class="line">        <span class="keyword">let</span> routes = <span class="title function_">filterRouter</span>(authList)</span><br><span class="line">        <span class="comment">// 拿到不同权限对应的动态路由路径后，将路由组件添加到`profile`中</span></span><br><span class="line">        <span class="keyword">let</span> route = router.<span class="property">options</span>.<span class="property">routes</span>.<span class="title function_">find</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">path</span> == <span class="string">&#x27;/profile&#x27;</span>) <span class="comment">// 可以打印router对象，它有一个options属性</span></span><br><span class="line">        route.<span class="property">children</span> = routes <span class="comment">// 动态添加子组件</span></span><br><span class="line">        router.<span class="title function_">addRouter</span>([route]) <span class="comment">// 该方法接收一个数组，动态的再向router中添加</span></span><br><span class="line">        </span><br><span class="line">        <span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">SET_MENUPERMISSION</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userActions</span><br></pre></td></tr></table></figure>

<p><code>profile.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;profile&quot;&gt;</span><br><span class="line">        &lt;vant-nav-bar title=&quot;个人中心&quot;&gt;&lt;/vant-nav-bar&gt;</span><br><span class="line">        &lt;div class=&quot;profil-info&quot;&gt;</span><br><span class="line">            &lt;!-- 如果功能很多，记得用mapState --&gt;</span><br><span class="line">            &lt;template v-if=&quot;!$store.state.user.hasPermission&quot;&gt;</span><br><span class="line">                &lt;img src=&quot;@/assets/logo.png&quot;&gt;</span><br><span class="line">                &lt;van-button size=&quot;small&quot;&gt;登录&lt;/van-button&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">			&lt;template v-else&gt;</span><br><span class="line">				&lt;!-- 头像上传 --&gt;</span><br><span class="line">				&lt;img src=&quot;@/assets/logo.png&quot;&gt;</span><br><span class="line">				&lt;span&gt;&#123;&#123;$store.state.user.username&#125;&#125;&lt;/span&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">    	&lt;/div&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;template  v-if=&quot;$store.state.user.menuPermission&quot;&gt;</span><br><span class="line">            &lt;vant-tabs types=&quot;card&quot;&gt;</span><br><span class="line">                &lt;vant-tab </span><br><span class="line">                          :title=&quot;item.name&quot;</span><br><span class="line">                          v-for=&quot;(item, index) in $store.state.user.authList&quot;</span><br><span class="line">                          :to=&quot;item.path&quot;</span><br><span class="line">                          :key=&quot;index&quot;</span><br><span class="line">                          &gt;</span><br><span class="line">                    &lt;!-- item.path中的path，是后端返回的字段 --&gt;</span><br><span class="line">                &lt;/vant-tab&gt;            </span><br><span class="line">            &lt;/vant-tabs&gt;</span><br><span class="line"> 			&lt;!-- 可以再配置个redirect字段，让其默认展示 --&gt;</span><br><span class="line">			&lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">		&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>



<h2 id="按钮权限"><a href="#按钮权限" class="headerlink" title="按钮权限"></a>按钮权限</h2><p>一般也是用户登录的一瞬间，把按钮权限字段，放在<code>vuex</code>中</p>
<p>页面中使用指令控制</p>
<p><code>src/store/modules/user/state.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userState = &#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">token</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// jwt的方式</span></span><br><span class="line">    <span class="attr">hasPermission</span>: <span class="literal">false</span>, <span class="comment">// 权限有无</span></span><br><span class="line">    <span class="attr">authList</span>: [], <span class="comment">// 菜单权限列表</span></span><br><span class="line">    <span class="attr">menuPermission</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">btnPermission</span>: [<span class="string">&#x27;edit&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>] <span class="comment">// 按钮权限列表，值是根据后台返回的值动态添加</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> userState</span><br></pre></td></tr></table></figure>

<p><code>profile.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;profile&quot;&gt;</span><br><span class="line">        &lt;vant-nav-bar title=&quot;个人中心&quot;&gt;&lt;/vant-nav-bar&gt;</span><br><span class="line">        &lt;div class=&quot;profil-info&quot;&gt;</span><br><span class="line">            &lt;template v-if=&quot;!$store.state.user.hasPermission&quot;&gt;</span><br><span class="line">                &lt;img src=&quot;@/assets/logo.png&quot;&gt;</span><br><span class="line">                &lt;van-button size=&quot;small&quot;&gt;登录&lt;/van-button&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">			&lt;template v-else&gt;</span><br><span class="line">				&lt;img src=&quot;@/assets/logo.png&quot;&gt;</span><br><span class="line">				&lt;span&gt;&#123;&#123;$store.state.user.username&#125;&#125;&lt;/span&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">    	&lt;/div&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;template  v-if=&quot;$store.state.user.menuPermission&quot;&gt;</span><br><span class="line">            &lt;vant-tabs types=&quot;card&quot;&gt;</span><br><span class="line">                &lt;vant-tab </span><br><span class="line">                          :title=&quot;item.name&quot;</span><br><span class="line">                          v-for=&quot;(item, index) in $store.state.user.authList&quot;</span><br><span class="line">                          :to=&quot;item.path&quot;</span><br><span class="line">                          :key=&quot;index&quot;</span><br><span class="line">                          &gt;</span><br><span class="line">                &lt;/vant-tab&gt;            </span><br><span class="line">            &lt;/vant-tabs&gt;</span><br><span class="line">			&lt;router-view&gt;&lt;/router-view&gt;</span><br><span class="line">		&lt;/template&gt;</span><br><span class="line">		</span><br><span class="line">		&lt;template&gt;</span><br><span class="line">			&lt;vant-button v-has=&quot;edit&quot;&gt;编辑&lt;/vant-button&gt;</span><br><span class="line">			&lt;vant-button v-has=&#x27;delete&#x27;&gt;删除&lt;/vant-button&gt;</span><br><span class="line">		&lt;/template&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p><code>src/utils/directives.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="string">&#x27;has&#x27;</span>: &#123;</span><br><span class="line">        <span class="title function_">inserted</span>(<span class="params">el, bindings, vnode</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> value = bindings.<span class="property">value</span> <span class="comment">// 用户写的values值 v-has=&quot;vlaue&quot;</span></span><br><span class="line">            <span class="keyword">let</span> permission = vnode.<span class="property">context</span>. $store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">btnPermission</span> <span class="comment">// 在上下文里找，上下文是当前指令所在组件的组件实例</span></span><br><span class="line">            <span class="keyword">if</span>(!permission.<span class="title function_">includes</span>(value)) &#123;</span><br><span class="line">                el.<span class="property">parentNode</span>.<span class="title function_">removeChild</span>(el)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>main.js</code>中引入指令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指令</span></span><br><span class="line"><span class="keyword">import</span> directives <span class="keyword">from</span> <span class="string">&#x27;@/utils/directives&#x27;</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">entries</span>(directives).<span class="title function_">forEach</span>(<span class="function">(<span class="params">[id, define]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="title function_">directives</span>(id, define)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 备注：全局组件、过滤器也可以这样封装</span></span><br></pre></td></tr></table></figure>



<h1 id="axios最佳实践"><a href="#axios最佳实践" class="headerlink" title="axios最佳实践"></a><code>axios</code>最佳实践</h1><h2 id="函数封装-1"><a href="#函数封装-1" class="headerlink" title="函数封装"></a>函数封装</h2><p><code>utils/request.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="comment">// import &#123; Message &#125; from &#x27;element-ui&#x27;</span></span><br><span class="line"><span class="comment">// console.log(Vue.prototype.$baseURL); // 验证是否已经把属性挂载在了Vue的原型上</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">config</span>) &#123;</span><br><span class="line">  <span class="comment">//console.log(&#x27;request中的router&#x27;, router)</span></span><br><span class="line">  <span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="comment">// baseURL: `http://$&#123;Config.ip&#125;:$&#123;Config.port&#125;`,</span></span><br><span class="line">    <span class="attr">baseURL</span>: <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$baseURL</span>,</span><br><span class="line">    <span class="comment">// timeout: `$&#123;Config.timeout&#125;`</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">      config.<span class="property">headers</span>[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/json&quot;</span>;</span><br><span class="line">      <span class="comment">// config.headers[&#x27;Authorization&#x27;] = &#x27;Bearer &#x27; + localStorage.getItem(&#x27;Authorization&#x27;)</span></span><br><span class="line">      <span class="comment">// console.log(config)</span></span><br><span class="line">      <span class="keyword">return</span> config;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">      <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="property">data</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err.<span class="property">response</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (err.<span class="property">response</span>.<span class="property">status</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="attr">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">      <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">instance</span>(config);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>api/target.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; request &#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get请求</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAllSpider</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/spider/all&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get请求携带parmas参数或query参数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getCounterByDays</span>(<span class="params">nums</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`/counter/all/days/<span class="subst">$&#123;nums&#125;</span>`</span>,</span><br><span class="line">    <span class="comment">// params: &#123;</span></span><br><span class="line">    <span class="comment">//     query: params</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// post请求</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">addSpider</span>(<span class="params">data</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/spider/add&quot;</span>,</span><br><span class="line">    data,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="类封装"><a href="#类封装" class="headerlink" title="类封装"></a>类封装</h2><h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><p><code>utils/axios.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/actions-types.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HttpRequest</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">baseURL</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> == <span class="string">&#x27;production&#x27;</span> ? <span class="string">&#x27;/&#x27;</span> : <span class="string">&#x27;http://localhost:7001&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">timeout</span> = <span class="number">3000</span></span><br><span class="line">        <span class="comment">// 需要加loading（一般很少加了，但要知道）</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span> = &#123;&#125; <span class="comment">// 专门用来维护请求队列，页面切换用来取消请求</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 全局拦截器</span></span><br><span class="line">    <span class="title function_">setInterceptor</span>(<span class="params">instance, url</span>) &#123; <span class="comment">// 设置全局拦截器</span></span><br><span class="line">        instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function">(<span class="params">config</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 开启loading，自己找个地方显示</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">queue</span>).<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 开loading </span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">let</span> token = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span>(token) &#123;</span><br><span class="line">                <span class="comment">// 每次请求都会携带一个权限访问服务器</span></span><br><span class="line">                config.<span class="property">headers</span>.<span class="property">authorization</span> = token</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 可以记录请求的取消函数</span></span><br><span class="line">            <span class="keyword">let</span> <span class="title class_">CancelToken</span> = axios.<span class="property">CancelToken</span></span><br><span class="line">            config.<span class="property">cacelToken</span> = <span class="keyword">new</span> <span class="title class_">CancelToken</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123; <span class="comment">// 绑定在config上</span></span><br><span class="line">                <span class="comment">// c就是当前取消请求的token</span></span><br><span class="line">                <span class="comment">// 可以存到vuex中，页面切换的时候，组件销毁时执行</span></span><br><span class="line">                <span class="comment">// 涉及到vuex三连环</span></span><br><span class="line">                store.<span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">SET_TOKEN</span>, c) <span class="comment">// 同步，将取消方法存入到vuex</span></span><br><span class="line">                <span class="comment">// 那么什么时候清除这些取消请求的token呢？ 在路由切换的时候（放在路由守卫中，只要你一切换路由，就认为请求跳一半了，就取消请求）</span></span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">queue</span>[url] = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">return</span> config</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">queue</span>[url] <span class="comment">// 一旦响应成功了，就删除</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">queue</span>).<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// close loading</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(res.<span class="property">data</span>.<span class="property">err</span> == <span class="number">0</span>) &#123; <span class="comment">//所有的响应体都有这个字段</span></span><br><span class="line">            	<span class="keyword">return</span> res.<span class="property">data</span>.<span class="property">data</span><span class="comment">// 这里要结合接口具体字段，可以配合switchCase状态</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">queue</span>[url]</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">queue</span>).<span class="property">length</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// close loading</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err) <span class="comment">// 把报错抛给用户，让用户处理</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">request</span>(<span class="params">options</span>) &#123; <span class="comment">// 通过request方法来进行请求操作</span></span><br><span class="line">        <span class="comment">// 每次请求可以创建一个新的实例，如果业务不复杂可以不创建实例，直接使用`axios`</span></span><br><span class="line">        <span class="comment">// 复杂场景下ab用的是同一个实例的话，要各自加拦截器就不好加，所以需要单独创建实例加拦截器</span></span><br><span class="line">        <span class="keyword">let</span> instance = axios.<span class="title function_">create</span>()</span><br><span class="line">        <span class="keyword">let</span> config = &#123;</span><br><span class="line">            <span class="attr">baseURL</span>: <span class="variable language_">this</span>.<span class="property">baseURL</span>,</span><br><span class="line">            <span class="attr">timeout</span>: <span class="variable language_">this</span>.<span class="property">timeout</span>,</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            ...options</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setInterceptor</span>(instance, config.<span class="property">url</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="title function_">instance</span>(config) <span class="comment">// 产生的是一个`Promise`</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">get</span>(<span class="params">url, data=&#123;&#125;</span>) &#123; <span class="comment">// axios.get(&#x27;/xxx&#x27;,&#123;params: xxx&#125;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">            url,</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">            ...data</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">post</span>(<span class="params">url, data=&#123;&#125;</span>) &#123; <span class="comment">// axios.post(&#x27;/xxx&#x27;, &#123;data&#125;)</span></span><br><span class="line">		<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(&#123;</span><br><span class="line">        	url,</span><br><span class="line">        	<span class="attr">method</span>: <span class="string">&#x27;post&#x27;</span>,</span><br><span class="line">            data</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">HttpRequest</span></span><br></pre></td></tr></table></figure>

<p><code>src/store/action-types.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置token</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">SET_TOKEN</span> = <span class="string">&#x27;SET_TOKEN&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">CLEAR_TOKEN</span> = <span class="string">&#x27;CLEAR_TOKEN&#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>src/store/index.js</code></p>
<p>这个功能是所有路由组件都需要的，可以放在根文件，当然也可以单独抽成一个模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> modules <span class="keyword">from</span> <span class="string">&#x27;./modules/index.js&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/actions-types&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123; <span class="comment">// 公共的状态</span></span><br><span class="line">        <span class="attr">tokens</span>: []</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        [<span class="title class_">Types</span>.<span class="property">SET_TOKEN</span>](state, token) &#123;</span><br><span class="line">            <span class="comment">// 我们希望状态可以被追踪，但一般不会用push方法来更新，而是会用新的数组赋值（内存地址会变化）</span></span><br><span class="line">    		<span class="comment">// state.tokens.push(token) </span></span><br><span class="line">            state.<span class="property">tokens</span> = [...state.<span class="property">tokens</span>, token] <span class="comment">// 存储token，后续页面切换可以让token一次执行</span></span><br><span class="line">		&#125;,</span><br><span class="line">        [<span class="title class_">Types</span>.<span class="property">CLEAR_TOKEN</span>](state) &#123; <span class="comment">// 一般这一步，放在actions里</span></span><br><span class="line">            state.<span class="property">tokens</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">token</span> =&gt;</span> <span class="title function_">token</span>()) <span class="comment">// 执行所有的取消方法，都调用一下</span></span><br><span class="line">            state.<span class="property">tokens</span> = [] <span class="comment">// 清空列表</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">        ...modules</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> store</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>src/router/hooks.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;@/store&#x27;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Types</span> <span class="keyword">from</span> <span class="string">&#x27;@/store/action-types.js&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="comment">// 此字段只是给自己看的</span></span><br><span class="line">    <span class="string">&#x27;clear_token&#x27;</span>: <span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 这里也可以做一些白名单，不管咋样都允许请求</span></span><br><span class="line">        <span class="comment">// whiteList</span></span><br><span class="line">        store.<span class="title function_">commit</span>(<span class="title class_">Types</span>.<span class="property">CLEAR_TOKEN</span>) <span class="comment">// 清空取消请求的token，如果只希望某个页面切换时取消请求，单独放在组件卸载的生命周期钩子里即可</span></span><br><span class="line">        <span class="title function_">next</span>() <span class="comment">// vue3中支持await的写法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>src/router/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> hooks <span class="keyword">from</span> <span class="string">&#x27;./hooks.js&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueRouter</span>)</span><br><span class="line"><span class="keyword">const</span> routes =[</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">    <span class="attr">mode</span>: <span class="string">&#x27;history&#x27;</span>,</span><br><span class="line">    <span class="attr">base</span>: process.<span class="property">env</span>.<span class="property">BASE_URL</span>,</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环的是hooks对象的value</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">values</span>(hooks).<span class="title function_">forEach</span>(<span class="function"><span class="params">hook</span> =&gt;</span> &#123;</span><br><span class="line">    router.<span class="title function_">beforeEach</span>(hook)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>



<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>新建<code>src/api/home.js</code>文件，对应每个页面的接口文件</p>
<p>如果一个页面的接口有很多，可以新建<code>src/api/config/config.js</code>，该文件单独维护各个路径</p>
<p><code>home/js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axois <span class="keyword">from</span> <span class="string">&#x27;@/utils/axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">fetchSliders</span> = (<span class="params"></span>) =&gt; axios.<span class="title function_">get</span>(<span class="string">&#x27;/api/slider&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>vue</code>的走<code>vuex</code>的开发流程：<code>state -&gt; action-types -&gt; api -&gt; actions -&gt; mutations</code></p>
<p>发请求的页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">        //...</span><br><span class="line">        async mounted() &#123;</span><br><span class="line">            // 页面一开始就加载数据</span><br><span class="line">            if(this.slides.length == 0 )&#123; // 如果vuex中没有数据，获取数据</span><br><span class="line">                try &#123;</span><br><span class="line">                    await this[Types.SET_SLIDES]()</span><br><span class="line">                &#125; catch(e) &#123; // 错误处理、或者异常处理</span><br><span class="line">                    console.log(e) // 这里的异常是处理取消请求token时的报错，应该是用户用的时候自己处理，不能在封装库的时候处理</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><ul>
<li><p>避免路由组件一切换就发请求，可以加一层判断</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// this[Types.ACTION_CATEGORYLIST]() // 注意写法</span></span><br><span class="line">  <span class="comment">// 加一层判断，避免每次切换路由组件时都请求一遍接口</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">categoryList</span>.<span class="property">length</span> == <span class="number">0</span>) &#123; <span class="comment">// 如果vuex中没有数据，再去重新请求（用户刷新页面会重新请求）</span></span><br><span class="line">      <span class="variable language_">this</span>[<span class="title class_">Types</span>.<span class="property">ACTION_CATEGORYLIST</span>]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
</li>
<li><p>刷新页面，立刻切换到其他路由组件时，之前的请求应该取消掉</p>
<p>之前我们在全局的请求拦截器中，加了<code>cancelToken</code>，相当于<code>xhr.abort()</code></p>
</li>
</ul>
<h2 id="抽离baseURL"><a href="#抽离baseURL" class="headerlink" title="抽离baseURL"></a>抽离baseURL</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jdWu-d/p/12687396.html">https://www.cnblogs.com/jdWu-d/p/12687396.html</a></p>
<p>在public目录下，新建一个文件，我命名为serverConfig.json，具体如图所示，里面配了一个baseURL。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;baseURL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建初始化方法<code>utils/init.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getServerConfig</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    axios</span><br><span class="line">      .<span class="title function_">get</span>(<span class="string">&quot;./serverConfig.json&quot;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;读取外部化配置文件&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">data</span>); <span class="comment">// 是否成功读取需要的配置项</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> res.<span class="property">data</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(key);</span><br><span class="line">          <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>[<span class="string">&quot;$&quot;</span> + key] = res.<span class="property">data</span>[key];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$baseURL</span>); <span class="comment">// 验证是否已经把属性挂载在了Vue的原型上</span></span><br><span class="line">        <span class="title function_">resolve</span>();</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">        <span class="title function_">reject</span>();</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，在main.js里面定义一个读取这个文件的方法，在初始化的时候读取这个文件。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;getServerConfig&#125; <span class="keyword">from</span> <span class="string">&quot;@/utils/init.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  <span class="attr">render</span>: <span class="function">(<span class="params">h</span>) =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>),</span><br><span class="line">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">getServerConfig</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).$mount(<span class="string">&quot;#app&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果封装了<code>axios</code>，在封装的<code>js</code>文件中,读取配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Vue&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">baseURL</span>: <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$baseURL</span>,</span><br><span class="line">    <span class="comment">// timeout: `$&#123;Config.timeout&#125;`</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>





<h1 id="持久化最佳实践"><a href="#持久化最佳实践" class="headerlink" title="持久化最佳实践"></a>持久化最佳实践</h1><h2 id="登录持久化"><a href="#登录持久化" class="headerlink" title="登录持久化"></a>登录持久化</h2><h3 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a><code>localStorage</code></h3><h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a><code>cookie</code></h3><h3 id="sessionStorage"><a href="#sessionStorage" class="headerlink" title="sessionStorage"></a><code>sessionStorage</code></h3><p>记录滚动条位置</p>
<h3 id="indexDB"><a href="#indexDB" class="headerlink" title="indexDB"></a><code>indexDB</code></h3><h1 id="移动端最佳实践"><a href="#移动端最佳实践" class="headerlink" title="移动端最佳实践"></a>移动端最佳实践</h1><h2 id="em适配"><a href="#em适配" class="headerlink" title="em适配"></a><code>em</code>适配</h2><h2 id="rem适配"><a href="#rem适配" class="headerlink" title="rem适配"></a><code>rem</code>适配</h2><p><strong>备注：见《移动端开发基础》</strong></p>
<p><code>postcss-plugin-px2rem</code></p>
<p>- </p>
<p><code>lib-flexible</code></p>
<ul>
<li>在页面中注入一段脚本，可获取设备<code>DPR</code>和屏幕宽度，自动计算<code>font-size</code>并添加至<code>html</code>节点属性上</li>
</ul>
<p>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i postcss-plugin-px2rem lib-flexible</span><br></pre></td></tr></table></figure>

<p><code>main.js</code>中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;lib/flexible&#x27;</span> <span class="comment">// 对应设置根的字体（这个插件也可以自己手写）</span></span><br></pre></td></tr></table></figure>

<p><code>vue.config.js</code>新增配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">css</span>: &#123;</span><br><span class="line">        <span class="attr">loaderOptions</span>: &#123;</span><br><span class="line">            <span class="attr">postcss</span>: &#123;</span><br><span class="line">                <span class="attr">plugins</span>: [</span><br><span class="line">                    <span class="built_in">require</span>(<span class="string">&quot;postcss-plugin-px2rem&quot;</span>)(&#123;</span><br><span class="line">                        <span class="attr">rootValue</span>: <span class="number">37.5</span>, <span class="comment">// 表示设计稿大小 375 1rem = 37.5 ,vant里设计稿的大小是375px，可以根据实际修改</span></span><br><span class="line">                        <span class="attr">exclude</span>: <span class="regexp">/node_module/</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="组件最佳实践"><a href="#组件最佳实践" class="headerlink" title="组件最佳实践"></a>组件最佳实践</h1><h2 id="业务组件"><a href="#业务组件" class="headerlink" title="业务组件"></a>业务组件</h2><h2 id="路由组件"><a href="#路由组件" class="headerlink" title="路由组件"></a>路由组件</h2><h2 id="公共组件"><a href="#公共组件" class="headerlink" title="公共组件"></a>公共组件</h2><h2 id="组件库的样式穿透"><a href="#组件库的样式穿透" class="headerlink" title="组件库的样式穿透"></a>组件库的样式穿透</h2><p><a target="_blank" rel="noopener" href="https://www.bbsmax.com/A/amd026aWJg/">https://www.bbsmax.com/A/amd026aWJg/</a></p>
<p>scoped看起来很好用，当时在Vue项目中，当我们引入第三方组件库时(如使用element-ui)，需要在局部组件中修改第三方组件库样式，而又不想去除scoped属性造成组件之间的样式覆盖。这时我们可以通过特殊的方式<strong>穿透scoped</strong></p>
<p><strong>stylus的样式穿透 使用 &gt;&gt;&gt;</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.wrapper</span> &gt;&gt;&gt; <span class="selector-class">.swiper-pagination-bullet-active</span></span><br><span class="line">   <span class="attribute">background</span>: <span class="number">#fff</span></span><br></pre></td></tr></table></figure>

<p><strong>sass和less的样式穿透 使用 &#x2F;deep&#x2F;</strong></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 语法</span></span><br><span class="line">外层 /deep/ 第三方组件 &#123;</span><br><span class="line">	样式</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// eg</span></span><br><span class="line"><span class="selector-class">.wrapper</span> /deep/ <span class="selector-class">.swiper-pagination-bullet-active</span>&#123;</span><br><span class="line">	<span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>vue-cli5.0</code>中使用<code>/deep/</code>报错，默认安装的<code>sass</code>版本为<code>1.32.7</code>，<code>sass-loader</code>版本为<code>12.0.0</code></p>
<p>报错信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error: Module build failed (from ./node_modules/sass-loader/dist/cjs.js):</span><br><span class="line">SassError: expected selector.</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<p>把<code>/deep/</code>写成<code>::v-deep</code></p>
<h1 id="控制台警告"><a href="#控制台警告" class="headerlink" title="控制台警告"></a>控制台警告</h1><h2 id="Added-non-passive-event-listener"><a href="#Added-non-passive-event-listener" class="headerlink" title="Added non-passive event listener..."></a><code>Added non-passive event listener...</code></h2><p>在使用第三方库时，可能控制台报错如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="title class_">Violation</span>] <span class="title class_">Added</span> non-passive event listener to a [scroll](<span class="attr">https</span>:<span class="comment">//so.csdn.net/so/search?q=scroll&amp;spm=1001.2101.3001.7020)-blocking &#x27;mousewheel&#x27; event. Consider marking event handler as &#x27;passive&#x27; to make the page more responsive.</span></span><br></pre></td></tr></table></figure>

<p><img src="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/40af32c14abc42c090960d33d2b6b508.png" alt="img"></p>
<p><img src="/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/image-20220706104041328.png" alt="image-20220706104041328"></p>
<p>[违规]添加非被动事件<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E7%9B%91%E5%90%AC%E5%99%A8&spm=1001.2101.3001.7020">监听器</a>到滚动阻塞’鼠标滚轮’事件。 考虑将事件处理程序标记为“被动”，以使页面响应更快。</p>
<p><strong>解决方案：</strong></p>
<p><strong>1、</strong>npm i default-passive-events -S</p>
<p>2、main.js中加入：import ‘default-passive-events’</p>
<p>原因是 Chrome51 版本以后，Chrome 增加了新的事件捕获机制－Passive Event Listeners；</p>
<p>Passive Event Listeners：就是告诉前页面内的事件监听器内部是否会调用preventDefault函数来阻止事件的默认行为，以便浏览器根据这个信息更好地做出决策来优化页面性能。当属性passive的值为true的时候，代表该监听器内部不会调用preventDefault函数来阻止默认滑动行为，Chrome浏览器称这类型的监听器为被动（passive）监听器。目前Chrome主要利用该特性来优化页面的滑动性能，所以Passive Event Listeners特性当前仅支持mousewheel&#x2F;touch相关事件。</p>
<p>来源：<a target="_blank" rel="noopener" href="https://blog.csdn.net/Wildness_/article/details/123190078">https://blog.csdn.net/Wildness_/article/details/123190078</a></p>
<h1 id="主题颜色管理"><a href="#主题颜色管理" class="headerlink" title="主题颜色管理"></a>主题颜色管理</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/08/08/web/%E6%A1%86%E6%9E%B6/Vue/Vue2.0/Vue2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" data-id="cldol83jb008m3cx6ckrlak3u" data-title="Vue2最佳实践" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web/专栏/积累/书籍笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E4%B9%A6%E7%B1%8D%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2022-08-06T23:09:21.000Z" itemprop="datePublished">2022-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E4%B9%A6%E7%B1%8D%E7%AC%94%E8%AE%B0/">书籍笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="JavaScript高级程序设计（第3版）"><a href="#JavaScript高级程序设计（第3版）" class="headerlink" title="JavaScript高级程序设计（第3版）"></a>JavaScript高级程序设计（第3版）</h1><h3 id="JS简介"><a href="#JS简介" class="headerlink" title="JS简介"></a>JS简介</h3><ul>
<li><p>JS简史</p>
</li>
<li><p>JS实现</p>
<ul>
<li><p>ECMAScript</p>
</li>
<li><p>DOM</p>
<p>通过 DOM 创建的这个表示文档的树形图，开发人员获得了控制页面内容和结构的主动权。借助DOM 提供的 API，开发人员可以轻松自如地删除、添加、替换或修改任何节点。</p>
<p>请读者注意，DOM 并不只是针对 JavaScript 的，很多别的语言也都实现了 DOM。</p>
<p>不过，在 Web 浏览器中，基于 ECMAScript 实现的 DOM 的确已经成为 JavaScript 这门语言的一个重要组成部分。</p>
</li>
<li><p>BOM</p>
<p>开发人员使用 BOM 可以控制浏览器显示的页面以外的部分。</p>
</li>
</ul>
</li>
<li><p>小结</p>
<ul>
<li><p>JavaScript 是一种专为与网页交互而设计的脚本语言，由下列三个不同的部分组成：</p>
<ul>
<li>ECMAScript，由 ECMA-262 定义，提供核心语言功能；</li>
<li>文档对象模型（DOM），提供访问和操作网页内容的方法和接口；</li>
<li>浏览器对象模型（BOM），提供与浏览器交互的方法和接口。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="第25章-新兴的API"><a href="#第25章-新兴的API" class="headerlink" title="第25章 新兴的API"></a>第25章 新兴的API</h2><h3 id="25-6-Web-Worker"><a href="#25-6-Web-Worker" class="headerlink" title="25.6 Web Worker"></a>25.6 Web Worker</h3><h4 id="25-6-1-使用worker"><a href="#25-6-1-使用worker" class="headerlink" title="25.6.1 使用worker"></a>25.6.1 使用worker</h4><p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./promiseTest.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>promiseTest.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webworker Testcode</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;webworker.js&#x27;</span>)</span><br><span class="line">worker.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">	<span class="attr">type</span>: <span class="string">&quot;command&quot;</span>,</span><br><span class="line">	<span class="attr">message</span>: <span class="string">&quot;start！&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> data = event.<span class="property">data</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(data)</span><br><span class="line">&#125;</span><br><span class="line">worker.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ERROR: &quot;</span> + event.<span class="property">filename</span> + <span class="string">&quot; ( &quot;</span> + event.<span class="property">lineno</span> + <span class="string">&quot; ) &quot;</span> + event.<span class="property">message</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;main task&#x27;</span>)</span><br><span class="line"><span class="comment">// worker.terminate()</span></span><br></pre></td></tr></table></figure>

<p>webworker.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;worker task&#x27;</span>)</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<p>效果：main task先被打印出来，两秒后，worker task再被打印出来，main task不会被阻塞</p>
<p><img src="/%E4%B9%A6%E7%B1%8D%E7%AC%94%E8%AE%B0.assets/%E4%BD%BF%E7%94%A8webworker.gif" alt="使用webworker"></p>
<h4 id="25-6-2-Worker全局作用域"><a href="#25-6-2-Worker全局作用域" class="headerlink" title="25.6.2 Worker全局作用域"></a>25.6.2 Worker全局作用域</h4><p>promiseTest.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webworker Testcode</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// main page data</span></span><br><span class="line"><span class="keyword">var</span> data = [<span class="number">23</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">40</span>,<span class="number">654</span>,<span class="number">463</span>,<span class="number">28</span>,<span class="number">45</span>,<span class="number">69</span>,<span class="number">12</span>],</span><br><span class="line"><span class="comment">// worker object</span></span><br><span class="line">	worker = <span class="keyword">new</span> <span class="title class_">Worker</span>(<span class="string">&#x27;./webworker.js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// send data to worker object by postMessage event handler</span></span><br><span class="line">worker.<span class="title function_">postMessage</span>(data)</span><br><span class="line"></span><br><span class="line"><span class="comment">// main page&#x27;s worker object which has onmessage event handler to deal data which form worker object</span></span><br><span class="line">worker.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> data = event.<span class="property">data</span></span><br><span class="line">	<span class="comment">// operate sorted data</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(data, <span class="string">&#x27;data from worker after sorted in main page&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">worker.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ERROR: &quot;</span> + event.<span class="property">filename</span> + <span class="string">&quot; (line &quot;</span> + event.<span class="property">lineno</span> + <span class="string">&quot; ) &quot;</span> + event.<span class="property">message</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;main task&#x27;</span>)</span><br><span class="line"><span class="comment">// worker.terminate()</span></span><br></pre></td></tr></table></figure>

<p>webworker.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// onmessage event handler</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;worker task&#x27;</span>)</span><br><span class="line">self.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> data = event.<span class="property">data</span></span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(data, <span class="string">&#x27;worker, before sort&#x27;</span>)</span><br><span class="line">	data.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b)</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(data, <span class="string">&#x27;worker, sorted&#x27;</span>)</span><br><span class="line">	<span class="comment">// worker task done, return data to main page by postMessage</span></span><br><span class="line">	self.<span class="title function_">postMessage</span>(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// self.close()</span></span><br></pre></td></tr></table></figure>

<p>效果：</p>
<p><img src="/%E4%B9%A6%E7%B1%8D%E7%AC%94%E8%AE%B0.assets/image-20220204113959446.png" alt="image-20220204113959446"></p>
<h4 id="25-6-3-包含其他脚本"><a href="#25-6-3-包含其他脚本" class="headerlink" title="25.6.3 包含其他脚本"></a>25.6.3 包含其他脚本</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Web Worker 内部的代码</span></span><br><span class="line"><span class="title function_">importScripts</span>(<span class="string">&quot;file1.js&quot;</span>, <span class="string">&quot;file2.js&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="25-6-4-Web-Workers的未来"><a href="#25-6-4-Web-Workers的未来" class="headerlink" title="25.6.4 Web Workers的未来"></a>25.6.4 Web Workers的未来</h4><p>本节所讨论的 Worker 目前被称为“专用 Worker” （dedicated worker），因为它们是专门为某个特定的页面服务的，不能在页面间共享。该规范的另外一个<br>概念是“共享 Worker”（shared worker），这种 Worker 可以在浏览器的多个标签中打开的同一个页面间共享。</p>
<p>书籍外拓展：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API">Web Workers API - Web API 接口参考 | MDN (mozilla.org)</a></p>
<h2 id="prototype"><a href="#prototype" class="headerlink" title="prototype"></a>prototype</h2><p>首次出现：5.5.3</p>
<h2 id="引用数据类型"><a href="#引用数据类型" class="headerlink" title="引用数据类型"></a>引用数据类型</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6992460438902423589">JS的基本数据类型和引用数据类型 - 掘金 (juejin.cn)</a></p>
<p>堆、栈：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903873992196110">「前端进阶」JS中的栈内存堆内存 - 掘金 (juejin.cn)</a></p>
<h1 id="JavaScript-DOM编程艺术"><a href="#JavaScript-DOM编程艺术" class="headerlink" title="JavaScript DOM编程艺术"></a>JavaScript DOM编程艺术</h1><h2 id="JS简史"><a href="#JS简史" class="headerlink" title="JS简史"></a>JS简史</h2><h2 id="JS语法"><a href="#JS语法" class="headerlink" title="JS语法"></a>JS语法</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E4%B9%A6%E7%B1%8D%E7%AC%94%E8%AE%B0/" data-id="cldol83fy00453cx69ed2brul" data-title="书籍笔记" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-web/专栏/积累/开发工具" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="article-date">
  <time class="dt-published" datetime="2022-08-06T23:09:21.000Z" itemprop="datePublished">2022-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="webstorm"><a href="#webstorm" class="headerlink" title="webstorm"></a>webstorm</h1><p>绿色版下载：网盘上</p>
<p>配置：</p>
<ul>
<li><p>破解插件</p>
<ul>
<li>插件市场搜索<code>IDE Eval Reset</code>，<code>description:zhile.io</code></li>
</ul>
</li>
<li><p>设置<code>Ctrl</code> + 鼠标滚轮改变字体大小</p>
<ul>
<li><code>Ctrl+Alt+s</code></li>
<li>Editor-&gt;General，选择Change font size (Zoom) with Ctrl+Mouse Wheel；</li>
</ul>
</li>
<li><p>关掉使用<code>webstorm</code>连续按两次Shift键弹出的全局搜索：</p>
<img src="开发工具.assets/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAcXFfNDAxNjU0MzI=,size_20,color_FFFFFF,t_70,g_se,x_16.png" alt="在这里插入图片描述" style="zoom:80%;" />
</li>
<li><p>设置缩进为两个空格</p>
<p><img src="/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyMzE4OTc3,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述"></p>
<p><img src="/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7.assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyMzE4OTc3,size_16,color_FFFFFF,t_70-16538194846792.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="doc转docx"><a href="#doc转docx" class="headerlink" title="doc转docx"></a><code>doc</code>转<code>docx</code></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">一、doc转docx文件linux库安装</span><br><span class="line">1、环境要求：服务器需要能连外网</span><br><span class="line">2、在root用户下，运行如下两行命令安装doc转换库（遇到需要交互确认的地方，输入 y 后回车确认）：</span><br><span class="line">yum install libreoffice-headless</span><br><span class="line">yum install libreoffice-writer</span><br><span class="line"></span><br><span class="line">如何确认是否安装成功：</span><br><span class="line">上传一个需要转换的doc文件，运行如下命令：</span><br><span class="line">soffice --headless --convert-to docx:&quot;MS Word 2007 XML&quot; docx &lt;doc文件路径&gt;</span><br><span class="line">其中&lt;doc文件路径&gt; 替换为所上传的真实doc文件路径，运行命令后，看当前运行命令的目录下有没有生成相应的docx文件。</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" data-id="cldol83g2004d3cx61wyh722z" data-title="开发工具" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-web/专栏/积累/进度" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E8%BF%9B%E5%BA%A6/" class="article-date">
  <time class="dt-published" datetime="2022-08-06T23:09:21.000Z" itemprop="datePublished">2022-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E8%BF%9B%E5%BA%A6/">进度</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h1><table>
<thead>
<tr>
<th>待做列表</th>
<th>首次开始日期</th>
<th>前置知识</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>webpack4</code>初级</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>less</code>最佳实践</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>vue2</code>基础教程巩固</td>
<td>2022年5月10日</td>
<td></td>
<td></td>
</tr>
<tr>
<td>自定义<code>UI</code>组件</td>
<td></td>
<td><code>elementUI</code>源码分析</td>
<td></td>
</tr>
<tr>
<td><code>elementUI</code>源码分析</td>
<td></td>
<td><code>vue2</code>基础教程巩固</td>
<td></td>
</tr>
<tr>
<td><code>《WebKit技术内幕》</code></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>devtools</code>使用技巧</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h1 id="每日回顾及耗时"><a href="#每日回顾及耗时" class="headerlink" title="每日回顾及耗时"></a>每日回顾及耗时</h1><ul>
<li><p>什么样的内容需要每日手写回顾</p>
<ul>
<li>设计代码能力的知识点</li>
<li>可能是别人前置知识的东西</li>
</ul>
</li>
<li><p>什么样的内容不需要</p>
<ul>
<li>软件的安装</li>
<li>项目创建</li>
</ul>
</li>
</ul>
<h2 id="手写常见布局模式"><a href="#手写常见布局模式" class="headerlink" title="手写常见布局模式"></a>手写常见布局模式</h2><h2 id="手写webpack配置"><a href="#手写webpack配置" class="headerlink" title="手写webpack配置"></a>手写<code>webpack</code>配置</h2><ul>
<li><p>2022年5月13日（第二次）</p>
<ul>
<li>开发环境配置（基础配置）：<code>20min</code></li>
<li>生产环境配置（基础配置）：<code>17min</code></li>
</ul>
</li>
<li><p>2022年5月14日（第三次）</p>
<ul>
<li>开发环境配置（基础配置+优化配置）：<code>8min</code></li>
<li>生产环境配置（基础配置）：<code>12min</code></li>
</ul>
</li>
<li><p>2022年5月16日（第四次）</p>
<ul>
<li>开发环境配置（基础配置+优化配置）：<code>6min</code></li>
<li>生产环境配置（基础配置+<code>package.json</code>中配置）：<code>16min</code></li>
</ul>
</li>
<li><p>2022年5月20日（第五次）</p>
<ul>
<li>开发环境配置（基础配置+优化配置）：<code>6min</code></li>
<li>生产环境配置（基础配置+<code>package.json</code>中配置）：<code>15min</code></li>
</ul>
</li>
</ul>
<h2 id="手写Promise"><a href="#手写Promise" class="headerlink" title="手写Promise"></a>手写<code>Promise</code></h2><ul>
<li>2022年5月13日（第一次）<ul>
<li><code>Promise/then/catch/resolve/reject/all/race</code>：<code>1hour34min</code></li>
</ul>
</li>
<li>2022年5月14日（第二次）<ul>
<li><code>Promise/then/catch/resolve/reject/all/race</code>： <code>29min</code></li>
</ul>
</li>
<li>2022年5月16日（第三次）<ul>
<li><code>Promise/then/catch/resolve/reject/all/race</code>： <code>21min</code></li>
</ul>
</li>
</ul>
<h1 id="每周回顾及耗时"><a href="#每周回顾及耗时" class="headerlink" title="每周回顾及耗时"></a>每周回顾及耗时</h1><ul>
<li>什么样的内容需要每周回顾？<ul>
<li>相对关联的知识点的集合<ul>
<li>如<code>布局组件.md</code>这篇文档中，涉及到关于布局的方方面面</li>
</ul>
</li>
<li>专题性内容<ul>
<li>如<code>MDN</code>上关于<code>http</code>的若干体系内容</li>
</ul>
</li>
<li>基础体系结构的进一步深入理解、关联搭建与拓展<ul>
<li>如理解<code>vue</code>中每个事件修饰符之间的关联（不再着眼于单个修饰符的知识点）</li>
</ul>
</li>
<li>项目能力的提升<ul>
<li>具体到<code>《项目能力》.md</code></li>
<li>完善基础知识点，在实际开发中，需要考虑的各种情况<ul>
<li>完善函数工具库</li>
<li>完善<code>UI</code>组件库使用经验</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="每两周回顾及耗时"><a href="#每两周回顾及耗时" class="headerlink" title="每两周回顾及耗时"></a>每两周回顾及耗时</h1><p>每月回顾及耗时</p>
<h1 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h1><h2 id="薪酬"><a href="#薪酬" class="headerlink" title="薪酬"></a>薪酬</h2><h2 id="要了解的问题"><a href="#要了解的问题" class="headerlink" title="要了解的问题"></a>要了解的问题</h2><ul>
<li>业务架构和部分架构，盈利模式</li>
</ul>
<h1 id="社会关系"><a href="#社会关系" class="headerlink" title="社会关系"></a>社会关系</h1><h2 id="雇佣环境"><a href="#雇佣环境" class="headerlink" title="雇佣环境"></a>雇佣环境</h2><h1 id="健康与医疗"><a href="#健康与医疗" class="headerlink" title="健康与医疗"></a>健康与医疗</h1><h2 id="饮食"><a href="#饮食" class="headerlink" title="饮食"></a>饮食</h2><h2 id="健身"><a href="#健身" class="headerlink" title="健身"></a>健身</h2><h1 id="心理健康"><a href="#心理健康" class="headerlink" title="心理健康"></a>心理健康</h1><h2 id="焦虑"><a href="#焦虑" class="headerlink" title="焦虑"></a>焦虑</h2><h3 id="认知焦虑"><a href="#认知焦虑" class="headerlink" title="认知焦虑"></a>认知焦虑</h3><h3 id="技能焦虑"><a href="#技能焦虑" class="headerlink" title="技能焦虑"></a>技能焦虑</h3><ul>
<li>知识点是对现实情况，可能发生的结果的一种概率描述，如果自己亲身经历体验过，称之为经验。</li>
<li>对于经验，人要有意识的组合经验，吸取经验及其中的教训，形成解决未来可能发生的某件事的方案。通过方案是基于无数个经验积累而成的。</li>
</ul>
<h1 id="资本"><a href="#资本" class="headerlink" title="资本"></a>资本</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E8%BF%9B%E5%BA%A6/" data-id="cldol83g3004f3cx6ahlddr5i" data-title="进度" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-web/专栏/积累/前端常见场景解决方案" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="article-date">
  <time class="dt-published" datetime="2022-08-06T23:09:21.000Z" itemprop="datePublished">2022-08-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">前端常见场景解决方案</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="工程化开发基本流程"><a href="#工程化开发基本流程" class="headerlink" title="工程化开发基本流程"></a>工程化开发基本流程</h1><h2 id="vite安装与使用"><a href="#vite安装与使用" class="headerlink" title="vite安装与使用"></a><code>vite</code>安装与使用</h2><p>安装<code>vite</code></p>
<p><code>vite</code>依赖的<code>node</code>版本 <code>&gt;=</code> 12.0.0</p>
<p>打开终端，查看<code>npm</code>版本：<code>npm -v</code></p>
<p><code>npm</code>版本在<code>6.x</code>及以下使用如下命令</p>
<ul>
<li><p><code>aribnb-ssr</code>表示项目名称</p>
</li>
<li><p><code>template</code>表示预设模板（技术栈）</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init vite@latest airbnb-ssr --template vue-ts</span><br></pre></td></tr></table></figure>

<p><code>npm</code>版本在<code>7</code>及<code>7+</code>使用如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init vite@latest airbnb-ssr -- --template vue-ts</span><br></pre></td></tr></table></figure>

<p>切换到文件夹下，安装依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> airbnb-ssr</span><br><span class="line">npm i -D</span><br></pre></td></tr></table></figure>

<h3 id="vite构建基本配置"><a href="#vite构建基本配置" class="headerlink" title="vite构建基本配置"></a><code>vite</code>构建基本配置</h3><p>由于是在<code>linux</code>环境下，运行启动命令前，改下<code>package.json</code>的配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite --host 0.0.0.0 --port 8081&quot;</span><span class="punctuation">,</span> <span class="comment">// 指定ip和开放的端口号</span></span><br></pre></td></tr></table></figure>

<p><code>vite</code>和<code>webapck</code>的不同：</p>
<ul>
<li>没有<code>vendor</code>文件，利用的是浏览器原生的<code>esModule</code></li>
</ul>
<h3 id="配置-别名"><a href="#配置-别名" class="headerlink" title="配置@别名"></a>配置<code>@</code>别名</h3><p><code>vite.config.ts</code></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="comment">// https://vitejs.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [<span class="title function_">vue</span>()],</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="comment">// 配置路径别名</span></span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./src&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>tsconfig.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      </span><br><span class="line">    <span class="attr">&quot;baseUrl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;paths&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;@/*&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;src/*&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">      </span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<h3 id="目录结构解析"><a href="#目录结构解析" class="headerlink" title="目录结构解析"></a>目录结构解析</h3><p>相比较于常规<code>vue2</code>目录，<code>index.html</code>抽离出来了，<code>&lt;scipt&gt;</code>标签上多了<code>type=&quot;module&quot;</code>属性，使用了<code>main.ts</code>作为项目的入口文件</p>
<h2 id="安装less-loader"><a href="#安装less-loader" class="headerlink" title="安装less-loader"></a>安装<code>less-loader</code></h2><ul>
<li><p>此时自己下载的<code>vue-cli</code>，用到<code>webpack</code>的版本为<code>5</code>版本（<code>node_modules</code>文件夹找<code>webapck</code>文件夹，查看<code>package.json</code>文件），这个时候装<code>less-loader</code>是没有问题的，因为默认安装的是最新版的<code>less-loader</code>，新版本是为了迎合<code>webpakc5</code></p>
</li>
<li><p>如果<code>vue-cli</code>用的<code>webpack</code>为<code>4</code>版本，则要<code>less-loader</code>版本降级以兼容<code>webpack4</code></p>
<ul>
<li>查看所有版本：<code>npm view less-loader versions</code></li>
<li>试一下不那么新的版本：<code>npm i less-loader@7.0.0 -D</code> <ul>
<li><code>8</code>及以上的版本就是为<code>webpack4</code>服务的了</li>
</ul>
</li>
</ul>
</li>
<li><p>使用</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span> <span class="selector-tag">lang</span>=&quot;<span class="selector-tag">less</span>&quot; <span class="selector-tag">scoped</span>&gt;</span><br><span class="line"><span class="selector-class">.outer</span> &#123;</span><br><span class="line">    <span class="selector-class">.inner</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/<span class="selector-tag">style</span>&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装vue-router"><a href="#安装vue-router" class="headerlink" title="安装vue-router"></a>安装<code>vue-router</code></h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i vue-router@next -D</span><br></pre></td></tr></table></figure>

<p>安装的是<code>4.0.13</code>版本</p>
<h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>新建<code>router</code>目录，并新建<code>router.ts</code></p>
<p><code>router.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> home <span class="keyword">from</span> <span class="string">&#x27;@/views/home/index.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> mine <span class="keyword">from</span> <span class="string">&#x27;@/views/mine/index.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;createRouter, createMemoryHistory, createWebHistory, createWebHashHistory&#125; <span class="keyword">from</span> <span class="string">&#x27;vue-router&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: home,</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="attr">keepAlive</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/mine&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;mine&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: mine,</span><br><span class="line">        <span class="attr">meta</span>: &#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="attr">keepAlive</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>

<p><code>main.ts</code>中使用<code>vue-router</code>插件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="title function_">use</span>(router)</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>组件中使用<code>router</code></p>
<p><code>App.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;useRouter&#125; from &#x27;vue-router&#x27;</span><br><span class="line">const router = useRouter()</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line"></span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;path: &#x27;/home&#x27;&#125;)&quot;&gt;首页&lt;/button&gt;</span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;path: &#x27;/mine&#x27;&#125;)&quot;&gt;个人中心&lt;/button&gt;</span><br><span class="line">  &lt;router-view/&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>@/views/home/index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;useRouter,useRoute&#125; from &#x27;vue-router&#x27;</span><br><span class="line">const router = useRouter()</span><br><span class="line">const route = useRoute()</span><br><span class="line">console.log(route.params)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  首页</span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;path: &#x27;/mine&#x27;, query: &#123;id: 1&#125;&#125;)&quot;&gt;跳转到个人中心&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>@/views/mine/index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;useRouter, useRoute&#125; from &#x27;vue-router&#x27;</span><br><span class="line">const router = useRouter()</span><br><span class="line">const route = useRoute()</span><br><span class="line"></span><br><span class="line">console.log(route.query)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  个人中心</span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;name: &#x27;home&#x27;, params: &#123;id: 2&#125;&#125;)&quot;&gt;回到首页&lt;/button&gt;</span><br><span class="line"></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装element-ui"><a href="#安装element-ui" class="headerlink" title="安装element-ui"></a>安装<code>element-ui</code></h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><p>官网：<a target="_blank" rel="noopener" href="https://element.eleme.io/#/zh-CN/component/installation">https://element.eleme.io/#/zh-CN/component/installation</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i element-ui -D</span><br></pre></td></tr></table></figure>

<p>当前项目是基于<code>vue-cli5</code>安装的<code>vue2</code>的项目，提示<code>core-js</code>版本过低</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm WARN deprecated core-js@2.6.12: core-js@&lt;3.4 is no longer maintained and not recommended for usage due to the number of issues. Because of the V8 engine whims, feature detection in old core-js versions could cause a slowdown up to 100x even if nothing is polyfilled. Please, upgrade your dependencies to the actual version of core-js.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但实际上<code>package.json</code>中的<code>core-js</code>版本是<code>3.8.3</code>，可能是<code>element-ui</code>中用到的版本吧，暂时跳过这一问题</p>
<h3 id="引入-1"><a href="#引入-1" class="headerlink" title="引入"></a>引入</h3><h4 id="全量引入（不推荐）"><a href="#全量引入（不推荐）" class="headerlink" title="全量引入（不推荐）"></a>全量引入（不推荐）</h4><p><code>main.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementUI</span> <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>; <span class="comment">// 引入element组件库</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span>; <span class="comment">// 引入element全部样式</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">productionTip</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">ElementUI</span>); <span class="comment">// 应用element</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="按需引入"><a href="#按需引入" class="headerlink" title="按需引入"></a>按需引入</h4><p>借助 <code>babel-plugin-component</code>，我们可以只引入需要的组件，以达到减小项目体积的目的。</p>
<p><code>main.js</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install babel-plugin-component -D</span><br></pre></td></tr></table></figure>

<p>然后，将 <code>.babelrc</code> 修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;presets&quot;</span>: [[<span class="string">&quot;es2015&quot;</span>, &#123; <span class="string">&quot;modules&quot;</span>: <span class="literal">false</span> &#125;]],</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;component&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;libraryName&quot;</span>: <span class="string">&quot;element-ui&quot;</span>,</span><br><span class="line">        <span class="string">&quot;styleLibraryName&quot;</span>: <span class="string">&quot;theme-chalk&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有<code>.babelrc</code>，应该有<code>babel.config.js</code></p>
<p>原来的内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [</span><br><span class="line">    <span class="string">&#x27;@vue/cli-plugin-babel/preset&#x27;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [</span><br><span class="line">    <span class="string">&#x27;@vue/cli-plugin-babel/preset&#x27;</span>,</span><br><span class="line">    [<span class="string">&quot;es2015&quot;</span>, &#123; <span class="string">&quot;modules&quot;</span>: <span class="literal">false</span> &#125;]</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">plugins</span>: [ <span class="comment">// 这里是js文件，去掉key的引号</span></span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;component&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;libraryName&quot;</span>: <span class="string">&quot;element-ui&quot;</span>,</span><br><span class="line">        <span class="string">&quot;styleLibraryName&quot;</span>: <span class="string">&quot;theme-chalk&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><h4 id="全量引入使用"><a href="#全量引入使用" class="headerlink" title="全量引入使用"></a>全量引入使用</h4><p>直接使用</p>
<p>看文档上哪个适合用的，复制然后改吧改吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-row&gt;</span><br><span class="line">  &lt;el-button&gt;默认按钮&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button type=&quot;primary&quot;&gt;主要按钮&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button type=&quot;success&quot;&gt;成功按钮&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button type=&quot;info&quot;&gt;信息按钮&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button type=&quot;warning&quot;&gt;警告按钮&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button type=&quot;danger&quot;&gt;危险按钮&lt;/el-button&gt;</span><br><span class="line">&lt;/el-row&gt;</span><br></pre></td></tr></table></figure>

<h4 id="按需引入使用"><a href="#按需引入使用" class="headerlink" title="按需引入使用"></a>按需引入使用</h4><p>接下来，如果你只希望引入部分组件，那么需要在 <code>main.js</code> 中写入以下内容：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&#x27;./store&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Button</span>, <span class="title class_">Row</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;element-ui&#x27;</span>; <span class="comment">// 注意引入的时候，是没有`el`的，然后第一个字母大写</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">productionTip</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="title class_">Button</span>.<span class="property">name</span>, <span class="title class_">Button</span>);  <span class="comment">// 第一个参数，就是自定义的一个名称</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="title class_">Row</span>.<span class="property">name</span>, <span class="title class_">Row</span>);</span><br><span class="line"><span class="comment">// 那么样式怎么把控呢？</span></span><br><span class="line"><span class="comment">// element会根据引入的组件库，自己分析依赖的样式</span></span><br><span class="line"><span class="comment">// Vue.use(Button)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;).$mount(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>值得注意的是，组件库的配置和脚手架的配置要合并起来的，如果脚手架更新了，但组件库的配置写法没更新，就会有问题</p>
<p>很明显的一个例子就是，<code>.babelrc</code>文件都换成了<code>babel.config.js</code></p>
<p>如上写法，会提示如下错误：</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220606155724194.png" alt="image-20220606155724194"></p>
<p>按照提示，安装下对应的包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i babel-preset-es2015 -D</span><br></pre></td></tr></table></figure>

<p>虽然安装成功了，但人家<code>babel-preset-es2015</code>更新改名了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos test2]<span class="comment"># npm i babel-preset-es2015 -D</span></span><br><span class="line">npm WARN deprecated babel-preset-es2015@6.24.1: 🙌  Thanks <span class="keyword">for</span> using Babel: we recommend using babel-preset-env now: please <span class="built_in">read</span> https://babeljs.io/env to update!</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再重新启动下项目，报如下错误</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220606160147715.png" alt="image-20220606160147715"></p>
<p>由于人家<code>es2015</code>改名了，所以配置文件得修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">presets</span>: [</span><br><span class="line">    <span class="string">&#x27;@vue/cli-plugin-babel/preset&#x27;</span>,</span><br><span class="line">    [<span class="string">&quot;@babel/preset-env&quot;</span>, &#123; <span class="string">&quot;modules&quot;</span>: <span class="literal">false</span> &#125;] <span class="comment">// 更正一下包名</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">&quot;component&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;libraryName&quot;</span>: <span class="string">&quot;element-ui&quot;</span>,</span><br><span class="line">        <span class="string">&quot;styleLibraryName&quot;</span>: <span class="string">&quot;theme-chalk&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>造成这些问题的原因在于，<code>element</code>没有及时更新</p>
<p>如果不说怎么改，要真想解决这个问题，需要研究下<code>babel-plugin-component</code>文档，看看目前针对最新的脚手架，它的配置是怎么样的</p>
<p>按需引入后的资源大小</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220606160818450.png" alt="image-20220606160818450"></p>
<h2 id="安装element-plus"><a href="#安装element-plus" class="headerlink" title="安装element-plus"></a>安装<code>element-plus</code></h2><h3 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i element-plus -D</span><br></pre></td></tr></table></figure>

<h3 id="引入-2"><a href="#引入-2" class="headerlink" title="引入"></a>引入</h3><p>按需引入</p>
<p>先下载依赖，实现自动导入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D unplugin-vue-components unplugin-auto-import</span><br></pre></td></tr></table></figure>

<p>在<code>vite.config.ts</code>中新增配置</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AutoImport</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-auto-import/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Components</span> <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">ElementPlusResolver</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;unplugin-vue-components/resolvers&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">      <span class="title function_">vue</span>(),</span><br><span class="line">      <span class="comment">// 新增</span></span><br><span class="line">      <span class="title class_">AutoImport</span>(&#123;</span><br><span class="line">        <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()]</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="title class_">Components</span>(&#123;</span><br><span class="line">        <span class="attr">resolvers</span>: [<span class="title class_">ElementPlusResolver</span>()]</span><br><span class="line">      &#125;)</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">resolve</span>: &#123;</span><br><span class="line">    <span class="attr">alias</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;@&#x27;</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;./src&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在入口文件中导入，并挂载</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementPlus</span> <span class="keyword">from</span> <span class="string">&#x27;element-plus&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-plus/dist/index.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="title function_">use</span>(router)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ElementPlus</span>)</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-2"><a href="#使用-2" class="headerlink" title="使用"></a>使用</h3><p><code>home/index.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;useRouter,useRoute&#125; from &#x27;vue-router&#x27;</span><br><span class="line">const router = useRouter()</span><br><span class="line">const route = useRoute()</span><br><span class="line">console.log(route.params)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  首页</span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;path: &#x27;/mine&#x27;, query: &#123;id: 1&#125;&#125;)&quot;&gt;跳转到个人中心&lt;/button&gt;</span><br><span class="line">  &lt;el-button type=&quot;primary&quot;&gt;Primary&lt;/el-button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，后台只引入了<code>button</code>相关的样式</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220602164011819.png" alt="image-20220602164011819"></p>
<p>前台：</p>
<ul>
<li><code>eleme-plus</code>是主包</li>
<li><code>base.css</code>是基本样式文件</li>
<li><code>el-button</code>是按钮相关样式</li>
</ul>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220602164241609.png" alt="image-20220602164241609"></p>
<p>可以看到，<code>UI</code>库占用的体积很小，这个就是按需加载的好处</p>
<p>我们再引入一下消息提示的组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;useRouter,useRoute&#125; from &#x27;vue-router&#x27;</span><br><span class="line">import &#123; h &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; ElMessage &#125; from &#x27;element-plus&#x27;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line">const route = useRoute()</span><br><span class="line">console.log(route.params)</span><br><span class="line"></span><br><span class="line">const openVn = () =&gt; &#123;</span><br><span class="line">  ElMessage(&#123;</span><br><span class="line">    message: h(&#x27;p&#x27;, null, [</span><br><span class="line">      h(&#x27;span&#x27;, null, &#x27;Message can be &#x27;),</span><br><span class="line">      h(&#x27;i&#x27;, &#123; style: &#x27;color: teal&#x27; &#125;, &#x27;VNode&#x27;),</span><br><span class="line">    ]),</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  首页</span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;path: &#x27;/mine&#x27;, query: &#123;id: 1&#125;&#125;)&quot;&gt;跳转到个人中心&lt;/button&gt;</span><br><span class="line">  &lt;el-button type=&quot;primary&quot;&gt;Primary&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button :plain=&quot;true&quot; @click=&quot;openVn&quot;&gt;VNode&lt;/el-button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>相比较于<code>button</code>，消息提示框的组件，我们全局可能都会用到，可以在全局引入</p>
<p>使用<code>vm</code>实例上的<code>config.globalProperty.XXX = YYY</code>来配置全局属性</p>
<p><code>main.ts</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ElementPlus</span>, &#123;<span class="title class_">ElMessage</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;element-plus&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;element-plus/dist/index.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line">app.<span class="property">config</span>.<span class="property">globalProperties</span>.<span class="property">$message</span> = <span class="title class_">ElMessage</span><span class="comment">// 新增</span></span><br><span class="line">app.<span class="title function_">use</span>(router)</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title class_">ElementPlus</span>)</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在组件中，使用<code>vue</code>的上下文来使用<code>$message</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;useRouter,useRoute&#125; from &#x27;vue-router&#x27;</span><br><span class="line">import &#123; h, getCurrentInstance&#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">const router = useRouter()</span><br><span class="line">const route = useRoute()</span><br><span class="line">console.log(route.params)</span><br><span class="line"></span><br><span class="line">const &#123;proxy&#125;:any = getCurrentInstance() // vue3中没有this，获取上下文</span><br><span class="line">const openVn = () =&gt; &#123;</span><br><span class="line">  proxy.$message(&#123;</span><br><span class="line">    message: h(&#x27;p&#x27;, null, [</span><br><span class="line">      h(&#x27;span&#x27;, null, &#x27;Message can be &#x27;),</span><br><span class="line">      h(&#x27;i&#x27;, &#123; style: &#x27;color: teal&#x27; &#125;, &#x27;VNode&#x27;),</span><br><span class="line">    ]),</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  首页</span><br><span class="line">  &lt;button @click=&quot;() =&gt; router.push(&#123;path: &#x27;/mine&#x27;, query: &#123;id: 1&#125;&#125;)&quot;&gt;跳转到个人中心&lt;/button&gt;</span><br><span class="line">  &lt;el-button type=&quot;primary&quot;&gt;Primary&lt;/el-button&gt;</span><br><span class="line">  &lt;el-button :plain=&quot;true&quot; @click=&quot;openVn&quot;&gt;VNode&lt;/el-button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h3><p>为啥还会有个<code>element-plus</code>的<code>chunk</code>文件，<code>2M</code>多！！</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220602170713170.png" alt="image-20220602170713170"></p>
<h2 id="安装eslint"><a href="#安装eslint" class="headerlink" title="安装eslint"></a>安装<code>eslint</code></h2><h3 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i eslint -D</span><br></pre></td></tr></table></figure>

<p>安装完之后，执行一下<code>eslint</code></p>
<p><code>npx eslint --init</code>或<code>npm init @eslint/config</code></p>
<ul>
<li>备注：<code>npm5.2</code>之后，内置了<code>npx</code>包，可以直接运行了（找自己的<code>node_modules</code>）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-12-centos airbnb-ssr]<span class="comment"># npm init @eslint/config</span></span><br><span class="line">Need to install the following packages:</span><br><span class="line">  @eslint/create-config</span><br><span class="line">Ok to proceed? (y) y</span><br><span class="line">✔ How would you like to use ESLint? · style</span><br><span class="line">✔ What <span class="built_in">type</span> of modules does your project use? · esm</span><br><span class="line">✔ Which framework does your project use? · vue</span><br><span class="line">✔ Does your project use TypeScript? · No / Yes</span><br><span class="line">✔ Where does your code run? · browser, node</span><br><span class="line">✔ How would you like to define a style <span class="keyword">for</span> your project? · guide</span><br><span class="line">✔ Which style guide <span class="keyword">do</span> you want to follow? · standard</span><br><span class="line">✔ What format <span class="keyword">do</span> you want your config file to be <span class="keyword">in</span>? · JavaScript</span><br><span class="line">Checking peerDependencies of eslint-config-standard@latest</span><br><span class="line">The config that you<span class="string">&#x27;ve selected requires the following dependencies:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">eslint-plugin-vue@latest @typescript-eslint/eslint-plugin@latest eslint-config-standard@latest eslint@^8.0.1 eslint-plugin-import@^2.25.2 eslint-plugin-n@^15.0.0 eslint-plugin-promise@^6.0.0 @typescript-eslint/parser@latest</span></span><br><span class="line"><span class="string">✔ Would you like to install them now? · No / Yes</span></span><br><span class="line"><span class="string">✔ Which package manager do you want to use? · npm</span></span><br><span class="line"><span class="string">Installing eslint-plugin-vue@latest, @typescript-eslint/eslint-plugin@latest, eslint-config-standard@latest, eslint@^8.0.1, eslint-plugin-import@^2.25.2, eslint-plugin-n@^15.0.0, eslint-plugin-promise@^6.0.0, @typescript-eslint/parser@latest</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">added 96 packages, and audited 291 packages in 19s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">82 packages are looking for funding</span></span><br><span class="line"><span class="string">  run `npm fund` for details</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">found 0 vulnerabilities</span></span><br><span class="line"><span class="string">Successfully created .eslintrc.js file in /root/hh_git/vue-project/airbnb-ssr</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p>安装完毕后，会根据我们的选择，生成<code>.eslintrc.js</code>配置文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">env</span>: &#123;</span><br><span class="line">    <span class="attr">browser</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">es2021</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">node</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">extends</span>: [</span><br><span class="line">    <span class="comment">// &#x27;plugin:vue/essential&#x27;,</span></span><br><span class="line">    <span class="comment">// 我们的项目是基于vue3的，改成vue3/essential，可以看下eslint官网，关于vue3的配置推荐</span></span><br><span class="line">    <span class="string">&#x27;plugin:vue3/essential&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;standard&#x27;</span> <span class="comment">// 使用单引号</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">parserOptions</span>: &#123;</span><br><span class="line">    <span class="attr">ecmaVersion</span>: <span class="string">&#x27;latest&#x27;</span>,</span><br><span class="line">    <span class="attr">parser</span>: <span class="string">&#x27;@typescript-eslint/parser&#x27;</span>,</span><br><span class="line">    <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="string">&#x27;vue&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;@typescript-eslint&#x27;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">rules</span>: &#123;</span><br><span class="line">      <span class="comment">// 自定义规则</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-3"><a href="#使用-3" class="headerlink" title="使用"></a>使用</h3><p>如果是在本地开发</p>
<ul>
<li>我们导入了未使用的组件，则会出现错误提示</li>
<li>统一变量定义等</li>
</ul>
<p>自定义规则：</p>
<ul>
<li>函数名和括号间不想强制加空格</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rules</span>: &#123;</span><br><span class="line">    <span class="comment">// 自定义规则</span></span><br><span class="line">    <span class="string">&#x27;space-before-function-paren&#x27;</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>搭配<code>vscode</code>插件：<code>eslint</code>使用更佳</p>
<p>如果<code>eslint</code>未生效，就要检查<code>vscode</code>之前有没有安装过类似的格式化工具、自动美化的一些插件</p>
<p>如果是在<code>linux</code>远程开发，暂时没办法</p>
<h2 id="安装Saas"><a href="#安装Saas" class="headerlink" title="安装Saas"></a>安装<code>Saas</code></h2><h2 id="创建react项目"><a href="#创建react项目" class="headerlink" title="创建react项目"></a>创建react项目</h2><h2 id="创建小程序项目"><a href="#创建小程序项目" class="headerlink" title="创建小程序项目"></a>创建小程序项目</h2><h2 id="mock流程"><a href="#mock流程" class="headerlink" title="mock流程"></a><code>mock</code>流程</h2><h3 id="最方便的"><a href="#最方便的" class="headerlink" title="最方便的"></a>最方便的</h3><p>使用<code>json-server</code>，见<code>ajax</code>的文章</p>
<h3 id="简单mock"><a href="#简单mock" class="headerlink" title="简单mock"></a>简单<code>mock</code></h3><p>以<code>vue</code>为例，<code>src</code>目录下新建<code>mock</code>文件夹</p>
<p>文件夹结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mock</span><br><span class="line">|----data</span><br><span class="line">|----index.js</span><br></pre></td></tr></table></figure>

<p>安装<code>express</code>：<code>npm i express -D</code></p>
<p><code>data</code>可以放一些假的返回数据，之后在<code>index.js</code>中定义接口并返回数据</p>
<p><code>index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> getdata = <span class="built_in">require</span>(<span class="string">&#x27;./data/spider/getdata.json&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/get-data&#x27;</span>,<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">send</span>(getdata) </span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8081</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;8081在运行&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后使用<code>node</code>运行：<code>node index.js</code></p>
<p>如果配置的端口是可以访问外网的话，输入<code>ip+接口路径</code>，即可正常返回数据：</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220519141935391.png" alt="image-20220519141935391"></p>
<p>在后台接口还没有或不便于调试时，可以先用本地数据来开发，只要返回的数据格式一致即可</p>
<h3 id="稍微复杂点的mock"><a href="#稍微复杂点的mock" class="headerlink" title="稍微复杂点的mock"></a>稍微复杂点的<code>mock</code></h3><p><code>mockjs</code>基本使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mockjs -D</span><br></pre></td></tr></table></figure>

<p>创建<code>src/mock</code>文件夹，新建相应的<code>json</code>文件以及入口文件<code>mockServer.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Mock</span> <span class="keyword">from</span> <span class="string">&#x27;mockjs&#x27;</span></span><br><span class="line"><span class="keyword">import</span> banner <span class="keyword">from</span> <span class="string">&#x27;./banner.json&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Mock</span>.<span class="title function_">mock</span>(<span class="string">&quot;/mock/banner&quot;</span>,&#123;<span class="attr">code</span>: <span class="number">200</span>, <span class="attr">message</span>: <span class="string">&quot;0k&quot;</span>, <span class="attr">data</span>: banner&#125;)</span><br></pre></td></tr></table></figure>

<p><code>main.js</code>中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;@/mock/mockServer.js&#x27;</span></span><br></pre></td></tr></table></figure>

<p>对于<code>mock</code>的请求地址，使用<code>axios</code>时，要新建个<code>axios</code>封装的文件（之前的是<code>request.js</code>，现在复制一下改个名）</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_46670795/article/details/109129987">https://blog.csdn.net/weixin_46670795/article/details/109129987</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用axios发送  ajax</span></span><br><span class="line">cnpm install axios --save</span><br><span class="line"><span class="comment">//使用mockjs产生随机数据</span></span><br><span class="line">cnpm install mockjs --save-dev</span><br><span class="line"><span class="comment">//使用json5解决json文件,无法添加注释问题</span></span><br><span class="line">cnpm install json5 --save-dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="文件服务器搭建流程"><a href="#文件服务器搭建流程" class="headerlink" title="文件服务器搭建流程"></a>文件服务器搭建流程</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2b3b03368249">https://www.jianshu.com/p/2b3b03368249</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express cors multer</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// multer插件配置：</span></span><br><span class="line"><span class="comment">//注册一个对象，dest里放的是上传的文件存储的位置，可以在当前目录下，建立一个static目录，上传的文件都放在这里</span></span><br><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123;<span class="attr">dest</span>: <span class="string">&#x27;./static/&#x27;</span>&#125;)</span><br><span class="line"><span class="comment">//使用中间件，没有挂载路径，应用的每个请求都会执行该中间件。any表示接受一切，具体参考文档。</span></span><br><span class="line">app.<span class="title function_">use</span>(upload.<span class="title function_">any</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment">// body</span></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">json</span>()) <span class="comment">// for parsing application/json</span></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">true</span> &#125;)) </span><br><span class="line"></span><br><span class="line"><span class="comment">// 跨域</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">send</span>(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">files</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">//拿到后缀名</span></span><br><span class="line">  <span class="keyword">var</span> extname = path.<span class="title function_">extname</span>(req.<span class="property">files</span>[<span class="number">0</span>].<span class="property">originalname</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//拼接新的文件路径，文件加上后缀名</span></span><br><span class="line">  <span class="keyword">var</span> newPath = req.<span class="property">files</span>[<span class="number">0</span>].<span class="property">path</span> + extname;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//重命名</span></span><br><span class="line">  fs.<span class="title function_">rename</span>(req.<span class="property">files</span>[<span class="number">0</span>].<span class="property">path</span>, newPath, <span class="keyword">function</span>(<span class="params">err</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;上传失败&#x27;</span>)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      res.<span class="title function_">send</span>(<span class="string">&#x27;上传成功&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">80</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server running!&#x27;</span>))</span><br></pre></td></tr></table></figure>





<h1 id="CSS解决方案"><a href="#CSS解决方案" class="headerlink" title="CSS解决方案"></a>CSS解决方案</h1><h2 id="点击事件记录样式"><a href="#点击事件记录样式" class="headerlink" title="点击事件记录样式"></a>点击事件记录样式</h2><ul>
<li>背景，现在是hover状态下，加深背景色，希望点击时，也能加深背景色，以提示用户目前操作的是哪一个菜单栏</li>
</ul>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220318093941394.png" alt="image-20220318093941394"></p>
<ul>
<li><p>思路：</p>
<ul>
<li><p>数据基于v-for渲染，已经存在一个index的列表</p>
</li>
<li><p>每次点击存一个currentIndex，同时根据index的current是否相等，动态绑定所有item子元素的样式</p>
<ul>
<li>对于点击的元素，currentIndex和index肯定是相等的</li>
<li>点击未点击的元素，两者的判断返回结果就是false</li>
</ul>
</li>
<li><p>核心代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div v-for=&quot;&quot;(item, index) in navigations&quot; @click=&quot;this.currentIndex=index&quot; :class=&#123;&#x27;menu-item-click&#x27;: currentIndex==index&#125;&gt;                                                             </span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">                                                                           </span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                currentIndex: 0, // 初始化</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .menu-item.click &#123;</span><br><span class="line">        background-color: grey;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以适当的进行封装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div v-for=&quot;&quot;(item, index) in navigations&quot; @click=&quot;getIndex(index)&quot; :class=&quot;bindStyle(index)&quot;&gt;                                                           </span><br><span class="line">    &lt;/div&gt;                                                                        </span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line">                currentIndex: 0, // 初始化</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">        	getIndex(index) &#123;</span><br><span class="line">            	this.currentIndex = index</span><br><span class="line">        	&#125;,</span><br><span class="line">            bindStyle(index) &#123;</span><br><span class="line">                return &#123;</span><br><span class="line">                    &#x27;menu-item-click&#x27;: this.currentIndex == index</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">    .menu-item.click &#123;</span><br><span class="line">        background-color: grey;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="布局的依赖性问题"><a href="#布局的依赖性问题" class="headerlink" title="布局的依赖性问题"></a>布局的依赖性问题</h2><ul>
<li>背景，如何避免改一个地方的样式，其他地方的样式还要跟着改</li>
</ul>
<h2 id="vue-cli中引入公共样式"><a href="#vue-cli中引入公共样式" class="headerlink" title="vue-cli中引入公共样式"></a><code>vue-cli</code>中引入公共样式</h2><ul>
<li><p>公共样式资源放在<code>public</code>目录，在<code>index.html</code>中引入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&lt;%= BASE_URL %&gt;css/bootstrap.css&quot;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>公共资源放在<code>src</code>目录，在入口文件中引入</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> <span class="string">&#x27;bootstrap.css&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="轮播图解决方案"><a href="#轮播图解决方案" class="headerlink" title="轮播图解决方案"></a>轮播图解决方案</h2><p>使用<code>swiper.js</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i swiper@5 -D</span><br></pre></td></tr></table></figure>

<p><code>main.js</code>中引入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &#x27;swiper/css/swiper.css&#x27;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://www.swiper.com.cn/">https://www.swiper.com.cn/</a></p>
<p>在<code>new swiper</code>实例之前，页面必须要有<code>dom</code>结构，多以要<code>watch</code>和<code>$nextTick</code>配合使用</p>
<p><code>html</code>部分</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--banner轮播--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-container&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;mySwiper&quot;</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-wrapper&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-slide&quot;</span> <span class="attr">v-for</span>=<span class="string">&quot;(carousel, index) in bannerList&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;carousel.id&quot;</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">&quot;carousel.imgUrl&quot;</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!-- 如果需要分页器 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-pagination&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">&lt;!-- 如果需要导航按钮 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-button-prev&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;swiper-button-next&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>js</code>部分</p>
<p>引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Swiper</span> <span class="keyword">from</span> <span class="string">&#x27;swiper&#x27;</span></span><br></pre></td></tr></table></figure>



<p>使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">watch</span>: &#123;</span><br><span class="line">    <span class="attr">bannerList</span>: &#123;</span><br><span class="line">      <span class="title function_">handler</span>(<span class="params">newValue, oldValue</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.$nextTick(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> mySwiper = <span class="keyword">new</span> <span class="title class_">Swiper</span>(<span class="variable language_">this</span>.<span class="property">$refs</span>.<span class="property">mySwiper</span>,&#123;</span><br><span class="line">            <span class="attr">loop</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">// 如果需要分页器</span></span><br><span class="line">            <span class="attr">pagination</span>: &#123;</span><br><span class="line">              <span class="attr">el</span>: <span class="string">&quot;.swiper-pagination&quot;</span>,</span><br><span class="line">              <span class="attr">clickable</span>: <span class="literal">true</span> <span class="comment">// 点击小球的时候也可以切换图片</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">// 如果需要前进后退按钮</span></span><br><span class="line">            <span class="attr">navigation</span>: &#123;</span><br><span class="line">              <span class="attr">nextEl</span>: <span class="string">&quot;.swiper-button-next&quot;</span>,</span><br><span class="line">              <span class="attr">prevEl</span>: <span class="string">&quot;.swiper-button-prev&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h1 id="常见UI库解决方案"><a href="#常见UI库解决方案" class="headerlink" title="常见UI库解决方案"></a>常见UI库解决方案</h1><h2 id="ElementUI"><a href="#ElementUI" class="headerlink" title="ElementUI"></a>ElementUI</h2><h3 id="el-popover"><a href="#el-popover" class="headerlink" title="el-popover"></a>el-popover</h3><ul>
<li>可以单向绑定类名，或者直接指定类名</li>
</ul>
<h1 id="网络请求常见处理"><a href="#网络请求常见处理" class="headerlink" title="网络请求常见处理"></a>网络请求常见处理</h1><h2 id="取消请求发送"><a href="#取消请求发送" class="headerlink" title="取消请求发送"></a>取消请求发送</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/22b49e6ad819">https://www.jianshu.com/p/22b49e6ad819</a></p>
<p>场景：搜索时，例如输入abc，尽管做了节流处理，但是在退格删除全部时，如果参数a的返回的数据量很大，即使一开始置空了，还是会回填参数a的结果，所以需要对输入间隔的时间戳进行判断，小于某个阈值时，取消axios请求</p>
<h1 id="常见异常处理"><a href="#常见异常处理" class="headerlink" title="常见异常处理"></a>常见异常处理</h1><h2 id="axios异常处理"><a href="#axios异常处理" class="headerlink" title="axios异常处理"></a>axios异常处理</h2><ul>
<li><p>场景：支持多端登陆，但多端用到的token是存在redis的一个键值里的，某一端注销导致redis清掉token之后，另一端报401错误。- </p>
<ul>
<li>我们可以在响应拦截器中，加上错误状态码的处理，进行重定向，如下：</li>
<li>备注：状态码的判断逻辑，是写在onFullfilled里还是onRejected里，取决于后台咋写的，注意下。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="property">data</span></span><br><span class="line">&#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err.<span class="property">response</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (err.<span class="property">response</span>.<span class="property">status</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">                store.<span class="title function_">commit</span>(<span class="variable constant_">LOGIN_OUT</span>)</span><br><span class="line">                <span class="variable language_">window</span>.<span class="title function_">alert</span>(<span class="string">&#x27;您已在其他地方登陆，认证失效&#x27;</span>) <span class="comment">// 将会被重复调用</span></span><br><span class="line">                <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;/#/home&#x27;</span></span><br><span class="line">                </span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>拓展：我们还希望给用户一个提示</p>
<ul>
<li><p>问题：一个页面不只一个接口会用到认证，也就是说onRejected的回调会被多次捕获到，会导致多次弹窗</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220318150014265.png" alt="image-20220318150014265"></p>
</li>
<li><p>相似场景：</p>
<ul>
<li>获取所有的el-message，判断长度：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36070288/article/details/105553009">https://blog.csdn.net/qq_36070288/article/details/105553009</a></li>
<li>自定义变量，只执行第一次的弹窗：<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46156566/article/details/113976916">https://blog.csdn.net/m0_46156566/article/details/113976916</a></li>
</ul>
</li>
<li><p>结果：<strong>没解决</strong>，所有的判断变量在刷新首页时，又被重新定义了</p>
</li>
</ul>
</li>
</ul>
<h2 id="图片资源异常处理"><a href="#图片资源异常处理" class="headerlink" title="图片资源异常处理"></a>图片资源异常处理</h2><p>参考链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/mouday/article/details/107190403">https://blog.csdn.net/mouday/article/details/107190403</a></p>
<p><strong>利用onerror 事件处理img标签中的src图片加载失败</strong></p>
<p>如果 <code>img</code>标签中的src图片<code>logo.png</code>加载失败，原来的图片位置会被<code>error.png</code> 替换</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;logo.png&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;handleImageError()&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">handleImageError</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(event);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> img = event.<span class="property">target</span>;</span></span><br><span class="line"><span class="language-javascript">    img.<span class="property">src</span> = <span class="string">&quot;error.png&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 控制它不循环;</span></span></span><br><span class="line"><span class="language-javascript">    img.<span class="property">onerror</span> = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果<code>logo.png</code>不存在会触发 onerror事件，指定图片<code>error.png</code> 去替补，</p>
<p>如果替补图片<code>error.png</code> 还不存在，还会继续触发onerror事件，</p>
<p>需要使用<code>img.onerror=null</code> 取消事件处理</p>
<p><strong>Vue处理方式</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;img v-bind=&quot;$attrs&quot;</span><br><span class="line">    v-on=&quot;$listeners&quot;</span><br><span class="line">    @error=&quot;handleError&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">/**</span><br><span class="line"> * 有错误处理的图片</span><br><span class="line"> */</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &quot;MoImage&quot;,</span><br><span class="line"></span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      // 默认值</span><br><span class="line">      defaultImage: require(&quot;@/assets/image/image-default.png&quot;),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    // 错误值处理</span><br><span class="line">    handleError(event) &#123;</span><br><span class="line">      event.target.src = this.defaultImage;</span><br><span class="line">      // 控制不要一直跳动</span><br><span class="line">      event.target.onerror = null;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="交互方案"><a href="#交互方案" class="headerlink" title="交互方案"></a>交互方案</h1><p>新增交互时，要考虑到</p>
<ul>
<li>新增前用户可能停留的页面情况，在新增交互结束后，要能还原</li>
<li>交互周期<ul>
<li>交互前<ul>
<li>释放信号，通知用户新的交互已经开始</li>
<li>明确新增元素</li>
<li>明确新增元素和已有元素的依存关系<ul>
<li>互斥：<code>v-if/v-show</code></li>
<li>依赖：定位</li>
</ul>
</li>
</ul>
</li>
<li>交互中<ul>
<li>交互频率<ul>
<li>单次交互</li>
<li>多次交互</li>
<li>连续交互</li>
</ul>
</li>
<li>输入反馈</li>
</ul>
</li>
<li>交互后<ul>
<li>交互测试<ul>
<li>大数据量测试</li>
<li>交互循环测试<ul>
<li>可以有效测出哪些结束状态量需要清除</li>
</ul>
</li>
</ul>
</li>
<li>对于没有不符合预期的交互，要给出提示<ul>
<li>如新增操作，不允许用户新增同类字段，要给出提示</li>
</ul>
</li>
</ul>
</li>
<li>结束<ul>
<li>提供结束交互入口<ul>
<li>通常在释放交互信号时，就要考虑交互结束的入口</li>
</ul>
</li>
<li>结束交互时，要考虑是否要清除当前的状态量<ul>
<li>对于结束状态量的变化，要进行代码健壮性考虑<ul>
<li>如：input输入框结束时进行清空值的操作，watch时对于oldValue为空的情况，就要进行处理</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="常见代码重构方案"><a href="#常见代码重构方案" class="headerlink" title="常见代码重构方案"></a>常见代码重构方案</h1><h2 id="条件嵌套重构方案"><a href="#条件嵌套重构方案" class="headerlink" title="条件嵌套重构方案"></a>条件嵌套重构方案</h2><p>参考链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904006154715143">https://juejin.cn/post/6844904006154715143</a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>日常开发经常会遇到复杂的条件判断, 一般做法就是用<code>if</code>&#x2F;<code>else</code>, 或者优雅一点用<code>switch</code>来实现多个条件的判断. 如果条件越来越多, 会导致代码越来越臃肿, 如何使用更优雅的方式来实现呢?</p>
<h3 id="基本代码-if-x2F-elseif-x2F-else"><a href="#基本代码-if-x2F-elseif-x2F-else" class="headerlink" title="基本代码-if&#x2F;elseif&#x2F;else"></a>基本代码-if&#x2F;elseif&#x2F;else</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">clickHandler</span> = (<span class="params">status</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span>(status === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="string">&#x27;processing&#x27;</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(<span class="string">&#x27;IndexPage&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(status === <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="string">&#x27;fail&#x27;</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(<span class="string">&#x27;FailPage&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(status === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="string">&#x27;fail&#x27;</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(<span class="string">&#x27;FailPage&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(status === <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(<span class="string">&#x27;SuccessPage&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(status === <span class="number">5</span>) &#123;</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="string">&#x27;cancel&#x27;</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(<span class="string">&#x27;CancelPage&#x27;</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="string">&#x27;other&#x27;</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="优化1-switch"><a href="#优化1-switch" class="headerlink" title="优化1-switch"></a>优化1-switch</h3><p>通过以上代码, 可以看出该函数的作用是: 根据<code>status</code>状态的不同, 发送日志和跳转到对应的页面.</p>
<p>大家可以轻易的使用<code>switch</code>来进行重构:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">clickHandler</span> = (<span class="params">status</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="title function_">sendLog</span>(<span class="string">&#x27;processing&#x27;</span>)</span><br><span class="line">            <span class="title function_">jumpTo</span>(<span class="string">&#x27;IndexPage&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="title function_">sendLog</span>(<span class="string">&#x27;fail&#x27;</span>)</span><br><span class="line">            <span class="title function_">jumpTo</span>(<span class="string">&#x27;FailPage&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="title function_">sendLog</span>(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">            <span class="title function_">jumpTo</span>(<span class="string">&#x27;SuccessPage&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="title function_">sendLog</span>(<span class="string">&#x27;cancel&#x27;</span>)</span><br><span class="line">            <span class="title function_">jumpTo</span>(<span class="string">&#x27;CancelPage&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="title function_">sendLog</span>(<span class="string">&#x27;other&#x27;</span>)</span><br><span class="line">            <span class="title function_">jumpTo</span>(<span class="string">&#x27;Index&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样看起来比<code>if / else</code>清晰多了. 细心的你一定会发现<code>case2</code>, <code>case3</code>的逻辑是一样的,</p>
<h3 id="优化2"><a href="#优化2" class="headerlink" title="优化2"></a>优化2</h3><p>在日常的代码开发中, 基本上大多数同学都是这样写. 这样写固然可以, 但也不太优雅. 有一观点是: <strong>编程的本质, <code>数据结构</code> + <code>算法</code>, 任何算法都包含两部分, <code>Logic</code> + <code>Control</code></strong></p>
<ul>
<li>Logic部分就是真正意义上的算法</li>
<li>Control部分只是影响解决问题的效率.</li>
</ul>
<p>如果我们能将 <code>Logic</code> 和 <code>Control</code>部分有效地分开, 那么代码将会变得更加容易维护和改进.</p>
<p>比如, 我们试着用下面的办法去分离代码:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> actions = &#123;</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: [<span class="string">&#x27;processing&#x27;</span>, <span class="string">&#x27;IndexPage&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: [<span class="string">&#x27;fail&#x27;</span>, <span class="string">&#x27;FailPage&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;3&#x27;</span>: [<span class="string">&#x27;fail&#x27;</span>, <span class="string">&#x27;FailPage&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;4&#x27;</span>: [<span class="string">&#x27;success&#x27;</span>, <span class="string">&#x27;SuccessPage&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;5&#x27;</span>: [<span class="string">&#x27;cancel&#x27;</span>, <span class="string">&#x27;CancelPage&#x27;</span>],</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: [<span class="string">&#x27;other&#x27;</span>, <span class="string">&#x27;Index&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clickHandler</span> = (<span class="params">status</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> action = actions[status] || actions[<span class="string">&#x27;default&#x27;</span>],</span><br><span class="line">        <span class="title class_">LogName</span> = action[<span class="number">0</span>],</span><br><span class="line">        pageName = action[<span class="number">1</span>]</span><br><span class="line">    <span class="title function_">sendLog</span>(<span class="title class_">LogName</span>)</span><br><span class="line">    <span class="title function_">jumpTo</span>(pageName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样的形式, 其实就是<code>DSL(Domain Specific Language)</code>解析器.</p>
<p><code> DSL</code>的描述是一个Logic, 函数<code>clickHandler</code>就是<code>Control</code>部分, 代码大大简化。</p>
<p>由此可以总结出如下思想:</p>
<ul>
<li>State Machine<ul>
<li>状态定义</li>
<li>状态变迁条件</li>
<li>状态的action</li>
</ul>
</li>
<li>DSL - Domain Specific Language<ul>
<li>HTML,  SQL, 正则表达式……</li>
</ul>
</li>
<li>编程范式<ul>
<li>面向对象:  委托, 桥接, 修饰, MVC…….</li>
<li>函数式编程: 修饰, 管道, 拼接</li>
<li>逻辑推导式编程</li>
</ul>
</li>
</ul>
<p>&#x2F;&#x2F; TODO</p>
<h1 id="文件导入导出"><a href="#文件导入导出" class="headerlink" title="文件导入导出"></a>文件导入导出</h1><h2 id="HTML转JSON"><a href="#HTML转JSON" class="headerlink" title="HTML转JSON"></a>HTML转JSON</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;box&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; ref=&quot;fileItem&quot;&gt;</span><br><span class="line">    &lt;button id=&quot;btn&quot; @click=&quot;submit&quot;&gt;确定&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">  body &#123;</span><br><span class="line">    margin: 0;</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    export default &#123;</span><br><span class="line">        data() &#123;</span><br><span class="line">            return &#123;</span><br><span class="line"></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            submit() &#123;</span><br><span class="line">                let file = this.$refs.fileItem.files.item(0)</span><br><span class="line">                if (file.name.indexOf(&quot;.html&quot;) &lt; 0) &#123;</span><br><span class="line">                    // 不处理非html的文件类型</span><br><span class="line">                    this.alertErr()</span><br><span class="line">                    return</span><br><span class="line">                &#125;</span><br><span class="line">                // 获取文件里面的文本信息</span><br><span class="line">                file.text().then(res =&gt; &#123;</span><br><span class="line">                    // 内容转成dom对象</span><br><span class="line">                    let doms = this.parseToDOM(res);</span><br><span class="line">                    for (const dom of doms) &#123;</span><br><span class="line">                        // 从dom对象中获取DL标签</span><br><span class="line">                        if (dom.tagName == &#x27;DL&#x27;) &#123;</span><br><span class="line">                            let result = this.textHandle(dom, null);</span><br><span class="line">                            this.exportRaw(&#x27;data.json&#x27;, JSON.stringify(result.children))</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            alertErr() &#123;</span><br><span class="line">                alert(&quot;请不要上传非浏览器书签文件&quot;)</span><br><span class="line">            &#125;,</span><br><span class="line">            /**</span><br><span class="line">             * 把String转为DOM对象</span><br><span class="line">             * @param str</span><br><span class="line">             * @returns &#123;NodeListOf&lt;ChildNode&gt;&#125;</span><br><span class="line">             */</span><br><span class="line">            parseToDOM(str) &#123;</span><br><span class="line">                let div = document.createElement(&quot;div&quot;);</span><br><span class="line">                if (typeof str == &quot;string&quot;) &#123;</span><br><span class="line">                    div.innerHTML = str;</span><br><span class="line">                &#125;</span><br><span class="line">                return div.childNodes;</span><br><span class="line">            &#125;,</span><br><span class="line">            /**</span><br><span class="line">             *</span><br><span class="line">             * @param dl</span><br><span class="line">             * @param temp</span><br><span class="line">             * @returns &#123;*&#125;</span><br><span class="line">             */</span><br><span class="line">            textHandle(dl, temp) &#123;</span><br><span class="line">                // 先获取DL 下面的DT</span><br><span class="line">                let dts = this.getDts(dl);</span><br><span class="line">                if (dts.length &gt; 0) &#123;</span><br><span class="line">                    // 判断DT下面是否有DL标签</span><br><span class="line">                    for (var i in dts) &#123;</span><br><span class="line">                        let dt = dts[i], hdl = this.getTag(dt, &quot;DL&quot;);</span><br><span class="line">                        if (hdl != null) &#123;</span><br><span class="line">                            let h = this.getTag(dt, &quot;H3&quot;);</span><br><span class="line">                            let returns = this.textHandle(hdl, &#123;name: h.textContent, children: [], web: []&#125;)</span><br><span class="line">                            if (temp == null) &#123;</span><br><span class="line">                                temp = returns;</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                temp.children.push(returns);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            var a = this.getTag(dt, &quot;A&quot;);</span><br><span class="line">                            temp.web.push(&#123;</span><br><span class="line">                                url: a.href,</span><br><span class="line">                                title: a.textContent,</span><br><span class="line">                                desc: a.textContent,</span><br><span class="line">                                logo: a.getAttribute(&quot;ICON&quot;)</span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return temp;</span><br><span class="line">            &#125;,</span><br><span class="line">            /**</span><br><span class="line">             * 获取DL下面的DT标签</span><br><span class="line">             * @param dl</span><br><span class="line">             * @returns &#123;[]&#125;</span><br><span class="line">             */</span><br><span class="line">            getDts(dl) &#123;</span><br><span class="line">                let dlcs = dl.children, arr = [];</span><br><span class="line">                if (dlcs.length &lt; 1) &#123;</span><br><span class="line">                    return arr;</span><br><span class="line">                &#125;</span><br><span class="line">                for (let dlc of dlcs) &#123;</span><br><span class="line">                    if ((dlc.tagName.toUpperCase()) == &#x27;DT&#x27;) &#123;</span><br><span class="line">                        arr.push(dlc)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return arr;</span><br><span class="line">            &#125;,</span><br><span class="line">            /**</span><br><span class="line">             * 获取dt下面的标签</span><br><span class="line">             *</span><br><span class="line">             * @param dl</span><br><span class="line">             * @return</span><br><span class="line">             */</span><br><span class="line">            getTag(dt, tagname) &#123;</span><br><span class="line">                let dtcs = dt.children, obj = null;</span><br><span class="line">                if (dtcs.length &lt; 1) &#123;</span><br><span class="line">                    return obj</span><br><span class="line">                &#125;</span><br><span class="line">                for (let dtc of dtcs) &#123;</span><br><span class="line">                    if ((dtc.tagName.toUpperCase()) == tagname) &#123;</span><br><span class="line">                        obj = dtc;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                return obj;</span><br><span class="line">            &#125;,</span><br><span class="line">            /**</span><br><span class="line">             * 导出为文件</span><br><span class="line">             */</span><br><span class="line">            exportRaw(name, data) &#123;</span><br><span class="line">                var urlObject = window.URL || window.webkitURL || window;</span><br><span class="line">                var export_blob = new Blob([data]);</span><br><span class="line">                var save_link = document.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;a&quot;)</span><br><span class="line">                save_link.href = urlObject.createObjectURL(export_blob);</span><br><span class="line">                save_link.download = name;</span><br><span class="line">                var ev = document.createEvent(&quot;MouseEvents&quot;);</span><br><span class="line">                ev.initMouseEvent(&quot;click&quot;, true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);</span><br><span class="line">                save_link.dispatchEvent(ev);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h1 id="可拖拽方案"><a href="#可拖拽方案" class="headerlink" title="可拖拽方案"></a>可拖拽方案</h1><h2 id="sortabeljs"><a href="#sortabeljs" class="headerlink" title="sortabeljs"></a>sortabeljs</h2><p><a target="_blank" rel="noopener" href="http://www.sortablejs.com/index.html">http://www.sortablejs.com/index.html</a></p>
<h2 id="鼠标拖拽调整div大小"><a href="#鼠标拖拽调整div大小" class="headerlink" title="鼠标拖拽调整div大小"></a>鼠标拖拽调整div大小</h2><h3 id="Javascript基本原理"><a href="#Javascript基本原理" class="headerlink" title="Javascript基本原理"></a>Javascript基本原理</h3><ul>
<li>根据鼠标位置改变鼠标样式</li>
<li>当鼠标在div的边缘和四个角时显示不同的样式，通过cursor修改</li>
<li>当鼠标在div的边缘和四个角按下时记录具体坐标点位置， 并开始根据鼠标的移动修改div的尺寸</li>
<li>鼠标松开时结束尺寸修改</li>
</ul>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220428110915610.png" alt="image-20220428110915610"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">body</span>, <span class="selector-tag">html</span> &#123;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"> </span></span><br><span class="line"><span class="language-css">  <span class="selector-id">#container</span> &#123;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">width</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">height</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">border</span>: <span class="number">#00cdcd</span> <span class="number">2px</span> solid;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"> </span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.item</span> &#123;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">cursor</span>: default;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">   <span class="attribute">background</span>: <span class="number">#757575</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"> </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">id</span>=<span class="string">&quot;body&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"> <span class="comment">//需要调整尺寸的div</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">let</span> c = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;container&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// body监听移动事件</span></span></span><br><span class="line"><span class="language-javascript"> <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;body&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;mousemove&#x27;</span>, move)</span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标按下事件</span></span></span><br><span class="line"><span class="language-javascript"> c.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mousedown&#x27;</span>, down)</span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标松开事件</span></span></span><br><span class="line"><span class="language-javascript"> <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;body&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseup&#x27;</span>, up)</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 是否开启尺寸修改</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">let</span> resizeable = <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标按下时的坐标，并在修改尺寸时保存上一个鼠标的位置</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">let</span> clientX, clientY</span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// div可修改的最小宽高</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">let</span> minW = <span class="number">8</span>, minH = <span class="number">8</span></span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标按下时的位置，使用n、s、w、e表示</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">let</span> direc = <span class="string">&#x27;&#x27;</span></span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标松开时结束尺寸修改</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">function</span> <span class="title function_">up</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  resizeable = <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript"> &#125;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标按下时开启尺寸修改</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">function</span> <span class="title function_">down</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> d = <span class="title function_">getDirection</span>(e)</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 当位置为四个边和四个角时才开启尺寸修改</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span> (d !== <span class="string">&#x27;&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">   resizeable = <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">   direc = d</span></span><br><span class="line"><span class="language-javascript">   clientX = e.<span class="property">clientX</span></span></span><br><span class="line"><span class="language-javascript">   clientY = e.<span class="property">clientY</span></span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"> &#125;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 鼠标移动事件</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">function</span> <span class="title function_">move</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> d = <span class="title function_">getDirection</span>(e)</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> cursor</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span> (d === <span class="string">&#x27;&#x27;</span>) cursor = <span class="string">&#x27;default&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">else</span> cursor = d + <span class="string">&#x27;-resize&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 修改鼠标显示效果</span></span></span><br><span class="line"><span class="language-javascript">  c.<span class="property">style</span>.<span class="property">cursor</span> = cursor;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 当开启尺寸修改时，鼠标移动会修改div尺寸</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span> (resizeable) &#123;</span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// 鼠标按下的位置在右边，修改宽度</span></span></span><br><span class="line"><span class="language-javascript">   <span class="keyword">if</span> (direc.<span class="title function_">indexOf</span>(<span class="string">&#x27;e&#x27;</span>) !== -<span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    c.<span class="property">style</span>.<span class="property">width</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minW, c.<span class="property">offsetWidth</span> + (e.<span class="property">clientX</span> - clientX)) + <span class="string">&#x27;px&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    clientX = e.<span class="property">clientX</span></span></span><br><span class="line"><span class="language-javascript">   &#125;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// 鼠标按下的位置在上部，修改高度</span></span></span><br><span class="line"><span class="language-javascript">   <span class="keyword">if</span> (direc.<span class="title function_">indexOf</span>(<span class="string">&#x27;n&#x27;</span>) !== -<span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    c.<span class="property">style</span>.<span class="property">height</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minH, c.<span class="property">offsetHeight</span> + (clientY - e.<span class="property">clientY</span>)) + <span class="string">&#x27;px&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    clientY = e.<span class="property">clientY</span></span></span><br><span class="line"><span class="language-javascript">   &#125;</span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// 鼠标按下的位置在底部，修改高度</span></span></span><br><span class="line"><span class="language-javascript">   <span class="keyword">if</span> (direc.<span class="title function_">indexOf</span>(<span class="string">&#x27;s&#x27;</span>) !== -<span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    c.<span class="property">style</span>.<span class="property">height</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minH, c.<span class="property">offsetHeight</span> + (e.<span class="property">clientY</span> - clientY)) + <span class="string">&#x27;px&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    clientY = e.<span class="property">clientY</span></span></span><br><span class="line"><span class="language-javascript">   &#125;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">   <span class="comment">// 鼠标按下的位置在左边，修改宽度</span></span></span><br><span class="line"><span class="language-javascript">   <span class="keyword">if</span> (direc.<span class="title function_">indexOf</span>(<span class="string">&#x27;w&#x27;</span>) !== -<span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    c.<span class="property">style</span>.<span class="property">width</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minW, c.<span class="property">offsetWidth</span> + (clientX - e.<span class="property">clientX</span>)) + <span class="string">&#x27;px&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    clientX = e.<span class="property">clientX</span></span></span><br><span class="line"><span class="language-javascript">   &#125;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"> &#125;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript"> <span class="comment">// 获取鼠标所在div的位置</span></span></span><br><span class="line"><span class="language-javascript"> <span class="keyword">function</span> <span class="title function_">getDirection</span>(<span class="params">ev</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> xP, yP, offset, dir;</span></span><br><span class="line"><span class="language-javascript">  dir = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">  xP = ev.<span class="property">offsetX</span>;</span></span><br><span class="line"><span class="language-javascript">  yP = ev.<span class="property">offsetY</span>;</span></span><br><span class="line"><span class="language-javascript">  offset = <span class="number">10</span>;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span> (yP &lt; offset) dir += <span class="string">&#x27;n&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">else</span> <span class="keyword">if</span> (yP &gt; c.<span class="property">offsetHeight</span> - offset) dir += <span class="string">&#x27;s&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">if</span> (xP &lt; offset) dir += <span class="string">&#x27;w&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">else</span> <span class="keyword">if</span> (xP &gt; c.<span class="property">offsetWidth</span> - offset) dir += <span class="string">&#x27;e&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">return</span> dir;</span></span><br><span class="line"><span class="language-javascript"> &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Vue实现"><a href="#Vue实现" class="headerlink" title="Vue实现"></a>Vue实现</h3><p>这个是自己的思路，很明显有问题，请看下一节</p>
<p>会有卡顿，在<code>vue</code>中还是用原生<code>js</code>实现：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012699754/article/details/103643421"> vue @mousemove实现拖动，鼠标移动过快拖动卡顿_木荣小逗比的博客-CSDN博客_@mousemove</a></p>
<p>卡顿的原因，在于事件绑定的元素有没有对上，上述的<code>move</code>事件，在<code>vue</code>中的实现，如果能拿到<code>container</code>的<code>$event</code>就不会出现卡顿了</p>
<p>如下代码，向右拉时，会卡顿，向左拉，由于事件冒泡到了子元素，所以向左拉是正常的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">		&lt;style&gt;</span><br><span class="line">			div#body &#123;</span><br><span class="line">				width: 100vw;</span><br><span class="line">				height: 100vh;</span><br><span class="line">				margin: 0;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			#container &#123;</span><br><span class="line">				width: 200px;</span><br><span class="line">				height: 200px;</span><br><span class="line">				padding: 15px;</span><br><span class="line">				border: #00cdcd 2px solid;</span><br><span class="line">				box-sizing: border-box;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			.item &#123;</span><br><span class="line">				cursor: default;</span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 100%;</span><br><span class="line">				background: #757575;</span><br><span class="line">			&#125;</span><br><span class="line">			body &#123;</span><br><span class="line">				margin: 0;</span><br><span class="line">				/* padding: 100px; */</span><br><span class="line">			&#125;</span><br><span class="line">		&lt;/style&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div id=&quot;app&quot;&gt;</span><br><span class="line">			&lt;div id=&quot;body&quot; @mouseup=&quot;up()&quot;   @mousemove.capture=&quot;move($event)&quot; &gt;</span><br><span class="line">				&lt;div id=&quot;container&quot; @mousedown.self=&quot;down($event)&quot;&gt;</span><br><span class="line">					&lt;div class=&quot;item&quot;&gt;&lt;/div&gt;</span><br><span class="line">				&lt;/div&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">		&lt;script src=&quot;./js/vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">		&lt;script&gt;</span><br><span class="line">			const app = new Vue(&#123;</span><br><span class="line">				el: &quot;#app&quot;,</span><br><span class="line">				data() &#123;</span><br><span class="line">					return &#123;</span><br><span class="line">						resizeable: false,</span><br><span class="line">						clientX: 0, // 鼠标像素点到浏览器边缘的距离</span><br><span class="line">						clientY: 0,</span><br><span class="line">						minW: 8,</span><br><span class="line">						minH: 8,</span><br><span class="line">						direc: &#x27;&#x27;,</span><br><span class="line">						body: null,</span><br><span class="line">						container: null,</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;,</span><br><span class="line">				created() &#123;</span><br><span class="line">					this.$nextTick(() =&gt; &#123;</span><br><span class="line">						</span><br><span class="line">					&#125;)</span><br><span class="line">				&#125;,</span><br><span class="line">				methods: &#123;</span><br><span class="line">					getDirection(ev) &#123;</span><br><span class="line">						let xP, yP, offset, dir;</span><br><span class="line">						dir = &#x27;&#x27;;</span><br><span class="line"></span><br><span class="line">						xP = ev.offsetX;</span><br><span class="line">						yP = ev.offsetY;</span><br><span class="line">						offset = 10;</span><br><span class="line"></span><br><span class="line">						if (yP &lt; offset) dir += &#x27;n&#x27;;</span><br><span class="line">						else if (yP &gt; ev.target.offsetHeight - offset) dir += &#x27;s&#x27;;</span><br><span class="line">						if (xP &lt; offset) dir += &#x27;w&#x27;;</span><br><span class="line">						else if (xP &gt; ev.target.offsetWidth - offset) dir += &#x27;e&#x27;;</span><br><span class="line">						// console.log(&#x27;方向为：&#x27;,dir)</span><br><span class="line">						return dir;</span><br><span class="line">					&#125;,</span><br><span class="line">					down($event) &#123;</span><br><span class="line">						let d = this.getDirection($event)</span><br><span class="line">						</span><br><span class="line">						// console.log($event.offsetX, $event.offsetY)</span><br><span class="line">						// console.log($event.target.offsetWidth, $event.target.offsetHeight)</span><br><span class="line">						// console.log($event.clientX, $event.clientY)</span><br><span class="line">						// 当位置为四个边和四个角时才开启尺寸修改</span><br><span class="line">						if (d !== &#x27;&#x27;) &#123;</span><br><span class="line">							this.resizeable = true</span><br><span class="line">							this.direc = d</span><br><span class="line">							this.clientX = $event.clientX</span><br><span class="line">							this.clientY = $event.clientY</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;,</span><br><span class="line">					up() &#123;</span><br><span class="line">						this.resizeable = false</span><br><span class="line">					&#125;,</span><br><span class="line">					move($event) &#123;</span><br><span class="line">						let d = this.getDirection($event)</span><br><span class="line">						console.log(d)</span><br><span class="line">						let cursor</span><br><span class="line">						if (d === &#x27;&#x27;) cursor = &#x27;default&#x27;;</span><br><span class="line">						else cursor = d + &#x27;-resize&#x27;;</span><br><span class="line">						// 修改鼠标显示效果</span><br><span class="line">						$event.target.style.cursor = cursor;</span><br><span class="line">						// 当开启尺寸修改时，鼠标移动会修改div尺寸</span><br><span class="line">						if (this.resizeable) &#123;</span><br><span class="line">							// 鼠标按下的位置在右边，修改宽度</span><br><span class="line">							if (this.direc.indexOf(&#x27;e&#x27;) !== -1) &#123;</span><br><span class="line">								$event.target.style.width = Math.max(this.minW, $event.target.offsetWidth + ($event.clientX - this.clientX)) + &#x27;px&#x27;</span><br><span class="line">								this.clientX = $event.clientX</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							// 鼠标按下的位置在上部，修改高度</span><br><span class="line">							if (this.direc.indexOf(&#x27;n&#x27;) !== -1) &#123;</span><br><span class="line">								$event.target.style.height = Math.max(this.minH, $event.target.offsetHeight + (this.clientY - $event.clientY)) + &#x27;px&#x27;</span><br><span class="line">								this.clientY = $event.clientY</span><br><span class="line">							&#125;</span><br><span class="line">							// 鼠标按下的位置在底部，修改高度</span><br><span class="line">							if (this.direc.indexOf(&#x27;s&#x27;) !== -1) &#123;</span><br><span class="line">								$event.target.style.height = Math.max(this.minH, $event.target.offsetHeight + ($event.clientY - this.clientY)) + &#x27;px&#x27;</span><br><span class="line">								this.clientY = $event.clientY</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							// 鼠标按下的位置在左边，修改宽度</span><br><span class="line">							if (this.direc.indexOf(&#x27;w&#x27;) !== -1) &#123;</span><br><span class="line">								$event.target.style.width = Math.max(this.minW, $event.target.offsetWidth + (this.clientX - $event.clientX)) + &#x27;px&#x27;</span><br><span class="line">								this.clientX = $event.clientX</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;)</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>向右拉会修改外层元素的width：</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/image-20220428170318441.png" alt="image-20220428170318441"></p>
<p><code>move</code>方法需要绑定在外层元素，因为要监听整个<code>move</code>过程，但<code>event</code>对象希望拿到子元素的</p>
<p>如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getEvent</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">    <span class="comment">// e.target 是你当前点击的元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget 是你绑定事件的元素</span></span><br><span class="line">	<span class="comment">// 请打开控制台核实，看哪个属性有值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得点击元素的前一个元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget.previousElementSibling.innerHTML</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得点击元素的第一个子元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget.firstElementChild</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得点击元素的下一个元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget.nextElementSibling</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得点击元素中id为string的元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget.getElementById(&quot;string&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得点击元素的string属性</span></span><br><span class="line">    <span class="comment">// e.currentTarget.getAttributeNode(&#x27;string&#x27;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得点击元素的父级元素</span></span><br><span class="line">    <span class="comment">// e.currentTarget.parentElement</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得点击元素的前一个元素的第一个子元素的HTML值</span></span><br><span class="line">    <span class="comment">// e.currentTarget.previousElementSibling.firstElementChild.innerHTML</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种方法行不通，根本还是在于事件冒泡的机制</p>
<h3 id="三区域拖动"><a href="#三区域拖动" class="headerlink" title="三区域拖动"></a>三区域拖动</h3><p>需求效果：</p>
<p><img src="/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88.assets/1080085-20190612141645469-371607470.gif" alt="img"></p>
<p>原理：拖动效果的实现基本都是dom操作来实现的，通过拖动分隔线，计算分隔线与浏览器边框的距离(left)，来实现拖动之后的不同宽度的计算；当拖动分隔线1时，计算元素框left和mid；当拖动分隔线2时，计算元素框mid和right；同时设置元素框最小值以防止元素框拖没了（其实是被遮住了）。使用SetCapture() 和 ReleaseCapture()的函数功能指定窗口里设置鼠标捕获。</p>
<p>在vuejs中使用，methods设置方法，mounted钩子挂载：</p>
<p>html部分代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;left&quot;</span>&gt;</span>西瓜<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;resize&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;resize&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;mid&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;mid&quot;</span>&gt;</span>备注2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;resize2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;resize2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;right&quot;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;left&quot;</span>&gt;</span>芒果<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;resize&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;resize&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;mid&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;mid&quot;</span>&gt;</span>备注<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;resize2&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;resize2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;right&quot;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>js部分代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  mounted () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">dragControllerDiv</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="attr">dragControllerDiv</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> resize = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;resize&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> resize2 = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;resize2&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> left = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;left&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> right = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;right&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> mid = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;mid&#x27;</span>);</span><br><span class="line">      <span class="keyword">var</span> box = <span class="variable language_">document</span>.<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;box&#x27;</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; resize.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        resize[i].<span class="property">onmousedown</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> startX = e.<span class="property">clientX</span>;</span><br><span class="line">          resize[i].<span class="property">left</span> = resize[i].<span class="property">offsetLeft</span>;</span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">onmousemove</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> endX = e.<span class="property">clientX</span>;</span><br><span class="line">            <span class="keyword">var</span> rightW = right[i].<span class="property">offsetWidth</span>;</span><br><span class="line">            <span class="keyword">var</span> moveLen = resize[i].<span class="property">left</span> + (endX - startX);</span><br><span class="line">            <span class="keyword">var</span> maxT = box[i].<span class="property">clientWidth</span> - resize[i].<span class="property">offsetWidth</span>;</span><br><span class="line">            <span class="keyword">if</span> (moveLen &lt; <span class="number">150</span>) moveLen = <span class="number">150</span>; </span><br><span class="line">            <span class="keyword">if</span> (moveLen &gt; maxT - rightW - <span class="number">150</span>) moveLen = maxT - rightW - <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line">            resize[i].<span class="property">style</span>.<span class="property">left</span> = moveLen;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; left.<span class="property">length</span>; j++) &#123;</span><br><span class="line">              left[j].<span class="property">style</span>.<span class="property">width</span> = moveLen + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">              mid[j].<span class="property">style</span>.<span class="property">width</span> = (box[i].<span class="property">clientWidth</span> - moveLen - rightW - <span class="number">10</span>) + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">onmouseup</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">onmousemove</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">onmouseup</span> = <span class="literal">null</span>; </span><br><span class="line">            resize[i].<span class="property">releaseCapture</span> &amp;&amp; resize[i].<span class="title function_">releaseCapture</span>();</span><br><span class="line">          &#125;</span><br><span class="line">          resize[i].<span class="property">setCapture</span> &amp;&amp; resize[i].<span class="title function_">setCapture</span>();</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; resize2.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        resize2[i].<span class="property">onmousedown</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">          <span class="keyword">var</span> startX = e.<span class="property">clientX</span>;</span><br><span class="line">          resize2[i].<span class="property">left</span> = resize2[i].<span class="property">offsetLeft</span>;</span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">onmousemove</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> endX = e.<span class="property">clientX</span>;</span><br><span class="line">            <span class="keyword">var</span> leftW = left[i].<span class="property">offsetWidth</span>;</span><br><span class="line">            <span class="keyword">var</span> moveLen = resize2[i].<span class="property">left</span> + (endX - startX) - leftW;</span><br><span class="line">            <span class="keyword">var</span> maxT = box[i].<span class="property">clientWidth</span> - resize2[i].<span class="property">offsetWidth</span> - <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">if</span> (moveLen &lt; <span class="number">150</span>) moveLen = <span class="number">150</span>; </span><br><span class="line">            <span class="keyword">if</span> (moveLen &gt; maxT - leftW - <span class="number">150</span>) moveLen = maxT - leftW - <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line">            resize2[i].<span class="property">style</span>.<span class="property">left</span> = moveLen;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; right.<span class="property">length</span>; j++) &#123;</span><br><span class="line">              mid[j].<span class="property">style</span>.<span class="property">width</span> = moveLen + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">              right[j].<span class="property">style</span>.<span class="property">width</span> = (box[i].<span class="property">clientWidth</span> - moveLen - leftW - <span class="number">10</span>) + <span class="string">&#x27;px&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">onmouseup</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">onmousemove</span> = <span class="literal">null</span>;</span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">onmouseup</span> = <span class="literal">null</span>; </span><br><span class="line">            resize2[i].<span class="property">releaseCapture</span> &amp;&amp; resize2[i].<span class="title function_">releaseCapture</span>();</span><br><span class="line">          &#125;</span><br><span class="line">          resize2[i].<span class="property">setCapture</span> &amp;&amp; resize2[i].<span class="title function_">setCapture</span>();</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>style部分：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;style scoped&gt;</span><br><span class="line"><span class="selector-tag">ul</span>,<span class="selector-tag">li</span>&#123;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">margin</span>:<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">padding</span>:<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.box</span>&#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">800px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">32px</span>;</span><br><span class="line">  <span class="attribute">overflow</span>:hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.left</span>&#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="built_in">calc</span>(<span class="number">30%</span> - <span class="number">10px</span>);</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100%</span>;  </span><br><span class="line">  <span class="attribute">background</span>:skyblue;</span><br><span class="line">  <span class="attribute">float</span><span class="selector-pseudo">:left</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.resize</span>&#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">cursor</span>: w-resize;</span><br><span class="line">  <span class="attribute">float</span><span class="selector-pseudo">:left</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.resize2</span>&#123;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">5px</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">cursor</span>: w-resize;</span><br><span class="line">  <span class="attribute">float</span><span class="selector-pseudo">:left</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.right</span>&#123;</span><br><span class="line">  <span class="attribute">float</span><span class="selector-pseudo">:left</span>;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">35%</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100%</span>;  </span><br><span class="line">  <span class="attribute">background</span>:tomato;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mid</span>&#123;</span><br><span class="line">  <span class="attribute">float</span><span class="selector-pseudo">:left</span>;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">35%</span>;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100%</span>;  </span><br><span class="line">  <span class="attribute">background</span>:<span class="number">#f00</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>



<p>相关链接：</p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000023324536">vue项目拖动实现修改左右宽度 - SegmentFault 思否</a></p>
<h3 id="双区域拖动"><a href="#双区域拖动" class="headerlink" title="双区域拖动"></a>双区域拖动</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">	&lt;head&gt;</span><br><span class="line">		&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">		&lt;title&gt;&lt;/title&gt;</span><br><span class="line">		&lt;style scoped&gt;</span><br><span class="line">			ul,</span><br><span class="line">			li &#123;</span><br><span class="line">				list-style: none;</span><br><span class="line">				display: block;</span><br><span class="line">				margin: 0;</span><br><span class="line">				padding: 0;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			.box &#123;</span><br><span class="line">				width: 100%;</span><br><span class="line">				height: 32px;</span><br><span class="line">				overflow: hidden;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			.left &#123;</span><br><span class="line">				width: calc(30% - 5px);</span><br><span class="line">				height: 100%;</span><br><span class="line">				background: skyblue;</span><br><span class="line">				float: left;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			.resize &#123;</span><br><span class="line">				width: 5px;</span><br><span class="line">				height: 100%;</span><br><span class="line">				cursor: w-resize;</span><br><span class="line">				float: left;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			.right &#123;</span><br><span class="line">				float: left;</span><br><span class="line">				width: 1%;</span><br><span class="line">				height: 100%;</span><br><span class="line">				background: tomato;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			.mid &#123;</span><br><span class="line">				float: left;</span><br><span class="line">				width: 70%;</span><br><span class="line">				height: 100%;</span><br><span class="line">				background: #f00;</span><br><span class="line">			&#125;</span><br><span class="line">		&lt;/style&gt;</span><br><span class="line">	&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;</span><br><span class="line">		&lt;div id=&quot;app&quot;&gt;</span><br><span class="line"></span><br><span class="line">			&lt;ul class=&quot;box&quot; ref=&quot;box&quot;&gt;</span><br><span class="line">				&lt;li class=&quot;left&quot; ref=&quot;left&quot;&gt;西瓜&lt;/li&gt;</span><br><span class="line">				&lt;li class=&quot;resize&quot; ref=&quot;resize&quot;&gt;&lt;/li&gt;</span><br><span class="line">				&lt;li class=&quot;mid&quot; ref=&quot;mid&quot;&gt;备注2&lt;/li&gt;</span><br><span class="line"></span><br><span class="line">			&lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">		&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">		&lt;script src=&quot;./js/vue.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">		&lt;script&gt;</span><br><span class="line">			new Vue(&#123;</span><br><span class="line">				el: &quot;#app&quot;,</span><br><span class="line">				mounted() &#123;</span><br><span class="line">					this.dragControllerDiv();</span><br><span class="line">				&#125;,</span><br><span class="line">				methods: &#123;</span><br><span class="line">					dragControllerDiv: function() &#123;</span><br><span class="line">						var resize = document.getElementsByClassName(&#x27;resize&#x27;);</span><br><span class="line">						var left = document.getElementsByClassName(&#x27;left&#x27;);</span><br><span class="line">						var mid = document.getElementsByClassName(&#x27;mid&#x27;);</span><br><span class="line">						var box = document.getElementsByClassName(&#x27;box&#x27;);</span><br><span class="line">						for (let i = 0; i &lt; resize.length; i++) &#123;</span><br><span class="line">							resize[i].onmousedown = function(e) &#123;</span><br><span class="line">								var startX = e.clientX; // 获取分隔线，距离浏览器左边的距离</span><br><span class="line">								resize[i].left = resize[i].offsetLeft; // </span><br><span class="line">								console.log(resize[i].offsetLeft)</span><br><span class="line">								document.onmousemove = function(e) &#123;</span><br><span class="line">									var endX = e.clientX;</span><br><span class="line">									var moveLen = resize[i].left + (endX - startX);</span><br><span class="line">									var maxT = box[i].clientWidth - resize[i].offsetWidth - 500;</span><br><span class="line">									if (moveLen &lt; 150) moveLen = 150;</span><br><span class="line">									if (moveLen &gt; maxT - 150) moveLen = maxT  - 150;</span><br><span class="line"></span><br><span class="line">									resize[i].style.left = moveLen;</span><br><span class="line"></span><br><span class="line">									for (let j = 0; j &lt; left.length; j++) &#123;</span><br><span class="line">										left[j].style.width = moveLen + &#x27;px&#x27;;</span><br><span class="line">										mid[j].style.width = (box[i].clientWidth - moveLen -  10) + &#x27;px&#x27;;</span><br><span class="line">									&#125;</span><br><span class="line">								&#125;</span><br><span class="line">								document.onmouseup = function(evt) &#123;</span><br><span class="line">									document.onmousemove = null;</span><br><span class="line">									document.onmouseup = null;</span><br><span class="line">									resize[i].releaseCapture &amp;&amp; resize[i].releaseCapture();</span><br><span class="line">								&#125;</span><br><span class="line">								resize[i].setCapture &amp;&amp; resize[i].setCapture();</span><br><span class="line">								return false;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;)</span><br><span class="line">		&lt;/script&gt;</span><br><span class="line">	&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="历史记录方案"><a href="#历史记录方案" class="headerlink" title="历史记录方案"></a>历史记录方案</h1><p>之前写过一遍了，同步的时候没注意丢掉了</p>
<h2 id="导航历史记录"><a href="#导航历史记录" class="headerlink" title="导航历史记录"></a>导航历史记录</h2><p>将<code>localStorage</code>的读取，结合<code>vuex</code>，利用数据代理封装成响应式</p>
<p>使用<code>v-if/v-else</code>来设计好<code>历史记录</code>和<code>搜集结果</code>之间的结构，并处理好状态变更的交互</p>
<p>添加存储历史记录的逻辑，并控制好存储数量、去重操作、新浏览的记录更新至第一位，最后提交将序列化好的数据格式提交<code>mutations</code></p>
<ul>
<li><p>存储</p>
<ul>
<li>搜索记录的结果，点击时需要存储</li>
<li>普通浏览时，点击时需要存储</li>
</ul>
</li>
<li><p>新浏览的记录更新至第一位</p>
<ul>
<li><p>当<code>localStorage</code>的值的数据结构数组内套对象时为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">	&#123;&#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>判断相等的逻辑，不能直接取数组数据中的对象和原对象比较（很明显这两个不是一个对象），需要取两个对象内部的标识，如<code>id</code>，且不能使用全等<code>===</code>，使用<code>==</code>即可</p>
</li>
</ul>
</li>
<li><p>去重操作</p>
<p>由于数据结构的问题，操作的是对象，正常页面和搜索结果页面，如果点击的是同一个，底层上时不同的对象，仍需要根据<code>id</code>来处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> arr = [</span><br><span class="line">    &#123;<span class="attr">id</span>:<span class="number">1</span>,<span class="attr">name</span>:<span class="string">&#x27;sai&#x27;</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">&#x27;hikaru&#x27;</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>:<span class="number">3</span>,<span class="attr">name</span>:<span class="string">&#x27;akira&#x27;</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> id = <span class="number">4</span> <span class="comment">// 入参</span></span><br><span class="line"><span class="keyword">let</span> filterNum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> value <span class="keyword">of</span> arr) &#123;</span><br><span class="line">    <span class="keyword">if</span>(id !== value.<span class="property">id</span>) &#123;</span><br><span class="line">        filterNum++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 也可以用forEach</span></span><br><span class="line"><span class="comment">// arr.forEach(item =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     if(item.id !== id) &#123;</span></span><br><span class="line"><span class="comment">//         filterNum++</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(filterNum == arr.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;执行保存操作&#x27;</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;已经有值了，啥也不做&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>异常结果的考虑</p>
<p>未搜到结果的提示，不应该被记录下来</p>
<p>添加删除历史记录<code>UI</code>界面及逻辑</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/08/07/web/%E4%B8%93%E6%A0%8F/%E7%A7%AF%E7%B4%AF/%E5%89%8D%E7%AB%AF%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" data-id="cldol83g7004l3cx6e25q6p15" data-title="前端常见场景解决方案" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-web/进阶/Node.js/Koa/koa_EN" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/" class="article-date">
  <time class="dt-published" datetime="2022-07-31T15:52:13.000Z" itemprop="datePublished">2022-07-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Koa/">Koa</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/">Koa2 build API service</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Getting-started-with-koa2"><a href="#Getting-started-with-koa2" class="headerlink" title="Getting started with koa2"></a>Getting started with koa2</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18h411H7GE?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV18h411H7GE?spm_id_from=333.999.0.0</a></p>
<h1 id="Node-koa2-build-API-service"><a href="#Node-koa2-build-API-service" class="headerlink" title="Node+koa2 build API service"></a>Node+koa2 build API service</h1><p>Tutorial source：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV13A411w79h?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV13A411w79h?spm_id_from=333.999.0.0</a></p>
<h2 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h2><ul>
<li><code>npm init -y</code></li>
<li><code>git init</code>，create a new <code>.gitignore</code> file，and add <code>node_modules</code><ul>
<li>After submitting the version, view the records through <code>git log</code></li>
</ul>
</li>
<li>Create a new <code>readme.md</code> document</li>
</ul>
<h2 id="Project-initialization"><a href="#Project-initialization" class="headerlink" title="Project initialization"></a>Project initialization</h2><ul>
<li><p><code>npm i koa</code></p>
</li>
<li><p>Create new<code>src/main.js</code> file in  rootdirectory</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// import koa, the exported class is generally capitalized</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// instantiation</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123; <span class="comment">// middleware</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span> <span class="comment">// test code</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// run server</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server is running on http://localhost:3000 !&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Start development service：</p>
<ul>
<li><code>node .\src\main.js</code>: <code>Node </code> mode start, is resident memory, not hot loaded</li>
</ul>
</li>
</ul>
<h2 id="Development-optimization"><a href="#Development-optimization" class="headerlink" title="Development optimization"></a>Development optimization</h2><h3 id="Automatic-restart-service"><a href="#Automatic-restart-service" class="headerlink" title="Automatic restart service"></a>Automatic restart service</h3><ul>
<li><p><code>npm i nodemon</code></p>
</li>
<li><p>Configure <code>dev</code> script: if <code>nodemon</code> is installed globally, then <code>npx</code> is not required</p>
<p><code>package.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx nodemon ./src/main.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;koa&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.13.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodemon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.19&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>npm run dev</code> run server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PS D:\workspace\github\code\project-workshop\code-prac\koa\01&gt; npm run dev</span><br><span class="line"></span><br><span class="line">&gt; 01@1.0.0 dev</span><br><span class="line">&gt; npx nodemon ./src/main.js</span><br><span class="line"></span><br><span class="line">[nodemon] 2.0.19</span><br><span class="line">[nodemon] to restart at any time, enter `rs`</span><br><span class="line">[nodemon] watching path(s): *.*</span><br><span class="line">[nodemon] watching extensions: js,mjs,json // Listen to these three files</span><br><span class="line">[nodemon] starting `node ./src/main.js` // Start with node</span><br><span class="line">server is running on http://localhost:3000 ! // Print out content</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Read-configuration-file"><a href="#Read-configuration-file" class="headerlink" title="Read configuration file"></a>Read configuration file</h3><ul>
<li><p>Install <code>dotenv</code> (you can check the introduction on the <code>NPM</code> official website)：load the configuration file of <code>.Env</code> in the root directory, and load the key value pair into the environment variable of <code>process.env </code></p>
<ul>
<li><p><code>npm i dotenv</code></p>
</li>
<li><p>项目根目录，新建<code>.env</code>配置文件并添加配置</p>
<p><code>.env</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APP_PORT = 8000</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>读取配置</p>
<ul>
<li><p>新建<code>src/config/config.default.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).<span class="title function_">config</span>() <span class="comment">// 导入dotenv，调用config方法，读取配置并写入到`process.env`中</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">export</span> = process.<span class="property">env</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>改写<code>main.js</code>，使用解构赋值的方式，获取到<code>APP_PORT</code>的配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>) <span class="comment">// 导入process.env环境变量中的APP_PORT字段</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>); <span class="comment">// 使用模板字符串</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动开发服务</p>
</li>
</ul>
</li>
</ul>
<h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><p>所谓的<code>api</code>，就是根据不同<code>url</code>返回不同的数据</p>
<p>目前<code>http://localhost:8000</code>和<code>http://localhost:8000/users</code>返回的内容都是一样的</p>
<p>需要使用路由，来根据不同的<code>url</code>，调用不同的处理函数</p>
<p>安装<code>koa-router</code></p>
<ul>
<li>&#96;&#96;api官网：&#96;<a target="_blank" rel="noopener" href="https://github.com/koajs/router/blob/master/API.md">router&#x2F;API.md at master · koajs&#x2F;router (github.com)</a></li>
<li><code>npm install @koa/router</code></li>
</ul>
<p>官网案例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>); <span class="comment">// 1.导入Router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(); <span class="comment">// 2.新建router实例对象</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123; <span class="comment">// 3.编写路由</span></span><br><span class="line">  <span class="comment">// ctx.router available</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app <span class="comment">// 4.注册中间件</span></span><br><span class="line">  .<span class="title function_">use</span>(router.<span class="title function_">routes</span>()) <span class="comment">// use方法只能接受函数作为参数，通过router.routes()方法返回一个函数给中间件处理</span></span><br><span class="line">  .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br></pre></td></tr></table></figure>

<p>配置多个路由</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>) <span class="comment">// 导入router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// app.use((ctx, next) =&gt; &#123; // 中间件</span></span><br><span class="line"><span class="comment">//     ctx.body = &#x27;hello world&#x27; // 测试代码</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">userRouter.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>但是代码都写在一起肯定不行，需要拆分一下路由</p>
<p>新建<code>src/router</code>文件夹</p>
<p>新建<code>user.routes.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>main.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>) <span class="comment">// 导入router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./router/user.route&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>()) <span class="comment">// 后续这里也会继续优化，不然当路由很多时，写法也会很恶心</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="目录结构优化"><a href="#目录结构优化" class="headerlink" title="目录结构优化"></a>目录结构优化</h2><h3 id="拆分http服务和业务代码"><a href="#拆分http服务和业务代码" class="headerlink" title="拆分http服务和业务代码"></a>拆分<code>http</code>服务和业务代码</h3><p>我们在<code>main.js</code>里面写了太多的功能</p>
<ul>
<li><p>拆分<code>http</code>服务与业务相关代码</p>
<ul>
<li>新建<code>src/app/index.js</code>，专门放业务代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>) <span class="comment">// 导入router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>man.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&#x27;./app&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="抽离控制层"><a href="#抽离控制层" class="headerlink" title="抽离控制层"></a>抽离控制层</h3><p>将路由<code>router</code>中的处理函数，单独抽离成控制层<code>controller</code></p>
<ul>
<li><p>新建<code>src/controller</code>文件夹</p>
</li>
<li><p>新建<code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户注册成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>修改<code>router/user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router =  <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123;register&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, register)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试接口</p>
<p>这里我们写成了<code>post</code>请求，使用<code>postman</code>或者是<code>Apifox</code>（国内的）来测试<code>post</code>请求</p>
<p>这里以<code>apifox</code>为例，下载后，新建项目 &gt; 新建接口</p>
<p>按图示配置</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725220620161.png" alt="image-20220725220620161"></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725220748784.png" alt="image-20220725220748784"></p>
<p>配置好路由后，点击运行，可以拿到数据了：</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725220846437.png" alt="image-20220725220846437"></p>
</li>
<li><p>我们再写一个登录的接口</p>
<p><code>user.router.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router =  <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123;register, login&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户注册成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="解析body、拆分service层"><a href="#解析body、拆分service层" class="headerlink" title="解析body、拆分service层"></a>解析<code>body</code>、拆分<code>service</code>层</h2><h3 id="解析body"><a href="#解析body" class="headerlink" title="解析body"></a>解析<code>body</code></h3><blockquote>
<p>完整的注册接口</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /user/register</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_name, password</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;code&quot;: 0,</span><br><span class="line">	&quot;message&quot;: &quot;用户注册成功&quot;,</span><br><span class="line">	&quot;result&quot;: &#123;</span><br><span class="line">		id: 2,</span><br><span class="line">		&quot;user_name&quot;: &quot;user&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原型图：</p>
<img src="image-20220725222952833.png" alt="image-20220725222952833" style="zoom:67%;" />

<p><code>koa</code>需要借助中间件，来解析参数</p>
<ul>
<li><p><code>koa-body</code>：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/koa-body">https://www.npmjs.com/package/koa-body</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A full-featured koa body parser middleware. Supports multipart, urlencoded, and json request bodies. Provides the same functionality as Express&#x27;s bodyParser - multer.</span><br></pre></td></tr></table></figure>

<p>官方基础样例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>); <span class="comment">// 1.引入中间件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>()); <span class="comment">// 在所有请求之前，注册这个中间件，就把所有的内容写到了ctx.request.body里面</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">`Request Body: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ctx.request.body)&#125;</span>`</span>; <span class="comment">// 3.看下request.body</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>更推荐，相比较于<code>koa-bodyparser</code>，还支持文件上传</li>
</ul>
</li>
<li><p><code>koa-bodyparser</code></p>
</li>
</ul>
<p>将之前<code>apifox</code>的注册接口完善下，由于是<code>post</code>请求，我们在<code>body</code>里面，设置参数</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725225232579.png" alt="image-20220725225232579"></p>
<p> 安装<code>koa-body</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-body</span><br></pre></td></tr></table></figure>

<p>补充，将<code>nodemon</code>安装到开发时依赖，先卸载：<code>npm uninstall nodemon</code>，再重新安装到开发依赖：<code>npm i nodemon -D</code></p>
<p>在<code>app/index.js</code>中添加<code>koa-body</code>相关代码</p>
<p><code>app/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>) <span class="comment">// 1.导入koa-body</span></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>()) <span class="comment">// 2.在所有中间件之前，注册koa-body</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;   </span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`Request Body: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ctx.request.body)&#125;</span>`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>控制层（处理函数）<code>user.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        ctx.<span class="property">body</span> = ctx.<span class="property">request</span>.<span class="property">body</span> <span class="comment">// 我的理解：把请求的参数，放在响应的body里面，再返给客户端</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>回到<code>apifox</code>中，我们生成下<code>body</code>请求体，发送下注册的请求</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725230641092.png" alt="image-20220725230641092"></p>
<p>后台也打印结果了</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725230741773.png" alt="image-20220725230741773"></p>
<p>控制器里一般做这些事</p>
<ul>
<li>1.获取数据</li>
<li>2.操作数据库<ul>
<li>如果操作数据库的逻辑很复杂，也会单独抽出这一部分（<code>service</code>层）</li>
</ul>
</li>
<li>3.返回结果</li>
</ul>
<h3 id="抽取servcie层"><a href="#抽取servcie层" class="headerlink" title="抽取servcie层"></a>抽取<code>servcie</code>层</h3><p>和数据库相关的，根据客户端传递的不同参数，来操作数据库</p>
<p>新建<code>src/service</code>目录</p>
<p>新建<code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 主要用来操作数据库</span></span><br><span class="line">    <span class="comment">// 处理函数对应数据库的操作，就是增删改查</span></span><br><span class="line">    <span class="comment">// 注册，就是往数据库里，增加一条记录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123; <span class="comment">// 当参数超过三个时，建议用一个对象</span></span><br><span class="line">        <span class="comment">//@<span class="doctag">TODO:</span> 写入数据库</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;写入数据库成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>修改<code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="comment">// console.log(ctx.request.body)</span></span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="comment">// 2.操作数据库</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.返回结果</span></span><br><span class="line">        ctx.<span class="property">body</span> = ctx.<span class="property">request</span>.<span class="property">body</span> <span class="comment">// 我的理解：把请求的参数，放在响应的body里面，再返给客户端</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>后台打印结果：</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220725232505667.png" alt="image-20220725232505667"></p>
<h2 id="ORM工具集成"><a href="#ORM工具集成" class="headerlink" title="ORM工具集成"></a><code>ORM</code>工具集成</h2><h3 id="sequelize介绍"><a href="#sequelize介绍" class="headerlink" title="sequelize介绍"></a><code>sequelize</code>介绍</h3><p><code>ORM</code>：对象关系映射</p>
<ul>
<li>数据表映射（对应）一个类</li>
<li>数据表中的数据行（记录）对应一个对象</li>
<li>数据表字段对应对象的属性</li>
<li>数据表的操作，对应对象的方法</li>
<li>就是使用面向对象的方式，来操作数据库</li>
</ul>
<p>使用<code>sequelize</code> <code>ORM</code>数据库工具：<a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/tree/master">https://github.com/demopark/sequelize-docs-Zh-CN/tree/master</a></p>
<ul>
<li><p>基于<code>Promise</code>的<code>ORM</code>工具</p>
</li>
<li><p>Sequelize 是一个基于<code> promise</code> 的 <code>Node.js ORM</code> 工具, 目前支持 <code>Postgres, MySQL, MariaDB, SQLite 以及 Microsoft SQL Server, Amazon Redshift 和 Snowflake’s Data Cloud</code>. 它具有强大的事务支持, 关联关系, 预读和延迟加载,读取复制等功能.</p>
</li>
<li><p>安装<code>sequelize</code>和<code>mysql2</code>（支持<code>Promise</code>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i sequelize mysql2</span><br></pre></td></tr></table></figure>

<p>得注意下安装的<code>sequelize</code>支持的最低版本的<code>mysql</code>，目前默认安装的<code>sequlize</code>版本是<code>6.21.3</code>，对应的<code>mysql</code>版本至少是<code>5.7</code>及以上：<a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/tree/v6">https://github.com/demopark/sequelize-docs-Zh-CN/tree/v6</a></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726064512073.png" alt="image-20220726064512073"></p>
</li>
</ul>
<h3 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h3><p>在正式连接之前，我们需要装下<code>mysql</code>数据库，这里暂时安装<code>windows</code>版本，参照：<a target="_blank" rel="noopener" href="https://blog.csdn.net/jsugs/article/details/124143762">https://blog.csdn.net/jsugs/article/details/124143762</a></p>
<p>启动<code>mysql</code>服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入net start mysql或sc start mysql</span><br></pre></td></tr></table></figure>





<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726070015186.png" alt="image-20220726070015186"></p>
<p>改密码后再用<code>navicat连接</code>，会报错<code>Authentication plugin &#39;caching_sha2_password&#39; cannot be loaded</code>，参照：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/465a444ad846">https://www.jianshu.com/p/465a444ad846</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123123&#x27;</span> PASSWORD EXPIRE NEVER;   <span class="comment">#修改加密规则 </span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;123123&#x27;</span>;   <span class="comment">#更新一下用户的密码</span></span><br><span class="line">FLUSH PRIVILEGES;   <span class="comment">#刷新权限 </span></span><br></pre></td></tr></table></figure>



<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726071528438.png" alt="image-20220726071528438"></p>
<p>查询mysql进程，并杀掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -aon|findstr <span class="string">&quot;3306&quot;</span></span><br><span class="line"></span><br><span class="line">taskkill /pid 26372 -t -f</span><br></pre></td></tr></table></figure>

<p>成功进入后，新建数据库</p>
<p>一开始是没有选中下面两个的，设置名称后直接确定</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726071755569.png" alt="image-20220726071755569"></p>
<h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><p>官方示例：<a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/blob/v6/core-concepts/getting-started.md">https://github.com/demopark/sequelize-docs-Zh-CN/blob/v6/core-concepts/getting-started.md</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法 1: 传递一个连接 URI</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;sqlite::memory:&#x27;</span>) <span class="comment">// Sqlite 示例</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;postgres://user:pass@example.com:5432/dbname&#x27;</span>) <span class="comment">// Postgres 示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法 2: 分别传递参数 (sqlite)</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(&#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&#x27;sqlite&#x27;</span>,</span><br><span class="line">  <span class="attr">storage</span>: <span class="string">&#x27;path/to/database.sqlite&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法 3: 分别传递参数 (其它数据库)</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">dialect</span>: <span class="comment">/* 选择 &#x27;mysql&#x27; | &#x27;mariadb&#x27; | &#x27;postgres&#x27; | &#x27;mssql&#x27; 其一 */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>新建<code>src/db/seq.js</code></p>
<p>该文件中实现数据库的连接，并导出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">Sequelize</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;mytest&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;123123&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seq.<span class="title function_">authenticate</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接成功&#x27;</span>, res)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接失败&#x27;</span>, error)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = seq</span><br></pre></td></tr></table></figure>

<p>在<code>db</code>目录下，使用<code>node</code>测试下：</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726200218491.png" alt="image-20220726200218491"></p>
<p>开发环境我们这样搞没事，生产环境可能会用连接池</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>使用<code>dotenv</code>将参数提取成配置文件</p>
<p>修改<code>.env</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APP_PORT = 8000</span><br><span class="line"></span><br><span class="line">MYSQL_HOST = localhost</span><br><span class="line">MYSQL_PORT = 3306</span><br><span class="line">MYSQL_USER = root</span><br><span class="line">MYSQL_PASSWORD = 123123</span><br><span class="line">MYSQL_DATABASE = mytest</span><br></pre></td></tr></table></figure>

<p><code>seq.js</code>中导入并使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; </span><br><span class="line">    <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_DATABASE</span> </span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config/config.default&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">MYSQL_HOST</span>,<span class="variable constant_">MYSQL_DATABASE</span>)</span><br><span class="line"><span class="keyword">const</span> seq = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="variable constant_">MYSQL_DATABASE</span>, <span class="variable constant_">MYSQL_USER</span>, <span class="variable constant_">MYSQL_PASSWORD</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// seq.authenticate().then(res =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;数据库连接成功&#x27;, res)</span></span><br><span class="line"><span class="comment">// &#125;).catch(error =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;数据库连接失败&#x27;, error)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = seq</span><br></pre></td></tr></table></figure>

<p>此时需要在根目录下测试，不然读不到<code>.env</code>文件</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726201817869.png" alt="image-20220726201817869"></p>
<p>测试完将测试代码注释掉</p>
<h2 id="创建User模型"><a href="#创建User模型" class="headerlink" title="创建User模型"></a>创建<code>User</code>模型</h2><h3 id="模型创建"><a href="#模型创建" class="headerlink" title="模型创建"></a>模型创建</h3><p>新建<code>src/model</code>文件夹</p>
<p><code>service</code>层通过<code>model</code>层来具体操作数据库</p>
<p>新建<code>user.model.js</code>，使用<code>define</code>方法来创建模型：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-basics#%E4%BD%BF%E7%94%A8-sequelizedefine">https://www.sequelize.com.cn/core-concepts/model-basics#%E4%BD%BF%E7%94%A8-sequelizedefine</a></p>
<p>全局定义表名等于模型名，<code>seq.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; </span><br><span class="line">    <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_DATABASE</span> </span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config/config.default&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">MYSQL_HOST</span>,<span class="variable constant_">MYSQL_DATABASE</span>)</span><br><span class="line"><span class="keyword">const</span> seq = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="variable constant_">MYSQL_DATABASE</span>, <span class="variable constant_">MYSQL_USER</span>, <span class="variable constant_">MYSQL_PASSWORD</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">define</span>: &#123;</span><br><span class="line">        <span class="attr">freezeTableName</span>: <span class="literal">true</span> <span class="comment">// 全局定义表明等于模型名</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = seq</span><br></pre></td></tr></table></figure>

<p>根据表设计文档，定义模型属性：</p>
<p><strong>用户表</strong></p>
<p>表名：<code>sai_users</code></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键，自增（sequelize会自动维护）</td>
</tr>
<tr>
<td>user_name</td>
<td>varchar(255)</td>
<td>用户名，unique</td>
</tr>
<tr>
<td>password</td>
<td>char(64)</td>
<td>密码</td>
</tr>
<tr>
<td>is_admin</td>
<td>tinyint(1)</td>
<td>0：不是管理员，1：是管理员</td>
</tr>
</tbody></table>
<p>定义模型属性时的数据类型，参见：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-basics#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">https://www.sequelize.com.cn/core-concepts/model-basics#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B</a></p>
<p><code>user.model.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">DataTypes</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;sequelize&quot;</span>) <span class="comment">// 不要相信vscode的自动导入，坑！！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建模型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_user&#x27;</span>, &#123;</span><br><span class="line">    <span class="comment">// id会被sequelize自动创建</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// user_name</span></span><br><span class="line">    <span class="attr">user_name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="comment">// 不允许为空</span></span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户名唯一&#x27;</span> <span class="comment">// 注释</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// password</span></span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">CHAR</span>(<span class="number">64</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">is_admin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;是否为管理员，0：不是管理员（默认值），1：是管理员&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">sync</span>(&#123;<span class="attr">force</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>有关模型同步：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-basics#%E6%A8%A1%E5%9E%8B%E5%90%8C%E6%AD%A5">https://www.sequelize.com.cn/core-concepts/model-basics#%E6%A8%A1%E5%9E%8B%E5%90%8C%E6%AD%A5</a></p>
<p>根目录下，执行<code>node src/model/user.model.js</code></p>
<p>就是执行了<code>sql</code>语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS D:\workspace\github\code\project-workshop\code-prac\koa\01&gt; node .\src\model\user.model.js</span><br><span class="line">localhost mytest</span><br><span class="line">Executing (default): DROP TABLE IF EXISTS `sai_user`;</span><br><span class="line">Executing (default): CREATE TABLE IF NOT EXISTS `sai_user` (`<span class="built_in">id</span>` INTEGER NOT NULL auto_increment , `user_name` VARCHAR(255) NOT NULL UNIQUE COMMENT <span class="string">&#x27;用户名唯一&#x27;</span>, `password` CHAR(64) NOT NULL COMMENT <span class="string">&#x27;</span></span><br><span class="line"><span class="string">密码&#x27;</span>, `is_admin` TINYINT(1) NOT NULL DEFAULT 0 COMMENT <span class="string">&#x27;是否为管理员，0：不是管理员（默认值），1：是管理员&#x27;</span>, `createdAt` DATETIME NOT NULL, `updatedAt` DATETIME NOT NULL, PRIMARY KEY (`<span class="built_in">id</span>`)) ENGINE=InnoDB;</span><br><span class="line">Executing (default): SHOW INDEX FROM `sai_user`</span><br></pre></td></tr></table></figure>

<p>可以看到，数据库中多了一个表：</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726211457412.png" alt="image-20220726211457412"></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726211857584.png" alt="image-20220726211857584"></p>
<p>其中，<code>createAt</code>和<code>updatedAt</code>是<code>sequelize</code>自动给我们维护的，如果不需要时间戳，在<code>define</code>函数中，添加配置项：<code>&#123;timestamps: false&#125;</code>，但是一般情况下，都是保留的</p>
<p>导出<code>User</code>模型，并注释掉<code>sync</code>的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">DataTypes</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;sequelize&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建模型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_user&#x27;</span>, &#123;</span><br><span class="line">    <span class="comment">// id会被sequelize自动创建</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// user_name</span></span><br><span class="line">    <span class="attr">user_name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="comment">// 不允许为空</span></span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户名唯一&#x27;</span> <span class="comment">// 注释</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// password</span></span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">CHAR</span>(<span class="number">64</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">is_admin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;是否为管理员，0：不是管理员（默认值），1：是管理员&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// User.sync(&#123;force: true&#125;) // 强制同步数据库（创建数据表）</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">User</span></span><br></pre></td></tr></table></figure>

<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><p>我们继续完善写入数据库的代码</p>
<p>需要通过<code>ORM</code>实现标准的<code>CRUD</code>：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-querying-basics">https://www.sequelize.com.cn/core-concepts/model-querying-basics</a></p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 主要用来操作数据库</span></span><br><span class="line">    <span class="comment">// 处理函数对应数据库的操作，就是增删改查</span></span><br><span class="line">    <span class="comment">// 注册，就是往数据库里，增加一条记录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123; <span class="comment">// 当参数超过三个时，建议用一个对象</span></span><br><span class="line">        <span class="comment">//@<span class="doctag">TODO:</span> 写入数据库</span></span><br><span class="line">        <span class="comment">// 插入数据</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">            user_name,</span><br><span class="line">            password</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>使用<code>apifox</code>发送<code>register</code>接口，成功后查看数据库</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726231148358.png" alt="image-20220726231148358"></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220726231243724.png" alt="image-20220726231243724"></p>
<p>成功注册，注意下时区慢8小时</p>
<p>再看下后台打印：</p>
<p>执行的了<code>insert</code>语句</p>
<p><code>User.create</code>返回的是一个<code>sai_user</code>的表模型对象，<code>dataValues</code>对应着表里面的一条记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Executing (default): INSERT INTO `sai_user` (`<span class="built_in">id</span>`,`user_name`,`password`,`is_admin`,`createdAt`,`updatedAt`) VALUES (DEFAULT,?,?,?,?,?);</span><br><span class="line">sai_user &#123;</span><br><span class="line">  dataValues: &#123;</span><br><span class="line">    is_admin: <span class="literal">false</span>,</span><br><span class="line">    <span class="built_in">id</span>: 1,</span><br><span class="line">    user_name: <span class="string">&#x27;邵洋&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;do&#x27;</span>,</span><br><span class="line">    updatedAt: 2022-07-26T15:08:52.849Z,</span><br><span class="line">    createdAt: 2022-07-26T15:08:52.849Z</span><br><span class="line">  &#125;,</span><br><span class="line">  _previousDataValues: &#123;</span><br><span class="line">    user_name: <span class="string">&#x27;邵洋&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;do&#x27;</span>,</span><br><span class="line">    <span class="built_in">id</span>: 1,</span><br><span class="line">    is_admin: <span class="literal">false</span>,</span><br><span class="line">    createdAt: 2022-07-26T15:08:52.849Z,</span><br><span class="line">    updatedAt: 2022-07-26T15:08:52.849Z</span><br><span class="line">  &#125;,</span><br><span class="line">  uniqno: 1,</span><br><span class="line">  _changed: Set(0) &#123;&#125;,</span><br><span class="line">  _options: &#123;</span><br><span class="line">    isNewRecord: <span class="literal">true</span>,</span><br><span class="line">    _schema: null,</span><br><span class="line">    _schemaDelimiter: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    attributes: undefined,</span><br><span class="line">    include: undefined,</span><br><span class="line">    raw: undefined,</span><br><span class="line">    silent: undefined</span><br><span class="line">  &#125;,</span><br><span class="line">  isNewRecord: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要返回给用户<code>dataValues</code>的结果</p>
<p>对于其他的值，在<code>service</code>层就可以直接过滤掉，直接返回<code>res.dataValues</code></p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 主要用来操作数据库</span></span><br><span class="line">    <span class="comment">// 处理函数对应数据库的操作，就是增删改查</span></span><br><span class="line">    <span class="comment">// 注册，就是往数据库里，增加一条记录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123; <span class="comment">// 当参数超过三个时，建议用一个对象</span></span><br><span class="line">        <span class="comment">//@<span class="doctag">TODO:</span> 写入数据库</span></span><br><span class="line">        <span class="comment">// 插入数据</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123; user_name, password &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>那么<code>controller</code>层拿到返回的数据后，再根据接口文档，构建最终要返回给客户端的数据格式</p>
<p>注册接口：</p>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户注册成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>失败</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户名或密码不能为空&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>修改控制层</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="comment">// console.log(ctx.request.body)</span></span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="comment">// 2.操作数据库</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">        <span class="comment">// console.log(res)</span></span><br><span class="line">        <span class="comment">// 3.返回结果</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>再次使用<code>apifox</code>测试下<code>register</code>接口，注意要使用新的样例</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727060131292.png" alt="image-20220727060131292"></p>
<p>整个的流程小结：</p>
<p>用户发送请求，<code>koa</code>服务接受到请求，先导入各种中间件，然后处理路由，根据路由调用处理函数（控制层），处理函数中涉及业务逻辑及数据库操作（服务层），服务层根据模型层，返回给控制层操作数据库的结果，控制层根据该结果封装接口数据，返回给路由，最后<code>koa</code>将路由的结果，作为接口响应发送到服务端</p>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>重复注册和没有用户名，目前都会返回<code>500</code>，错误类型不够细致</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727061109390.png" alt="image-20220727061109390"></p>
<p>后台是可以看到两次操作的错误提示的</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727061249819.png" alt="image-20220727061249819"></p>
<p>对于不同的错误类型，我们要分别处理</p>
<p>在控制层接受到用户参数时，要进行验证</p>
<ul>
<li><p>合法性验证</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="comment">// 合法性验证</span></span><br><span class="line">        <span class="keyword">if</span>(!user_name || !password) &#123;</span><br><span class="line">            <span class="comment">// 记录错误信息，后续可以记录到错误日志中</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>)</span><br><span class="line">            ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="comment">// 自定义的，公司一般会有开发规范</span></span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="comment">// 合法性验证不通过的话，直接返回</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 验证通过后，再去操作数据库</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>参数只写一个字段，测试一下注册接口：<br><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727062331691.png" alt="image-20220727062331691"></p>
<p>可以看到后台，打印的错误日志</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727062455540.png" alt="image-20220727062455540"></p>
</li>
<li><p>合理性验证</p>
<ul>
<li><p><code>controller</code>层，需要根据传入的参数，查询数据库</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser, getUserInfo&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="keyword">if</span>(!user_name || !password) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>)</span><br><span class="line">            ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合理性验证</span></span><br><span class="line">        <span class="comment">// 需要再次查询数据库 getUserInfo</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_">getUserInfo</span>(&#123;user_name&#125;)) &#123; <span class="comment">// 根据用户名来查询，参数使用对象，这样可以让查询参数不受顺序影响</span></span><br><span class="line">            ctx.<span class="property">status</span> = <span class="number">409</span> <span class="comment">// 状态完成冲突，不熟悉的话，可以去MDN上看下常见状态码</span></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>service</code>层中新增<code>getUserInfo</code>方法</p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123; user_name, password &#125;)</span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getUserInfo</span>(<span class="params">&#123;id, user_name, password, is_admin&#125;</span>) &#123; <span class="comment">// 参数设计成一个对象，因为查询用户，有可能根据id、user_name、password、is_admin字段去查询</span></span><br><span class="line">        <span class="comment">// 判断参数是否存在，拿到实参</span></span><br><span class="line">        <span class="keyword">const</span>  whereOpt = &#123;&#125;</span><br><span class="line">        id &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;id&#125;)</span><br><span class="line">        user_name &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;user_name&#125;)</span><br><span class="line">        password &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;password&#125;)</span><br><span class="line">        is_admin &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;is_admin&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用ORM查询接口：findOne，这是一个异步函数</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;user_name&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;is_admin&#x27;</span>],</span><br><span class="line">            <span class="attr">where</span>: whereOpt</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res ? res.<span class="property">dataValues</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>测试下接口返回值</p>
<p>选一个数据库中已经有的用户名进行测试</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727070845751.png" alt="image-20220727070845751"></p>
<p>后代打印的<code>sql</code></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727070942651.png" alt="image-20220727070942651"></p>
</li>
</ul>
</li>
</ul>
<h3 id="错误处理函数封装"><a href="#错误处理函数封装" class="headerlink" title="错误处理函数封装"></a>错误处理函数封装</h3><p>我们可以把格式的验证，单独封装成一个中间件（处理函数）</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220727071500267.png" alt="image-20220727071500267"></p>
<p>在<code>controller</code>层拆分中间件</p>
<p>新建<code>middleware/user.middleware.js</code>，中间件里定义各种函数，然后导出</p>
<p><code>user.middleware.js</code></p>
<p>从<code>controller</code>里把合法性验证的代码抽离出来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">userValidator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user_name || !password) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// 校验没通过，直接返回</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>() <span class="comment">// 校验通过了的话，就放行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么什么时候执行中间件呢？</p>
<p>在路由匹配的时候，只要路由一匹配上，就立刻调用校验的中间件</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用<code>apifox</code>测试一下，可以正常打印错误日志</p>
<p>再抽离查询用户的代码（合理性验证）</p>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; getUserInfo &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">userValidator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user_name || !password) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>() </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">409</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator,</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator, verifyUser &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, verifyUser, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p>测试下用户名已存在的情况，正常</p>
<p>至此，逻辑已经很清晰了，但我们还可以进一步管理<strong>错误信息</strong></p>
<h3 id="统一错误管理"><a href="#统一错误管理" class="headerlink" title="统一错误管理"></a>统一错误管理</h3><p>在<code>koa</code>中，怎么进行错误管理呢？</p>
<ul>
<li>中间件里提交错误类型</li>
</ul>
<p>通过<code>ctx.app</code>可以拿到实例化的<code>koa</code>对象，它有一个<code>emit</code>方法用来提交错误，我们可以对此做一个检测</p>
<p><code>ctx.app.emit(&#39;error&#39;, &#123;&#125;, ctx)</code></p>
<ul>
<li>该对象是自定义的错误类型，可以统一放在一个新的文件里管理</li>
</ul>
<p>新建<code>src/constant</code>常量文件夹</p>
<p>新建<code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">userFormateError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userAlreadyExists</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>user.middle.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; getUserInfo &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userFormateError, userAlreadyExists &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">userValidator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user_name || !password) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        <span class="comment">// ctx.status = 400</span></span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userFormateError, ctx) <span class="comment">// 该对象是自定义的错误类型，可以统一放在一个新的文件里管理</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        <span class="comment">// ctx.status = 409</span></span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator,</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>app/index.js</code>中统一进行错误处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errorHandler&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;   </span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`Request Body: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ctx.request.body)&#125;</span>`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一进行错误处理</span></span><br><span class="line"><span class="comment">// 发布订阅模式</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同级目录下，新建<code>errHandler.js</code>错误处理函数</p>
<p><code>errHandler.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> status = <span class="number">500</span> <span class="comment">// 默认错误状态码</span></span><br><span class="line">    <span class="keyword">switch</span> (err.<span class="property">code</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;10001&#x27;</span>:</span><br><span class="line">            status = <span class="number">400</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;10002&#x27;</span>:</span><br><span class="line">            status = <span class="number">409</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            status = <span class="number">500</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">status</span> = status</span><br><span class="line">    ctx.<span class="property">body</span> = err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h3><p><code>verifyUser</code>中间件调用的<code>getUserInfo</code>返回的是一个<code>Promise</code>对象，恒为真，正常注册流程也走不下去了</p>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改</p>
<ul>
<li><p>添加<code>await</code>，相当于判断条件是一个表达式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>另外假设中间件都没问题，到了控制层<code>createUser</code>这一步了，目前我们对这一步做任何的异常处理，使用<code>try-catch</code>来处理下</p>
<p>虽说这一步是<code>sequelize</code>自己操作的数据库，不大可能会出错，但为了代码的健壮性，还是要处理下的</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createUser &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userRegisterError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 处理写入用户数据时，可能出现的异常</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: &#123;</span><br><span class="line">                    <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                    <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userRegisterError, ctx)</span><br><span class="line">			<span class="keyword">return</span> <span class="comment">// 发生错误就不要继续往下执行了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>定义错误类型</p>
<p><code>constant/error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">userFormateError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userAlreadyExists</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userRegisterError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10003&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户注册错误&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在&#96;createUser方法中，模拟下写入数据库时发生了错误</p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123; user_name, password &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(aa) <span class="comment">// 打印不存在的变量，模拟数据库操作错误</span></span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>测试下</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220728194137316.png" alt="image-20220728194137316"></p>
<p>后台日志</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220728194219755.png" alt="image-20220728194219755"></p>
<p>建议调用<code>service</code>层所有的函数时，都加上错误处理</p>
<p>继续完善<code>verifyUser</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名已存在&#x27;</span>, &#123; user_name &#125;)</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">err</span>(<span class="string">&#x27;获取用户信息错误&#x27;</span>, err)</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userQueryError, ctx)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">userFormateError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userAlreadyExists</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userRegisterError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10003&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户注册错误&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userQueryError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10004&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户查询错误&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，真正要写代码的部分，其实是比较少的</p>
<p>很重要的一部分，在于提高代码的质量上，都在一些异常捕获和错误处理上，这一块是需要下功夫的，平时写代码的时候，要有这样的意识</p>
<p>这样当代码上线后，如果有问题，我们调试错误会很方便</p>
<p><code>ctx.app.emit</code>提交的错误，最后会以接口的形式返回给客户端，如果服务器自己想记录错误信息，可以使用<code>console.error()</code>来记录日志信息</p>
<p>目前来说，这里还是有一个问题，就是重复注册直接走到了<code>register</code>，验证重复用户名的中间件直接就通过了！！</p>
<p>原因是<code>getUserInfo</code>函数里的<code>User.findOne</code>是一个异步函数，需要加一个<code>await</code>，否则会出错</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">async</span> <span class="title function_">getUserInfo</span>(<span class="params">&#123;id, user_name, password, is_admin&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span>  whereOpt = &#123;&#125;</span><br><span class="line">        id &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;id&#125;)</span><br><span class="line">        user_name &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;user_name&#125;)</span><br><span class="line">        password &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;password&#125;)</span><br><span class="line">        is_admin &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;is_admin&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用ORM查询接口：findOne，这是一个异步函数</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;user_name&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;is_admin&#x27;</span>],</span><br><span class="line">            <span class="attr">where</span>: whereOpt</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res ? res.<span class="property">dataValues</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样重复注册走到<code>verifyUser</code>中间件时，就不会被当做异常处理</p>
<h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><p>在将密码保存到数据库之前，要对密码进行加密处理</p>
<p><code>md5</code>加密还是有可能被破解的，使用<code>bcrypt</code>加密</p>
<p>第一个依赖也多，这里我们使用第二个<code>bcryptjs</code>：在 JavaScript 中优化了 <code>bcrypt</code>，零依赖关系。</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220729054812130.png" alt="image-20220729054812130"></p>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i bcryptjs</span><br></pre></td></tr></table></figure>

<p>用法：有同步和异步的用法：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcryptjs">https://www.npmjs.com/package/bcryptjs</a></p>
<p>使用：</p>
<ul>
<li>将代码加密功能，也抽离成一个中间件（单一职责原则）<ul>
<li>不想<code>bcrypt</code>这种加密方式，耦合到代码中</li>
<li>后面有可能会换成其他加密方式：<code>hash</code>、<code>md5</code></li>
</ul>
</li>
</ul>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">scyptPassword</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">const</span> salt =  bcrypt.<span class="title function_">genSaltSync</span>(<span class="number">10</span>); <span class="comment">// 生成盐</span></span><br><span class="line">    <span class="keyword">const</span> hash = bcrypt.<span class="title function_">hashSync</span>(password, salt); <span class="comment">// 根据盐生成hash，hash保存的是密文</span></span><br><span class="line">    ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">password</span> = hash <span class="comment">// 使用hash覆盖password</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator,</span><br><span class="line">    verifyUser,</span><br><span class="line">    scyptPassword</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>user.route.js</code>导入并使用</p>
<p>测试注册接口成功后，查看<code>user</code>表<code>password</code>字段，已加密</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220729060929127.png" alt="image-20220729060929127"></p>
<p>仍存在的问题：密码在前端传给后端的过程中，是明文的，应该前端先加密，后端存储密文；而登录时，后面采用和前端一样的加密算法解密即可</p>
<h3 id="小结：注册接口"><a href="#小结：注册接口" class="headerlink" title="小结：注册接口"></a>小结：注册接口</h3><p>梳理一下整理流程，及每个模块的功能</p>
<h2 id="登录接口"><a href="#登录接口" class="headerlink" title="登录接口"></a>登录接口</h2><p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`欢迎回来，<span class="subst">$&#123;user_name&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完善<code>apifox</code></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220729062050491.png" alt="image-20220729062050491"></p>
<p>添加样例，应为数据库有已有的数据</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220729062118325.png" alt="image-20220729062118325"></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220729062229643.png" alt="image-20220729062229643"></p>
<p>但事实上，现在<code>login</code>对任何的输入都是可以的，我们需要对数据进行一个校验</p>
<ul>
<li><p>是否为空（合法性校验）</p>
<ul>
<li>复用</li>
</ul>
</li>
<li><p>是否存在（合理性校验）</p>
<ul>
<li>复用</li>
</ul>
</li>
<li><p>验证登录</p>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyLogin</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 1.判断用户是否存在（不存在：报错）</span></span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户不存在&#x27;</span>, res)</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userNotFound, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.找到了用户，比对密码是否匹配（不匹配：报错）</span></span><br><span class="line">        <span class="keyword">if</span> (!bcrypt.<span class="title function_">compareSync</span>(password, res.<span class="property">password</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userInvalidPassword, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userLoginFailed, ctx) <span class="comment">// getUserInfo出错，在不同场景下，抛出的错误应该是不同的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>登录成功后记录用户状态</p>
<ul>
<li>用户认证与授权</li>
</ul>
</li>
</ul>
<h2 id="用户认证和授权"><a href="#用户认证和授权" class="headerlink" title="用户认证和授权"></a>用户认证和授权</h2><h3 id="颁发token"><a href="#颁发token" class="headerlink" title="颁发token"></a>颁发<code>token</code></h3><p>登录成功后，给用户颁发一个令牌<code>token</code>，用户在以后的每一次请求中，携带这个令牌</p>
<p>前后端分离中，使用<code>jwt</code>：<code>json web token</code></p>
<ul>
<li><code>header</code>：头部</li>
<li><code>payload</code>：载荷</li>
<li><code>signature</code>：签名</li>
</ul>
<p>如何使用</p>
<ul>
<li><p>使用<code>jsonwebtoken</code>包：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jsonwebtoken">https://www.npmjs.com/package/jsonwebtoken</a></p>
<ul>
<li>安装：<code>npm i jsonwebtoken</code></li>
<li><code>sign</code>方法生成<code>token</code></li>
</ul>
</li>
<li><p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">            <span class="comment">// 获取用户信息（在paylaod中，记录id、user_name、is_admin）</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 从返回结果中，过滤掉password，将剩下的属性，放在新的res对象中</span></span><br><span class="line">                <span class="keyword">const</span> &#123; password, ...res &#125; = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)</span><br><span class="line">                ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;用户登录成功&#x27;</span>,</span><br><span class="line">                    <span class="attr">result</span>: &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        * @params1:配置对象</span></span><br><span class="line"><span class="comment">                        * @params2:秘钥</span></span><br><span class="line"><span class="comment">                        * @params3:过期时间，一天</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                        <span class="attr">token</span>: jwt.<span class="title function_">sign</span>(res, <span class="variable constant_">JWT_SECRET</span>, &#123;<span class="attr">expiresIn</span>: <span class="string">&#x27;1d&#x27;</span>&#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户登录失败&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730062107079.png" alt="image-20220730062107079"></p>
</li>
</ul>
<h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><p>我们新建一个修改密码的接口</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730063834013.png" alt="image-20220730063834013"></p>
<p>修改的操作</p>
<ul>
<li><code>PUT</code>：全量修改</li>
<li><code>PATCH</code>：部分修改</li>
</ul>
<p>写对应的路由</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator, verifyUser, scyptPassword, verifyLogin &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, verifyUser, scyptPassword, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userValidator,  verifyLogin, login)</span><br><span class="line"><span class="comment">// 修改密码接口</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/modifyPassword&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;修改密码成功&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先简单测试下</p>
<p>我们在上面颁发<code>token</code>后，后续的请求（如修改密码）需要携带这个<code>token</code></p>
<p>请求头新增<code>Authorization</code>，值一开始固定的是<code>Bearer </code>，有一个空格</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730082130815.png" alt="image-20220730082130815"></p>
<p>后面发送请求时，需要加上签发的<code>token</code></p>
<p>新建<code>auth.middleware.js</code>文件，将认证相关的验证放在这里面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">JWT_SECRET</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config/config.default&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; tokenExpiredError, invalidToken&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">auth</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取请求头的token</span></span><br><span class="line">    <span class="keyword">const</span> &#123; authorization &#125; = ctx.<span class="property">request</span>.<span class="property">header</span></span><br><span class="line">    <span class="keyword">const</span> token = authorization.<span class="title function_">replace</span>(<span class="string">&#x27;Bearer &#x27;</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment">// 这里要有一个空格</span></span><br><span class="line">    <span class="comment">// 根据自定义私钥，使用jwt验证token</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token&#x27;</span>, token)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// user中包含了payload的信息：user_name, id, is_admin</span></span><br><span class="line">        <span class="keyword">const</span> user = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>) <span class="comment">// 如果jwt.verify验证失败，会抛出一个异常</span></span><br><span class="line">        <span class="comment">// console.log(&#x27;user&#x27;, user)</span></span><br><span class="line">        ctx.<span class="property">state</span>.<span class="property">user</span> = user</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="comment">// console.log(&#x27;err name&#x27;, err.name)</span></span><br><span class="line">        <span class="comment">// jwt.verify异常情况有多种，可参照Npm文档 https://www.npmjs.com/package/jsonwebtoken</span></span><br><span class="line">        <span class="keyword">switch</span> (err.<span class="property">name</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;TokenExpiredError&#x27;</span>: <span class="comment">// jwt返回的错误类型</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;token已过期&#x27;</span>, err)</span><br><span class="line">                ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, tokenExpiredError, ctx)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;JsonWebTokenError&#x27;</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无效的token&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, invalidToken, ctx)</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;token错误&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    auth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="comment">// 100 用户模块</span></span><br><span class="line"><span class="comment">// 101 授权模块</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="attr">tokenExpiredError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10101&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;token已过期&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">invalidToken</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10102&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;无效的token&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在路由上，加上<code>token</code>认证的中间件</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator, verifyUser, scyptPassword, verifyLogin &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; auth &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, verifyUser, scyptPassword, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userValidator, verifyLogin, login)</span><br><span class="line"><span class="comment">// 修改密码接口</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/modifyPassword&#x27;</span>, auth, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123; <span class="comment">// 加上认证的中间件</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;修改密码成功&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接口测试工具中，将登录成功后颁发的<code>token</code>，存为全局变量</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730172723345.png" alt="image-20220730172723345">这样在修改密码的接口里，就可以不用复制<code>token</code>了</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730172826331.png" alt="image-20220730172826331"></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730172900867.png" alt="image-20220730172900867"></p>
<p>但这里有个不好的地方，我想测试下错误<code>token</code>的响应，是不支持修改的，测试的时候还是需要手动复制</p>
<p>正常接口返回的<code>user</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user &#123;</span><br><span class="line">  <span class="built_in">id</span>: 46,</span><br><span class="line">  user_name: <span class="string">&#x27;sai&#x27;</span>,</span><br><span class="line">  is_admin: <span class="literal">false</span>,</span><br><span class="line">  iat: 1659173449,</span><br><span class="line">  exp: 1659259849</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试无效的<code>token</code></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730173957547.png" alt="image-20220730173957547"></p>
<p>把<code>token</code>失效时间改为<code>5s</code>，测试过期<code>token</code>（记得测试完改回去）</p>
<p>重新登录后，测试下</p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730174247201.png" alt="image-20220730174247201"></p>
<h4 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h4><p>测试没问题后，我们再加上加密的中间件，并正式写修改密码接口对应的处理函数</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改密码接口</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/modifyPassword&#x27;</span>, auth, scyptPassword, modifyPassword)</span><br></pre></td></tr></table></figure>

<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createUser, getUserInfo, updateById &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">modifyPassword</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="keyword">const</span> id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">        <span class="keyword">const</span> password = ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">        <span class="comment">// 2. 操作数据库</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">updateById</span>(&#123; id, password &#125;)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 返回结果</span></span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;修改密码成功&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(id, password)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">updateById</span>(<span class="params">&#123; id, user_name, password, is_admin &#125;</span>) &#123; <span class="comment">// 接口的设计要考虑到复用性，不要这次只是根据id修改密码，就只写这一个功能</span></span><br><span class="line">    <span class="keyword">const</span> whereOpt = &#123; id &#125;</span><br><span class="line">    <span class="keyword">const</span> newUser = &#123;&#125;</span><br><span class="line">    user_name &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(newUser, &#123; user_name &#125;)</span><br><span class="line">    password &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(newUser, &#123; password &#125;)</span><br><span class="line">    is_admin &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(newUser, &#123; is_admin &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">update</span>(newUser, &#123;</span><br><span class="line">        <span class="attr">where</span>: whereOpt</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&#x27;res&#x27;, res, typeof res) // 返回是一个数组</span></span><br><span class="line">    <span class="keyword">return</span> res[<span class="number">0</span>] &gt; <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小问题：入参为空对象时，应该做处理；修改密码还是原密码时，应该做处理</p>
<h2 id="商品模块"><a href="#商品模块" class="headerlink" title="商品模块"></a>商品模块</h2><h3 id="整体流程打通"><a href="#整体流程打通" class="headerlink" title="整体流程打通"></a>整体流程打通</h3><p><strong>路由</strong></p>
<p>新建<code>router/goods.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/goods&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; upload &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/goods.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p><strong>控制器</strong></p>
<p>新建<code>controller/goods/controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="comment">// 根据实际业务，可以写的很复杂，比如支持word、excel、图片等资源上传</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">upload</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;商品上传成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">GoodsController</span>()</span><br></pre></td></tr></table></figure>

<p><code>app/index.js</code>	</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> goodsRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/goods.route&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(goodsRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一进行错误处理</span></span><br><span class="line"><span class="comment">// 发布订阅模式</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试接口</strong></p>
<p><img src="/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/image-20220730191605224.png" alt="image-20220730191605224"></p>
<p>至此，整个流程已经打通</p>
<h3 id="自动加载路由"><a href="#自动加载路由" class="headerlink" title="自动加载路由"></a>自动加载路由</h3><p>上面我们在<code>app/index.js</code>注册路由时，需要手动一个个导入</p>
<p>可以使用<code>fs</code>模块实现自动导入</p>
<p>新建<code>router/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readdirSync</span>(__dirname).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123; <span class="comment">// readdirSync方法，以同步的方式获取文件名</span></span><br><span class="line">    <span class="comment">// console.log(file) // 当前目录下的所有文件名</span></span><br><span class="line">    <span class="keyword">if</span> (file !== <span class="string">&#x27;index.js&#x27;</span>) &#123; <span class="comment">// 过滤掉自身</span></span><br><span class="line">        <span class="keyword">let</span> r = <span class="built_in">require</span>(<span class="string">&#x27;./&#x27;</span> + file) <span class="comment">// 加载文件</span></span><br><span class="line">        router.<span class="title function_">use</span>(r.<span class="title function_">routes</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p>改写<code>app/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>) <span class="comment">// 默认会找index.js</span></span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// use方法返回app自身</span></span><br><span class="line">app</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>()) <span class="comment">// 请求类型不支持的话，会更友好的响应</span></span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>use(router.allowedMethods()) </code>，请求类型不支持的话，会更友好的响应</p>
<p><img src="/image-20220730193114786.png" alt="image-20220730193114786"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/07/31/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa_EN/" data-id="cldol83ji008v3cx6fcr156ea" data-title="Koa2 build API service" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Koa/" rel="tag">Koa</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web/进阶/Node.js/Koa/koa" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/" class="article-date">
  <time class="dt-published" datetime="2022-07-25T15:52:13.000Z" itemprop="datePublished">2022-07-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Koa/">Koa</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/">Koa2搭建API服务</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Koa2入门"><a href="#Koa2入门" class="headerlink" title="Koa2入门"></a>Koa2入门</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV18h411H7GE?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV18h411H7GE?spm_id_from=333.999.0.0</a></p>
<h1 id="Node-Koa2搭建API服务"><a href="#Node-Koa2搭建API服务" class="headerlink" title="Node+Koa2搭建API服务"></a>Node+Koa2搭建<code>API</code>服务</h1><p>教程来源：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV13A411w79h?spm_id_from=333.999.0.0">https://www.bilibili.com/video/BV13A411w79h?spm_id_from=333.999.0.0</a></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><ul>
<li><code>npm init -y</code></li>
<li><code>git init</code>，并新建<code>.gitignore</code>，添加<code>node_modules</code><ul>
<li>提交版本后，并通过<code>git log</code>查看记录</li>
</ul>
</li>
<li>新建<code>README.md</code>文档</li>
</ul>
<h2 id="项目初始化"><a href="#项目初始化" class="headerlink" title="项目初始化"></a>项目初始化</h2><ul>
<li><p><code>npm i koa</code></p>
</li>
<li><p>根目录新建<code>src/main.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123; <span class="comment">// 中间件</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span> <span class="comment">// 测试代码</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server is running on http://localhost:3000 !&#x27;</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动开发服务：</p>
<ul>
<li><code>node .\src\main.js</code>:<code>node</code>方式启动，是常驻内存，不是热加载的</li>
</ul>
</li>
</ul>
<h2 id="开发优化"><a href="#开发优化" class="headerlink" title="开发优化"></a>开发优化</h2><h3 id="自动重启服务"><a href="#自动重启服务" class="headerlink" title="自动重启服务"></a>自动重启服务</h3><ul>
<li><p><code>npm i nodemon -D</code></p>
</li>
<li><p>配置<code>dev</code>脚本：如果<code>nodemon</code>装在了全局，则不需要加<code>npx</code></p>
<p><code>package.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;index.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx nodemon ./src/main.js&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ISC&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;koa&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.13.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nodemon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.19&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>npm run dev</code>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PS D:\workspace\github\code\project-workshop\code-prac\koa\01&gt; npm run dev</span><br><span class="line"></span><br><span class="line">&gt; 01@1.0.0 dev</span><br><span class="line">&gt; npx nodemon ./src/main.js</span><br><span class="line"></span><br><span class="line">[nodemon] 2.0.19</span><br><span class="line">[nodemon] to restart at any time, enter `rs`</span><br><span class="line">[nodemon] watching path(s): *.*</span><br><span class="line">[nodemon] watching extensions: js,mjs,json // 监听这三种文件</span><br><span class="line">[nodemon] starting `node ./src/main.js` // 使用node启动</span><br><span class="line">server is running on http://localhost:3000 ! // 打印输出内容</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="读取配置文件"><a href="#读取配置文件" class="headerlink" title="读取配置文件"></a>读取配置文件</h3><ul>
<li><p>安装<code>dotenv</code>（可以去<code>npm</code>官网上查看介绍）：在根目录中加载<code>.env</code>的配置文件，将键值对加载到<code>process.env</code>的环境变量中</p>
<ul>
<li><p><code>npm i dotenv</code></p>
</li>
<li><p>项目根目录，新建<code>.env</code>配置文件并添加配置</p>
<p><code>.env</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APP_PORT = 8000</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>读取配置</p>
<ul>
<li><p>新建<code>src/config/config.default.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;dotenv&#x27;</span>).<span class="title function_">config</span>() <span class="comment">// 导入dotenv，调用config方法，读取配置并写入到`process.env`中</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">export</span> = process.<span class="property">env</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>改写<code>main.js</code>，使用解构赋值的方式，获取到<code>APP_PORT</code>的配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>) <span class="comment">// 导入process.env环境变量中的APP_PORT字段</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>); <span class="comment">// 使用模板字符串</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动开发服务</p>
</li>
</ul>
</li>
</ul>
<h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><p>所谓的<code>api</code>，就是根据不同<code>url</code>返回不同的数据</p>
<p>目前<code>http://localhost:8000</code>和<code>http://localhost:8000/users</code>返回的内容都是一样的</p>
<p>需要使用路由，来根据不同的<code>url</code>，调用不同的处理函数</p>
<p>安装<code>koa-router</code></p>
<ul>
<li>&#96;&#96;api官网：&#96;<a target="_blank" rel="noopener" href="https://github.com/koajs/router/blob/master/API.md">router&#x2F;API.md at master · koajs&#x2F;router (github.com)</a></li>
<li><code>npm install @koa/router</code></li>
</ul>
<p>官网案例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>); <span class="comment">// 1.导入Router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(); <span class="comment">// 2.新建router实例对象</span></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123; <span class="comment">// 3.编写路由</span></span><br><span class="line">  <span class="comment">// ctx.router available</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app <span class="comment">// 4.注册中间件</span></span><br><span class="line">  .<span class="title function_">use</span>(router.<span class="title function_">routes</span>()) <span class="comment">// use方法只能接受函数作为参数，通过router.routes()方法返回一个函数给中间件处理</span></span><br><span class="line">  .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>());</span><br></pre></td></tr></table></figure>

<p>配置多个路由</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>) <span class="comment">// 导入router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// app.use((ctx, next) =&gt; &#123; // 中间件</span></span><br><span class="line"><span class="comment">//     ctx.body = &#x27;hello world&#x27; // 测试代码</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">userRouter.<span class="title function_">get</span>(<span class="string">&#x27;/user&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>但是代码都写在一起肯定不行，需要拆分一下路由</p>
<p>新建<code>src/router</code>文件夹</p>
<p>新建<code>user.routes.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>main.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>) <span class="comment">// 导入router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;./router/user.route&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>()) <span class="comment">// 后续这里也会继续优化，不然当路由很多时，写法也会很恶心</span></span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="目录结构优化"><a href="#目录结构优化" class="headerlink" title="目录结构优化"></a>目录结构优化</h2><h3 id="拆分http服务和业务代码"><a href="#拆分http服务和业务代码" class="headerlink" title="拆分http服务和业务代码"></a>拆分<code>http</code>服务和业务代码</h3><p>我们在<code>main.js</code>里面写了太多的功能</p>
<ul>
<li><p>拆分<code>http</code>服务与业务相关代码</p>
<ul>
<li>新建<code>src/app/index.js</code>，专门放业务代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>) <span class="comment">// 导入Koa，由于导出的是类，一般大写</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>) <span class="comment">// 导入router</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>() <span class="comment">// 实例化</span></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>man.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">APP_PORT</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./config/config.default&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&#x27;./app&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">APP_PORT</span>, <span class="function">() =&gt;</span> &#123; <span class="comment">// 开启服务</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`server is running on http://localhost:<span class="subst">$&#123;APP_PORT&#125;</span> !`</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="抽离控制层"><a href="#抽离控制层" class="headerlink" title="抽离控制层"></a>抽离控制层</h3><p>将路由<code>router</code>中的处理函数，单独抽离成控制层<code>controller</code></p>
<ul>
<li><p>新建<code>src/controller</code>文件夹</p>
</li>
<li><p>新建<code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户注册成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>修改<code>router/user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router =  <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123;register&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, register)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试接口</p>
<p>这里我们写成了<code>post</code>请求，使用<code>postman</code>或者是<code>Apifox</code>（国内的）来测试<code>post</code>请求</p>
<p>这里以<code>apifox</code>为例，下载后，新建项目 &gt; 新建接口</p>
<p>按图示配置</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725220620161.png" alt="image-20220725220620161"></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725220748784.png" alt="image-20220725220748784"></p>
<p>配置好路由后，点击运行，可以拿到数据了：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725220846437.png" alt="image-20220725220846437"></p>
</li>
<li><p>我们再写一个登录的接口</p>
<p><code>user.router.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router =  <span class="keyword">new</span> <span class="title class_">Router</span>(&#123;<span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123;register, login&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户注册成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="解析body、拆分service层"><a href="#解析body、拆分service层" class="headerlink" title="解析body、拆分service层"></a>解析<code>body</code>、拆分<code>service</code>层</h2><h3 id="解析body"><a href="#解析body" class="headerlink" title="解析body"></a>解析<code>body</code></h3><blockquote>
<p>完整的注册接口</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /user/register</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_name, password</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;code&quot;: 0,</span><br><span class="line">    &quot;message&quot;: &quot;用户注册成功&quot;,</span><br><span class="line">    &quot;result&quot;: &#123;</span><br><span class="line">		&quot;id&quot;: 2,</span><br><span class="line">        &quot;user_name&quot;: &quot;user&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原型图：</p>
<img src="image-20220725222952833.png" alt="image-20220725222952833" style="zoom:67%;" />

<p><code>koa</code>需要借助中间件，来解析参数</p>
<ul>
<li><p><code>koa-body</code>：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/koa-body">https://www.npmjs.com/package/koa-body</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A full-featured koa body parser middleware. Supports multipart, urlencoded, and json request bodies. Provides the same functionality as Express&#x27;s bodyParser - multer.</span><br></pre></td></tr></table></figure>

<p>官方基础样例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>); <span class="comment">// 1.引入中间件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>()); <span class="comment">// 在所有请求之前，注册这个中间件，就把所有的内容写到了ctx.request.body里面</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = <span class="string">`Request Body: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ctx.request.body)&#125;</span>`</span>; <span class="comment">// 3.看下request.body</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>更推荐，相比较于<code>koa-bodyparser</code>，还支持文件上传</li>
</ul>
</li>
<li><p><code>koa-bodyparser</code></p>
</li>
</ul>
<p>将之前<code>apifox</code>的注册接口完善下，由于是<code>post</code>请求，我们在<code>body</code>里面，设置参数</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725225232579.png" alt="image-20220725225232579"></p>
<p> 安装<code>koa-body</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-body</span><br></pre></td></tr></table></figure>



<p>在<code>app/index.js</code>中添加<code>koa-body</code>相关代码</p>
<p><code>app/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>) <span class="comment">// 1.导入koa-body</span></span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>()) <span class="comment">// 2.在所有中间件之前，注册koa-body</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;   </span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`Request Body: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ctx.request.body)&#125;</span>`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>控制层（处理函数）<code>user.config.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        ctx.<span class="property">body</span> = ctx.<span class="property">request</span>.<span class="property">body</span> <span class="comment">// 我的理解：把请求的参数，放在响应的body里面，再返给客户端</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>回到<code>apifox</code>中，我们生成下<code>body</code>请求体，发送下注册的请求</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725230641092.png" alt="image-20220725230641092"></p>
<p>后台也打印结果了</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725230741773.png" alt="image-20220725230741773"></p>
<p>控制器里一般做这些事</p>
<ul>
<li>1.获取数据</li>
<li>2.操作数据库<ul>
<li>如果操作数据库的逻辑很复杂，也会单独抽出这一部分（<code>service</code>层）</li>
</ul>
</li>
<li>3.返回结果</li>
</ul>
<h3 id="抽取servcie层"><a href="#抽取servcie层" class="headerlink" title="抽取servcie层"></a>抽取<code>servcie</code>层</h3><p>和数据库相关的，根据客户端传递的不同参数，来操作数据库</p>
<p>新建<code>src/service</code>目录</p>
<p>新建<code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 主要用来操作数据库</span></span><br><span class="line">    <span class="comment">// 处理函数对应数据库的操作，就是增删改查</span></span><br><span class="line">    <span class="comment">// 注册，就是往数据库里，增加一条记录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123; <span class="comment">// 当参数超过三个时，建议用一个对象</span></span><br><span class="line">        <span class="comment">//@<span class="doctag">TODO:</span> 写入数据库</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;写入数据库成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>修改<code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="comment">// console.log(ctx.request.body)</span></span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="comment">// 2.操作数据库</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.返回结果</span></span><br><span class="line">        ctx.<span class="property">body</span> = ctx.<span class="property">request</span>.<span class="property">body</span> <span class="comment">// 我的理解：把请求的参数，放在响应的body里面，再返给客户端</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>后台打印结果：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220725232505667.png" alt="image-20220725232505667"></p>
<h2 id="ORM工具集成"><a href="#ORM工具集成" class="headerlink" title="ORM工具集成"></a><code>ORM</code>工具集成</h2><h3 id="sequelize介绍"><a href="#sequelize介绍" class="headerlink" title="sequelize介绍"></a><code>sequelize</code>介绍</h3><p><code>ORM</code>：对象关系映射</p>
<ul>
<li>数据表映射（对应）一个类</li>
<li>数据表中的数据行（记录）对应一个对象</li>
<li>数据表字段对应对象的属性</li>
<li>数据表的操作，对应对象的方法</li>
<li>就是使用面向对象的方式，来操作数据库</li>
</ul>
<p>使用<code>sequelize</code> <code>ORM</code>数据库工具：<a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/tree/master">https://github.com/demopark/sequelize-docs-Zh-CN/tree/master</a></p>
<ul>
<li><p>基于<code>Promise</code>的<code>ORM</code>工具</p>
</li>
<li><p>Sequelize 是一个基于<code> promise</code> 的 <code>Node.js ORM</code> 工具, 目前支持 <code>Postgres, MySQL, MariaDB, SQLite 以及 Microsoft SQL Server, Amazon Redshift 和 Snowflake’s Data Cloud</code>. 它具有强大的事务支持, 关联关系, 预读和延迟加载,读取复制等功能.</p>
</li>
<li><p>安装<code>sequelize</code>和<code>mysql2</code>（支持<code>Promise</code>）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i sequelize mysql2</span><br></pre></td></tr></table></figure>

<p>得注意下安装的<code>sequelize</code>支持的最低版本的<code>mysql</code>，目前默认安装的<code>sequlize</code>版本是<code>6.21.3</code>，对应的<code>mysql</code>版本至少是<code>5.7</code>及以上：<a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/tree/v6">https://github.com/demopark/sequelize-docs-Zh-CN/tree/v6</a></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726064512073.png" alt="image-20220726064512073"></p>
</li>
</ul>
<h3 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h3><h4 id="windows安装"><a href="#windows安装" class="headerlink" title="windows安装"></a><code>windows</code>安装</h4><p>在正式连接之前，我们需要装下<code>mysql</code>数据库，这里暂时安装<code>windows</code>版本，参照：<a target="_blank" rel="noopener" href="https://blog.csdn.net/jsugs/article/details/124143762">https://blog.csdn.net/jsugs/article/details/124143762</a></p>
<p>启动<code>mysql</code>服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">输入net start mysql或sc start mysql</span><br></pre></td></tr></table></figure>



<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726070015186.png" alt="image-20220726070015186"></p>
<p>改密码后再用<code>navicat连接</code>，会报错<code>Authentication plugin &#39;caching_sha2_password&#39; cannot be loaded</code>，参照：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/465a444ad846">https://www.jianshu.com/p/465a444ad846</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123123&#x27;</span> PASSWORD EXPIRE NEVER;   <span class="comment">#修改加密规则 </span></span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;123123&#x27;</span>;   <span class="comment">#更新一下用户的密码</span></span><br><span class="line">FLUSH PRIVILEGES;   <span class="comment">#刷新权限 </span></span><br></pre></td></tr></table></figure>



<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726071528438.png" alt="image-20220726071528438"></p>
<p>查询mysql进程，并杀掉</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -aon|findstr <span class="string">&quot;3306&quot;</span></span><br><span class="line"></span><br><span class="line">taskkill /pid 26372 -t -f</span><br></pre></td></tr></table></figure>

<p>成功进入后，新建数据库</p>
<p>一开始是没有选中下面两个的，设置名称后直接确定</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726071755569.png" alt="image-20220726071755569"></p>
<h4 id="linux安装"><a href="#linux安装" class="headerlink" title="linux安装"></a><code>linux</code>安装</h4><p>使用<code>docker</code>安装，参见</p>
<ul>
<li><p>待添加</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a49389497a0c">Docker安装mysql5.7报错 ERROR 1045 (28000): Access denied for user - 简书 (jianshu.com)</a></p>
</li>
</ul>
<p>最后一步报语法错误，可以不用管</p>
<h3 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h3><p>官方示例：<a target="_blank" rel="noopener" href="https://github.com/demopark/sequelize-docs-Zh-CN/blob/v6/core-concepts/getting-started.md">https://github.com/demopark/sequelize-docs-Zh-CN/blob/v6/core-concepts/getting-started.md</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法 1: 传递一个连接 URI</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;sqlite::memory:&#x27;</span>) <span class="comment">// Sqlite 示例</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;postgres://user:pass@example.com:5432/dbname&#x27;</span>) <span class="comment">// Postgres 示例</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法 2: 分别传递参数 (sqlite)</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(&#123;</span><br><span class="line">  <span class="attr">dialect</span>: <span class="string">&#x27;sqlite&#x27;</span>,</span><br><span class="line">  <span class="attr">storage</span>: <span class="string">&#x27;path/to/database.sqlite&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法 3: 分别传递参数 (其它数据库)</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;database&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>,</span><br><span class="line">  <span class="attr">dialect</span>: <span class="comment">/* 选择 &#x27;mysql&#x27; | &#x27;mariadb&#x27; | &#x27;postgres&#x27; | &#x27;mssql&#x27; 其一 */</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>新建<code>src/db/seq.js</code></p>
<p>该文件中实现数据库的连接，并导出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">Sequelize</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="string">&#x27;mytest&#x27;</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;123123&#x27;</span>, &#123; <span class="comment">// 需要手动新建mytest</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;localhost&#x27;</span>, <span class="comment">// host: &#x27;1.12.**.**&#x27;, // 若需要指定其他端口号，请参阅官网查询配置</span></span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">seq.<span class="title function_">authenticate</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接成功&#x27;</span>, res)</span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;数据库连接失败&#x27;</span>, error)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = seq</span><br></pre></td></tr></table></figure>

<p>在<code>db</code>目录下，使用<code>node</code>测试下：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726200218491.png" alt="image-20220726200218491"></p>
<p>开发环境我们这样搞没事，生产环境可能会用连接池</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>使用<code>dotenv</code>将参数提取成配置文件</p>
<p>修改<code>.env</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">APP_PORT = 8000</span><br><span class="line"></span><br><span class="line">MYSQL_HOST = localhost</span><br><span class="line">MYSQL_PORT = 3306</span><br><span class="line">MYSQL_USER = root</span><br><span class="line">MYSQL_PASSWORD = 123123</span><br><span class="line">MYSQL_DATABASE = mytest</span><br></pre></td></tr></table></figure>

<p><code>seq.js</code>中导入并使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; </span><br><span class="line">    <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_DATABASE</span> </span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config/config.default&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">MYSQL_HOST</span>,<span class="variable constant_">MYSQL_DATABASE</span>)</span><br><span class="line"><span class="keyword">const</span> seq = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="variable constant_">MYSQL_DATABASE</span>, <span class="variable constant_">MYSQL_USER</span>, <span class="variable constant_">MYSQL_PASSWORD</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// seq.authenticate().then(res =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;数据库连接成功&#x27;, res)</span></span><br><span class="line"><span class="comment">// &#125;).catch(error =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(&#x27;数据库连接失败&#x27;, error)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = seq</span><br></pre></td></tr></table></figure>

<p>此时需要在根目录下测试，不然读不到<code>.env</code>文件</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726201817869.png" alt="image-20220726201817869"></p>
<p>测试完将测试代码注释掉</p>
<h2 id="创建User模型"><a href="#创建User模型" class="headerlink" title="创建User模型"></a>创建<code>User</code>模型</h2><h3 id="模型创建"><a href="#模型创建" class="headerlink" title="模型创建"></a>模型创建</h3><p>新建<code>src/model</code>文件夹</p>
<p><code>service</code>层通过<code>model</code>层来具体操作数据库</p>
<p>新建<code>user.model.js</code>，使用<code>define</code>方法来创建模型：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-basics#%E4%BD%BF%E7%94%A8-sequelizedefine">https://www.sequelize.com.cn/core-concepts/model-basics#%E4%BD%BF%E7%94%A8-sequelizedefine</a></p>
<p>全局定义表名等于模型名，<code>seq.js</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Sequelize</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; </span><br><span class="line">    <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PORT</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_USER</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_PASSWORD</span>,</span><br><span class="line">    <span class="variable constant_">MYSQL_DATABASE</span> </span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config/config.default&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable constant_">MYSQL_HOST</span>,<span class="variable constant_">MYSQL_DATABASE</span>)</span><br><span class="line"><span class="keyword">const</span> seq = <span class="keyword">new</span> <span class="title class_">Sequelize</span>(<span class="variable constant_">MYSQL_DATABASE</span>, <span class="variable constant_">MYSQL_USER</span>, <span class="variable constant_">MYSQL_PASSWORD</span>, &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="variable constant_">MYSQL_HOST</span>,</span><br><span class="line">    <span class="attr">dialect</span>: <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">define</span>: &#123;</span><br><span class="line">        <span class="attr">freezeTableName</span>: <span class="literal">true</span> <span class="comment">// 全局定义表明等于模型名</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = seq</span><br></pre></td></tr></table></figure>

<p>根据表设计文档，定义模型属性：</p>
<p><strong>用户表</strong></p>
<p>表名：<code>sai_users</code></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键，自增（sequelize会自动维护）</td>
</tr>
<tr>
<td>user_name</td>
<td>varchar(255)</td>
<td>用户名，unique</td>
</tr>
<tr>
<td>password</td>
<td>char(64)</td>
<td>密码</td>
</tr>
<tr>
<td>is_admin</td>
<td>tinyint(1)</td>
<td>0：不是管理员，1：是管理员</td>
</tr>
</tbody></table>
<p>定义模型属性时的数据类型，参见：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-basics#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">https://www.sequelize.com.cn/core-concepts/model-basics#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B</a></p>
<p><code>user.model.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">DataTypes</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;sequelize&quot;</span>) <span class="comment">// 不要相信vscode的自动导入，坑！！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建模型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_user&#x27;</span>, &#123;</span><br><span class="line">    <span class="comment">// id会被sequelize自动创建</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// user_name</span></span><br><span class="line">    <span class="attr">user_name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="comment">// 不允许为空</span></span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户名唯一&#x27;</span> <span class="comment">// 注释</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// password</span></span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">CHAR</span>(<span class="number">64</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">is_admin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;是否为管理员，0：不是管理员（默认值），1：是管理员&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="title class_">User</span>.<span class="title function_">sync</span>(&#123;<span class="attr">force</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>有关模型同步：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-basics#%E6%A8%A1%E5%9E%8B%E5%90%8C%E6%AD%A5">https://www.sequelize.com.cn/core-concepts/model-basics#%E6%A8%A1%E5%9E%8B%E5%90%8C%E6%AD%A5</a></p>
<p>根目录下，执行<code>node src/model/user.model.js</code></p>
<p>就是执行了<code>sql</code>语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS D:\workspace\github\code\project-workshop\code-prac\koa\01&gt; node .\src\model\user.model.js</span><br><span class="line">localhost mytest</span><br><span class="line">Executing (default): DROP TABLE IF EXISTS `sai_user`;</span><br><span class="line">Executing (default): CREATE TABLE IF NOT EXISTS `sai_user` (`<span class="built_in">id</span>` INTEGER NOT NULL auto_increment , `user_name` VARCHAR(255) NOT NULL UNIQUE COMMENT <span class="string">&#x27;用户名唯一&#x27;</span>, `password` CHAR(64) NOT NULL COMMENT <span class="string">&#x27;</span></span><br><span class="line"><span class="string">密码&#x27;</span>, `is_admin` TINYINT(1) NOT NULL DEFAULT 0 COMMENT <span class="string">&#x27;是否为管理员，0：不是管理员（默认值），1：是管理员&#x27;</span>, `createdAt` DATETIME NOT NULL, `updatedAt` DATETIME NOT NULL, PRIMARY KEY (`<span class="built_in">id</span>`)) ENGINE=InnoDB;</span><br><span class="line">Executing (default): SHOW INDEX FROM `sai_user`</span><br></pre></td></tr></table></figure>

<p>可以看到，数据库中多了一个表：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726211457412.png" alt="image-20220726211457412"></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726211857584.png" alt="image-20220726211857584"></p>
<p>其中，<code>createAt</code>和<code>updatedAt</code>是<code>sequelize</code>自动给我们维护的，如果不需要时间戳，在<code>define</code>函数中，添加配置项：<code>&#123;timestamps: false&#125;</code>，但是一般情况下，都是保留的</p>
<p>导出<code>User</code>模型，并注释掉<code>sync</code>的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">DataTypes</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;sequelize&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建模型</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_user&#x27;</span>, &#123;</span><br><span class="line">    <span class="comment">// id会被sequelize自动创建</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// user_name</span></span><br><span class="line">    <span class="attr">user_name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="comment">// 不允许为空</span></span><br><span class="line">        <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户名唯一&#x27;</span> <span class="comment">// 注释</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// password</span></span><br><span class="line">    <span class="attr">password</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">CHAR</span>(<span class="number">64</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;密码&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">is_admin</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;是否为管理员，0：不是管理员（默认值），1：是管理员&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// User.sync(&#123;force: true&#125;) // 强制同步数据库（创建数据表）</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">User</span></span><br></pre></td></tr></table></figure>

<h3 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h3><p>我们继续完善写入数据库的代码</p>
<p>需要通过<code>ORM</code>实现标准的<code>CRUD</code>：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/model-querying-basics">https://www.sequelize.com.cn/core-concepts/model-querying-basics</a></p>
<p>新建<code>src/service/user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 主要用来操作数据库</span></span><br><span class="line">    <span class="comment">// 处理函数对应数据库的操作，就是增删改查</span></span><br><span class="line">    <span class="comment">// 注册，就是往数据库里，增加一条记录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123; <span class="comment">// 当参数超过三个时，建议用一个对象</span></span><br><span class="line">        <span class="comment">//@<span class="doctag">TODO:</span> 写入数据库</span></span><br><span class="line">        <span class="comment">// 插入数据</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">            user_name,</span><br><span class="line">            password</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>使用<code>apifox</code>发送<code>register</code>接口，成功后查看数据库</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726231148358.png" alt="image-20220726231148358"></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220726231243724.png" alt="image-20220726231243724"></p>
<p>成功注册，注意下时区慢8小时</p>
<p>再看下后台打印：</p>
<p>执行的了<code>insert</code>语句</p>
<p><code>User.create</code>返回的是一个<code>sai_user</code>的表模型对象，<code>dataValues</code>对应着表里面的一条记录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Executing (default): INSERT INTO `sai_user` (`<span class="built_in">id</span>`,`user_name`,`password`,`is_admin`,`createdAt`,`updatedAt`) VALUES (DEFAULT,?,?,?,?,?);</span><br><span class="line">sai_user &#123;</span><br><span class="line">  dataValues: &#123;</span><br><span class="line">    is_admin: <span class="literal">false</span>,</span><br><span class="line">    <span class="built_in">id</span>: 1,</span><br><span class="line">    user_name: <span class="string">&#x27;邵洋&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;do&#x27;</span>,</span><br><span class="line">    updatedAt: 2022-07-26T15:08:52.849Z,</span><br><span class="line">    createdAt: 2022-07-26T15:08:52.849Z</span><br><span class="line">  &#125;,</span><br><span class="line">  _previousDataValues: &#123;</span><br><span class="line">    user_name: <span class="string">&#x27;邵洋&#x27;</span>,</span><br><span class="line">    password: <span class="string">&#x27;do&#x27;</span>,</span><br><span class="line">    <span class="built_in">id</span>: 1,</span><br><span class="line">    is_admin: <span class="literal">false</span>,</span><br><span class="line">    createdAt: 2022-07-26T15:08:52.849Z,</span><br><span class="line">    updatedAt: 2022-07-26T15:08:52.849Z</span><br><span class="line">  &#125;,</span><br><span class="line">  uniqno: 1,</span><br><span class="line">  _changed: Set(0) &#123;&#125;,</span><br><span class="line">  _options: &#123;</span><br><span class="line">    isNewRecord: <span class="literal">true</span>,</span><br><span class="line">    _schema: null,</span><br><span class="line">    _schemaDelimiter: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    attributes: undefined,</span><br><span class="line">    include: undefined,</span><br><span class="line">    raw: undefined,</span><br><span class="line">    silent: undefined</span><br><span class="line">  &#125;,</span><br><span class="line">  isNewRecord: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要返回给用户<code>dataValues</code>的结果</p>
<p>对于其他的值，在<code>service</code>层就可以直接过滤掉，直接返回<code>res.dataValues</code></p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    <span class="comment">// 主要用来操作数据库</span></span><br><span class="line">    <span class="comment">// 处理函数对应数据库的操作，就是增删改查</span></span><br><span class="line">    <span class="comment">// 注册，就是往数据库里，增加一条记录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123; <span class="comment">// 当参数超过三个时，建议用一个对象</span></span><br><span class="line">        <span class="comment">//@<span class="doctag">TODO:</span> 写入数据库</span></span><br><span class="line">        <span class="comment">// 插入数据</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123; user_name, password &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>那么<code>controller</code>层拿到返回的数据后，再根据接口文档，构建最终要返回给客户端的数据格式</p>
<p>注册接口：</p>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户注册成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>失败</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10001&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户名或密码不能为空&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>修改控制层</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="comment">// console.log(ctx.request.body)</span></span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="comment">// 2.操作数据库</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">        <span class="comment">// console.log(res)</span></span><br><span class="line">        <span class="comment">// 3.返回结果</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>再次使用<code>apifox</code>测试下<code>register</code>接口，注意要使用新的样例（不要重复注册，目前没做异常处理）</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727060131292.png" alt="image-20220727060131292"></p>
<p>整个的流程小结：</p>
<p>用户发送请求，<code>koa</code>服务接受到请求，先导入各种中间件，然后处理路由，根据路由调用处理函数（控制层），处理函数中涉及业务逻辑及数据库操作（服务层），服务层根据模型层，返回给控制层操作数据库的结果，控制层根据该结果封装接口数据，返回给路由，最后<code>koa</code>将路由的结果，作为接口响应发送到服务端</p>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>重复注册和没有用户名，目前都会返回<code>500</code>，错误类型不够细致</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727061109390.png" alt="image-20220727061109390"></p>
<p>后台是可以看到两次操作的错误提示的</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727061249819.png" alt="image-20220727061249819"></p>
<p>对于不同的错误类型，我们要分别处理</p>
<p>在控制层接受到用户参数时，要进行验证</p>
<ul>
<li><p>合法性验证</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="comment">// 合法性验证</span></span><br><span class="line">        <span class="keyword">if</span>(!user_name || !password) &#123;</span><br><span class="line">            <span class="comment">// 记录错误信息，后续可以记录到错误日志中</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>)</span><br><span class="line">            ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="comment">// 自定义的，公司一般会有开发规范</span></span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="comment">// 合法性验证不通过的话，直接返回</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 验证通过后，再去操作数据库</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>参数只写一个字段，测试一下注册接口：<br><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727062331691.png" alt="image-20220727062331691"></p>
<p>可以看到后台，打印的错误日志</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727062455540.png" alt="image-20220727062455540"></p>
</li>
<li><p>合理性验证</p>
<ul>
<li><p><code>controller</code>层，需要根据传入的参数，查询数据库</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createUser, getUserInfo&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;user_name, password&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="keyword">if</span>(!user_name || !password) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>)</span><br><span class="line">            ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 合理性验证</span></span><br><span class="line">        <span class="comment">// 需要再次查询数据库 getUserInfo</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123;user_name&#125;)) &#123; <span class="comment">// 根据用户名来查询，参数使用对象，这样可以让查询参数不受顺序影响</span></span><br><span class="line">            ctx.<span class="property">status</span> = <span class="number">409</span> <span class="comment">// 状态完成冲突，不熟悉的话，可以去MDN上看下常见状态码</span></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>service</code>层中新增<code>getUserInfo</code>方法</p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123; user_name, password &#125;)</span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getUserInfo</span>(<span class="params">&#123;id, user_name, password, is_admin&#125;</span>) &#123; <span class="comment">// 参数设计成一个对象，因为查询用户，有可能根据id、user_name、password、is_admin字段去查询</span></span><br><span class="line">        <span class="comment">// 判断参数是否存在，拿到实参</span></span><br><span class="line">        <span class="keyword">const</span>  whereOpt = &#123;&#125;</span><br><span class="line">        id &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;id&#125;)</span><br><span class="line">        user_name &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;user_name&#125;)</span><br><span class="line">        password &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;password&#125;)</span><br><span class="line">        is_admin &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;is_admin&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用ORM查询接口：findOne，这是一个异步函数</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;user_name&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;is_admin&#x27;</span>],</span><br><span class="line">            <span class="attr">where</span>: whereOpt</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res ? res.<span class="property">dataValues</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>测试下接口返回值</p>
<p>选一个数据库中已经有的用户名进行测试</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727070845751.png" alt="image-20220727070845751"></p>
<p>后代打印的<code>sql</code></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727070942651.png" alt="image-20220727070942651"></p>
</li>
</ul>
</li>
</ul>
<h3 id="错误处理函数封装"><a href="#错误处理函数封装" class="headerlink" title="错误处理函数封装"></a>错误处理函数封装</h3><p>我们可以把格式的验证，单独封装成一个中间件（处理函数）</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220727071500267.png" alt="image-20220727071500267"></p>
<p>在<code>controller</code>层拆分中间件</p>
<p>新建<code>middleware/user.middleware.js</code>，中间件里定义各种函数，然后导出</p>
<p><code>user.middleware.js</code></p>
<p>从<code>controller</code>里把合法性验证的代码抽离出来</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">userValidator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user_name || !password) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// 校验没通过，直接返回</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>() <span class="comment">// 校验通过了的话，就放行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么什么时候执行中间件呢？</p>
<p>在路由匹配的时候，只要路由一匹配上，就立刻调用校验的中间件</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用<code>apifox</code>测试一下，可以正常打印错误日志</p>
<p>再抽离查询用户的代码（合理性验证）</p>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; getUserInfo &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">userValidator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user_name || !password) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">400</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>() </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">409</span></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator,</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator, verifyUser &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, verifyUser, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, login)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p>测试下用户名已存在的情况，正常</p>
<p>至此，逻辑已经很清晰了，但我们还可以进一步管理<strong>错误信息</strong></p>
<h3 id="统一错误管理"><a href="#统一错误管理" class="headerlink" title="统一错误管理"></a>统一错误管理</h3><p>在<code>koa</code>中，怎么进行错误管理呢？</p>
<ul>
<li>中间件里提交错误类型</li>
</ul>
<p>通过<code>ctx.app</code>可以拿到实例化的<code>koa</code>对象，它有一个<code>emit</code>方法用来提交错误，我们可以对此做一个检测</p>
<p><code>ctx.app.emit(&#39;error&#39;, &#123;&#125;, ctx)</code></p>
<ul>
<li>该对象是自定义的错误类型，可以统一放在一个新的文件里管理</li>
</ul>
<p>新建<code>src/constant</code>常量文件夹</p>
<p>新建<code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">userFormateError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userAlreadyExists</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改<code>user.middle.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; getUserInfo &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userFormateError, userAlreadyExists &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">userValidator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!user_name || !password) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名或密码为空&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        <span class="comment">// ctx.status = 400</span></span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userFormateError, ctx) <span class="comment">// 该对象是自定义的错误类型，可以统一放在一个新的文件里管理</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        <span class="comment">// ctx.status = 409</span></span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)	</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator,</span><br><span class="line">    verifyUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>app/index.js</code>中统一进行错误处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errorHandler&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line"><span class="keyword">const</span> indexRouter = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line">indexRouter.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;   </span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`Request Body: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(ctx.request.body)&#125;</span>`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(indexRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一进行错误处理</span></span><br><span class="line"><span class="comment">// 发布订阅模式</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同级目录下，新建<code>errHandler.js</code>错误处理函数</p>
<p><code>errHandler.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> status = <span class="number">500</span> <span class="comment">// 默认错误状态码</span></span><br><span class="line">    <span class="keyword">switch</span> (err.<span class="property">code</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;10001&#x27;</span>:</span><br><span class="line">            status = <span class="number">400</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;10002&#x27;</span>:</span><br><span class="line">            status = <span class="number">409</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            status = <span class="number">500</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">status</span> = status</span><br><span class="line">    ctx.<span class="property">body</span> = err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="小问题"><a href="#小问题" class="headerlink" title="小问题"></a>小问题</h3><p><code>verifyUser</code>中间件调用的<code>getUserInfo</code>返回的是一个<code>Promise</code>对象，恒为真，正常注册流程也走不下去了</p>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改</p>
<ul>
<li><p>添加<code>await</code>，相当于判断条件是一个表达式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)) &#123;</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p>另外假设中间件都没问题，到了控制层<code>createUser</code>这一步了，目前我们对这一步做任何的异常处理，使用<code>try-catch</code>来处理下</p>
<p>虽说这一步是<code>sequelize</code>自己操作的数据库，不大可能会出错，但为了代码的健壮性，还是要处理下的</p>
<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createUser &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userRegisterError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">register</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">		</span><br><span class="line">        <span class="comment">// 处理写入用户数据时，可能出现的异常</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createUser</span>(user_name, password)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;用户注册成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: &#123;</span><br><span class="line">                    <span class="attr">id</span>: res.<span class="property">id</span>,</span><br><span class="line">                    <span class="attr">user_name</span>: res.<span class="property">user_name</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userRegisterError, ctx)</span><br><span class="line">			<span class="keyword">return</span> <span class="comment">// 发生错误就不要继续往下执行了</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;用户登录成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserController</span>()</span><br></pre></td></tr></table></figure>

<p>定义错误类型</p>
<p><code>constant/error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">userFormateError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userAlreadyExists</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userRegisterError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10003&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户注册错误&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在<code>createUser</code>方法中，模拟下写入数据库时发生了错误</p>
<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">User</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/user.model&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">user_name, password</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">create</span>(&#123; user_name, password &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(aa) <span class="comment">// 打印不存在的变量，模拟数据库操作错误</span></span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">UserService</span>()</span><br></pre></td></tr></table></figure>

<p>测试下</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220728194137316.png" alt="image-20220728194137316"></p>
<p>后台日志</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220728194219755.png" alt="image-20220728194219755"></p>
<p>建议调用<code>service</code>层所有的函数时，都加上错误处理</p>
<p>继续完善<code>verifyUser</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyUser</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户名已存在&#x27;</span>, &#123; user_name &#125;)</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userAlreadyExists, ctx)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">err</span>(<span class="string">&#x27;获取用户信息错误&#x27;</span>, err)</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userQueryError, ctx)</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    <span class="attr">userFormateError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10001&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名或者密码为空&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userAlreadyExists</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10002&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户名已经存在&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userRegisterError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10003&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户注册错误&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">userQueryError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10004&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;用户查询错误&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，真正要写代码的部分，其实是比较少的</p>
<p>很重要的一部分，在于提高代码的质量上，都在一些异常捕获和错误处理上，这一块是需要下功夫的，平时写代码的时候，要有这样的意识</p>
<p>这样当代码上线后，如果有问题，我们调试错误会很方便</p>
<p><code>ctx.app.emit</code>提交的错误，最后会以接口的形式返回给客户端，如果服务器自己想记录错误信息，可以使用<code>console.error()</code>来记录日志信息</p>
<p>目前来说，这里还是有一个问题，就是重复注册直接走到了<code>register</code>，验证重复用户名的中间件直接就通过了！！</p>
<p>原因是<code>getUserInfo</code>函数里的<code>User.findOne</code>是一个异步函数，需要加一个<code>await</code>，否则会出错</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">async</span> <span class="title function_">getUserInfo</span>(<span class="params">&#123;id, user_name, password, is_admin&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span>  whereOpt = &#123;&#125;</span><br><span class="line">        id &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;id&#125;)</span><br><span class="line">        user_name &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;user_name&#125;)</span><br><span class="line">        password &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;password&#125;)</span><br><span class="line">        is_admin &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(whereOpt, &#123;is_admin&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用ORM查询接口：findOne，这是一个异步函数</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;user_name&#x27;</span>, <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;is_admin&#x27;</span>],</span><br><span class="line">            <span class="attr">where</span>: whereOpt</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> res ? res.<span class="property">dataValues</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样重复注册走到<code>verifyUser</code>中间件时，就不会被当做异常处理</p>
<h3 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h3><p>在将密码保存到数据库之前，要对密码进行加密处理</p>
<p><code>md5</code>加密还是有可能被破解的，使用<code>bcrypt</code>加密</p>
<p>第一个依赖也多，这里我们使用第二个<code>bcryptjs</code>：在 JavaScript 中优化了 <code>bcrypt</code>，零依赖关系。</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220729054812130.png" alt="image-20220729054812130"></p>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i bcryptjs</span><br></pre></td></tr></table></figure>

<p>用法：有同步和异步的用法：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcryptjs">https://www.npmjs.com/package/bcryptjs</a></p>
<p>使用：</p>
<ul>
<li>将代码加密功能，也抽离成一个中间件（单一职责原则）<ul>
<li>不想<code>bcrypt</code>这种加密方式，耦合到代码中</li>
<li>后面有可能会换成其他加密方式：<code>hash</code>、<code>md5</code></li>
</ul>
</li>
</ul>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">scyptPassword</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">const</span> salt =  bcrypt.<span class="title function_">genSaltSync</span>(<span class="number">10</span>); <span class="comment">// 生成盐</span></span><br><span class="line">    <span class="keyword">const</span> hash = bcrypt.<span class="title function_">hashSync</span>(password, salt); <span class="comment">// 根据盐生成hash，hash保存的是密文</span></span><br><span class="line">    ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">password</span> = hash <span class="comment">// 使用hash覆盖password</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    userValidator,</span><br><span class="line">    verifyUser,</span><br><span class="line">    scyptPassword</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>user.route.js</code>导入并使用</p>
<p>测试注册接口成功后，查看<code>user</code>表<code>password</code>字段，已加密</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220729060929127.png" alt="image-20220729060929127"></p>
<p>仍存在的问题：密码在前端传给后端的过程中，是明文的，应该前端先加密，后端存储密文；而登录时，后面采用和前端一样的加密算法解密即可</p>
<h3 id="小结：注册接口"><a href="#小结：注册接口" class="headerlink" title="小结：注册接口"></a>小结：注册接口</h3><p>梳理一下整理流程，及每个模块的功能</p>
<h2 id="登录接口"><a href="#登录接口" class="headerlink" title="登录接口"></a>登录接口</h2><p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">`欢迎回来，<span class="subst">$&#123;user_name&#125;</span>`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完善<code>apifox</code></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220729062050491.png" alt="image-20220729062050491"></p>
<p>添加样例，应为数据库有已有的数据</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220729062118325.png" alt="image-20220729062118325"></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220729062229643.png" alt="image-20220729062229643"></p>
<p>但事实上，现在<code>login</code>对任何的输入都是可以的，我们需要对数据进行一个校验</p>
<ul>
<li><p>是否为空（合法性校验）</p>
<ul>
<li>复用</li>
</ul>
</li>
<li><p>是否存在（合理性校验）</p>
<ul>
<li>复用</li>
</ul>
</li>
<li><p>验证登录</p>
<p><code>user.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">verifyLogin</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 1.判断用户是否存在（不存在：报错）</span></span><br><span class="line">    <span class="keyword">const</span> &#123; user_name, password &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)</span><br><span class="line">        <span class="keyword">if</span> (!res) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;用户不存在&#x27;</span>, res)</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userNotFound, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.找到了用户，比对密码是否匹配（不匹配：报错）</span></span><br><span class="line">        <span class="keyword">if</span> (!bcrypt.<span class="title function_">compareSync</span>(password, res.<span class="property">password</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userInvalidPassword, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, userLoginFailed, ctx) <span class="comment">// getUserInfo出错，在不同场景下，抛出的错误应该是不同的</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>登录成功后记录用户状态</p>
<ul>
<li>用户认证与授权</li>
</ul>
</li>
</ul>
<h2 id="用户认证和授权"><a href="#用户认证和授权" class="headerlink" title="用户认证和授权"></a>用户认证和授权</h2><h3 id="颁发token"><a href="#颁发token" class="headerlink" title="颁发token"></a>颁发<code>token</code></h3><p>登录成功后，给用户颁发一个令牌<code>token</code>，用户在以后的每一次请求中，携带这个令牌</p>
<p>前后端分离中，使用<code>jwt</code>：<code>json web token</code></p>
<ul>
<li><code>header</code>：头部</li>
<li><code>payload</code>：载荷</li>
<li><code>signature</code>：签名</li>
</ul>
<p>如何使用</p>
<ul>
<li><p>使用<code>jsonwebtoken</code>包：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jsonwebtoken">https://www.npmjs.com/package/jsonwebtoken</a></p>
<ul>
<li>安装：<code>npm i jsonwebtoken</code></li>
<li><code>sign</code>方法生成<code>token</code></li>
</ul>
</li>
<li><p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; user_name &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">            <span class="comment">// 获取用户信息（在paylaod中，记录id、user_name、is_admin）</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 从返回结果中，过滤掉password，将剩下的属性，放在新的res对象中</span></span><br><span class="line">                <span class="keyword">const</span> &#123; password, ...res &#125; = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>(&#123; user_name &#125;)</span><br><span class="line">                ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;用户登录成功&#x27;</span>,</span><br><span class="line">                    <span class="attr">result</span>: &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        * @params1:配置对象</span></span><br><span class="line"><span class="comment">                        * @params2:秘钥</span></span><br><span class="line"><span class="comment">                        * @params3:过期时间，一天</span></span><br><span class="line"><span class="comment">                        */</span></span><br><span class="line">                        <span class="attr">token</span>: jwt.<span class="title function_">sign</span>(res, <span class="variable constant_">JWT_SECRET</span>, &#123;<span class="attr">expiresIn</span>: <span class="string">&#x27;1d&#x27;</span>&#125;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;用户登录失败&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730062107079.png" alt="image-20220730062107079"></p>
</li>
</ul>
<h3 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h3><p>我们新建一个修改密码的接口</p>
<p><img src="/image-20220730063834013.png" alt="image-20220730063834013"></p>
<p>修改的操作</p>
<ul>
<li><code>PUT</code>：全量修改</li>
<li><code>PATCH</code>：部分修改</li>
</ul>
<p>写对应的路由</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator, verifyUser, scyptPassword, verifyLogin &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, verifyUser, scyptPassword, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userValidator,  verifyLogin, login)</span><br><span class="line"><span class="comment">// 修改密码接口</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/modifyPassword&#x27;</span>, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;修改密码成功&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先简单测试下</p>
<p>我们在上面颁发<code>token</code>后，后续的请求（如修改密码）需要携带这个<code>token</code></p>
<p>请求头新增<code>Authorization</code>，值一开始固定的是<code>Bearer </code>，有一个空格</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730082130815.png" alt="image-20220730082130815"></p>
<p>后面发送请求时，需要加上签发的<code>token</code></p>
<p>新建<code>auth.middleware.js</code>文件，将认证相关的验证放在这里面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">JWT_SECRET</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../config/config.default&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; tokenExpiredError, invalidToken&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">auth</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 获取请求头的token</span></span><br><span class="line">    <span class="keyword">const</span> &#123; authorization = <span class="string">&#x27;Bearer &#x27;</span> &#125; = ctx.<span class="property">request</span>.<span class="property">header</span> <span class="comment">// 如果没带请求头，要给一个默认值</span></span><br><span class="line">    <span class="keyword">const</span> token = authorization.<span class="title function_">replace</span>(<span class="string">&#x27;Bearer &#x27;</span>,<span class="string">&#x27;&#x27;</span>) <span class="comment">// 这里要有一个空格</span></span><br><span class="line">    <span class="comment">// 根据自定义私钥，使用jwt验证token</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;token&#x27;</span>, token)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// user中包含了payload的信息：user_name, id, is_admin</span></span><br><span class="line">        <span class="keyword">const</span> user = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">JWT_SECRET</span>) <span class="comment">// 如果jwt.verify验证失败，会抛出一个异常</span></span><br><span class="line">        <span class="comment">// console.log(&#x27;user&#x27;, user)</span></span><br><span class="line">        ctx.<span class="property">state</span>.<span class="property">user</span> = user</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="comment">// console.log(&#x27;err name&#x27;, err.name)</span></span><br><span class="line">        <span class="comment">// jwt.verify异常情况有多种，可参照Npm文档 https://www.npmjs.com/package/jsonwebtoken</span></span><br><span class="line">        <span class="keyword">switch</span> (err.<span class="property">name</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;TokenExpiredError&#x27;</span>: <span class="comment">// jwt返回的错误类型</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;token已过期&#x27;</span>, err)</span><br><span class="line">                ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, tokenExpiredError, ctx)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;JsonWebTokenError&#x27;</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;无效的token&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, invalidToken, ctx)</span><br><span class="line">            <span class="attr">default</span>:</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;token错误&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    auth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义错误类型</span></span><br><span class="line"><span class="comment">// 100 用户模块</span></span><br><span class="line"><span class="comment">// 101 授权模块</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">    <span class="attr">tokenExpiredError</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10101&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;token已过期&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">invalidToken</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10102&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;无效的token&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在路由上，加上<code>token</code>认证的中间件</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/user&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; register, login &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/user.conroller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; userValidator, verifyUser, scyptPassword, verifyLogin &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/user.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; auth &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>, userValidator, verifyUser, scyptPassword, register)</span><br><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, userValidator, verifyLogin, login)</span><br><span class="line"><span class="comment">// 修改密码接口</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/modifyPassword&#x27;</span>, auth, <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123; <span class="comment">// 加上认证的中间件</span></span><br><span class="line">    ctx.<span class="property">body</span> = <span class="string">&#x27;修改密码成功&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接口测试工具中，将登录成功后颁发的<code>token</code>，存为全局变量</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730172723345.png" alt="image-20220730172723345">这样在修改密码的接口里，就可以不用复制<code>token</code>了</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730172826331.png" alt="image-20220730172826331"></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730172900867.png" alt="image-20220730172900867"></p>
<p>但这里有个不好的地方，我想测试下错误<code>token</code>的响应，是不支持修改的，测试的时候还是需要手动复制</p>
<p>正常接口返回的<code>user</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user &#123;</span><br><span class="line">  <span class="built_in">id</span>: 46,</span><br><span class="line">  user_name: <span class="string">&#x27;sai&#x27;</span>,</span><br><span class="line">  is_admin: <span class="literal">false</span>,</span><br><span class="line">  iat: 1659173449,</span><br><span class="line">  exp: 1659259849</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试无效的<code>token</code></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730173957547.png" alt="image-20220730173957547"></p>
<p>把<code>token</code>失效时间改为<code>5s</code>，测试过期<code>token</code>（记得测试完改回去）</p>
<p>重新登录后，测试下</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730174247201.png" alt="image-20220730174247201"></p>
<h4 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h4><p>测试没问题后，我们再加上加密的中间件，并正式写修改密码接口对应的处理函数</p>
<p><code>user.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改密码接口</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/modifyPassword&#x27;</span>, auth, scyptPassword, modifyPassword)</span><br></pre></td></tr></table></figure>

<p><code>user.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createUser, getUserInfo, updateById &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/user.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">modifyPassword</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="keyword">const</span> id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">        <span class="keyword">const</span> password = ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 操作数据库</span></span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">updateById</span>(&#123; id, password &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 返回结果</span></span><br><span class="line">            <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;修改密码成功&#x27;</span>,</span><br><span class="line">                    <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, modifyPasswordFailed, ctx)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;修改密码更新数据库失败&#x27;</span>, err)</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, modifyPasswordFailed, ctx)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(id, password)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>user.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">updateById</span>(<span class="params">&#123; id, user_name, password, is_admin &#125;</span>) &#123; <span class="comment">// 接口的设计要考虑到复用性，不要这次只是根据id修改密码，就只写这一个功能</span></span><br><span class="line">    <span class="keyword">const</span> whereOpt = &#123; id &#125;</span><br><span class="line">    <span class="keyword">const</span> newUser = &#123;&#125;</span><br><span class="line">    user_name &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(newUser, &#123; user_name &#125;)</span><br><span class="line">    password &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(newUser, &#123; password &#125;)</span><br><span class="line">    is_admin &amp;&amp; <span class="title class_">Object</span>.<span class="title function_">assign</span>(newUser, &#123; is_admin &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">update</span>(newUser, &#123;</span><br><span class="line">        <span class="attr">where</span>: whereOpt</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.log(&#x27;res&#x27;, res, typeof res) // 返回是一个数组</span></span><br><span class="line">    <span class="keyword">return</span> res[<span class="number">0</span>] &gt; <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小问题：入参为空对象时，应该做处理；修改密码还是原密码时，应该做处理</p>
<h2 id="商品模块"><a href="#商品模块" class="headerlink" title="商品模块"></a>商品模块</h2><h3 id="整体流程打通"><a href="#整体流程打通" class="headerlink" title="整体流程打通"></a>整体流程打通</h3><p><strong>路由</strong></p>
<p>新建<code>router/goods.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/goods&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; upload &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/goods.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p><strong>控制器</strong></p>
<p>新建<code>controller/goods/controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="comment">// 根据实际业务，可以写的很复杂，比如支持word、excel、图片等资源上传</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">upload</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;商品上传成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">GoodsController</span>()</span><br></pre></td></tr></table></figure>

<p><code>app/index.js</code>	</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/user.route&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> goodsRouter = <span class="built_in">require</span>(<span class="string">&#x27;../router/goods.route&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line">app.<span class="title function_">use</span>(userRouter.<span class="title function_">routes</span>())</span><br><span class="line">app.<span class="title function_">use</span>(goodsRouter.<span class="title function_">routes</span>())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统一进行错误处理</span></span><br><span class="line"><span class="comment">// 发布订阅模式</span></span><br><span class="line">app.<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>测试接口</strong></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730191605224.png" alt="image-20220730191605224"></p>
<p>至此，整个流程已经打通</p>
<h3 id="自动加载路由"><a href="#自动加载路由" class="headerlink" title="自动加载路由"></a>自动加载路由</h3><p>上面我们在<code>app/index.js</code>注册路由时，需要手动一个个导入</p>
<p>可以使用<code>fs</code>模块实现自动导入</p>
<p>新建<code>router/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>()</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readdirSync</span>(__dirname).<span class="title function_">forEach</span>(<span class="function"><span class="params">file</span> =&gt;</span> &#123; <span class="comment">// readdirSync方法，以同步的方式获取文件名</span></span><br><span class="line">    <span class="comment">// console.log(file) // 当前目录下的所有文件名</span></span><br><span class="line">    <span class="keyword">if</span> (file !== <span class="string">&#x27;index.js&#x27;</span>) &#123; <span class="comment">// 过滤掉自身</span></span><br><span class="line">        <span class="keyword">let</span> r = <span class="built_in">require</span>(<span class="string">&#x27;./&#x27;</span> + file) <span class="comment">// 加载文件</span></span><br><span class="line">        router.<span class="title function_">use</span>(r.<span class="title function_">routes</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p>改写<code>app/index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>) <span class="comment">// 默认会找index.js</span></span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// use方法返回app自身</span></span><br><span class="line">app</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">koaBody</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>()) <span class="comment">// 请求类型不支持的话，会更友好的响应</span></span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>use(router.allowedMethods()) </code>，请求类型不支持的话，会更友好的响应</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220730193114786.png" alt="image-20220730193114786"></p>
<h3 id="封装管理员权限"><a href="#封装管理员权限" class="headerlink" title="封装管理员权限"></a>封装管理员权限</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ul>
<li>用户要登录<ul>
<li>先将<code>auth</code>中间件加上（认证）</li>
</ul>
</li>
<li>还要有管理员权限<ul>
<li>然后再添加一个判断管理员权限的中间件（授权）</li>
</ul>
</li>
</ul>
<p><code>goods.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/goods&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; upload &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/goods.controller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; auth, hasAdminPermission &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, auth, hasAdminPermission, upload)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p><code>auth.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; tokenExpiredError, invalidToken, hasNoAdminPermission &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hasAdminPermission</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; is_admin &#125; = ctx.<span class="property">state</span>.<span class="property">user</span></span><br><span class="line">    <span class="keyword">if</span> (!is_admin) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;该用户无管理员权限&#x27;</span>, ctx.<span class="property">state</span>.<span class="property">user</span>)</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, hasNoAdminPermission, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    auth,</span><br><span class="line">    hasAdminPermission</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="attr">hasNoAdminPermission</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10103&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;无管理员权限&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>然后注册<code>admin</code>用户，在数据库里<code>is_admin</code>字段的值改为<code>1</code>，接着用测试工具登录，然后测一下上传图片接口</p>
<h4 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h4><p><code>koa-body</code>是支持文件上传的（参数配置项，见<code>npm</code>）</p>
<ul>
<li><p><code>multipart</code>配置项默认是<code>false</code>，要改成<code>true</code></p>
</li>
<li><p><code>formidable</code>是一些关于文件上传的配置信息，<code>multipart</code>依赖<code>fomidabel</code>这个包</p>
<ul>
<li><code>uploadDir</code>：上传路径</li>
<li><code>keepExtensions</code>：保持后缀名</li>
</ul>
</li>
<li><p>会把上传成功的文件信息，挂载到<code>ctx.request.files</code>中</p>
<ul>
<li><p>可以上传多个文件</p>
</li>
<li><p>上传时需要约定好的一个<code>key</code>，表示具体的某一个文件，这里约定为<code>file</code></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220731074001576.png" alt="image-20220731074001576"></p>
</li>
</ul>
</li>
</ul>
<p>修改<code>app.index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>) <span class="comment">// 默认会找index.js</span></span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"><span class="comment">// use方法返回app自身</span></span><br><span class="line">app</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">koaBody</span>(&#123;</span><br><span class="line">        <span class="attr">multipart</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">formidable</span>: &#123;</span><br><span class="line">            <span class="comment">// 单独在src下新建一个upload文件夹，不推荐配置成../upload，这样的相对路径</span></span><br><span class="line">            <span class="comment">// 在option里相对路径不是相对于当前文件，是相对于proces.cwd()，指向当前脚本执行时所在的目录，可以打印一下</span></span><br><span class="line">            <span class="comment">// 使用node的path模块，写成绝对路径</span></span><br><span class="line">            <span class="attr">uploadDir</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>), </span><br><span class="line">            <span class="attr">keepExtensions</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们在<code>upload</code>处理函数里，打印下文件信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="comment">// 根据实际业务，可以写的很复杂，比如支持word、excel、图片等资源上传</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">upload</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;file&#x27;</span>, ctx.<span class="property">request</span>.<span class="property">files</span>.<span class="property">file</span>)</span><br><span class="line">        ctx.<span class="property">body</span> = <span class="string">&#x27;商品上传成功&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">GoodsController</span>()</span><br></pre></td></tr></table></figure>

<p>信息如下，有用的几个字段：<code>lastModifiedDate</code>、<code>mimetype</code>、<code>size</code>等</p>
<p>注意：不同版本的<code>koa-body</code>，里面的字段可能不一样，需要打印看下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">file PersistentFile &#123;</span><br><span class="line">  _events: [Object: null prototype] &#123; error: [Function (anonymous)] &#125;,</span><br><span class="line">  _eventsCount: 1,</span><br><span class="line">  _maxListeners: undefined,</span><br><span class="line">  lastModifiedDate: 2022-07-30T23:43:02.773Z,</span><br><span class="line">  filepath: <span class="string">&#x27;D:\\workspace\\github\\code\\project-workshop\\code-prac\\koa\\01\\src\\upload\\8d12dbfca3833df9df3594700.png&#x27;</span>,</span><br><span class="line">  newFilename: <span class="string">&#x27;8d12dbfca3833df9df3594700.png&#x27;</span>,</span><br><span class="line">  originalFilename: <span class="string">&#x27;blog.png&#x27;</span>,</span><br><span class="line">  mimetype: <span class="string">&#x27;image/png&#x27;</span>,</span><br><span class="line">  hashAlgorithm: <span class="literal">false</span>,</span><br><span class="line">  size: 257457,</span><br><span class="line">  _writeStream: WriteStream &#123;</span><br><span class="line">    fd: null,</span><br><span class="line">    path: <span class="string">&#x27;D:\\workspace\\github\\code\\project-workshop\\code-prac\\koa\\01\\src\\upload\\8d12dbfca3833df9df3594700.png&#x27;</span>,</span><br><span class="line">    flags: <span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">    mode: 438,</span><br><span class="line">    start: undefined,</span><br><span class="line">    pos: undefined,</span><br><span class="line">    bytesWritten: 257457,</span><br><span class="line">    closed: <span class="literal">false</span>,</span><br><span class="line">    _writableState: WritableState &#123;</span><br><span class="line">      objectMode: <span class="literal">false</span>,</span><br><span class="line">      highWaterMark: 16384,</span><br><span class="line">      finalCalled: <span class="literal">false</span>,</span><br><span class="line">      needDrain: <span class="literal">true</span>,</span><br><span class="line">      ending: <span class="literal">true</span>,</span><br><span class="line">      ended: <span class="literal">true</span>,</span><br><span class="line">      finished: <span class="literal">true</span>,</span><br><span class="line">      destroyed: <span class="literal">true</span>,</span><br><span class="line">      decodeStrings: <span class="literal">true</span>,</span><br><span class="line">      defaultEncoding: <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">      length: 0,</span><br><span class="line">      writing: <span class="literal">false</span>,</span><br><span class="line">      corked: 0,</span><br><span class="line">      <span class="built_in">sync</span>: <span class="literal">false</span>,</span><br><span class="line">      bufferProcessing: <span class="literal">false</span>,</span><br><span class="line">      onwrite: [Function: bound onwrite],</span><br><span class="line">      writecb: null,</span><br><span class="line">      writelen: 0,</span><br><span class="line">      afterWriteTickInfo: null,</span><br><span class="line">      buffered: [],</span><br><span class="line">      bufferedIndex: 0,</span><br><span class="line">      allBuffers: <span class="literal">true</span>,</span><br><span class="line">      allNoop: <span class="literal">true</span>,</span><br><span class="line">      pendingcb: 0,</span><br><span class="line">      constructed: <span class="literal">true</span>,</span><br><span class="line">      prefinished: <span class="literal">true</span>,</span><br><span class="line">      errorEmitted: <span class="literal">false</span>,</span><br><span class="line">      emitClose: <span class="literal">true</span>,</span><br><span class="line">      autoDestroy: <span class="literal">true</span>,</span><br><span class="line">      errored: null,</span><br><span class="line">      closed: <span class="literal">false</span>,</span><br><span class="line">      closeEmitted: <span class="literal">false</span>,</span><br><span class="line">      [Symbol(kOnFinished)]: []</span><br><span class="line">    &#125;,</span><br><span class="line">    _events: [Object: null prototype] &#123; error: [Function (anonymous)] &#125;,</span><br><span class="line">    _eventsCount: 1,</span><br><span class="line">    _maxListeners: undefined,</span><br><span class="line">    [Symbol(kFs)]: &#123;</span><br><span class="line">      appendFile: [Function: appendFile],</span><br><span class="line">      appendFileSync: [Function: appendFileSync],</span><br><span class="line">      access: [Function: access],</span><br><span class="line">      accessSync: [Function: accessSync],</span><br><span class="line">      <span class="built_in">chown</span>: [Function: <span class="built_in">chown</span>],</span><br><span class="line">      chownSync: [Function: chownSync],</span><br><span class="line">      <span class="built_in">chmod</span>: [Function: <span class="built_in">chmod</span>],</span><br><span class="line">      chmodSync: [Function: chmodSync],</span><br><span class="line">      close: [Function: close],</span><br><span class="line">      closeSync: [Function: closeSync],</span><br><span class="line">      copyFile: [Function: copyFile],</span><br><span class="line">      copyFileSync: [Function: copyFileSync],</span><br><span class="line">      <span class="built_in">cp</span>: [Function: <span class="built_in">cp</span>],</span><br><span class="line">      cpSync: [Function: cpSync],</span><br><span class="line">      createReadStream: [Function: createReadStream],</span><br><span class="line">      createWriteStream: [Function: createWriteStream],</span><br><span class="line">      exists: [Function: exists],</span><br><span class="line">      existsSync: [Function: existsSync],</span><br><span class="line">      fchown: [Function: fchown],</span><br><span class="line">      fchownSync: [Function: fchownSync],</span><br><span class="line">      fchmod: [Function: fchmod],</span><br><span class="line">      fchmodSync: [Function: fchmodSync],</span><br><span class="line">      fdatasync: [Function: fdatasync],</span><br><span class="line">      fdatasyncSync: [Function: fdatasyncSync],</span><br><span class="line">      fstat: [Function: fstat],</span><br><span class="line">      fstatSync: [Function: fstatSync],</span><br><span class="line">      fsync: [Function: fsync],</span><br><span class="line">      fsyncSync: [Function: fsyncSync],</span><br><span class="line">      ftruncate: [Function: ftruncate],</span><br><span class="line">      ftruncateSync: [Function: ftruncateSync],</span><br><span class="line">      futimes: [Function: futimes],</span><br><span class="line">      futimesSync: [Function: futimesSync],</span><br><span class="line">      lchown: [Function: lchown],</span><br><span class="line">      lchownSync: [Function: lchownSync],</span><br><span class="line">      lchmod: undefined,</span><br><span class="line">      lchmodSync: undefined,</span><br><span class="line">      <span class="built_in">link</span>: [Function: <span class="built_in">link</span>],</span><br><span class="line">      linkSync: [Function: linkSync],</span><br><span class="line">      lstat: [Function: lstat],</span><br><span class="line">      lstatSync: [Function: lstatSync],</span><br><span class="line">      lutimes: [Function: lutimes],</span><br><span class="line">      lutimesSync: [Function: lutimesSync],</span><br><span class="line">      <span class="built_in">mkdir</span>: [Function: <span class="built_in">mkdir</span>],</span><br><span class="line">      mkdirSync: [Function: mkdirSync],</span><br><span class="line">      mkdtemp: [Function: mkdtemp],</span><br><span class="line">      mkdtempSync: [Function: mkdtempSync],</span><br><span class="line">      open: [Function: open],</span><br><span class="line">      openSync: [Function: openSync],</span><br><span class="line">      opendir: [Function: opendir],</span><br><span class="line">      opendirSync: [Function: opendirSync],</span><br><span class="line">      readdir: [Function: readdir],</span><br><span class="line">      readdirSync: [Function: readdirSync],</span><br><span class="line">      <span class="built_in">read</span>: [Function: <span class="built_in">read</span>],</span><br><span class="line">      readSync: [Function: readSync],</span><br><span class="line">      readv: [Function: readv],</span><br><span class="line">      readvSync: [Function: readvSync],</span><br><span class="line">      readFile: [Function: readFile],</span><br><span class="line">      readFileSync: [Function: readFileSync],</span><br><span class="line">      <span class="built_in">readlink</span>: [Function: <span class="built_in">readlink</span>],</span><br><span class="line">      readlinkSync: [Function: readlinkSync],</span><br><span class="line">      <span class="built_in">realpath</span>: [Function],</span><br><span class="line">      realpathSync: [Function],</span><br><span class="line">      rename: [Function: rename],</span><br><span class="line">      renameSync: [Function: renameSync],</span><br><span class="line">      <span class="built_in">rm</span>: [Function: <span class="built_in">rm</span>],</span><br><span class="line">      rmSync: [Function: rmSync],</span><br><span class="line">      <span class="built_in">rmdir</span>: [Function: <span class="built_in">rmdir</span>],</span><br><span class="line">      rmdirSync: [Function: rmdirSync],</span><br><span class="line">      <span class="built_in">stat</span>: [Function: <span class="built_in">stat</span>],</span><br><span class="line">      statSync: [Function: statSync],</span><br><span class="line">      symlink: [Function: symlink],</span><br><span class="line">      symlinkSync: [Function: symlinkSync],</span><br><span class="line">      <span class="built_in">truncate</span>: [Function: <span class="built_in">truncate</span>],</span><br><span class="line">      truncateSync: [Function: truncateSync],</span><br><span class="line">      unwatchFile: [Function: unwatchFile],</span><br><span class="line">      <span class="built_in">unlink</span>: [Function: <span class="built_in">unlink</span>],</span><br><span class="line">      unlinkSync: [Function: unlinkSync],</span><br><span class="line">      utimes: [Function: utimes],</span><br><span class="line">      utimesSync: [Function: utimesSync],</span><br><span class="line">      watch: [Function: watch],</span><br><span class="line">      watchFile: [Function: watchFile],</span><br><span class="line">      writeFile: [Function: writeFile],</span><br><span class="line">      writeFileSync: [Function: writeFileSync],</span><br><span class="line">      write: [Function: write],</span><br><span class="line">      writeSync: [Function: writeSync],</span><br><span class="line">      writev: [Function: writev],</span><br><span class="line">      writevSync: [Function: writevSync],</span><br><span class="line">      Dir: [class Dir],</span><br><span class="line">      Dirent: [class Dirent],</span><br><span class="line">      Stats: [Function: Stats],</span><br><span class="line">      ReadStream: [Getter/Setter],</span><br><span class="line">      WriteStream: [Getter/Setter],</span><br><span class="line">      FileReadStream: [Getter/Setter],</span><br><span class="line">      FileWriteStream: [Getter/Setter],</span><br><span class="line">      _toUnixTimestamp: [Function: toUnixTimestamp],</span><br><span class="line">      F_OK: 0,</span><br><span class="line">      R_OK: 4,</span><br><span class="line">      W_OK: 2,</span><br><span class="line">      X_OK: 1,</span><br><span class="line">      constants: [Object: null prototype],</span><br><span class="line">      promises: [Getter]</span><br><span class="line">    &#125;,</span><br><span class="line">    [Symbol(kIsPerformingIO)]: <span class="literal">false</span>,</span><br><span class="line">    [Symbol(kCapture)]: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">hash</span>: null,</span><br><span class="line">  [Symbol(kCapture)]: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完善<code>upload</code>处理函数</p>
<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; fileUploadFailed &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">upload</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; file &#125; = ctx.<span class="property">request</span>.<span class="property">files</span></span><br><span class="line">        <span class="keyword">if</span> (file) &#123;</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;商品图片上传成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: &#123;</span><br><span class="line">                    <span class="attr">goods_img</span>: path.<span class="title function_">basename</span>(file.<span class="property">filepath</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, fileUploadFailed, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">GoodsController</span>()</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<p>每一种类型可以进一步携带<code>status</code>，这里没有做那么细</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="attr">fileUploadFailed</span>: &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;10201&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;商品图片上传失败&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220731075739871.png" alt="image-20220731075739871"></p>
<h4 id="静态资源回显"><a href="#静态资源回显" class="headerlink" title="静态资源回显"></a>静态资源回显</h4><p>现在我们希望对静态资源做一个回显，将某个目录设置成静态资源文件夹</p>
<p>安装<code>koa-static</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-static</span><br></pre></td></tr></table></figure>

<p><code>app/index.js</code>中使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">KoaStatic</span> =  <span class="built_in">require</span>(<span class="string">&#x27;koa-static&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>) <span class="comment">// 默认会找index.js</span></span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"><span class="comment">// use方法返回app自身</span></span><br><span class="line">app</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">koaBody</span>(&#123;</span><br><span class="line">        <span class="attr">multipart</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">formidable</span>: &#123;</span><br><span class="line">            <span class="attr">uploadDir</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>), </span><br><span class="line">            <span class="attr">keepExtensions</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title class_">KoaStatic</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>)))</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重启项目，可以通过<code>http://localhost:8000/4f791979542fe84e316506b00.png</code>访问静态资源（后面跟实际的文件名）</p>
<h4 id="前端实现上传图片"><a href="#前端实现上传图片" class="headerlink" title="前端实现上传图片"></a>前端实现上传图片</h4><p>后面会讲到</p>
<ul>
<li><code>form</code>表单</li>
<li><code>ajax</code></li>
</ul>
<h4 id="图片类型判断"><a href="#图片类型判断" class="headerlink" title="图片类型判断"></a>图片类型判断</h4><p>不能在<code>upload</code>处理函数里面校验，走到这一步时图片已经上传了</p>
<p>下面的方式不建议</p>
<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">upload</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; file &#125; = ctx.<span class="property">request</span>.<span class="property">files</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(file)</span><br><span class="line">    <span class="keyword">const</span> fileTypes = [<span class="string">&#x27;image/png&#x27;</span>, <span class="string">&#x27;image/jpg&#x27;</span>, <span class="string">&#x27;image/jpeg&#x27;</span>, <span class="string">&#x27;image/webp&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!fileTypes.<span class="title function_">includes</span>(file.<span class="property">mimetype</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, unSupportedFileType, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;商品图片上传成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: &#123;</span><br><span class="line">                <span class="attr">goods_img</span>: path.<span class="title function_">basename</span>(file.<span class="property">filepath</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, fileUploadFailed, ctx)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">unSupportedFileType</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10202&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;商品图不支持的文件类型&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试接口上传<code>txt</code>文件</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220731091404172.png" alt="image-20220731091404172"></p>
<p>但我们看到，后台文件其实已经上传了</p>
<p>更好的方式失去配置<code>formidable</code>，但如果要统一错误处理，还需要写专门的中间件去返回错误类型</p>
<h3 id="发布商品接口"><a href="#发布商品接口" class="headerlink" title="发布商品接口"></a>发布商品接口</h3><blockquote>
<p>路由</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /goods/release</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goods_name, goods_price, goods_num, goods_img</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;发布商品成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        id<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        goods_name<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        goods_price<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        goods_img<span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        goods_num<span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>新增路由</p>
<p><code>goods.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; upload, release &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/goods.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/release&#x27;</span>, auth, hasAdminPermission, release)</span><br></pre></td></tr></table></figure>



<h4 id="参数格式校验"><a href="#参数格式校验" class="headerlink" title="参数格式校验"></a>参数格式校验</h4><p>发布商品，除了需要认证、授权中间件，还需要参数格式校验的中间件</p>
<ul>
<li>如果使用<code>ts</code>写的话，自带类型校验</li>
</ul>
<p>新建<code>goods.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">validator</span> = <span class="keyword">async</span>(<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    validator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前写<code>user</code>模块的时候，我们是自己写的参数校验，不是说不好，实际写业务的时候，可以直接用社区里稳定的包</p>
<p><code>koa-parameter</code>或者其它（先跟着教程里的来，这个库是5年前的，并且周下载量 不高了）<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/koa-parameter%EF%BC%8C%E6%98%AF%E5%9F%BA%E4%BA%8E%60parameter%60%E8%BF%99%E4%B8%AA%E5%BA%93">https://www.npmjs.com/package/koa-parameter，是基于`parameter`这个库</a></p>
<p>安装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i koa-parameter</span><br></pre></td></tr></table></figure>

<p>在<code>app/index.js</code>中导入，并在路由注册之前，导入该中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Koa</span> = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> koaBody = <span class="built_in">require</span>(<span class="string">&#x27;koa-body&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">KoaStatic</span> =  <span class="built_in">require</span>(<span class="string">&#x27;koa-static&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> parameter = <span class="built_in">require</span>(<span class="string">&#x27;koa-parameter&#x27;</span>) <span class="comment">// 导入koa-parameter</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">&#x27;../router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> errHandler = <span class="built_in">require</span>(<span class="string">&#x27;./errHandler&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line"><span class="comment">// use方法返回app自身</span></span><br><span class="line">app</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">koaBody</span>(&#123;</span><br><span class="line">        <span class="attr">multipart</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">formidable</span>: &#123;</span><br><span class="line">            <span class="attr">uploadDir</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>), </span><br><span class="line">            <span class="attr">keepExtensions</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;))</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title class_">KoaStatic</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>)))</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">parameter</span>(app)) <span class="comment">// 传入app实例，在app原型对象上添加校验的方法：verifyParams</span></span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>完善校验逻辑</p>
<p><code>goods.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;goodsParamsError&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">validator</span> = <span class="keyword">async</span> (<span class="params">ctx, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ctx.<span class="title function_">verifyParams</span>(&#123;</span><br><span class="line">            <span class="attr">goods_name</span>: &#123;<span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">goods_price</span>: &#123;<span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">goods_num</span>: &#123;<span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">goods_img</span>: &#123;<span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        <span class="comment">// 把第三方的错误信息，传递到自定义的错误信息中，做一个统一</span></span><br><span class="line">        goodsParamsError.<span class="property">result</span> = err</span><br><span class="line">        ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, goodsParamsError, ctx)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    validator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">goodsParamsError</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10203&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;商品参数格式错误&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建发布商品接口，并测试</p>
<p>我们将价格参数写成字符串，错误提示正确：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220801191725388.png" alt="image-20220801191725388"></p>
<h4 id="发布商品写入数据库"><a href="#发布商品写入数据库" class="headerlink" title="发布商品写入数据库"></a>发布商品写入数据库</h4><p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; fileUploadFailed, unSupportedFileType, publishGoodsError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;createGoods&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/goods.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">upload</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; file &#125; = ctx.<span class="property">request</span>.<span class="property">files</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;file&quot;</span>, file)</span><br><span class="line">        <span class="keyword">const</span> fileTypes = [<span class="string">&#x27;image/png&#x27;</span>, <span class="string">&#x27;image/jpg&#x27;</span>, <span class="string">&#x27;image/jpeg&#x27;</span>, <span class="string">&#x27;image/webp&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> (file) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!fileTypes.<span class="title function_">includes</span>(file.<span class="property">mimetype</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, unSupportedFileType, ctx)</span><br><span class="line">            &#125;</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;商品图片上传成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: &#123;</span><br><span class="line">                    <span class="attr">goods_img</span>: path.<span class="title function_">basename</span>(file.<span class="property">filepath</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, fileUploadFailed, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">release</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123;createdAt, updatedAt, ...res&#125; = <span class="keyword">await</span> <span class="title function_">createGoods</span>(ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;发布商品成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, publishGoodsError, ctx) <span class="comment">// 不要把数据库相关的报错信息，暴露给前端</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">GoodsController</span>()</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">publishGoodsError</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10204&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;商品发布失败&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>goods.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Goods</span>  = <span class="built_in">require</span>(<span class="string">&#x27;../model/goods.model&#x27;</span>) <span class="comment">// 导入模型层时，不用解构赋值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">goodsService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createGoods</span>(<span class="params">goods</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">create</span>(goods)</span><br><span class="line">        <span class="keyword">return</span> res.<span class="property">dataValues</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title function_">goodsService</span>()</span><br></pre></td></tr></table></figure>

<p><code>goods.model.js</code></p>
<p>生成表结构后，记得注释掉<code>seq.sync()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">DataTypes</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Goods</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_goods&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">goods_name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品名称&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_price</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品价格&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_num</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品库存&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_img</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品图片的url地址&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建表后注释掉</span></span><br><span class="line"><span class="comment">// Goods.sync(&#123;force: true&#125;)</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Goods</span></span><br></pre></td></tr></table></figure>

<p>测试接口</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220801195958558.png" alt="image-20220801195958558"></p>
<h3 id="修改商品接口"><a href="#修改商品接口" class="headerlink" title="修改商品接口"></a>修改商品接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /goods/modify/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goods_name, goods_price, goods_num, goods_img</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;修改商品成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;goods_prcie&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>新建修改商品的测试接口</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802062718051.png" alt="image-20220802062718051"></p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802062725439.png" alt="image-20220802062725439"></p>
<p><code>goods.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/goods&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; upload, release, update &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/goods.controller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; auth, hasAdminPermission &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; validator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/goods.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// 商品图片上传接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, auth, hasAdminPermission, upload)</span><br><span class="line"><span class="comment">// 发布商品接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/release&#x27;</span>, auth, hasAdminPermission, validator, release)</span><br><span class="line"><span class="comment">// 修改商品接口</span></span><br><span class="line">router.<span class="title function_">put</span>(<span class="string">&#x27;/update/:id&#x27;</span>,auth, hasAdminPermission, validator, update)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">updateGoods</span>(ctx.<span class="property">params</span>.<span class="property">id</span>, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line">        <span class="keyword">if</span> (res) &#123;</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;修改商品成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, invalidGoodsId, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, updateGoodsError, ctx)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">invalidGoodsId</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10205&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;待修改的商品不存在&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span>  </span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">updateGoodsError</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10206&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;更新商品失败&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>:<span class="string">&#x27;&#x27;</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>goods.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">async</span> <span class="title function_">updateGoods</span>(<span class="params">id, goods</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">update</span>(goods, &#123; <span class="attr">where</span>: &#123; id &#125; &#125;) <span class="comment">// 这里的id记得加括号</span></span><br><span class="line">        <span class="keyword">return</span> res[<span class="number">0</span>] &gt; <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试接口</p>
<p>成功：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802062917097.png" alt="image-20220802062917097"></p>
<p>失败：</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802062940954.png" alt="image-20220802062940954"></p>
<h3 id="删除商品接口"><a href="#删除商品接口" class="headerlink" title="删除商品接口"></a>删除商品接口</h3><ul>
<li>硬删除（直接从数据库中删除）</li>
<li>软删除（通过字段标识是否删除）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /goods/remove/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;删除商品成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h4 id="硬删除"><a href="#硬删除" class="headerlink" title="硬删除"></a>硬删除</h4><p><code>goods.router.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/goods&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; upload, release, update, remove &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/goods.controller&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; auth, hasAdminPermission &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; validator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/goods.middleware&#x27;</span>)</span><br><span class="line"><span class="comment">// 商品图片上传接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, auth, hasAdminPermission, upload)</span><br><span class="line"><span class="comment">// 发布商品接口</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/release&#x27;</span>, auth, hasAdminPermission, validator, release)</span><br><span class="line"><span class="comment">// 修改商品接口</span></span><br><span class="line">router.<span class="title function_">put</span>(<span class="string">&#x27;/update/:id&#x27;</span>,auth, hasAdminPermission, validator, update)</span><br><span class="line"><span class="comment">// 删除接口</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">&#x27;/remove/:id&#x27;</span>, auth, hasAdminPermission, remove)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">removeGoods</span>(ctx.<span class="property">params</span>.<span class="property">id</span>)</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;商品删除成功&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>goods.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">async</span> <span class="title function_">removeGoods</span>(<span class="params">id</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">destroy</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;)</span><br><span class="line">        <span class="keyword">return</span> res[<span class="number">0</span>] &gt; <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="软删除"><a href="#软删除" class="headerlink" title="软删除"></a>软删除</h4><blockquote>
<p>扩展</p>
</blockquote>
<p>可以做成上下架的状态，考虑加一个状态字段，删除商品做成下架，下架商品更新字段值</p>
<p> 一般不会硬删除的</p>
<p>修改<code>goods.model.js</code></p>
<p><code>define</code>函数新增第三个参数，然后取消<code>sync</code>注释重新创建表</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">DataTypes</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Goods</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_goods&#x27;</span>, &#123; </span><br><span class="line">    <span class="attr">goods_name</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品名称&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_price</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品价格&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_num</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品库存&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_img</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品图片的url地址&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">    <span class="attr">paranoid</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建表后注释掉</span></span><br><span class="line"><span class="title class_">Goods</span>.<span class="title function_">sync</span>(&#123;<span class="attr">force</span>: <span class="literal">true</span>&#125;)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Goods</span></span><br></pre></td></tr></table></figure>

<p>重新执行后，商品表会多一个字段，删除时会更新一个时间戳，表示删除</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802215458234.png" alt="image-20220802215458234"></p>
<p>将硬删除改为软删除接口</p>
<p><code>goods.router.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下架商品，注意改成了post方法</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/remove/:id/off&#x27;</span>, auth, hasAdminPermission, remove)</span><br></pre></td></tr></table></figure>

<p>新建软删除测试接口，<code>deleteAt</code>字段有值，表示下架</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802220330688.png" alt="image-20220802220330688"></p>
<p>调通后，完善错误处理</p>
<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; fileUploadFailed, unSupportedFileType, publishGoodsError, invalidGoodsId &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">removeGoods</span>(ctx.<span class="property">params</span>.<span class="property">id</span>)</span><br><span class="line">        <span class="keyword">if</span>(res) &#123;</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;商品下架成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, invalidGoodsId, ctx)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>goods.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">removeGoods</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">destroy</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;) <span class="comment">// destroy的返回值，不是数组</span></span><br><span class="line">    <span class="keyword">return</span> res &gt; <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span> <span class="comment">// 返回值为0或1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试下架商品接口，</p>
<p>对于重复下架、下架不存在的商品，给出错误提示</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802221044222.png" alt="image-20220802221044222"></p>
<p><strong>上架接口</strong></p>
<p><code>goods.router.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上架商品</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/remove/:id/on&#x27;</span>, auth, hasAdminPermission, restore)</span><br></pre></td></tr></table></figure>

<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">restore</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">restoreGoods</span>(ctx.<span class="property">params</span>.<span class="property">id</span>)</span><br><span class="line">       <span class="keyword">if</span> (res) &#123;</span><br><span class="line">           ctx.<span class="property">body</span> = &#123;</span><br><span class="line">               <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">               <span class="attr">message</span>: <span class="string">&#x27;商品上架成功&#x27;</span>,</span><br><span class="line">               <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, invalidGoodsId, ctx)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>goods.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">restoreGoods</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">restore</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;)</span><br><span class="line">    <span class="keyword">return</span> res &gt; <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试上架接口，</p>
<p>对于重复上架、上架不存在的商品，给出错误提示</p>
<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220802221044222.png" alt="image-20220802221044222"></p>
<h3 id="商品列表接口"><a href="#商品列表接口" class="headerlink" title="商品列表接口"></a>商品列表接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET/goods</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pageNum(default=1)</span><br><span class="line">pageSize(default=10)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取商品成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> </span><br><span class="line">		<span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"> 			<span class="punctuation">&#123;</span></span><br><span class="line">            	<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            	<span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            	<span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        	<span class="punctuation">&#123;</span></span><br><span class="line">            	<span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            	<span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            	<span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>goods.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取商品列表</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/lists&#x27;</span>, findAll)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>goods.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(ctx.<span class="property">params</span>.<span class="property">query</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; pageNum = <span class="number">1</span>, pageSize = <span class="number">10</span> &#125; = ctx.<span class="property">request</span>.<span class="property">query</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">findGoods</span>(pageNum, pageSize)</span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;获取商品列表成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: res</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>goods.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findGoods</span>(<span class="params">pageNum, pageSize</span>) &#123;</span><br><span class="line">        <span class="comment">// 获取表记录数</span></span><br><span class="line">        <span class="keyword">const</span> count = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">count</span>() <span class="comment">// count()和findAll()将看不到软删除的记录</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取分页具体数据</span></span><br><span class="line">        <span class="keyword">const</span> offset = (pageNum - <span class="number">1</span>) * pageSize</span><br><span class="line">        <span class="keyword">const</span> rows = <span class="keyword">await</span> <span class="title class_">Goods</span>.<span class="title function_">findAll</span>(&#123; offset, <span class="attr">limit</span>: pageSize * <span class="number">1</span> &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回字段对应接口文档</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            pageNum,</span><br><span class="line">            pageSize,</span><br><span class="line">            <span class="attr">total</span>: count,</span><br><span class="line">            <span class="attr">list</span>: rows</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/image-20220803203126192.png" alt="image-20220803203126192"></p>
<p>这个接口还是有很多问题的，如参数校验、异常处理等</p>
<h2 id="购物车模块"><a href="#购物车模块" class="headerlink" title="购物车模块"></a>购物车模块</h2><h3 id="添加购物车"><a href="#添加购物车" class="headerlink" title="添加购物车"></a>添加购物车</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /carts</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goods_id</span><br></pre></td></tr></table></figure>

<ul>
<li>计算登录用户的<code>user_id</code>	<ul>
<li>如果该用户下的<code>goods_id</code>不存在，新建一条记录</li>
<li>如果该用户下的<code>goods_id</code>已存在，更新数量+1</li>
</ul>
</li>
</ul>
<blockquote>
<p>响应</p>
</blockquote>
<p><strong>购物车表</strong></p>
<p>表名：<code>sai_carts</code></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键，自增</td>
</tr>
<tr>
<td>goods_id</td>
<td>int</td>
<td>商品id</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>用户id</td>
</tr>
<tr>
<td>number</td>
<td>int</td>
<td>数量</td>
</tr>
<tr>
<td>selected</td>
<td>tinyint</td>
<td>0：没选中；1：选中</td>
</tr>
</tbody></table>
<p><code>cart.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/carts&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; validator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/cart.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; auth &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; add &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/cart.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, auth, validator, add)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>cart.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createOrUpdate&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/cart.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">add</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">            <span class="keyword">const</span> goods_id = ctx.<span class="property">request</span>.<span class="property">body</span>.<span class="property">goods_id</span></span><br><span class="line">    </span><br><span class="line">            <span class="keyword">const</span> res  = <span class="keyword">await</span> <span class="title function_">createOrUpdate</span>(user_id, goods_id)</span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;添加到购物车成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">CartController</span>()</span><br></pre></td></tr></table></figure>

<p><code>cart.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Cart</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/cart.model&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">Op</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>) <span class="comment">// 要以解构赋值的形式导入</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createOrUpdate</span>(<span class="params">user_id, goods_id</span>) &#123;</span><br><span class="line">        <span class="comment">// 根据user_id和goods_id同时查找</span></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">findOne</span>(&#123;</span><br><span class="line">            [<span class="title class_">Op</span>.<span class="property">and</span>]: &#123;</span><br><span class="line">                user_id,</span><br><span class="line">                goods_id</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 已经存在一条记录，将number + 1</span></span><br><span class="line">        <span class="keyword">if</span>(res) &#123;</span><br><span class="line">            <span class="keyword">await</span> res.<span class="title function_">increment</span>(<span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> res.<span class="title function_">reload</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">                user_id,</span><br><span class="line">                goods_id</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">CartService</span>()</span><br></pre></td></tr></table></figure>

<p><code>cart.model.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">DataTypes</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Cart</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_carts&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">goods_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品的id&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户的id&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">number</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品的数量&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">selected</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;是否选中&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cart.sync(&#123;force: true&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Cart</span></span><br></pre></td></tr></table></figure>

<p>小问题：这里&#x3D;我们没有对<code>goods_id</code>是否存在做校验，并且已经下架的商品是不能够进行操作的</p>
<p>要做一个真实的、可以商用的接口，不是那么简单的，会有很多的细节要考虑</p>
<h3 id="获取购物车列表"><a href="#获取购物车列表" class="headerlink" title="获取购物车列表"></a>获取购物车列表</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /carts</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pageNum(default=1)</span><br><span class="line">pageSize(default=10)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>表关联：<a target="_blank" rel="noopener" href="https://www.sequelize.com.cn/core-concepts/assocs">https://www.sequelize.com.cn/core-concepts/assocs</a></p>
<p><code>cart.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, auth, findAll)</span><br></pre></td></tr></table></figure>

<p><code>cart.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;pageNum = <span class="number">1</span>, pageSize = <span class="number">10</span>&#125; = ctx.<span class="property">request</span>.<span class="property">query</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">findCarts</span>(pageNum, pageSize)</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;获取购物车列表成功&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cart.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findCarts</span>(<span class="params">pageNum, pageSize</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> offset = (pageNum - <span class="number">1</span>) * pageSize</span><br><span class="line">    <span class="keyword">const</span> &#123; count, rows &#125; = <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">        <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;selected&#x27;</span>], <span class="comment">// 指定需要查找的字段</span></span><br><span class="line">        <span class="attr">offset</span>: offset,</span><br><span class="line">        <span class="attr">limit</span>: pageSize * <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        pageNum,</span><br><span class="line">        pageSize,</span><br><span class="line">        <span class="attr">total</span>: count,</span><br><span class="line">        <span class="attr">list</span>: rows</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加几件商品到购物车后，测试获取购物车列表的接口：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在需要做一个联表查询，查询具体的商品信息</p>
<p>现在是<code>cart</code>表要关联<code>goods</code>表（根据<code>cart</code>表里的<code>goods_id</code>去<code>goods</code>表里查询）</p>
<p><code>cart.model.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">DataTypes</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Goods</span> = <span class="built_in">require</span>(<span class="string">&#x27;./goods.model&#x27;</span>) <span class="comment">// 导入Goods模型</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Cart</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_carts&#x27;</span>, &#123;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cart.sync(&#123;force: true&#125;)</span></span><br><span class="line"><span class="title class_">Cart</span>.<span class="title function_">belongsTo</span>(<span class="title class_">Goods</span>, &#123;</span><br><span class="line">    <span class="attr">foreignKey</span>: <span class="string">&#x27;goods_id&#x27;</span>,</span><br><span class="line">    <span class="attr">as</span>: <span class="string">&#x27;goods_info&#x27;</span></span><br><span class="line">&#125;) <span class="comment">// 外键在Cart表里用belongsTo，否则用hasOne</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Cart</span></span><br></pre></td></tr></table></figure>

<p><code>cart.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Goods</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/goods.model&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">	<span class="keyword">async</span> <span class="title function_">findCarts</span>(<span class="params">pageNum, pageSize</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> offset = (pageNum - <span class="number">1</span>) * pageSize</span><br><span class="line">        <span class="keyword">const</span> &#123; count, rows &#125; = <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;number&#x27;</span>, <span class="string">&#x27;selected&#x27;</span>],</span><br><span class="line">            <span class="attr">offset</span>: offset,</span><br><span class="line">            <span class="attr">limit</span>: pageSize * <span class="number">1</span>,</span><br><span class="line">            <span class="attr">include</span>: &#123;</span><br><span class="line">                <span class="attr">model</span>: <span class="title class_">Goods</span>,</span><br><span class="line">                <span class="attr">as</span>: <span class="string">&#x27;goods_info&#x27;</span>, <span class="comment">// 指定查询结构的别名，和接口文档的字段保持一致</span></span><br><span class="line">                <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;goods_name&#x27;</span>, <span class="string">&#x27;goods_price&#x27;</span>, <span class="string">&#x27;goods_img&#x27;</span>] <span class="comment">// 这里的先后顺序，会反映到接口中的字段顺序</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            pageNum,</span><br><span class="line">            pageSize,</span><br><span class="line">            <span class="attr">total</span>: count,</span><br><span class="line">            <span class="attr">list</span>: rows</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>测试接口：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;证断影然度叫&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dummyimage.com/400x400&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;53.00&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;酸这争取&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dummyimage.com/400x400&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13.00&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;证断影然度叫&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dummyimage.com/400x400&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;53.00&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;酸这争取&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://dummyimage.com/400x400&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13.00&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果自己写<code>SQL</code>也可以，可以用<code>LEFT OUTER JOIN</code>做联表查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> `sai_carts`.`id`, `sai_carts`.`number`, `sai_carts`.`selected`, `goods_info`.`id` <span class="keyword">AS</span> `goods_info.id`, `goods_info`.`goods_name` <span class="keyword">AS</span> `goods_info.goods_name`, `goods_info`.`goods_img` <span class="keyword">AS</span> `goods_info.goods_img`, `goods_info`.`goods_price` <span class="keyword">AS</span> `goods_info.goods_price` <span class="keyword">FROM</span> `sai_carts` <span class="keyword">AS</span> `sai_carts` <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> `sai_goods` <span class="keyword">AS</span> `goods_info` <span class="keyword">ON</span> `sai_carts`.`goods_id` <span class="operator">=</span> `goods_info`.`id` <span class="keyword">AND</span> (`goods_info`.`deletedAt` <span class="keyword">IS</span> <span class="keyword">NULL</span>) LIMIT <span class="number">0</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p>一个接口把前端想要的所有信息都返回，避免两次网络请求（否则将根据<code>goods_id</code>又重新发送请求获取商品信息）</p>
<p>要多看看<code>sequelize</code>官方文档</p>
<h3 id="更新购物车"><a href="#更新购物车" class="headerlink" title="更新购物车"></a>更新购物车</h3><p>通过更新接口可以修改购物车中商品的选中状态和数量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATCH /carts/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">number, selected</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>cart.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新购物车</span></span><br><span class="line">router.<span class="title function_">patch</span>(</span><br><span class="line">    <span class="string">&#x27;/:id&#x27;</span>,</span><br><span class="line">    auth,</span><br><span class="line">    <span class="title function_">validator</span>(&#123;</span><br><span class="line">        <span class="attr">number</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">required</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">        <span class="attr">selected</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;bool&#x27;</span>,   <span class="attr">required</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    &#125;),</span><br><span class="line">    update</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>cart.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">      <span class="comment">// 解析参数</span></span><br><span class="line">      <span class="keyword">const</span> &#123; id &#125; = ctx.<span class="property">request</span>.<span class="property">params</span></span><br><span class="line">      <span class="keyword">const</span> &#123; number, selected &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 参数判断</span></span><br><span class="line">      <span class="keyword">if</span> (number === <span class="literal">undefined</span> &amp;&amp; selected === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          cartFormatError.<span class="property">message</span> = <span class="string">&#x27;number和selected不能同时为空&#x27;</span></span><br><span class="line">          <span class="keyword">return</span> ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, cartFormatError, ctx)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 操作数据库</span></span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">updateCarts</span>(&#123; id, number, selected &#125;)</span><br><span class="line"></span><br><span class="line">      ctx.<span class="property">body</span> = &#123;</span><br><span class="line">          <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">message</span>: <span class="string">&#x27;更新购物车成功&#x27;</span>,</span><br><span class="line">          <span class="attr">result</span>: res</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cartFormatError</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10301&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;购物车数据格式错误&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cart.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">updateCarts</span>(<span class="params">params</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; id, number, selected &#125; = params</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">findByPk</span>(id)</span><br><span class="line">    <span class="keyword">if</span>(!res) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    number !== <span class="literal">undefined</span> ? (res.<span class="property">number</span> =  number) : <span class="string">&#x27;&#x27;</span></span><br><span class="line">    selected !== <span class="literal">undefined</span> ? (res.<span class="property">selected</span> = selected) : <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> res.<span class="title function_">save</span>()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="刪除购物车"><a href="#刪除购物车" class="headerlink" title="刪除购物车"></a>刪除购物车</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /carts</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ids&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>cart.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除购物车，默认delete、get、head请求方法下,koa-body不会把请求体放到ctx.body中，需要在koa-body中开启：parsedMethods: [&#x27;POST&#x27;, &#x27;PUT&#x27;, &#x27;PATCH&#x27;, &#x27;DELETE&#x27;]</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">&#x27;/&#x27;</span>, auth, <span class="title function_">validator</span>(&#123; <span class="attr">ids</span>: <span class="string">&#x27;array&#x27;</span> &#125;), remove)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>app.index.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> <span class="title class_">Koa</span>()</span><br><span class="line">app</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">koaBody</span>(&#123;</span><br><span class="line">        <span class="attr">multipart</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">formidable</span>: &#123;</span><br><span class="line"></span><br><span class="line">            <span class="attr">uploadDir</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>), </span><br><span class="line">            <span class="attr">keepExtensions</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">parsedMethods</span>: [<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;PATCH&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>] <span class="comment">// 让其支持DELETE方法下，也写入body参数</span></span><br><span class="line">    &#125;))</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title class_">KoaStatic</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../upload&#x27;</span>)))</span><br><span class="line">    .<span class="title function_">use</span>(<span class="title function_">parameter</span>(app))</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">routes</span>())</span><br><span class="line">    .<span class="title function_">use</span>(router.<span class="title function_">allowedMethods</span>())</span><br><span class="line">    .<span class="title function_">on</span>(<span class="string">&#x27;error&#x27;</span>, errHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = app</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>cart.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; ids &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(ids)</span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">removeCarts</span>(ids)</span><br><span class="line"></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;删除购物车成功&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>cart.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">removeCarts</span>(<span class="params">ids</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">destroy</span>(&#123;</span><br><span class="line">            <span class="attr">where</span>: &#123;</span><br><span class="line">                <span class="attr">id</span>: &#123;</span><br><span class="line">                    [<span class="title class_">Op</span>.<span class="property">in</span>]: ids</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="全选中接口"><a href="#全选中接口" class="headerlink" title="全选中接口"></a>全选中接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /carts/selectAll</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<p>无</p>
<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="全不选中接口"><a href="#全不选中接口" class="headerlink" title="全不选中接口"></a>全不选中接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /carts/unSelectAll</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<p>无</p>
<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;蓝牙耳机&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_price&quot;</span><span class="punctuation">:</span> <span class="number">199.00</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;goods_img&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./32048091210.jpg&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p><code>cart.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全选 和 全部不选 ，其实可以合并起来写</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/selectAll&#x27;</span>, auth, selectAll)</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/unselectAll&#x27;</span>, auth, unSelectAll)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>cart.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">selectAll</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">            <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">selectAllCarts</span>(user_id)</span><br><span class="line"></span><br><span class="line">            ctx.<span class="property">body</span> = &#123;</span><br><span class="line">                <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;全部选中&#x27;</span>,</span><br><span class="line">                <span class="attr">result</span>: res</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">unSelectAll</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">unSelectAllCarts</span>(user_id)</span><br><span class="line"></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;全不选&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: res</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>cart.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">selectAllCarts</span>(<span class="params">user_id</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">update</span>(&#123; <span class="attr">selected</span>: <span class="literal">true</span> &#125;, &#123;</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">              user_id</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">unSelectAllCarts</span>(<span class="params">user_id</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Cart</span>.<span class="title function_">update</span>(&#123; <span class="attr">selected</span>: <span class="literal">false</span> &#125;, &#123;</span><br><span class="line">          <span class="attr">where</span>: &#123;</span><br><span class="line">              user_id</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取购物车商品总数量接口"><a href="#获取购物车商品总数量接口" class="headerlink" title="获取购物车商品总数量接口"></a>获取购物车商品总数量接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /carts/total</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<p>无</p>
<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取购物车商品数量成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">10</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>这个接口可以不写，直接在前端计算显示</p>
<h2 id="地址模块"><a href="#地址模块" class="headerlink" title="地址模块"></a>地址模块</h2><h3 id="添加地址接口"><a href="#添加地址接口" class="headerlink" title="添加地址接口"></a>添加地址接口</h3><p>这里我们做一下限制，假设只支持3个地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /address</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consignee, phone, address</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;添加地址成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        </span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>地址表</p>
<p>表名：<code>sai_address</code></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键，自增</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>用户id</td>
</tr>
<tr>
<td>consignee</td>
<td>varchar(255)</td>
<td>收货人</td>
</tr>
<tr>
<td>phone</td>
<td>char(11)</td>
<td>手机号</td>
</tr>
<tr>
<td>address</td>
<td>varchar(255)</td>
<td>收货地址</td>
</tr>
<tr>
<td>is_default</td>
<td>tinyint</td>
<td>0：不是默认，1：默认地址</td>
</tr>
</tbody></table>
<p><code>address.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/address&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; auth &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; validator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/address.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;create&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/address.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, auth, <span class="title function_">validator</span>(&#123;</span><br><span class="line">    <span class="attr">consignee</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">    <span class="attr">phone</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">format</span>: <span class="regexp">/^1\d&#123;10&#125;$/</span> &#125;, <span class="comment">// 简单的手机号正则</span></span><br><span class="line">    <span class="attr">address</span>: <span class="string">&#x27;string&#x27;</span></span><br><span class="line">&#125;), create)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>address.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; addressFormatError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">validator</span> = (<span class="params">rules</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> ctx.<span class="title function_">verifyParams</span>(rules)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">            addressFormatError.<span class="property">result</span> = err</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, addressFormatError, ctx)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    validator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不同模块的参数校验中间件，可以进一步封装的</p>
<p><code>address.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;createAddr&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/address.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddressController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">        <span class="keyword">const</span> &#123; consignee, phone, address &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createAddr</span>(&#123;user_id, consignee, phone, address&#125;)</span><br><span class="line"></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;添加地址成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: res</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AddressController</span>()</span><br></pre></td></tr></table></figure>

<p><code>address.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Address</span> = <span class="built_in">require</span>(<span class="string">&#x27;../model/address.model&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddressService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createAddr</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Address</span>.<span class="title function_">create</span>(addr)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">AddressService</span>()</span><br></pre></td></tr></table></figure>

<p><code>address.model.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">DataTypes</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Address</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_address&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户id&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">consignee</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;收货人姓名&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">phone</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">CHAR</span>(<span class="number">11</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;收货人手机号&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">address</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">STRING</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;收货人地址&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">is_default</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">BOOLEAN</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;是否为默认地址，0：不是，1：是&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Address.sync(&#123;force: true&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Address</span></span><br></pre></td></tr></table></figure>



<h3 id="获取地址列表接口"><a href="#获取地址列表接口" class="headerlink" title="获取地址列表接口"></a>获取地址列表接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /address</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求 参数</p>
</blockquote>
<p>无</p>
<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enim Duis id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18167553843&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;澳门特别行政区贵港市滨湖区&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nisi ullamco&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13157913140&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;陕西省揭阳市玛多县&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>address.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取地址</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, auth, findAll)</span><br></pre></td></tr></table></figure>

<p><code>address.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">     <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// const &#123; user_id: uid, createdAt, updatedAt, ...res &#125; = await findAllAddr(user_id) // 返回的是数组，过滤属性可以在service层</span></span><br><span class="line">     <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">findAllAddr</span>(user_id)</span><br><span class="line"></span><br><span class="line">     ctx.<span class="property">body</span> = &#123;</span><br><span class="line">         <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">         <span class="attr">message</span>: <span class="string">&#x27;获取地址成功&#x27;</span>,</span><br><span class="line">         <span class="attr">result</span>: res</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>address.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAllAddr</span>(<span class="params">user_id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Address</span>.<span class="title function_">findAll</span>(&#123;</span><br><span class="line">        <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;consignee&#x27;</span>, <span class="string">&#x27;phone&#x27;</span>, <span class="string">&#x27;address&#x27;</span>, <span class="string">&#x27;is_default&#x27;</span>],</span><br><span class="line">        <span class="attr">where</span>: &#123; user_id &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取地址成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enim Duis id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18167553843&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;澳门特别行政区贵港市滨湖区&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;is_default&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;commodo adipisicing officia&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18661881741&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;安徽省广元市青神县&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;is_default&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nisi ullamco&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13157913140&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;陕西省揭阳市玛多县&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;is_default&quot;</span><span class="punctuation">:</span> <span class="keyword">false</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h3 id="修改地址接口"><a href="#修改地址接口" class="headerlink" title="修改地址接口"></a>修改地址接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /address/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consignee, phone, address</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;修改列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enim Duis id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18167553843&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;澳门特别行政区贵港市滨湖区&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nisi ullamco&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13157913140&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;陕西省揭阳市玛多县&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>address.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改地址</span></span><br><span class="line">router.<span class="title function_">put</span>(<span class="string">&#x27;/:id&#x27;</span>, auth, <span class="title function_">validator</span>(&#123;</span><br><span class="line">    <span class="attr">consignee</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">    <span class="attr">phone</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">format</span>: <span class="regexp">/^1\d&#123;10&#125;$/</span> &#125;,</span><br><span class="line">    <span class="attr">address</span>: <span class="string">&#x27;string&#x27;</span></span><br><span class="line">&#125;), update)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>address.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">request</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">updateAddr</span>(id, ctx.<span class="property">request</span>.<span class="property">body</span>)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;更新地址成功&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>address.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">updateAddr</span>(<span class="params">id, addr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Address</span>.<span class="title function_">update</span>(addr, &#123; <span class="attr">where</span>: &#123; id &#125; &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;更新地址成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果修改后的地址需要回填，就需要进一步完善</p>
<h3 id="删除接口"><a href="#删除接口" class="headerlink" title="删除接口"></a>删除接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /address/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;enim Duis id&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;18167553843&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;澳门特别行政区贵港市滨湖区&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;consignee&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nisi ullamco&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;13157913140&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;陕西省揭阳市玛多县&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>address.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除地址</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">&#x27;/:id&#x27;</span>, auth, remove)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>address.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">remove</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> id = ctx.<span class="property">request</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">removeAddr</span>(id)</span><br><span class="line">       </span><br><span class="line">       ctx.<span class="property">body</span> = &#123;</span><br><span class="line">           <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">message</span>: <span class="string">&#x27;删除地址成功&#x27;</span>,</span><br><span class="line">           <span class="attr">result</span>: res</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>address.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">removeAddr</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Address</span>.<span class="title function_">destroy</span>(&#123; <span class="attr">where</span>: &#123; id &#125; &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;删除地址成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="设为默认接口"><a href="#设为默认接口" class="headerlink" title="设为默认接口"></a>设为默认接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATCH /address/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">无</span><br></pre></td></tr></table></figure>

<p><code>address.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除地址</span></span><br><span class="line">router.<span class="title function_">delete</span>(<span class="string">&#x27;/:id&#x27;</span>, auth, remove)</span><br></pre></td></tr></table></figure>

<p><code>address.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">setDefault</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">       <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">       <span class="keyword">const</span> id = ctx.<span class="property">request</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">setDefaultAddr</span>(user_id, id)</span><br><span class="line"></span><br><span class="line">       ctx.<span class="property">body</span> = &#123;</span><br><span class="line">           <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">           <span class="attr">message</span>: <span class="string">&#x27;设置默认地址成功&#x27;</span>,</span><br><span class="line">           <span class="attr">result</span>: res</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><code>address.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">setDefaultAddr</span>(<span class="params">user_id, id</span>) &#123;</span><br><span class="line">    <span class="comment">// 先把所有的地址都设置为非默认</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Address</span>.<span class="title function_">update</span>( </span><br><span class="line">        &#123; <span class="attr">is_default</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">where</span>: &#123; user_id &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="comment">// 再根据传的值，设置为默认地址</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Address</span>.<span class="title function_">update</span>(</span><br><span class="line">        &#123; <span class="attr">is_default</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">where</span>: &#123; id &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;设置默认地址成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="订单模块"><a href="#订单模块" class="headerlink" title="订单模块"></a>订单模块</h2><h3 id="生成订单接口"><a href="#生成订单接口" class="headerlink" title="生成订单接口"></a>生成订单接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /orders</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">address_id, goods_info, total</span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<p>成功</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;生成订单成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address_id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order_number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>订单表</p>
<p>表名：<code>sai_orders</code></p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>主键，自增</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>用户id</td>
</tr>
<tr>
<td>address_id</td>
<td>int</td>
<td>地址id</td>
</tr>
<tr>
<td>goods_info</td>
<td>text</td>
<td>商品信息，json字符</td>
</tr>
<tr>
<td>total</td>
<td>decimal(10,2)</td>
<td>订单总金额</td>
</tr>
<tr>
<td>order_number</td>
<td>char(16)</td>
<td>订单号，唯一订单标识</td>
</tr>
<tr>
<td>status</td>
<td>tinyint</td>
<td>订单状态（ 0：未支付，1：已支付，2：已发货，3：已签收，4：取消 ）</td>
</tr>
</tbody></table>
<p><code>order.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&#x27;@koa/router&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>(&#123; <span class="attr">prefix</span>: <span class="string">&#x27;/orders&#x27;</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; auth &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; validator &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/order.middleware&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; create &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../controller/order.controller&#x27;</span>)</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(</span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    auth,</span><br><span class="line">    <span class="title function_">validator</span>(&#123;</span><br><span class="line">        <span class="attr">address_id</span>: <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">        <span class="attr">goods_info</span>: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">        <span class="attr">total</span>: <span class="string">&#x27;string&#x27;</span></span><br><span class="line">    &#125;),</span><br><span class="line">    create</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router</span><br></pre></td></tr></table></figure>

<p><code>order.middleware.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; orderFormatError &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../constant/error.type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">validator</span> = (<span class="params">rules</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> ctx.<span class="title function_">verifyParams</span>(rules)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">            orderFormatError.<span class="property">result</span> = err</span><br><span class="line">            ctx.<span class="property">app</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, orderFormatError, ctx)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    validator</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>error.type.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">orderFormatError</span>: &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="string">&#x27;10401&#x27;</span>,</span><br><span class="line">    <span class="attr">message</span>: <span class="string">&#x27;数据格式错误&#x27;</span>,</span><br><span class="line">    <span class="attr">result</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>order.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; createOrder &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../service/order.service&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">create</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> user_id = ctx.<span class="property">state</span>.<span class="property">user</span>.<span class="property">id</span></span><br><span class="line">        <span class="keyword">const</span> &#123; address_id, goods_info, total &#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">        <span class="keyword">const</span> order_number = <span class="string">&#x27;sai&#x27;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">createOrder</span>(&#123;</span><br><span class="line">            user_id,</span><br><span class="line">            address_id,</span><br><span class="line">            goods_info,</span><br><span class="line">            total,</span><br><span class="line">            order_number</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        ctx.<span class="property">body</span> = &#123;</span><br><span class="line">            <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;生成订单成功&#x27;</span>,</span><br><span class="line">            <span class="attr">result</span>: res</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">OrderController</span>()</span><br></pre></td></tr></table></figure>

<p><code>order.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Order</span>  = <span class="built_in">require</span>(<span class="string">&#x27;../model/order.model&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">createOrder</span>(<span class="params">order</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Order</span>.<span class="title function_">create</span>(order)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">new</span> <span class="title class_">OrderService</span>()</span><br></pre></td></tr></table></figure>

<p><code>order.model.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> seq = <span class="built_in">require</span>(<span class="string">&#x27;../db/seq&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">DataTypes</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;sequelize&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Order</span> = seq.<span class="title function_">define</span>(<span class="string">&#x27;sai_orders&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">user_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;用户id&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">address_id</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">INTEGER</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;地址id&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">goods_info</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">TEXT</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;商品信息&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">total</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;订单总金额&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">order_number</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="title function_">CHAR</span>(<span class="number">16</span>),</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;订单号&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">status</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="title class_">DataTypes</span>.<span class="property">TINYINT</span>,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">defaultValue</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">comment</span>: <span class="string">&#x27;订单状态（ 0：未支付，1：已支付，2：已发货，3：已签收，4：取消 ）&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Order.sync(&#123;force: true&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Order</span></span><br></pre></td></tr></table></figure>

<p>正确响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;生成订单成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;user_id&quot;</span><span class="punctuation">:</span> <span class="number">48</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address_id&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[&#123;&#125;, &#123;&#125;, &#123;&#125;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="string">&quot;199.99&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;order_number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sai1659969030037&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;updatedAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-08-08T14:30:30.041Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;createdAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-08-08T14:30:30.041Z&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="订单列表接口"><a href="#订单列表接口" class="headerlink" title="订单列表接口"></a>订单列表接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /orders</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;pageNum&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>响应</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;messaeg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;获取订单列表成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;goods_info&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;order_number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>order.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取订单列表</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, auth, findAll)</span><br></pre></td></tr></table></figure>

<p><code>order.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAll</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;pageNum = <span class="number">1</span>,pageSize = <span class="number">10</span>, status = <span class="number">0</span>&#125; = ctx.<span class="property">request</span>.<span class="property">query</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">findAllOrder</span>(pageNum, pageSize, status)</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;获取订单列表成功&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>order.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">findAllOrder</span>(<span class="params">pageNum, pageSize, status</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; count, rows &#125; = <span class="keyword">await</span> <span class="title class_">Order</span>.<span class="title function_">findAndCountAll</span>(&#123;</span><br><span class="line">        <span class="attr">attributes</span>: [<span class="string">&#x27;goods_info&#x27;</span>, <span class="string">&#x27;total&#x27;</span>, <span class="string">&#x27;order_number&#x27;</span>, <span class="string">&#x27;status&#x27;</span>],</span><br><span class="line">        <span class="attr">where</span>: &#123;</span><br><span class="line">            status</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">offset</span>: (pageNum - <span class="number">1</span>) * pageSize,</span><br><span class="line">        <span class="attr">limit</span>: pageSize * <span class="number">1</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        pageNum,</span><br><span class="line">        pageSize,</span><br><span class="line">        <span class="attr">total</span>: count,</span><br><span class="line">        <span class="attr">list</span>: rows</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改订单接口"><a href="#修改订单接口" class="headerlink" title="修改订单接口"></a>修改订单接口</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PATCH /order/:id</span><br></pre></td></tr></table></figure>

<blockquote>
<p>请求参数</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>对于会员，可以取消订单（取消订单也是更新状态）</p>
<p><code>order.route.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改订单</span></span><br><span class="line">router.<span class="title function_">patch</span>(<span class="string">&#x27;/:id&#x27;</span>, auth, <span class="title function_">validator</span>(&#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&#x27;number&#x27;</span></span><br><span class="line">&#125;), update)</span><br></pre></td></tr></table></figure>

<p><code>order.controller.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">update</span>(<span class="params">ctx, next</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = ctx.<span class="property">request</span>.<span class="property">params</span>.<span class="property">id</span></span><br><span class="line">    <span class="keyword">const</span> &#123;status&#125; = ctx.<span class="property">request</span>.<span class="property">body</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">updateOrder</span>(id, status)</span><br><span class="line"></span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">        <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;更新订单状态成功&#x27;</span>,</span><br><span class="line">        <span class="attr">result</span>: res</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>order.service.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">updateOrder</span>(<span class="params">id, status</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="title class_">Order</span>.<span class="title function_">update</span>(&#123; status &#125;, &#123; <span class="attr">where</span>: &#123; id &#125; &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功响应</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;更新订单状态成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>






















































      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/07/25/web/%E8%BF%9B%E9%98%B6/Node.js/Koa/koa/" data-id="cldol83jf008s3cx65rsa9h54" data-title="Koa2搭建API服务" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Koa/" rel="tag">Koa</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web/其他/运维/Neovim/《Neovim 配置实战：从0到1打造自己的IDE》" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/" class="article-date">
  <time class="dt-published" datetime="2022-07-25T12:34:51.000Z" itemprop="datePublished">2022-07-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/">Neovim 配置实战：从0到1打造自己的IDE</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<p>源链接：<a target="_blank" rel="noopener" href="https://juejin.cn/book/7051157342770954277">Neovim 配置实战：从0到1打造自己的IDE - 陈新_nshen - 掘金小册 (juejin.cn)</a></p>
<p>对应的github：</p>
<p>花了我<code>26.91</code>大洋</p>
<h1 id="1-多年-VSCode-老粉，为什么最终转向-Neovim？"><a href="#1-多年-VSCode-老粉，为什么最终转向-Neovim？" class="headerlink" title="1.多年 VSCode 老粉，为什么最终转向 Neovim？"></a>1.多年 VSCode 老粉，为什么最终转向 Neovim？</h1><p>本人常年在 Windows 系统上做程序开发，虽然已经习惯使用 “VIM” 的快捷键指法好多年了，但一直使用的都是被称为宇宙第一开发工具 VSCode 下的  <a href="https://link.juejin.cn/?target=https://github.com/VSCodeVim/Vim">VSCodeVim</a> 插件，中间曾尝试配置过几次原生的 VIM，包括各种 GUI 的版本，最终都放弃了。</p>
<p>主要原因一个是 VSCode 实在是太强大了，应用商店有各种插件，涵盖 Web 开发的方方面面，装上基本不用配置就非常非常好用（ 虽然在早期的 VSCode 上的有好几个 VIM 相关的插件都各有各的 bug，但后期当 VSCodeVim 被微软收编后，其他插件都停止了更新。<a href="https://link.juejin.cn/?target=https://github.com/VSCodeVim/Vim">VSCodeVim</a> 在有了微软的投入后，也变得足够好用了）。最主要的是，我们还可以混用 VIM 的快捷键和 VSCode 的原生功能，比如  <code>Ctrl + Shift + p</code> 打开的无敌窗口调用 VSCode 的任意功能。</p>
<p>而当时的原生 VIM 这边配置太原始了，要在 <code>vimrc</code> 里写一堆看不懂的配置才能满足最基本使用。代码提示也不够智能，费大劲配置出来，效果还也不如 VSCode 默认配置。 而且在 Windows 上的支持也不是很好，除了在服务器上开发外，在本地做编辑器根本没有任何优势。</p>
<p>可是，随着  <a href="https://link.juejin.cn/?target=https://docs.microsoft.com/en-us/windows/wsl/">WSL 2</a> 和  <a href="https://link.juejin.cn/?target=https://github.com/microsoft/terminal">Windows Terminal</a> 的推出，Windows 命令行也有了 Unicode 和 UTF-8 字符，GPU 加速文本渲染引擎等支持。而  <a href="https://link.juejin.cn/?target=https://github.com/neovim/neovim">Neovim</a> 0.5.x 正式版推出后，更是内置了 LSP（<a href="https://link.juejin.cn/?target=https://microsoft.github.io/language-server-protocol/">Language Server Protocol</a>），代码提示的体验已经跟 VSCode 看齐了，<strong>现在的 VSCode 和原生 VIM 相比优势就不是那么明显了。</strong></p>
<p>与此同时，<a href="https://link.juejin.cn/?target=https://github.com/neovim/neovim">Neovim</a> 在 0.5.x 版本引入了 Lua 编程语言作为编辑器的一等语言，相比于传统的 VIM 脚本 ，Lua 是一门通用的编程语言，代码更清晰，运行速度也更快，语法也更简单，即使没学过 Lua 也能猜出大概意思，使配置文件更人性化，更易看懂，没有原生 VIM 那么硬核了。</p>
<p><strong>现在众多 VIM 插件都有了基于 Lua 的原生 Neovim 版本，使得 Neovim 脱离了传统 VIM 的束缚，可以真正的称之为现代化的开发工具了。</strong></p>
<p>反而 VSCode 每月都有一次强制的更新，给人的压迫感极大，<a href="https://link.juejin.cn/?target=https://code.visualstudio.com/updates">长长的 Release Notes</a> 中，不断地增加完全用不到的功能，你也只能被动接受，导致系统肉眼可见的越来越慢，越来越难用。而 Neovim 是以高度可定制性闻名的，你可以只配置你需要的功能，直接砍掉不喜欢的功能，或者干脆裸跑当成记事本都可以，这点上好于 VSCode 太多了。</p>
<p>最烦的还有 VSCode 并不会考虑到你的开发效率，使用中总有窗口弹出来，总有要你离开键盘用鼠标去点的按钮，而  Neovim 则可以天然的完全脱离鼠标，在任何窗口之间随意切换焦点，提升开发效率。</p>
<p>Neovim 的配置可以不断修改和改进。我觉得学会调教 Neovim 在程序开发生涯中是非常有意义的一件事，让编辑器适配你的习惯，而不是无限地追赶编辑器的更新，也是成为“ 10 倍速程序员” 必经之路。</p>
<p>如果你在 Google 上搜索 “Years Vim” ，会看到很多高手都已经自豪的使用 VIM 编辑器 10 年以上了，比如这篇 <a href="https://link.juejin.cn/?target=https://statico.github.io/vim3.html">VIM AFTER 15 YEARS</a> 或这篇 <a href="https://link.juejin.cn/?target=https://endler.dev/2018/ten-years-of-vim/">Ten Years of Vim</a> 等等，他们都会一直维护一个属于自己独一无二的配置，彼此各不相同，通过不断地调教，使之越来越适合自己，达到了“人剑合一”的境界。</p>
<p>这里我也展示一下自己配置的运行效果：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/82fd07bc9d6746be9c786009a0321b71tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="features2.gif"></p>
<p>我自己已经使用 VSCode 很多年了，这次下决心转移到 Neovim，看了很多文档，参考了很多配置资料，尝试了很多插件，也走了很多弯路，终于我的 Neovim 的配置已经完全可以满足目前我对代码编辑器的需求了。所以我想写成小册，把配置方法分享出来。</p>
<p>回想当初我在学习的时候，如果有这个小册，真的可以节省很多时间。所以也希望能帮助到你，通过对这个小册的学习，你将可以把 Neovim 配置成你希望的样子，也许跟我的完全不同。</p>
<p>在章节的安排上，分为 <strong>基建篇</strong> 和 <strong>代码篇</strong>。</p>
<p>在 <strong>基建篇</strong> 中，我们会先从最基础的如何安装 Neovim 始，接着介绍配置文件位置，以及我们应该如何组织配置文件、必备的基础配置、快捷键如何设置、插件如何安装和管理。然后通过逐个介绍目前流行的插件安装方式和使用方法来补全文本编辑器所需的所有功能。</p>
<p>基建篇完成后你将会得到一个现代化的文本编辑器。</p>
<p>在 <strong>代码篇</strong> 中，我们会补全程序开发相关的功能，包括如何实现代码高亮，什么是内置 LSP，如何配置 Neovim 内置 LSP，代码如何补全，如何设置自定义代码段，代码格式化，UI 可否再美化加强等。之后还会专门针对前端开发和 rust 开发所必备的插件配置介绍，一步一步帮助你将手中的 Neovim 装配成 VSCode 般的开发环境。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/7f4e9afbfa684e25ad4c5b2b913c7623tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="xmind.png"></p>
<p>本小册适合有一点 VIM 基础的使用者（至少知道怎么编辑文件和退出 VIM 😁），有志于提升开发效率与开发体验，却被网上零散过时的 VIM 配置教程困扰的同学们。</p>
<p>我们一起加油，早点成为 10x 程序员！</p>
<h1 id="2-Neovim-的安装与配置架构总览"><a href="#2-Neovim-的安装与配置架构总览" class="headerlink" title="2.Neovim 的安装与配置架构总览"></a>2.Neovim 的安装与配置架构总览</h1><p>本节是第一篇，我们要先介绍一下如何在 Windows 命令行环境下安装 Neovim，然后会对配置文件结构做一个总体的规划。</p>
<p>在安装 Neovim 之前，首先要确保你的电脑上有 WSL 2 环境，WSL 是 Windows Subsystem for Linux 的缩写，简单来讲就是在 Windows 上运行的 Linux 子系统。WSL 2 就是 WSL 的 2.0 版本。WSL 2 的安装方法在这里就不展开说了，如有需要请参考<a href="https://link.juejin.cn/?target=https://docs.microsoft.com/en-us/windows/wsl/install">官方指南</a>或其他教程。</p>
<p>我们假设您的系统已经成功安装 WSL 2，如果不确定是否安装过，可以打开 <code>cmd</code> 中运行 <code>wsl -l -v</code> 进行验证：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/3d2b4880841d45579e7677ae1095fcf0tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="wsl2.png"></p>
<p>跟上图一致，表示安装成功，可以看到我们安装的子系统为 <code>Ubuntu-18.04</code>，也是我推荐的系统。</p>
<p>后边的 <code>VERSION 2</code> 表示是在 <code>WSL2</code> 环境，成功后可以继续下一步。</p>
<p>由于我们的整个编辑器都要在命令行下运行，所以需要的终端工具必须支持 UTF8 字符， <code>cmd</code> 是不可以的，需要安装微软的 Windows Terminal。</p>
<h2 id="安装-Windows-Terminal"><a href="#安装-Windows-Terminal" class="headerlink" title="安装 Windows Terminal"></a>安装 Windows Terminal</h2><p>Windows Terminal 是微软开源的新一代终端工具，主要功能包括多个选项卡、窗格、Unicode和 UTF-8 字符支持，GPU 加速文本渲染引擎以及自定义主题、样式和配置。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/9437fd75bdcd44069d6461a9f16fe532tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="terminal.jpg"></p>
<p>推荐使用 <a href="https://link.juejin.cn/?target=https://www.microsoft.com/zh-cn/p/windows-terminal/">微软应用商店</a> 进行安装。安装后可以在 <code>设置</code> 里进行对外观进行设置，比如我在 <code>外观</code> 中打开了<code>深色主题</code>，在 <code>配色方案中</code> 可以选择 <code>One Half Dark</code>，如果在之后发现有快捷键出现冲突，可以在这里的 <code>操作</code> 中 删除了与 VIM 冲突的快捷键。</p>
<p>在这里最重要的设置，是字体设置，要选择包含 <strong>Nerd fonts</strong> 的字体。因为命令行中是不支持显示图标的，比如下图的文件夹图标，如果没有 Nerd fonts 则会显示成右边类似<strong>乱码</strong>的样子。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/b9724b1008424c04b970dcd2cf1b9c0atplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="nerdfonts4.png"></p>
<p>那么，什么是 Nerd fonts ？</p>
<blockquote>
<p>Nerd Fonts 是一个使用大量字体图标来解决程序员在开发过程中缺少合适字体的问题的项目。它可以从流行的字体图标库中将大量外部字体引入待开发的项目中，它支持的字体图标库包括 Font Awesome , Devicons , Octicons , and others。</p>
</blockquote>
<p>简单讲，Nerd fonts 就是把各种常见的 ‘iconic fonts’，打包到你常用的字体里，这样在命令行里就支持显示这些图标了。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/31609ce6810d4dbab0c84ce48aab6028tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="nerdfonts.png"></p>
<p>很多 <code>Neovim</code> 插件都会使用到这里的图标，必须正确安装才可以在命令行下正确显示 icons。</p>
<h2 id="安装-Nerd-fonts"><a href="#安装-Nerd-fonts" class="headerlink" title="安装 Nerd fonts"></a>安装 Nerd fonts</h2><p>Nerd fonts 本身并不是一种新的字体，而是把常用图标以打补丁的方式打到了常用字体上。</p>
<p>比如我在 VSCode 里最常用的是 <code>Fira Code</code> 字体，那么我就要去安装这个打了 Nerd fonts 补丁的 <code>FiraCode</code> 字体。或者你也可以到官网这里 <a href="https://link.juejin.cn/?target=https://www.nerdfonts.com/font-downloads">www.nerdfonts.com/font-downlo…</a> 找到你喜欢的字体。</p>
<p>这里我找到的字体的路径为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/ryanoasis/nerd-fonts/tree/master/patched-fonts/FiraCode/Regular/complete/</span><br></pre></td></tr></table></figure>

<p>注意要下载里边兼容 Windows 的版本，就是名为 <code>XXXX Windows Compatible.ttf</code>，下载后双击即可安装完成。</p>
<p>然后回到 Terminal 中点击 <strong>设置</strong>，<strong>外观</strong>，在字体选项里，选中刚才安装的带 <code>NF</code> 结尾的字体（NF：Nerd Fonts），保存。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/1f57f8fd18b84e9bb23eff999dcde775tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="nerdfonts2.png"></p>
<p>安装过后，命令行里就支持显示这些小图标了，为了测试是否成功，可以到这个网址：<a href="https://link.juejin.cn/?target=https://www.nerdfonts.com/cheat-sheet">www.nerdfonts.com/cheat-sheet</a></p>
<p>点击 <code>Show All Icons</code> 按钮，选择一个图标，点击右上角的 Copy Icon，然后粘贴到我们的 Terminal 命令行里。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/41dc19d7624041089a51e32d547a130etplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="nerdfonts3.png"></p>
<p>看到我复制的 <code>github</code> 和 <code>twitter</code> 小图标了吗，如果可以正确显示就是成功了。 准备工作完成，可以开始安装 Neovim 了。</p>
<h2 id="安装-Neovim"><a href="#安装-Neovim" class="headerlink" title="安装 Neovim"></a>安装 Neovim</h2><p>由于我的环境是 <code>Ubuntu-18.04</code>，所以要用 <code>apt</code> 安装 Neovim ，具体方法如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:neovim-ppa/unstable</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install neovim</span><br></pre></td></tr></table></figure>

<p>如果你这里出现报错，找不到 <code>add-apt-repository</code> 命令，这是因为系统缺少必要的依赖包，</p>
<p>需要先安装下边的包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install software-properties-common</span><br></pre></td></tr></table></figure>

<p>安装成功后，运行 <code>nvim --version</code> 即可输出版本信息，注意确认 <code>nvim</code> 版本必须为 <strong>0.6</strong> 以上。</p>
<p>我在编写这本小册时，显示为 <code>NVIM v0.7.0-dev</code> ，如果版本过低，说明没有成功添加 <code>ppa:neovim-ppa/unstable</code>，需要重新安装。</p>
<p>安装完成后可选步骤，替换默认的 vim <code>nvim ~/.bashrc</code>，添加别名：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> vim=<span class="string">&#x27;nvim&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> vi=<span class="string">&#x27;nvim&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> v=<span class="string">&#x27;nvim&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这样修改后，无论运行 vim、 vi 或 v 打开的都是 Neovim 了。安装到此也就完成了，如果你也安装成功了，那么恭喜你走完了万里长征的第一步，接下来就可以对 Neovim 进行一系列的定制了。不过在定制之前，还有一件事需要提前做好，那就是提前做好规划。</p>
<h2 id="配置总览"><a href="#配置总览" class="headerlink" title="配置总览"></a>配置总览</h2><p>虽然可以把所有配置写在一个文件里，但由于后续我们要配置很多东西，所以预先的规划是很有必要的，因为配置可能随时调整，需要随时打开、关闭某个功能的时候，尽量不要影响到其他功能。建议你在阅读时先跟着我的结构配置走，当你完成本小册的学习后，就可以根据你的需要随意调整了。</p>
<p>这里我先对本小册中的配置文件结构做一个总览，后续章节会逐个介绍。</p>
<p>整体结构：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── init.lua</span><br><span class="line">└── lua</span><br><span class="line">    ├── autocmds.lua</span><br><span class="line">    ├── basic.lua</span><br><span class="line">    ├── colorscheme.lua</span><br><span class="line">    ├── keybindings.lua</span><br><span class="line">    ├── lsp</span><br><span class="line">    │   ├── cmp.lua</span><br><span class="line">    │   ├── config</span><br><span class="line">    │   │   ├── bash.lua</span><br><span class="line">    │   │   ├── emmet.lua</span><br><span class="line">    │   │   ├── html.lua</span><br><span class="line">    │   │   ├── json.lua</span><br><span class="line">    │   │   ├── lua.lua</span><br><span class="line">    │   │   ├── markdown.lua</span><br><span class="line">    │   │   ├── pyright.lua</span><br><span class="line">    │   │   ├── rust.lua</span><br><span class="line">    │   │   └── ts.lua</span><br><span class="line">    │   ├── formatter.lua</span><br><span class="line">    │   ├── null-ls.lua</span><br><span class="line">    │   ├── setup.lua</span><br><span class="line">    │   └── ui.lua</span><br><span class="line">    ├── plugin-config</span><br><span class="line">    │   ├── bufferline.lua</span><br><span class="line">    │   ├── comment.lua</span><br><span class="line">    │   ├── dashboard.lua</span><br><span class="line">    │   ├── gitsigns.lua</span><br><span class="line">    │   ├── indent-blankline.lua</span><br><span class="line">    │   ├── lualine.lua</span><br><span class="line">    │   ├── nvim-autopairs.lua</span><br><span class="line">    │   ├── nvim-tree.lua</span><br><span class="line">    │   ├── nvim-treesitter.lua</span><br><span class="line">    │   ├── project.lua</span><br><span class="line">    │   ├── surround.lua</span><br><span class="line">    │   ├── telescope.lua</span><br><span class="line">    │   ├── toggleterm.lua</span><br><span class="line">    │   ├── vimspector.lua</span><br><span class="line">    │   └── which-key.lua</span><br><span class="line">    ├── plugins.lua</span><br><span class="line">    └── utils</span><br><span class="line">        ├── fix-yank.lua</span><br><span class="line">        ├── global.lua</span><br><span class="line">        └── im-select.lua</span><br></pre></td></tr></table></figure>

<p>首先 <strong>init.lua</strong> 是整个配置的入口文件，负责引用所有其他的模块，基本上想要打开或关闭某个插件只要在这里修改一行代码即可。</p>
<ul>
<li><p><strong>basic.lua：</strong> 基础配置，是对默认配置的一个重置。</p>
</li>
<li><p><strong>colorscheme.lua：</strong> 我们安装的主题皮肤配置，在这里切换主题。</p>
</li>
<li><p><strong>keybindings.lua：</strong> 快捷键的设置，所有插件的快捷键也都会放在这里。</p>
</li>
<li><p><strong>plugins.lua：</strong> 插件安装管理，插件安装或卸载全在这里设置。</p>
</li>
<li><p>lsp 文件夹：</p>
<p>是对 Neovim 内置 LSP 功能的配置，包括常见编程语言与语法提示等。</p>
<ul>
<li><strong>config</strong> <strong>：</strong> 文件夹包含各种语言服务器单独的配置文件。</li>
<li><strong>setup.lua</strong> <strong>：</strong> 内置 LSP 的配置。</li>
<li><strong>cmp.lua</strong> <strong>：</strong> 语法自动补全补全的配置，包括各种补全源，与自定义代码段。</li>
<li><strong>ui.lua：</strong> 对内置 LSP 功能增强和 UI 美化。</li>
<li><strong>formatter.lua：</strong> 独立代码格式化功能。</li>
</ul>
</li>
<li><p><strong>plugin-config 文件夹：</strong> 是对第三方插件的配置，未来每添加一个插件，这里就多一个配置文件。</p>
</li>
<li><p><strong>utils 文件夹：</strong> 是对常见问题的修改，包括输入法切换，针对 windows 的特殊配置等。</p>
</li>
</ul>
<p>目前 Neovim 的默认配置还不尽人意，还需要一些基础的配置。在下一节中，我们会先介绍如何对 Neovim 做一些基础配置。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>下载：<a target="_blank" rel="noopener" href="https://www.nerdfonts.com/">Nerd Fonts - Iconic font aggregator, glyphs&#x2F;icons collection, &amp; fonts patcher</a></p>
<p>选择字体：Agave Nerd Font</p>
<p>下载下来后，在windows系统上安装，然后xshell上设置一下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20220425171043801.png" alt="image-20220425171043801"></p>
<p>复制该链接上的<code>Icon</code>:<a target="_blank" rel="noopener" href="https://www.nerdfonts.com/cheat-sheet">https://www.nerdfonts.com/cheat-sheet</a></p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20220425171122978.png" alt="image-20220425171122978"></p>
<p>粘贴到终端上测试一下，没问题的话，就会显示图标了：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20220425171212058.png" alt="image-20220425171212058"></p>
<p>xhsell我还额外应用了主题，可能会合<code>neo-vim</code>的主题色冲突，建议使用默认的即可</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20220425172548567.png" alt="image-20220425172548567"></p>
<p><strong>补充结束</strong></p>
<h1 id="3-Neovim-有哪些需要关注的基础配置项？"><a href="#3-Neovim-有哪些需要关注的基础配置项？" class="headerlink" title="3.Neovim 有哪些需要关注的基础配置项？"></a>3.Neovim 有哪些需要关注的基础配置项？</h1><p>由于历史的原因， VIM 的很多默认设置都不太合理。Neovim 出现以后，虽然对 VIM 默认配置做很多修正，但它的定位仍然是文本编辑器，对于习惯 VSCode 等现代化的开发工具的开发者来说，内置的功能是远远不够，需要为添加插件做一些修正。</p>
<p>同时为了配置信息的跨版本安全，我们也应该把需要的配置信息明确地列出来，作为我们的第一层配置，也是对整个配置项的一个重置。</p>
<p>本节将会介绍如何创建这个配置。但在开始配置之前，我们要知道 Neovim 默认配置的入口在哪里。</p>
<h2 id="配置入口文件"><a href="#配置入口文件" class="headerlink" title="配置入口文件"></a>配置入口文件</h2><p>Neovim 配置文件入口与 VIM 不太一样，不是 <code>.vimrc</code> 。而是保存在用户Home目录中的 <code>~/.config/nvim/init.lua</code> 文件， 也可以是用 VIM 脚本写的 <code>init.vim</code> 文件。</p>
<p>不过 Neovim 未来的趋势应该会是全 Lua 化了。由于<code>Lua</code> 是一种很轻巧的脚本语言，体积小，启动速度快，也更通用，最重要的是语法简单，非常容易学习，所以我这里选择使用 <code>init.lua</code> 文件，请记住根目录的这个文件，后续课程中我每次提到 <strong>入口文件</strong> 就是指的这个文件。</p>
<p>当然，如果你是一个 VIM 老用户，你会有一些属于你的 VIM 脚本配置，那么使用 <code>init.vim</code> 也是可以的，而且 Neovim 未来也并不会取消对 VIM 脚本的支持，在 <code>.vim</code> 文件里也可以任意调用 Lua 的代码，所以你可以保留在 <code>init.vim</code> 中的配置，只在后边新加的配置中增量添加 Lua 代码。</p>
<h2 id="在-vim-中调用-lua"><a href="#在-vim-中调用-lua" class="headerlink" title="在 .vim 中调用 lua"></a>在 .vim 中调用 lua</h2><p>如果要从 <code>init.vim</code> 里写 <code>Lua</code>代码，通常要以 lua 关键字开头，类似这样：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lua</span> <span class="keyword">print</span>(<span class="string">&#x27;单行 lua&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>多行调用，则可以写成这样：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lua</span> &lt;&lt;EOF </span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;多行 lua&#x27;</span>) </span><br><span class="line"><span class="keyword">print</span>(<span class="string">&#x27;多行 lua&#x27;</span>) </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>加载其他 lua 文件，可以写成：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&quot; 加载 lua/basic.lua 文件，此行为注释 </span></span><br><span class="line"><span class="keyword">lua</span> require(<span class="string">&#x27;basic&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>由于我没有历史遗留，所以这里我使用全 Lua 编写，在 <code>~/.config/nvim/</code> 里创建全新的入口文件 <code>init.lua</code> 。</p>
<h2 id="配置入口-init-lua"><a href="#配置入口-init-lua" class="headerlink" title="配置入口 init.lua"></a>配置入口 init.lua</h2><p>我们在 <code>~/.config/nvim/init.lua</code> 里写入如下内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础设置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;basic&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>require</code> 函数在 Lua 中用于加载一个模块，而这些模块通常位于 <code>runtimepath</code> 中的 <code>lua/</code> 目录下，也就是我们的 <code>~/.config/nvim/lua/</code> 目录。</p>
<p>所以上边的代码，就是加载 <code>~/.config/nvim/lua/basic.lua</code> 文件（注意：require 里没有 <code>.lua</code> 扩展名）。当然也可以创建 <code>~/.config/nvim/lua/basic/</code> 目录，在目录下边创建 <code>init.lua</code> 文件也是可以成功加载的。</p>
<h2 id="基础配置文件-basic-lua"><a href="#基础配置文件-basic-lua" class="headerlink" title="基础配置文件 basic.lua"></a>基础配置文件 basic.lua</h2><p>创建对应的 <code>~/.config/nvim/lua/basic.lua</code> 文件，作为基础配置文件。</p>
<p>添加内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- utf8</span></span><br><span class="line">vim.g.encoding = <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">vim.o.fileencoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line"><span class="comment">-- jkhl 移动时光标周围保留8行</span></span><br><span class="line">vim.o.scrolloff = <span class="number">8</span></span><br><span class="line">vim.o.sidescrolloff = <span class="number">8</span></span><br><span class="line"><span class="comment">-- 使用相对行号</span></span><br><span class="line">vim.wo.number = <span class="literal">true</span></span><br><span class="line">vim.wo.relativenumber = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 高亮所在行</span></span><br><span class="line">vim.wo.cursorline = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 显示左侧图标指示列</span></span><br><span class="line">vim.wo.signcolumn = <span class="string">&quot;yes&quot;</span></span><br><span class="line"><span class="comment">-- 右侧参考线，超过表示代码太长了，考虑换行，可以不加，太丑了</span></span><br><span class="line"><span class="comment">--- vim.wo.colorcolumn = &quot;80&quot;</span></span><br><span class="line"><span class="comment">-- 缩进2个空格等于一个Tab</span></span><br><span class="line">vim.o.tabstop = <span class="number">2</span></span><br><span class="line">vim.bo.tabstop = <span class="number">2</span></span><br><span class="line">vim.o.softtabstop = <span class="number">2</span></span><br><span class="line">vim.o.shiftround = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- &gt;&gt; &lt;&lt; 时移动长度</span></span><br><span class="line">vim.o.shiftwidth = <span class="number">2</span></span><br><span class="line">vim.bo.shiftwidth = <span class="number">2</span></span><br><span class="line"><span class="comment">-- 空格替代tab</span></span><br><span class="line">vim.o.expandtab = <span class="literal">true</span></span><br><span class="line">vim.bo.expandtab = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 新行对齐当前行</span></span><br><span class="line">vim.o.autoindent = <span class="literal">true</span></span><br><span class="line">vim.bo.autoindent = <span class="literal">true</span></span><br><span class="line">vim.o.smartindent = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 搜索大小写不敏感，除非包含大写</span></span><br><span class="line">vim.o.ignorecase = <span class="literal">true</span></span><br><span class="line">vim.o.smartcase = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 搜索不要高亮</span></span><br><span class="line">vim.o.hlsearch = <span class="literal">false</span></span><br><span class="line"><span class="comment">-- 边输入边搜索</span></span><br><span class="line">vim.o.incsearch = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 命令行高为2，提供足够的显示空间</span></span><br><span class="line">vim.o.cmdheight = <span class="number">2</span></span><br><span class="line"><span class="comment">-- 当文件被外部程序修改时，自动加载</span></span><br><span class="line">vim.o.autoread = <span class="literal">true</span></span><br><span class="line">vim.bo.autoread = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 禁止折行</span></span><br><span class="line">vim.wo.<span class="built_in">wrap</span> = <span class="literal">false</span></span><br><span class="line"><span class="comment">-- 光标在行首尾时&lt;Left&gt;&lt;Right&gt;可以跳到下一行</span></span><br><span class="line">vim.o.whichwrap = <span class="string">&#x27;&lt;,&gt;,[,]&#x27;</span></span><br><span class="line"><span class="comment">-- 允许隐藏被修改过的buffer</span></span><br><span class="line">vim.o.hidden = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 鼠标支持</span></span><br><span class="line">vim.o.mouse = <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="comment">-- 禁止创建备份文件</span></span><br><span class="line">vim.o.backup = <span class="literal">false</span></span><br><span class="line">vim.o.writebackup = <span class="literal">false</span></span><br><span class="line">vim.o.swapfile = <span class="literal">false</span></span><br><span class="line"><span class="comment">-- smaller updatetime</span></span><br><span class="line">vim.o.updatetime = <span class="number">300</span></span><br><span class="line"><span class="comment">-- 设置 timeoutlen 为等待键盘快捷键连击时间500毫秒，可根据需要设置</span></span><br><span class="line">vim.o.timeoutlen = <span class="number">500</span></span><br><span class="line"><span class="comment">-- split window 从下边和右边出现</span></span><br><span class="line">vim.o.splitbelow = <span class="literal">true</span></span><br><span class="line">vim.o.splitright = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 自动补全不自动选中</span></span><br><span class="line">vim.g.completeopt = <span class="string">&quot;menu,menuone,noselect,noinsert&quot;</span></span><br><span class="line"><span class="comment">-- 样式</span></span><br><span class="line">vim.o.background = <span class="string">&quot;dark&quot;</span></span><br><span class="line">vim.o.termguicolors = <span class="literal">true</span></span><br><span class="line">vim.opt.termguicolors = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- 不可见字符的显示，这里只把空格显示为一个点</span></span><br><span class="line">vim.o.list = <span class="literal">true</span></span><br><span class="line">vim.o.listchars = <span class="string">&quot;space:·&quot;</span></span><br><span class="line"><span class="comment">-- 补全增强</span></span><br><span class="line">vim.o.wildmenu = <span class="literal">true</span></span><br><span class="line"><span class="comment">-- Dont&#x27; pass messages to |ins-completin menu|</span></span><br><span class="line">vim.o.shortmess = vim.o.shortmess .. <span class="string">&#x27;c&#x27;</span></span><br><span class="line"><span class="comment">-- 补全最多显示10行</span></span><br><span class="line">vim.o.pumheight = <span class="number">10</span></span><br><span class="line"><span class="comment">-- 永远显示 tabline</span></span><br><span class="line">vim.o.showtabline = <span class="number">2</span></span><br><span class="line"><span class="comment">-- 使用增强状态栏插件后不再需要 vim 的模式提示</span></span><br><span class="line">vim.o.showmode = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里用到的分类有</p>
<ul>
<li><code>vim.g.&#123;name&#125;</code>: 全局变量</li>
<li><code>vim.b.&#123;name&#125;</code>: 缓冲区变量</li>
<li><code>vim.w.&#123;name&#125;</code>: 窗口变量</li>
<li><code>vim.bo.&#123;option&#125;</code>: buffer-local 选项</li>
<li><code>vim.wo.&#123;option&#125;</code>: window-local 选项</li>
</ul>
<p>这样的分类初看上去是有些混乱的，有些时候想设置一个变量，确实很难判断应该放在哪个分类里。一般来说，全部设置在 <code>vim.opt</code> 下也是可以的，例如 <code>vim.opt.number = true</code> 也是有效的，只是我们上边设置到了比较详细位置而已，具体每个变量的分类可以在 :help 文档中查看。</p>
<p>不管怎么说， <code>basic.lua</code> 代码中都是一些非常常用的配置，基本上大家也都是这么配置的，所以如果你是新手的话，完全可以不用考虑太多，直接拷贝到你的配置里就可以了，当然我都写了注释，你也可以根据你的习惯不断进行微调，比如你喜欢使用 TAB 还是 SPACE，缩进2个空格还是4个空格等。需要注意的是一些重点设置项，接下来我们来看下。</p>
<h2 id="重点设置项"><a href="#重点设置项" class="headerlink" title="重点设置项"></a>重点设置项</h2><p>默认情况下，编辑器底部会以文本方式显示当前模式如： <code>-- INSERT --</code> ， <code>-- VISUAL --</code> 等。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/b386d4d893b24b4abed50c24f789c5batplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="5.gif"></p>
<p><code>vim.o.showmode = false</code> 表示关闭显示，这里是固定设置，因为我们后边章节会添加增强显示的插件，已经包含了其功能，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/38a601a67d084e67a7abae59fe28366ftplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="6.gif"></p>
<p>同样的， <code>vim.o.showtabline = 2</code> 也是固定设置，表示永远显示 tabline，因为后边也有对应的 tabline 插件，<code>vim.o.hidden = true</code> 在使用多个 buffer的时候是必需的，表示允许隐藏被修改过的 buffer。 否则会报 E37: No write since last change 错误，强制你保存当前buffer后才允许切换到其他的 buffer。</p>
<p>同样的还有 <code>vim.g.completeopt = &quot;menu,menuone,noselect,noinsert&quot;</code>，后边自动补全插件会用到。而 <code>vim.wo.signcolumn = &quot;yes&quot;</code> 会让左侧留出一列，用于符号显示，所以不建议修改。</p>
<p>下边两行代码用于控制不可见字符的显示。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim.o.list = <span class="literal">true</span></span><br><span class="line">vim.o.listchars = <span class="string">&quot;space:·&quot;</span></span><br></pre></td></tr></table></figure>

<p>我这里习惯把不可见空格显示为一个点，这样很容易看清哪里有空格，你如果不喜欢可以设置为 false 关闭。</p>
<p><code>timeoutlen </code>这个参数 <strong>非常重要</strong>，在 VIM 快捷键中经常有多个键连敲的情况，下边代码表示键盘快捷键连击时限设为500毫秒，超过500毫秒就不认为是连续快捷键了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim.o.timeoutlen = 500</span><br></pre></td></tr></table></figure>

<p>如果你的手速很慢经常按不出快捷键，则建议加大这个数值。如果你的手速很快，可以把时间设置得更短。我看过有些高手会设置为 300。</p>
<p><code>:wq</code> 保存文件，重启后的 Neovim 就具备基础配置了。</p>
<p>好，到此，我们已经完成了编码需要的基础环境设置，为后续章节的配置打好了基础。</p>
<p>高效编码的关键是快捷键的使用，快捷键也是 VIM 的核心，那么在 Neovim 中如何配置快捷键呢？还有哪些高效的快捷键技巧呢？下一节将会介绍 Neovim 配置快捷键配置，解答上述的疑问。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="4-如何设置快捷键以提高开发效率？"><a href="#4-如何设置快捷键以提高开发效率？" class="headerlink" title="4.如何设置快捷键以提高开发效率？"></a>4.如何设置快捷键以提高开发效率？</h1><p>快捷键是提高开发效率的关键。在 Neovim 中， <code>Normal</code> 模式本身就是快捷键模式，而我们在这里说的快捷键相当于是 <strong>快捷键的快捷键</strong>，比如把某些按键映射成其他快捷键，或者映射成几个连续的快捷键的点击用来简化操作。 又或者映射到某个内置命令上，或者以某一个字母开头，抽象出一系列常用的快捷键组合。还可以为安装的插件设置快捷的打开方式。</p>
<p>这里的玩法可以非常多，每个人的习惯都不同，在 <code>Neovim</code> 中，你不需要强记软件的快捷键，只要把你的习惯告诉 <code>Neovim</code> 就行了。</p>
<p>例如我把分屏相关的操作，都设置以 <code>s</code> 开头 (Split)，组成一系列命令， <code>sh</code> 代表水平分屏（Split Horizontally），<code>sv</code> 代表垂直分屏 (Split Vertically）， <code>sc</code> 关闭窗口 (Close)， <code>so</code> 关闭其他 (Others)。 同时我也习惯把 <code>Alt + h/j/k/l</code> 设置为在窗口之间跳转。</p>
<p>下图演示：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/1dd0fbf36e6f4fbb8586891ce2bf5f4dtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="4-1.gif"></p>
<p>这样经过简单的配置，就把窗口管理提升到了 <code>VSCode</code> 无法达到的高度，而在 <code>VSCode</code> 中想达到同样的效果，就离不开键盘和鼠标的操作了。</p>
<p>我甚至还设置了改变窗口比例的快捷键，这里就先不演示了。</p>
<p>除了可以在 <code>Normal</code> 模式下设置快捷键，其他模式也可以设置快捷键，例如下边演示一个在 <code>Visual</code> 模式下比较实用的快捷键，选中并挪动多行代码：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/c20f67d37cba446497fa37496c868cedtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="4-2.gif"></p>
<p>除了上述的小技巧，我们后续要安装的大量插件也都需要快捷键设置，所以本节课除了要学习如何在 <code>Neovim</code> 中设置快捷键外，还要了解如何把所有快捷键都放在一个配置文件中管理，方便我们后续查找和修改，那么我们开始吧。</p>
<h2 id="如何在-Neovim-中设置快捷键？"><a href="#如何在-Neovim-中设置快捷键？" class="headerlink" title="如何在 Neovim 中设置快捷键？"></a>如何在 Neovim 中设置快捷键？</h2><p>在 Neovim 中使用以下方法设置快捷键：</p>
<ul>
<li><code>vim.api.nvim_set_keymap()</code> 全局快捷键</li>
<li><code>vim.api.nvim_buf_set_keymap()</code> Buffer 快捷键</li>
</ul>
<p>一般情况下，都是定义使用全局快捷键， Buffer 快捷键一般是在某些异步回调函数里指定，例如某插件初始化结束后，会有回调函数提供 Buffer，这个时候我们可以只针对这一个 Buffer 设置快捷键。</p>
<p>关于 Buffer 快捷键部分，我们后边课程会遇到，这里先看全局设置。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim.api.nvim_set_keymap(<span class="string">&#x27;模式&#x27;</span>, <span class="string">&#x27;按键&#x27;</span>, <span class="string">&#x27;映射为&#x27;</span>, <span class="string">&#x27;options&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里 <strong>模式</strong> 参数用一个字母表示，常见的有：</p>
<ul>
<li><strong>n</strong> Normal 模式</li>
<li><strong>i</strong> Insert 模式</li>
<li><strong>v</strong> Visual 模式</li>
<li><strong>t</strong> Terminal 模式</li>
<li><strong>c</strong> Command 模式</li>
</ul>
<p><strong>按键</strong> 就是你按下的键，没什么说的。</p>
<p><strong>映射为</strong> 可以是多个按键组合，比如 <code>5j</code> 就是连续点击<code>5</code>和<code>j</code>， 也可以是一条命令比如 <code>:q&lt;CR&gt;</code>，表示退出。</p>
<p><strong>options</strong> 大部分会设置为 <code>&#123; noremap = true, silent = true &#125;</code>。<code>noremap</code> 表示不会重新映射，比如你有一个映射 <code>A</code> -&gt; <code>B</code> , 还有一个 <code>B</code> -&gt; <code>C</code>，这个时候如果你设置 <code>noremap = false</code> 的话，表示会重新映射，那么 <code>A</code> 就会被映射为 <code>C</code>。<code>silent</code> 为 <code>true</code>，表示不会输出多余的信息。</p>
<p>下边我们开始实践一下。</p>
<p>创建 <code>lua/keybindings.lua</code> 文件，我们会统一在这个文件里设置快捷键。</p>
<p>在设置之前，先选定一个 Leader 键。</p>
<h2 id="Leader-Key"><a href="#Leader-Key" class="headerlink" title="Leader Key"></a>Leader Key</h2><p><code>leader key</code> 是你常用的前缀，我通常设置为 <code>空格</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim.g.mapleader = <span class="string">&quot; &quot;</span></span><br><span class="line">vim.g.maplocalleader = <span class="string">&quot; &quot;</span></span><br></pre></td></tr></table></figure>

<p>后边定义快捷键看到 <code>&lt;leader&gt;</code> 就表示 <code>空格</code> 。</p>
<p>由于要设置很多快捷键，所以先保存本地变量。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> map = vim.api.nvim_set_keymap</span><br><span class="line"><span class="comment">-- 复用 opt 参数</span></span><br><span class="line"><span class="keyword">local</span> opt = &#123;noremap = <span class="literal">true</span>, silent = <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure>

<p>之后就可以这样映射按键了 <code>map(&#39;模式&#39;, &#39;按键&#39;, &#39;映射为&#39;, &#39;options&#39;)</code> 。</p>
<h2 id="窗口管理快捷键映射"><a href="#窗口管理快捷键映射" class="headerlink" title="窗口管理快捷键映射"></a>窗口管理快捷键映射</h2><p>添加代码，实现篇首提到的窗口管理功能。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 取消 s 默认功能</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- windows 分屏快捷键</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;sv&quot;</span>, <span class="string">&quot;:vsp&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;sh&quot;</span>, <span class="string">&quot;:sp&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 关闭当前</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;sc&quot;</span>, <span class="string">&quot;&lt;C-w&gt;c&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 关闭其他</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;so&quot;</span>, <span class="string">&quot;&lt;C-w&gt;o&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- Alt + hjkl  窗口之间跳转</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-h&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;h&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-j&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;j&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-k&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;k&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-l&gt;&quot;</span>, <span class="string">&quot;&lt;C-w&gt;l&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>水平分屏很常用，比如，通常在程序开发中会有跳转到定义 <code>gd</code> 快捷键(Go Definition 在后续 LSP 章节会提供)，这个可以和 <code>sv</code> 组合起来，形成 <code>svgd</code> 命令，相当于打开右侧窗口进入方法的定义。看完可以随手 <code>sc</code> 关闭掉，非常方便。</p>
<p>我还增加了调整窗口比例快捷键，使用 <code>Ctrl + 上下左右</code> 或者 <code>s,</code> <code>s.</code> <code>sj</code> <code>sk</code> 调整比例。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 左右比例控制</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Left&gt;&quot;</span>, <span class="string">&quot;:vertical resize -2&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Right&gt;&quot;</span>, <span class="string">&quot;:vertical resize +2&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;s,&quot;</span>, <span class="string">&quot;:vertical resize -20&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;s.&quot;</span>, <span class="string">&quot;:vertical resize +20&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 上下比例</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;sj&quot;</span>, <span class="string">&quot;:resize +10&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;sk&quot;</span>, <span class="string">&quot;:resize -10&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Down&gt;&quot;</span>, <span class="string">&quot;:resize +2&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-Up&gt;&quot;</span>, <span class="string">&quot;:resize -2&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 等比例</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;s=&quot;</span>, <span class="string">&quot;&lt;C-w&gt;=&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>顺便扩展到 <code>Terminal</code> 模式也设置一下，<code>Neovim</code> 内置的命令行要用<code>&lt;C-\&gt;&lt;C-N&gt;</code> 退出，我们把它映射为 <code>ESC</code> ，并用 <code>leader + t</code> 在下边窗口打开，或 <code>leader + vt</code> 侧边窗口打开。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Terminal相关</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;t&quot;</span>, <span class="string">&quot;:sp | terminal&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;vt&quot;</span>, <span class="string">&quot;:vsp | terminal&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;t&quot;</span>, <span class="string">&quot;&lt;Esc&gt;&quot;</span>, <span class="string">&quot;&lt;C-\\&gt;&lt;C-n&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;t&quot;</span>, <span class="string">&quot;&lt;A-h&gt;&quot;</span>, <span class="string">[[ &lt;C-\&gt;&lt;C-N&gt;&lt;C-w&gt;h ]]</span>, opt)</span><br><span class="line">map(<span class="string">&quot;t&quot;</span>, <span class="string">&quot;&lt;A-j&gt;&quot;</span>, <span class="string">[[ &lt;C-\&gt;&lt;C-N&gt;&lt;C-w&gt;j ]]</span>, opt)</span><br><span class="line">map(<span class="string">&quot;t&quot;</span>, <span class="string">&quot;&lt;A-k&gt;&quot;</span>, <span class="string">[[ &lt;C-\&gt;&lt;C-N&gt;&lt;C-w&gt;k ]]</span>, opt)</span><br><span class="line">map(<span class="string">&quot;t&quot;</span>, <span class="string">&quot;&lt;A-l&gt;&quot;</span>, <span class="string">[[ &lt;C-\&gt;&lt;C-N&gt;&lt;C-w&gt;l ]]</span>, opt)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/075e9b3d0c404215ba3e2fe8fa84b53btplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="4-3.gif"></p>
<h2 id="Visule-模式下快捷键"><a href="#Visule-模式下快捷键" class="headerlink" title="Visule 模式下快捷键"></a>Visule 模式下快捷键</h2><p>在 visual 模式下可以<code>J</code> <code>K</code> 上下移动代码，又增加了连续 <code>&gt;</code> 或 <code>&lt;</code> 缩进代码。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- visual模式下缩进代码</span></span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&lt;gv&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&gt;gv&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 上下移动选中文本</span></span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;J&quot;</span>, <span class="string">&quot;:move &#x27;&gt;+1&lt;CR&gt;gv-gv&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;K&quot;</span>, <span class="string">&quot;:move &#x27;&lt;-2&lt;CR&gt;gv-gv&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>map 的第一个参数 <code>v</code> 表示 visual 模式。</p>
<h2 id="浏览代码快捷键"><a href="#浏览代码快捷键" class="headerlink" title="浏览代码快捷键"></a>浏览代码快捷键</h2><p>我还有小技巧，比如在浏览非常长的代码文件时，通常要用 <code>Ctrl+u</code> &#x2F; <code>Ctrl + d</code> 来滚动代码，<code>u</code> 和 <code>p</code> 表示 <code>up翻页</code> 和 <code>down翻页</code>。</p>
<p>但是<code>ctrl + u</code> &#x2F; <code>ctrl + d</code> 默认移动半屏，翻太快，一不留神就不知道翻到哪了， <code>j</code> &#x2F; <code>k</code> 又移动得太慢了。这时我会设置两种不同级别的翻页距离， <code>Ctrl+j</code> &#x2F; <code>Ctrl+k</code> 移动 4 行，<code>Ctrl+u</code> &#x2F; <code>Ctrl + d</code> 移动 9 行</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/e06e164f2de242dc9cf71904b8417cf3tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="4-4.gif"></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 上下滚动浏览</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-j&gt;&quot;</span>, <span class="string">&quot;4j&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-k&gt;&quot;</span>, <span class="string">&quot;4k&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- ctrl u / ctrl + d  只移动9行，默认移动半屏</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-u&gt;&quot;</span>, <span class="string">&quot;9k&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-d&gt;&quot;</span>, <span class="string">&quot;9j&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>为什么是 4 行和 9 行呢？因为刚好适合我，尤其是命令行全屏的时候，刚好拉开两个级别，不多不少，但你应该根据你的情况设置。</p>
<p>我还有一些个人的设置，你可以参考。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 在visual 模式里粘贴不要复制</span></span><br><span class="line">map(<span class="string">&quot;v&quot;</span>, <span class="string">&quot;p&quot;</span>, <span class="string">&#x27;&quot;_dP&#x27;</span>, opt)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 退出</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;q&quot;</span>, <span class="string">&quot;:q&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;qq&quot;</span>, <span class="string">&quot;:q!&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;Q&quot;</span>, <span class="string">&quot;:qa!&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- insert 模式下，跳到行首行尾</span></span><br><span class="line">map(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;&lt;C-h&gt;&quot;</span>, <span class="string">&quot;&lt;ESC&gt;I&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;&lt;C-l&gt;&quot;</span>, <span class="string">&quot;&lt;ESC&gt;A&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>最后，别忘了在 <code>init.lua</code> 入口文件里引入 <code>lua/keybindings.lua</code>，注意不要写 <code>.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>现在 <code>:wq</code> 退出重启后，之前设置的快捷键就生效了。</p>
<p>后续课程中的每个插件，如果需要设置快捷键，我们都会回来在<code>keybindings.lua</code>文件里继续添加。</p>
<p>不要担心你的<code>Neovim</code> 和我截图中的不一样，因为你还没有安装插件，也没有安装配色，下一节课我们会学习如何给 <code>Neovim</code> 添加和配置插件。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="5-如何安装和管理插件？"><a href="#5-如何安装和管理插件？" class="headerlink" title="5.如何安装和管理插件？"></a>5.如何安装和管理插件？</h1><p>Neovim 可以通过扩展插件来添加新功能，或修改现有功能以增强开发体验。为了安装插件，需要先安装一个插件管理器，插件管理器可以安装，升级，卸载第三方插件。</p>
<p>目前在 Neovim 最常见的插件管理器主要有 <a href="https://link.juejin.cn/?target=https://github.com/junegunn/vim-plug">vim-plug</a> 和 <a href="https://link.juejin.cn/?target=https://github.com/wbthomason/packer.nvim">packer.nvim</a> 两个。</p>
<p>一个好插件管理器，最重要是常用的插件都支持。 现在 Neovim 常用插件的 github 主页上，一般都会同时有 vim-plug 和 Packer.nvim 的安装的说明。</p>
<p>vim-plug 的特点是使用简单，并且同时支持 Vim 和 Neovim，所有功能在一个 VIM 脚本中实现了。</p>
<p>而 Packer.nvim 是后起之秀，但功能更为强大，支持插件间的依赖，指定 commit 版本，Post-install&#x2F;update hooks，指定分支等功能，使用全 lua 编写，是专门针对最新 Neovim v0.5.0 以上版本设计的，所以推荐使用。</p>
<p>本节将选用 Packer.nvim 作为插件管理器，首先我们看一下如何安装 Packer.nvim。</p>
<h2 id="安装-Packer-nvim-插件管理器"><a href="#安装-Packer-nvim-插件管理器" class="headerlink" title="安装 Packer.nvim 插件管理器"></a>安装 Packer.nvim 插件管理器</h2><p>由于 Neovim 的插件默认都是通过 Github 进行安装的，所以我们需要保证网络环境是可以联通 Github 的。</p>
<p>根据官网的说明，在 Terminal 终端中输入以下命令，回车，安装 packer.nvim：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth 1 https://github.com/wbthomason/packer.nvim\</span><br><span class="line"> ~/.local/share/nvim/site/pack/packer/start/packer.nvim</span><br></pre></td></tr></table></figure>

<p>安装成功后，我们添加一个新的配置文件，专门用于管理插件，新建 <code>lua/plugins.lua</code> 为如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> packer = <span class="built_in">require</span>(<span class="string">&quot;packer&quot;</span>)</span><br><span class="line">packer.startup(</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">   <span class="comment">-- Packer 可以管理自己本身</span></span><br><span class="line">   use <span class="string">&#x27;wbthomason/packer.nvim&#x27;</span></span><br><span class="line">   <span class="comment">-- 你的插件列表...</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>我们通常使用 <code>use &#39;name/repo&#39;</code> 来安装插件，<code>name/repo</code> 对应<code>github</code> 的地址。例如上边代码中的 <code>use &#39;wbthomason/packer.nvim&#39;</code>，对应的就是 <code>https://github.com/wbthomason/packer.nvim</code> 地址。</p>
<p>我们之前说过，安装插件要求你有一个稳定可联通 Github 的网络环境，如果你的网络不好，可以尝试设置第二个 config 参数，使用代理站点。</p>
<p>下边代码中我列出了目前常见的几个代理站点，供你尝试，但还是推荐使用 Github， 因为代理站点有些冷门的插件有可能没有同步，或者同步不及时，也有可能有并发数限制等，体验并不是很好。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> packer = <span class="built_in">require</span>(<span class="string">&quot;packer&quot;</span>)</span><br><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以管理自己本身</span></span><br><span class="line">    use <span class="string">&#x27;wbthomason/packer.nvim&#x27;</span></span><br><span class="line">    <span class="comment">-- 你的插件列表...</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">  <span class="built_in">config</span> = &#123;</span><br><span class="line">    <span class="comment">-- 并发数限制</span></span><br><span class="line">    max_jobs = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">-- 自定义源</span></span><br><span class="line">    git = &#123;</span><br><span class="line">      <span class="comment">-- default_url_format = &quot;https://hub.fastgit.xyz/%s&quot;,</span></span><br><span class="line">      <span class="comment">-- default_url_format = &quot;https://mirror.ghproxy.com/https://github.com/%s&quot;,</span></span><br><span class="line">      <span class="comment">-- default_url_format = &quot;https://gitcode.net/mirrors/%s&quot;,</span></span><br><span class="line">      <span class="comment">-- default_url_format = &quot;https://gitclone.com/github.com/%s&quot;,</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>config</code> 中还有很多参数，具体可参考帮助文档，比较实用的还有，以浮动窗口打开安装列表：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">config</span> = &#123;</span><br><span class="line">    display = &#123;</span><br><span class="line">        open_fn = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">require</span>(<span class="string">&quot;packer.util&quot;</span>).float(&#123; border = <span class="string">&quot;single&quot;</span> &#125;)</span><br><span class="line">        <span class="keyword">end</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成后，<code>:wq</code> 保存文件并退出。</p>
<p>别忘了想要这个配置文件生效，必须在 <strong>入口文件</strong> 中引入才可以， 打开 <code>init.lua</code> 增加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Packer 插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>再次 <code>:wq</code> 后，配置生效。</p>
<p>配置生效后，Neovim 会增加以下命令。</p>
<ul>
<li><code>:PackerCompile</code>： 每次改变插件配置时，必须运行此命令或 <code>PackerSync</code>, 重新生成编译的加载文件</li>
<li><code>:PackerClean</code> ： 清除所有不用的插件</li>
<li><code>:PackerInstall</code> ： 清除，然后安装缺失的插件</li>
<li><code>:PackerUpdate</code> ： 清除，然后更新并安装插件</li>
<li><code>:PackerSync</code> : 执行 <code>PackerUpdate</code> 后，再执行 <code>PackerCompile</code></li>
<li><code>:PackerLoad</code> : 立刻加载 opt 插件</li>
</ul>
<p>通过上边的说明，我们观察到 <code>:PackerSync</code> 命令包含了 <code>:PackerUpdate</code> 和<code>:PackerCompile</code>，而 <code>:PackerUpdate</code> 又包含了 <code>:PackerClean</code> 和 <code>:PackerInstall</code> 流程。</p>
<p>所以通常情况下，无论<strong>安装</strong>还是<strong>更新</strong>插件，我只需要下边这一条命令就够了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:PackerSync</span><br></pre></td></tr></table></figure>

<p>每次修改完 <code>lua/plugins.lua</code> 这个文件后，保存退出，重新打开并调用 <code>:PackerSync</code> 就可以了，只要你的网络可以连接到 <code>github</code>，插件就会安装成功。</p>
<p>安装完成， 按 <code>q</code> 退出，如图演示：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/2d7b2baa9a4d48968ee08fc8190a5674tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="5-1.gif"></p>
<p>由于我们没有增加新的插件，所以上图显示为 <code>Everything already up to date!</code>，这是因为 <code>Packer</code> 已经检查过了，并且没有发现新的插件。</p>
<p>目前你的界面应该和上图类似，还是比较丑的，这是因为还没有安装主题 <code>colorscheme</code>，不要着急，我们会在下一节中详细讲解，在此之前我们先看一下插件安装在哪了。</p>
<h2 id="安装位置"><a href="#安装位置" class="headerlink" title="安装位置"></a>安装位置</h2><p>Neovim 推荐将数据存储在 <strong>标准数据目录</strong>下（<code>:h base-directories</code> 查看详细文档），<strong>标准数据目录</strong>默认是 <code>~/.local/share/nvim/</code> ，你可以通过调用 <code>:echo stdpath(&quot;data&quot;)</code> 命令查看你系统下的实际路径。</p>
<p><code>Packer</code> 会将插件默认安装在 <code>标准数据目录/site/pack/packer/start</code> 中，完整目录也就是<code>~/.local/share/nvim/site/pack/packer/start</code> 目录下。</p>
<p>你现在可以进入这个目录，查看一下安装的插件，应该看到只安装了 <code>packer.nvim</code> 一个插件，后续安装的插件也都会出现在这个目录中。</p>
<p>之前我们讲了安装组件的流程为： 修改 <code>lua/plugins.lua</code> 文件，保存退出，重新打开并调用 <code>:PackerSync</code>。</p>
<p>其实如果你愿意的话，我们可以添加一条自动命令让每次保存 <code>lua/plugins.lua</code> 就自动安装组件。</p>
<h2 id="添加自动安装"><a href="#添加自动安装" class="headerlink" title="添加自动安装"></a>添加自动安装</h2><p>打开 <code>lua/plugins.lua</code> 文件，在最后添加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 每次保存 plugins.lua 自动安装插件</span></span><br><span class="line"><span class="built_in">pcall</span>(</span><br><span class="line">  vim.cmd,</span><br><span class="line">  <span class="string">[[</span></span><br><span class="line"><span class="string">    augroup packer_user_config</span></span><br><span class="line"><span class="string">    autocmd!</span></span><br><span class="line"><span class="string">    autocmd BufWritePost plugins.lua source &lt;afile&gt; | PackerSync</span></span><br><span class="line"><span class="string">    augroup end</span></span><br><span class="line"><span class="string">  ]]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这里的 <code>[[ ... ]]</code> 中间的部分是 VIM 脚本，因为 Neovim 还没有实现自动命令的 API，所以我们需要使用 <code>vim.cmd</code> 命令来执行这段脚本。</p>
<p>这段脚本的意思是 <code>BufWritePost</code> 事件时，如果改的是 <code>lua/plugins.lua</code> 文件，就自动重新加载并调用 <code>:PackerSync</code> 命令，这样就不用手动重启，可以自动安装插件了。</p>
<p><code>pcall</code> 命令是一个 Lua 函数，它的作用是检查一个函数是否执行成功，如果执行成功，则返回 <code>true</code>，否则返回 <code>false</code> ，防止报错，后边遇到的时候还会再详细解释。</p>
<p>现在修改 <code>lua/plugins.lua</code> 后输入 <code>:w</code> 就会自动安装和更新插件了，赶快翻到下一节，一起试试吧。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h2 id="补充-1"><a href="#补充-1" class="headerlink" title="补充"></a>补充</h2><p>如果<code>:PackerSync</code>提示<code>Failed</code>，手动在<code>/root/.local/share/nvim/site/pack/packer/start</code>目录下,，使用<code>git clone --depth 1 github路径</code>下载即可。</p>
<h1 id="6-Neovim-主题配色与优秀主题推荐"><a href="#6-Neovim-主题配色与优秀主题推荐" class="headerlink" title="6.Neovim 主题配色与优秀主题推荐"></a>6.Neovim 主题配色与优秀主题推荐</h1><p>本节课我们学习如何给 Neovim 设置主题配色来改变编辑器的外观，以及如何使用上一节课的 Packer.nvim 插件管理器安装第三方主题配色，什么样的主题可以被称为现代化的主题配色。 另外，我们也会介绍，如何找到合适的主题，最后我再来推荐我最喜欢的几大主题推荐, 你可以从中选择一个作为你的默认主题配色。</p>
<p>首先我们需要了解，Neovim 本身内置了一些主题配色，你可以通过 <code>:colorscheme Tab键</code> 命令来查看， 回车确认选中。 过程如下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/8950f36d147643b29571387a808622d8tplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165061967302327.awebp" alt="6-1.gif"></p>
<p>这里列出的都是内置的 <code>colorscheme</code>，它们都保存在 <code>$VIMRUNTIME/colors/</code> 目录下。</p>
<p>你可以在 <code>Neovim</code> 中输入命令 <code>:echo $VIMRUNTIME</code> 来查看 <code>$VIMRUNTIME</code> 具体的路径，比如我的路径显示如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/nvim/runtime/</span><br></pre></td></tr></table></figure>

<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b47b5b326a414c56bd6047ace13fdae4~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt="6-2.gif"></p>
<p>但通过这种方式选择的主题，在重启后就失效了。需要写入配置才可以保存，下边看一下如何写入配置。</p>
<h2 id="配置主题"><a href="#配置主题" class="headerlink" title="配置主题"></a>配置主题</h2><p>打开入口文件 <code>init.lua</code>，修改代码为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;basic&quot;</span>)</span><br><span class="line"><span class="comment">-- Packer插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="comment">-- 主题设置 （新增）</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;colorscheme&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>新建被引入的 <code>lua/colorscheme.lua</code> 文件，代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> colorscheme = <span class="string">&quot;tokyonight&quot;</span></span><br><span class="line"><span class="keyword">local</span> status_ok, _ = <span class="built_in">pcall</span>(vim.cmd, <span class="string">&quot;colorscheme &quot;</span> .. colorscheme)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> status_ok <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;colorscheme &quot;</span> .. colorscheme .. <span class="string">&quot; 没有找到！&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>简单解释一下，上边代码第一行，定义了一个 <code>colorscheme</code> 的变量，表示我们要设置的主题，注意其实这里我们使用的 <code>tokyonight</code> <strong>并不存在</strong>。</p>
<p>接下来的部分代码，我们又见到了 <code>pcall</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> status_ok, _ = <span class="built_in">pcall</span>(vim.cmd, <span class="string">&quot;colorscheme &quot;</span> .. colorscheme)</span><br></pre></td></tr></table></figure>

<p><code>pcall</code> 在 Lua 中用于捕获错误，这句话如果不用<code>pcall</code> 的话，相当于：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim.cmd(<span class="string">&#x27;colorscheme &#x27;</span>.. colorscheme)</span><br></pre></td></tr></table></figure>

<p>Lua 语言中用 <code>..</code> 来连接两个字符串，上边已经声明了 <code>colorscheme</code> 变量也是一个字符串 <code>&quot;tokyonight&quot; </code>所以这里其实就等于调用 <code>:colorscheme tokyonight</code> 命令。 但如果这样直接调用命令，如果主题不存在，Neovim 就会直接崩溃报错找不到该主题，程序中也就没法知道主题是否设置成功了。</p>
<p>使用 <code>pcall</code> 的话就不同了，<code>pcall</code> 函数的返回的第一个参数是 <code>boolean</code> 类型表示状态，这句话的意思是，如果 <code>colorscheme</code> 执行成功，则返回 <code>true</code>，否则返回 <code>false</code>。</p>
<p>如果没有设置成功，我们就让它输出信息：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim.notify(<span class="string">&quot;colorscheme &quot;</span> .. colorscheme .. <span class="string">&quot; 没有找到！&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/3feb8936a6cc4f96b52b5de2f4cdd2a8tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="6-3.png"></p>
<p>至此配置的部分就完成了，提示没有找到是因为 <code>tokyonight</code> 主题并不存在，如果把该值修改成已经存在的主题，比如 <code>ron</code> 就会设置成功了。</p>
<p>下边我们看看如何安装第三方主题。</p>
<h2 id="安装第三方主题"><a href="#安装第三方主题" class="headerlink" title="安装第三方主题"></a>安装第三方主题</h2><p>打开 <code>lua/plugins.lua</code> 文件，增加 colorschemes 部分：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以升级自己</span></span><br><span class="line">    use(<span class="string">&quot;wbthomason/packer.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">--------------------- colorschemes --------------------</span></span><br><span class="line">    <span class="comment">-- tokyonight</span></span><br><span class="line">    use(<span class="string">&quot;folke/tokyonight.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">-------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 略...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存，如果顺利的话，会自动安装，完成后按 <code>q</code> 退出，重启后就可以看到 <code>tokyonight</code> 主题的样子了。如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/e5a35990d60945d9b916e8c5d3970289tplv-k3u1fbpfcp-zoom-in-crop-mark1304000-16507631138653.awebp" alt="6-4.gif"></p>
<p>补充：</p>
<p>但通常不顺利，可以到插件目录下手动安装<code>git clone --depth 1 https://github.com/folke/tokyonight.nvim.git</code></p>
<p>目录：<code>/root/.local/share/nvim/site/pack/packer/start</code></p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20221126150213983.png" alt="image-20221126150213983"></p>
<p>通常我们都会选择专门为 Neovim 制作的第三方主题，因为它们大多都会支持基于 <code>TreeSitter</code> 的语法高亮（后续代码高亮章节会详细说明），我认为这是考量是否应该选择一个主题最基础也是重要的事。</p>
<p>也就是说，一个现代化的主题，必须支持 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter">nvim-treesitter</a> 语法高亮。</p>
<p>nvim-treesitter 的官方 wiki 上列出了许多支持 Treesitter 的主题，如果你想寻找更多的主题配色，可以到 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter/wiki/Colorschemes">nvim-treesitter wiki</a> 页里查看。</p>
<p>一个优秀的现代化主题的第二个特点，就是能支持很多流行 Lua 插件的配色。</p>
<p>比如刚刚安装的 <a href="https://link.juejin.cn/?target=https://github.com/folke/tokyonight.nvim">tokyonight</a> 主题，就支持非常多的 <a href="https://link.juejin.cn/?target=https://github.com/folke/tokyonight.nvim%23plugin-support">Lua 插件</a>，也是 Github 上星星最多的一款主题，我在这里强烈推荐，本书后续也将使用这款主题配色。</p>
<p>下边是我推荐的其他主题配色。</p>
<h2 id="我最喜欢的主题推荐"><a href="#我最喜欢的主题推荐" class="headerlink" title="我最喜欢的主题推荐"></a>我最喜欢的主题推荐</h2><p>这里是我最能找到的最喜欢的几个配色，你可以选择一款作为你的默认配色。</p>
<ul>
<li>tokyonight</li>
</ul>
<p>移植自 Visual Studio Code <a href="https://link.juejin.cn/?target=https://github.com/enkia/tokyo-night-vscode-theme">TokyoNight</a> theme，我的最爱，目前 Github 上有 1.3k 星星。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/1b6b2482c1d14b6b9f34ef533a2526f0tplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165061967302432.awebp" alt="tokyonight.png"></p>
<ul>
<li>OceanicNext</li>
</ul>
<p>Oceanic-Next 是受 <a href="https://link.juejin.cn/?target=https://github.com/voronianski/oceanic-next-color-scheme">Oceanic Next for Sublime</a> 启发而制作的主题，但只是用到了基础色系，并不是直接移植，同时支持 Neovim 和 Vim 8，目前在 Github 上有接近1000个星星。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/d1e2c08536324da7b90b96ab4f01bbf7tplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165061967302534.awebp" alt="oceanicNext.png"></p>
<ul>
<li>gruvbox.nvim</li>
</ul>
<p>是非常有名的配色 <a href="https://link.juejin.cn/?target=https://github.com/gruvbox-community/gruvbox">gruvbox community</a> 的 Lua 移植版本，支持 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter">treesitter</a>。</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f8ba6c15dc843bb819396890f8b4405~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt="gruvbox.png"></p>
<ul>
<li>zephyr</li>
</ul>
<p>这是我非常非常喜欢的一款配色，作者还是中国人，可惜在某次 Treesitter 更新后就与该配色冲突了，如果你的动手能力强的话，可以参考此 <a href="https://link.juejin.cn/?target=https://github.com/glepnir/zephyr-nvim/issues/29">issues</a> 自行修复，或者先关注，等待作者的修复吧。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/641fccb5240f4b3fb5dbebb7f3e9e5ba~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp" alt="zephyr.png"></p>
<ul>
<li>nord</li>
</ul>
<p>nrod 绝对可以称得上是现代化的主题配色，官网上列出了其支持非常非常多的第三方插件配色，但颜色偏素，我不是特别的喜欢。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/3baeeb8d748f4709aff1910c74fcf53dtplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165061967302538.awebp" alt="nord.png"></p>
<ul>
<li>onedark</li>
</ul>
<p>onedark 这个名字不用说，任何编辑器里应该都见过，也是支持非常非常多第三方插件，以及 Treesitter 和 LSP。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/5e6fc8efeb404f66b1ff6fa8b997e58etplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165061967302540.awebp" alt="onedark.png"></p>
<ul>
<li>nightfox</li>
</ul>
<p>一个插件包含多种配色 Nightfox &#x2F; Nordfox &#x2F; Dayfox &#x2F; Dawnfox &#x2F; Duskfox，支持非常多的第三方插件。并且有很多配置项，相对比较复杂。目前在 Github 上有600 多颗星星，是非常不错的选择。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/d31961d706f146ed9953e49fa7dcf784tplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165061967302542.awebp" alt="nightfox.png"></p>
<p>如果还是没有你喜欢的，你也可以到 Github 的 <a href="https://link.juejin.cn/?target=https://github.com/topics/neovim-colorscheme">neovim-colorscheme</a> 链接下找找你的最爱。</p>
<p>怎么样，选好了吗？ 要不，我们把上边推荐的所有主题一次全安装了吧？</p>
<p>修改 <code>lua/plugins.lua</code> 增加代码如下， 然后 <code>:w</code> 即可自动安装:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">--------------------- colorschemes --------------------</span></span><br><span class="line"><span class="comment">-- tokyonight</span></span><br><span class="line">use(<span class="string">&quot;folke/tokyonight.nvim&quot;</span>)</span><br><span class="line"><span class="comment">-- OceanicNext</span></span><br><span class="line">use(<span class="string">&quot;mhartington/oceanic-next&quot;</span>)</span><br><span class="line"><span class="comment">-- gruvbox</span></span><br><span class="line">use(&#123; <span class="string">&quot;ellisonleao/gruvbox.nvim&quot;</span>, requires = &#123; <span class="string">&quot;rktjmp/lush.nvim&quot;</span> &#125; &#125;)</span><br><span class="line"><span class="comment">-- zephyr 暂时不推荐，详见上边解释</span></span><br><span class="line"><span class="comment">-- use(&quot;glepnir/zephyr-nvim&quot;)</span></span><br><span class="line"><span class="comment">-- nord</span></span><br><span class="line">use(<span class="string">&quot;shaunsingh/nord.nvim&quot;</span>)</span><br><span class="line"><span class="comment">-- onedark</span></span><br><span class="line">use(<span class="string">&quot;ful1e5/onedark.nvim&quot;</span>)</span><br><span class="line"><span class="comment">-- nightfox</span></span><br><span class="line">use(<span class="string">&quot;EdenEast/nightfox.nvim&quot;</span>)</span><br><span class="line"><span class="comment">-------------------------------------------------------</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>然后找到你喜欢的样式后修改 <code>lua/colorscheme.lua</code> 内 <code>colorscheme</code> 变量的名字保存，重启后即可生效。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> colorscheme = <span class="string">&quot;tokyonight&quot;</span></span><br></pre></td></tr></table></figure>

<p>下一章会开始给我们的 Neovim 装上侧边栏插件，如果没问题了就快来吧。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="7-如何给-Neovim-增加侧边栏文件浏览器？"><a href="#7-如何给-Neovim-增加侧边栏文件浏览器？" class="headerlink" title="7.如何给 Neovim 增加侧边栏文件浏览器？"></a>7.如何给 Neovim 增加侧边栏文件浏览器？</h1><p>本节课我们学习如何给 Neovim 增加一个侧边栏，也叫做文件浏览器，一般 IDE 默认都有，用于列出当前目录树。</p>
<p>可以方便地浏览目录结构，添加、删除、移动或者重命名文件，更快地打开文件。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/d9230327232f43f1a7f4d05f27b815d7tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="7-4.png"></p>
<p>目前 <a href="https://link.juejin.cn/?target=https://github.com/kyazdani42/nvim-tree.lua">nvim-tree.lua</a> 是最流行的全 Lua 编写的侧边栏插件，第一步安装，打开 <code>lua/plugins.lua</code>，增加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以升级自己</span></span><br><span class="line">    use(<span class="string">&quot;wbthomason/packer.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">-------------------------- plugins -------------------------------------------</span></span><br><span class="line">    <span class="comment">-- nvim-tree (新增)，文件侧边栏</span></span><br><span class="line">    use(&#123; <span class="string">&quot;kyazdani42/nvim-tree.lua&quot;</span>, requires = <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line">...略</span><br></pre></td></tr></table></figure>

<p>注意上边 <code>requires</code> 语法，表示 <code>nvim-tree.lua</code> 依赖 <code>nvim-web-devicons</code>，当安装组件的时候，两个组件都会安装。</p>
<p><code>:w</code> 保存，自动安装，安装完成如图，按 <code>q</code> 退出。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/7e6f6aaefd514d2195b3dd442d93e47btplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="7-2.png"></p>
<p>如果报错网络错误，可以重新运行 <code>:PackerSync</code> 。</p>
<p>插件安装完成，只表示下载成功。并不是说就可以直接使用了，每个插件都需要单独配置。</p>
<p>下边开始配置侧边栏。</p>
<p>也可到插件目录下手动安装</p>
<p>人家改名字了，但不影响（第一个我用新的名字，第二个还是用的老名字，都可以）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth 1 https://github.com/nvim-tree/nvim-web-devicons.git</span><br><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> --depth 1 https://github.com/kyazdani42/nvim-tree.lua.git</span><br></pre></td></tr></table></figure>



<h2 id="配置-nvim-tree"><a href="#配置-nvim-tree" class="headerlink" title="配置 nvim-tree"></a>配置 nvim-tree</h2><p>创建 <code>lua/plugin-config/nvim-tree.lua</code> 文件，添加如下内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, nvim_tree = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;nvim-tree&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">    vim.notify(<span class="string">&quot;没有找到 nvim-tree&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上边的代码相当于：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> nvim_tree = <span class="built_in">require</span><span class="string">&#x27;nvim-tree&#x27;</span></span><br></pre></td></tr></table></figure>

<p>但是如果我们直接 <code>require</code> 一个插件，当这个插件不存在的时候，<code>Neovim</code> 就会崩溃，所以我这里使用 <code>pcall</code> 来捕获了错误，如果 <code>nvim-tree</code> 没有安装，我们就会直接 <code>return</code>，<strong>不</strong>再继续执行下边的配置。</p>
<p>由于我们经常会调整插件，所以应该尽量避免报错，后续的所有插件配置文件都会这么做。</p>
<p>继续增加代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, nvim_tree = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;nvim-tree&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">    vim.notify(<span class="string">&quot;没有找到 nvim-tree&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 列表操作快捷键</span></span><br><span class="line"><span class="keyword">local</span> list_keys = <span class="built_in">require</span>(<span class="string">&#x27;keybindings&#x27;</span>).nvimTreeList</span><br><span class="line">nvim_tree.setup(&#123;</span><br><span class="line">    <span class="comment">-- 不显示 git 状态图标</span></span><br><span class="line">    git = &#123;</span><br><span class="line">        enable = <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">-- project plugin 需要这样设置</span></span><br><span class="line">    update_cwd = <span class="literal">true</span>,</span><br><span class="line">    update_focused_file = &#123;</span><br><span class="line">        enable = <span class="literal">true</span>,</span><br><span class="line">        update_cwd = <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">-- 隐藏 .文件 和 node_modules 文件夹</span></span><br><span class="line">    filters = &#123;</span><br><span class="line">        dotfiles = <span class="literal">true</span>,</span><br><span class="line">        custom = &#123; <span class="string">&#x27;node_modules&#x27;</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    view = &#123;</span><br><span class="line">        <span class="comment">-- 宽度</span></span><br><span class="line">        width = <span class="number">40</span>,</span><br><span class="line">        <span class="comment">-- 也可以 &#x27;right&#x27;</span></span><br><span class="line">        side = <span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">        <span class="comment">-- 隐藏根目录</span></span><br><span class="line">        hide_root_folder = <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">-- 自定义列表中快捷键</span></span><br><span class="line">        mappings = &#123;</span><br><span class="line">            custom_only = <span class="literal">false</span>,</span><br><span class="line">            list = list_keys,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">-- 不显示行数</span></span><br><span class="line">        number = <span class="literal">false</span>,</span><br><span class="line">        relativenumber = <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">-- 显示图标</span></span><br><span class="line">        signcolumn = <span class="string">&#x27;yes&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    actions = &#123;</span><br><span class="line">        open_file = &#123;</span><br><span class="line">            <span class="comment">-- 首次打开大小适配</span></span><br><span class="line">            resize_window = <span class="literal">true</span>,</span><br><span class="line">            <span class="comment">-- 打开文件时关闭</span></span><br><span class="line">            quit_on_open = <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">-- wsl install -g wsl-open</span></span><br><span class="line">    <span class="comment">-- https://github.com/4U6U57/wsl-open/</span></span><br><span class="line">    system_open = &#123;</span><br><span class="line">        cmd = <span class="string">&#x27;wsl-open&#x27;</span>, <span class="comment">-- mac 直接设置为 open</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">-- 自动关闭</span></span><br><span class="line">vim.cmd(<span class="string">[[</span></span><br><span class="line"><span class="string">  autocmd BufEnter * ++nested if winnr(&#x27;$&#x27;) == 1 &amp;&amp; bufname() == &#x27;NvimTree_&#x27; . tabpagenr() | quit | endif</span></span><br><span class="line"><span class="string">]]</span>)</span><br></pre></td></tr></table></figure>

<p>上边代码就是 nvim-tree 的配置，可以根据注释进行修改。这里简单解释一下，值得注意的是 <code>system_open</code> 项，如果想要在 <code>WSL</code> 中用 Windows 系统默认设置打开文件，需要使用 <code>Node.js</code> 全局安装一个 <code>wsl-open</code> 包，使用命令 <code>npm install -g wsl-open</code>，如果不需要这个功能，也可以不用安装。 如果不是 Windows 系统也就不需要安装。</p>
<p>nvim-tree 初始化支持很多参数，如果想知道还有哪些其他的参数，可以运行 <code>:h nvim-tree.setup</code> 调出帮助文档查看。</p>
<p>注意到上述代码第一行，引入了我们之前创建的 <code>lua/keybindings.lua</code>，并取出 <code>nvimTreeList</code> 变量作为快捷键设置， 那我们就看看 <code>keybinding</code> 中是如何导出这个变量的。</p>
<p>打开 <code>lua/keybindings.lua</code> 文件，增加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插件快捷键</span></span><br><span class="line"><span class="keyword">local</span> pluginKeys = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- nvim-tree</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;A-n&gt;&quot;</span>, <span class="string">&quot;:NvimTreeToggle&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;n&quot;</span>, <span class="string">&quot;:NvimTreeToggle&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 列表快捷键</span></span><br><span class="line">pluginKeys.nvimTreeList = &#123; </span><br><span class="line">  <span class="comment">-- 打开文件或文件夹</span></span><br><span class="line">  &#123; key = &#123;<span class="string">&quot;&lt;CR&gt;&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;&lt;2-LeftMouse&gt;&quot;</span>&#125;, action = <span class="string">&quot;edit&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- v分屏打开文件</span></span><br><span class="line">  &#123; key = <span class="string">&quot;v&quot;</span>, action = <span class="string">&quot;vsplit&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- h分屏打开文件</span></span><br><span class="line">  &#123; key = <span class="string">&quot;h&quot;</span>, action = <span class="string">&quot;split&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- Ignore (node_modules)</span></span><br><span class="line">  &#123; key = <span class="string">&quot;i&quot;</span>, action = <span class="string">&quot;toggle_ignored&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- Hide (dotfiles)</span></span><br><span class="line">  &#123; key = <span class="string">&quot;.&quot;</span>, action = <span class="string">&quot;toggle_dotfiles&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;R&quot;</span>, action = <span class="string">&quot;refresh&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- 文件操作</span></span><br><span class="line">  &#123; key = <span class="string">&quot;a&quot;</span>, action = <span class="string">&quot;create&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;d&quot;</span>, action = <span class="string">&quot;remove&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;r&quot;</span>, action = <span class="string">&quot;rename&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;x&quot;</span>, action = <span class="string">&quot;cut&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;c&quot;</span>, action = <span class="string">&quot;copy&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;p&quot;</span>, action = <span class="string">&quot;paste&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;y&quot;</span>, action = <span class="string">&quot;copy_name&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;Y&quot;</span>, action = <span class="string">&quot;copy_path&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;gy&quot;</span>, action = <span class="string">&quot;copy_absolute_path&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;I&quot;</span>, action = <span class="string">&quot;toggle_file_info&quot;</span> &#125;,</span><br><span class="line">  &#123; key = <span class="string">&quot;n&quot;</span>, action = <span class="string">&quot;tabnew&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- 进入下一级</span></span><br><span class="line">  &#123; key = &#123; <span class="string">&quot;]&quot;</span> &#125;, action = <span class="string">&quot;cd&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- 进入上一级</span></span><br><span class="line">  &#123; key = &#123; <span class="string">&quot;[&quot;</span> &#125;, action = <span class="string">&quot;dir_up&quot;</span> &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pluginKeys</span><br></pre></td></tr></table></figure>

<p>在上边代码中，我们首先在 Normal 模式下定义了一个<code>Alt + m</code> 的快捷键，调用 <code>:NvimTreeToggle&lt;CR&gt;</code> 命令，这个快捷键用来打开和关闭侧边栏。（补充：最后的配置文件中，还用了<code>空格键 + m</code>，可以回过头重新看一下第4小节）</p>
<p><code>pluginKeys.nvimTreeList</code> 下则是在光标在列表中时的快捷键设置，比如用 <code>o</code> 来打开关闭文件夹，<code>a</code> 添加一个文件，<code>d</code> 删除文件等等。</p>
<p>代码的最后一行，我们 <code>return</code> 了一个 <code>lua table</code>， 类似 <code>Javascript</code>的 <code>object</code>，也叫关联数组。 当我们从其他文件 <code>require</code> 这个文件的时候，就会得到这个对象。</p>
<p>最后不要忘记在入口文件 <code>init.lua</code> 中引入配置：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;basic&quot;</span>)</span><br><span class="line"><span class="comment">-- Packer插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="comment">-- 主题设置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;colorscheme&quot;</span>)</span><br><span class="line"><span class="comment">-- 插件配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-tree&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>重启 nvim 后，侧边栏就会生效了，使用 <code>Alt + m</code> 打开&#x2F;关闭， <code>j/k</code> 上下移动， <code>Alt + h</code> &#x2F; <code>Alt + l</code> 可以左右窗口跳转，演示如下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/4c9c8866ba5a45d791f382005075be25tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="7-3.gif"></p>
<p>注意：有的远程连接工具，如<code>WindTerm</code>它自己有<code>Alt + m</code>的快捷键，可以取消它的设置，或者设置成其他的。<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a1c067578b93">windows Terminal 修改快捷键 - 简书 (jianshu.com)</a></p>
<p>我们这里不用<code>alt + m</code>，改成<code>alt +n</code>，并注意调整连接工具的显示大小，过大的话会有多余空行</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20221126153235138.png" alt="image-20221126153235138"></p>
<p>超级酷的侧边栏，下一节课继续增加顶部标签栏和底部信息显示栏。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="8-如何给-Neovim-增加顶部标签页与底部信息显示栏？"><a href="#8-如何给-Neovim-增加顶部标签页与底部信息显示栏？" class="headerlink" title="8.如何给 Neovim 增加顶部标签页与底部信息显示栏？"></a>8.如何给 Neovim 增加顶部标签页与底部信息显示栏？</h1><p>本章介绍如何通过 <a href="https://link.juejin.cn/?target=https://github.com/akinsho/bufferline.nvim">bufferline.nvim</a> 和 <a href="https://link.juejin.cn/?target=https://github.com/nvim-lualine/lualine.nvim">lualine.nvim</a> 插件给 Neovim 增加 <strong>顶部标签页</strong> 与 <strong>底部信息显示</strong> 栏。</p>
<p>首先看一下如何安装和配置 bufferline 插件。</p>
<p><code>bufferline</code> 顾名思义是把 Neovim 的 <code>buffer</code> 图形化显示成类似 VSCode 中 标签页的形式，如下动图所示：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/9fc23c0875884bcb8c38173b0edba40dtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="8-2.gif"></p>
<p>常用 VSCode 的一定非常熟悉这个 Tab 页的概念，现在已经是代码编辑器的标配了，一个 Tab 用来表示一个打开的文件，很匹配 Neovim 中 <code>buffer</code> 的概念。</p>
<h2 id="安装方法"><a href="#安装方法" class="headerlink" title="安装方法"></a>安装方法</h2><p>第一步，打开 <code>lua/plugins.lua</code>，增加 <code>bufferline</code> 相关的代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以升级自己</span></span><br><span class="line">    use(<span class="string">&quot;wbthomason/packer.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">-------------------------- plugins -------------------------------------------</span></span><br><span class="line">    <span class="comment">-- nvim-tree</span></span><br><span class="line">    use(&#123; <span class="string">&quot;kyazdani42/nvim-tree.lua&quot;</span>, requires = <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125;)</span><br><span class="line">    <span class="comment">-- bufferline (新增)</span></span><br><span class="line">    use(&#123; <span class="string">&quot;akinsho/bufferline.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span>, <span class="string">&quot;moll/vim-bbye&quot;</span> &#125;&#125;)</span><br><span class="line"></span><br><span class="line">...略</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存，自动安装，安装完整按 <code>q</code> 退出。 如果报错网络错误，可以重新运行 <code>:PackerSync</code> 。</p>
<p>这里我增加了一个 <a href="https://link.juejin.cn/?target=https://github.com/moll/vim-bbye">vim-bbye</a> 依赖，因为这个插件安装后会增加一个 <code>:Bdelete</code> 命令，相比内置的 <code>:bdelete</code>, 它删除 buffer 的同时，并不会搞乱布局 。 待会儿我们会配置 <code>Bdelete</code> 为关闭 Tab 的命令。</p>
<p>第二步，新建配置文件 <code>lua/plugin-config/bufferline.lua</code>，代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, bufferline = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;bufferline&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">    vim.notify(<span class="string">&quot;没有找到 bufferline&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- bufferline 配置</span></span><br><span class="line"><span class="comment">-- https://github.com/akinsho/bufferline.nvim#configuration</span></span><br><span class="line">bufferline.setup(&#123;</span><br><span class="line">  options = &#123;</span><br><span class="line">    <span class="comment">-- 关闭 Tab 的命令，这里使用 moll/vim-bbye 的 :Bdelete 命令</span></span><br><span class="line">    close_command = <span class="string">&quot;Bdelete! %d&quot;</span>,</span><br><span class="line">    right_mouse_command = <span class="string">&quot;Bdelete! %d&quot;</span>,</span><br><span class="line">    <span class="comment">-- 侧边栏配置</span></span><br><span class="line">    <span class="comment">-- 左侧让出 nvim-tree 的位置，显示文字 File Explorer</span></span><br><span class="line">    offsets = &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        filetype = <span class="string">&quot;NvimTree&quot;</span>,</span><br><span class="line">        text = <span class="string">&quot;File Explorer&quot;</span>,</span><br><span class="line">        highlight = <span class="string">&quot;Directory&quot;</span>,</span><br><span class="line">        text_align = <span class="string">&quot;left&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">-- 使用 nvim 内置 LSP  后续课程会配置</span></span><br><span class="line">    diagnostics = <span class="string">&quot;nvim_lsp&quot;</span>,</span><br><span class="line">    <span class="comment">-- 可选，显示 LSP 报错图标</span></span><br><span class="line">    <span class="comment">---@diagnostic disable-next-line: unused-local</span></span><br><span class="line">    diagnostics_indicator = <span class="function"><span class="keyword">function</span><span class="params">(count, level, diagnostics_dict, context)</span></span></span><br><span class="line">      <span class="keyword">local</span> s = <span class="string">&quot; &quot;</span></span><br><span class="line">      <span class="keyword">for</span> e, n <span class="keyword">in</span> <span class="built_in">pairs</span>(diagnostics_dict) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> sym = e == <span class="string">&quot;error&quot;</span> <span class="keyword">and</span> <span class="string">&quot; &quot;</span> <span class="keyword">or</span> (e == <span class="string">&quot;warning&quot;</span> <span class="keyword">and</span> <span class="string">&quot; &quot;</span> <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">        s = s .. n .. sym</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>经过这样配置后，就基本跟 <code>VSCode</code> 中的标签页一样了，相关的说明见注释，更多的配置项可参考官网 <a href="https://link.juejin.cn/?target=https://github.com/akinsho/bufferline.nvim%23configuration">bufferline.nvim</a> 配置项说明。</p>
<p>第三步，增加快捷键。 打开 <code>lua/keybindings.lua</code>，根据你的使用习惯增加键盘映射：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- bufferline</span></span><br><span class="line"><span class="comment">-- 左右Tab切换</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-h&gt;&quot;</span>, <span class="string">&quot;:BufferLineCyclePrev&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-l&gt;&quot;</span>, <span class="string">&quot;:BufferLineCycleNext&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 关闭</span></span><br><span class="line"><span class="comment">--&quot;moll/vim-bbye&quot;</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-w&gt;&quot;</span>, <span class="string">&quot;:Bdelete!&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;bl&quot;</span>, <span class="string">&quot;:BufferLineCloseRight&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;bh&quot;</span>, <span class="string">&quot;:BufferLineCloseLeft&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;bc&quot;</span>, <span class="string">&quot;:BufferLinePickClose&lt;CR&gt;&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>上述代码延续了我在 <code>VSCode</code> 中的使用习惯，使用 <code>Ctrl + h</code> 和 <code>Ctrl + l</code> 左右切换标签页， <code>Ctrl + w</code> 关闭当前标签页。</p>
<p>我又将 <code>bufferline</code> 提供的我不太常用到的命令，映射为由空格键开头， <code>&lt;leader&gt;bl</code> 关闭左侧标签页， <code>&lt;leader&gt;bh</code> 关闭右侧标签页， <code>&lt;leader&gt;bc</code> 选择要关闭的标签页。</p>
<p><strong>补充：</strong></p>
<p>做个笔记bufferline的快捷键要放到插件快捷键的上边，也就是你return pluginkeys这行代码的上边找个地方放</p>
<p>不然会报错！</p>
<p>最后一步，在入口文件中引入配置文件。 打开 <code>init.lua</code>，增加代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.bufferline&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:wq</code> 保存退出，重启后安装生效。</p>
<p>下面开始安装底部状态信息显示栏。</p>
<h2 id="底部信息显示栏"><a href="#底部信息显示栏" class="headerlink" title="底部信息显示栏"></a>底部信息显示栏</h2><p>底部状态栏用于显示一些额外信息，比如当前的编辑模式，光标所在的行号，列号。当前文件大小，编码格式，当前 <code>git</code> 分支等状态，如下图所示。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/c1097b4cce304631a5f71fdd4f4f06e5tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="8-1.png"></p>
<p>我在这里选择了 <a href="https://link.juejin.cn/?target=https://github.com/nvim-lualine/lualine.nvim">lualine.nvim</a> 插件。</p>
<p>第一步安装，打开 <code>lua/plugins.lua</code>， 增加 <code>lualine</code> 相关代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以升级自己</span></span><br><span class="line">    use(<span class="string">&quot;wbthomason/packer.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">-------------------------- plugins -------------------------------------------</span></span><br><span class="line">    <span class="comment">-- nvim-tree</span></span><br><span class="line">    use(&#123; <span class="string">&quot;kyazdani42/nvim-tree.lua&quot;</span>, requires = <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125;)</span><br><span class="line">    <span class="comment">-- bufferline</span></span><br><span class="line">    use(&#123; <span class="string">&quot;akinsho/bufferline.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span>, <span class="string">&quot;moll/vim-bbye&quot;</span> &#125;&#125;)</span><br><span class="line">    <span class="comment">-- lualine (新增)</span></span><br><span class="line">    use(&#123; <span class="string">&quot;nvim-lualine/lualine.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125; &#125;)</span><br><span class="line">    use(<span class="string">&quot;arkav/lualine-lsp-progress&quot;</span>)</span><br><span class="line">    ... 略</span><br></pre></td></tr></table></figure>

<p>注意这里新增了两行，第二行是 <code>lualine</code> 的一个扩展，<code>:w</code> 保存，自动安装，安装完整按 <code>q</code> 退出。 如果报网络错误，可以重新运行 <code>:PackerSync</code> 。</p>
<p>第二步，新建配置文件 <code>lua/plugin-config/lualine.lua</code>，代码如下：（补充：有特殊字符，直接复制的源文件）</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 如果找不到lualine 组件，就不继续执行</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, lualine = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;lualine&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">    vim.notify(<span class="string">&quot;没有找到 lualine&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">lualine.setup(&#123;</span><br><span class="line">  options = &#123;</span><br><span class="line">    theme = <span class="string">&quot;tokyonight&quot;</span>,</span><br><span class="line">    component_separators = &#123; left = <span class="string">&quot;|&quot;</span>, right = <span class="string">&quot;|&quot;</span> &#125;,</span><br><span class="line">    <span class="comment">-- https://github.com/ryanoasis/powerline-extra-symbols</span></span><br><span class="line">    section_separators = &#123; left = <span class="string">&quot; &quot;</span>, right = <span class="string">&quot;&quot;</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  extensions = &#123; <span class="string">&quot;nvim-tree&quot;</span>, <span class="string">&quot;toggleterm&quot;</span> &#125;,</span><br><span class="line">  sections = &#123;</span><br><span class="line">    lualine_c = &#123;</span><br><span class="line">      <span class="string">&quot;filename&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;lsp_progress&quot;</span>,</span><br><span class="line">        spinner_symbols = &#123; <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span> &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    lualine_x = &#123;</span><br><span class="line">      <span class="string">&quot;filesize&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;fileformat&quot;</span>,</span><br><span class="line">        <span class="comment">-- symbols = &#123;</span></span><br><span class="line">        <span class="comment">--   unix = &#x27;&#x27;, -- e712</span></span><br><span class="line">        <span class="comment">--   dos = &#x27;&#x27;, -- e70f</span></span><br><span class="line">        <span class="comment">--   mac = &#x27;&#x27;, -- e711</span></span><br><span class="line">        <span class="comment">-- &#125;,</span></span><br><span class="line">        symbols = &#123;</span><br><span class="line">          unix = <span class="string">&quot;LF&quot;</span>,</span><br><span class="line">          dos = <span class="string">&quot;CRLF&quot;</span>,</span><br><span class="line">          mac = <span class="string">&quot;CR&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;encoding&quot;</span>,</span><br><span class="line">      <span class="string">&quot;filetype&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>lualine 的配置参数主要有 <code>options</code>，<code>extensions</code> 和 <code>sections</code> 三块。</p>
<p><code>options</code> 用于设置样式， 其中 <code>theme</code> 设置主题配色，可以设置为 <code>auto</code>， 也可以设置为<a href="https://link.juejin.cn/?target=https://github.com/nvim-lualine/lualine.nvim/blob/master/THEMES.md">主题列表</a>中的一个， 我这里设置的是 <code>tokyonight</code>，是由 tokyonight 主题配色额外提供的支持。<code>section_separators</code> 设置分段分隔符<code>， component_separators</code> 设置分段中的组件分隔符。</p>
<p><code>extensions</code> 用于设置 <code>lualine</code> 支持的扩展，详见<a href="https://link.juejin.cn/?target=https://github.com/nvim-lualine/lualine.nvim%23extensions">扩展列表</a> 这里我们只会用到 <code>nvim-tree</code> 和 <code>toggleterm</code> 。</p>
<p><code>sections</code> 用于设置不同分段，所需显示的功能模块， 分段有 6 个，分别为： <code>A B C X Y Z</code> 。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------------------------------+</span><br><span class="line">| A | B | C                             X | Y | Z |</span><br><span class="line">+-------------------------------------------------+</span><br></pre></td></tr></table></figure>

<p>对应默认配置项为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sections = &#123;</span><br><span class="line">   lualine_a = &#123;<span class="string">&#x27;mode&#x27;</span>&#125;,</span><br><span class="line">   lualine_b = &#123;<span class="string">&#x27;branch&#x27;</span>, <span class="string">&#x27;diff&#x27;</span>, <span class="string">&#x27;diagnostics&#x27;</span>&#125;,</span><br><span class="line">   lualine_c = &#123;<span class="string">&#x27;filename&#x27;</span>&#125;,</span><br><span class="line">   lualine_x = &#123;<span class="string">&#x27;encoding&#x27;</span>, <span class="string">&#x27;fileformat&#x27;</span>, <span class="string">&#x27;filetype&#x27;</span>&#125;,</span><br><span class="line">   lualine_y = &#123;<span class="string">&#x27;progress&#x27;</span>&#125;,</span><br><span class="line">   lualine_z = &#123;<span class="string">&#x27;location&#x27;</span>&#125;</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<p>我的配置中，修改了 <code>C</code> 的部分：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lualine_c = &#123;</span><br><span class="line">  <span class="string">&quot;filename&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;lsp_progress&quot;</span>,</span><br><span class="line">    spinner_symbols = &#123; <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>在文件名后边增加了 <code>lsp_progress</code> 进度显示，该信息是由我们之前安装的 <a href="https://link.juejin.cn/?target=https://github.com/arkav/lualine-lsp-progress">arkav&#x2F;lualine-lsp-progress</a> 提供的。</p>
<p>我还修改了 <code>X</code> 的部分， 因为 <code>lualine</code> 默认的 <code>fileformat</code> 是用图标表示的，不是很直观，我换成了和 <code>VSCode</code> 一致的 <code>LF/CRLF/CR</code> 格式。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">lualine_x = &#123;</span><br><span class="line">  <span class="string">&quot;filesize&quot;</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;fileformat&quot;</span>,</span><br><span class="line">    <span class="comment">-- symbols = &#123;</span></span><br><span class="line">    <span class="comment">--   unix = &#x27;&#x27;, -- e712</span></span><br><span class="line">    <span class="comment">--   dos = &#x27;&#x27;, -- e70f</span></span><br><span class="line">    <span class="comment">--   mac = &#x27;&#x27;, -- e711</span></span><br><span class="line">    <span class="comment">-- &#125;,</span></span><br><span class="line">    symbols = &#123;</span><br><span class="line">      unix = <span class="string">&quot;LF&quot;</span>,</span><br><span class="line">      dos = <span class="string">&quot;CRLF&quot;</span>,</span><br><span class="line">      mac = <span class="string">&quot;CR&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;encoding&quot;</span>,</span><br><span class="line">  <span class="string">&quot;filetype&quot;</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>由于该插件并不需要定义快捷键，所以我们执行最后一步，在<strong>入口文件</strong>中引入配置文件。 打开 <code>init.lua</code>，增加代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.lualine&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:wq</code> 保存退出，重启后安装生效。</p>
<p>目前已经安装 3 个插件，完整的 <code>init.lua</code> 文件如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;basic&quot;</span>)</span><br><span class="line"><span class="comment">-- Packer插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="comment">-- 主题设置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;colorscheme&quot;</span>)</span><br><span class="line"><span class="comment">-- 插件配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-tree&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.bufferline&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.lualine&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>除了在侧边栏树形列表中打开文件，如果你熟悉 VSCode 那么你一定经常使用 <code>Ctrl + p</code> 快捷键快速打开文件，下一节课我们会给 Neovim 增加一个同样类似的快速打开文件的功能。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="9-如何模糊搜索快速打开文件？"><a href="#9-如何模糊搜索快速打开文件？" class="headerlink" title="9.如何模糊搜索快速打开文件？"></a>9.如何模糊搜索快速打开文件？</h1><p>在写代码的时候，经常会想要打开一个文件，但却不记得完整的文件名，只记得部分文件名或者隐约只记得里边写过的代码。这个时候如何快速找到并打开这个文件呢？</p>
<p>使用之前章节中定义的<code>Alt + m</code> 打开 nvim-tree 目录树查找？不，这个时候你需要的是一个模糊查询工具。</p>
<p>我在使用 VSCode 的时候经常使用中内置的模糊查找 <code>Ctrl + p</code> 来查找文件，使用 <code>Ctrl + shift + f</code> 来全局查找，非常方便，我已经形成了肌肉记忆，所以这节课我们要给 Neovim 也增加这样的的功能。</p>
<p>如果你也跟我一样需要一个模糊查询工具，那么就跟着我一起安装 <a href="https://link.juejin.cn/?target=https://github.com/nvim-telescope/telescope.nvim">telescope.nvim</a> 插件吧。</p>
<p>先看一下使用 <code>telescope</code> 模糊查找文件的样子，打开窗口以后有一个输入框，随着内容的输入会实时在结果框中显示搜索结果，使用快捷键在结果框中选择，右侧会实时显示文件预览，非常酷炫。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/567f9023338b4a77b6f35716516ec2c6tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="telescope.gif"></p>
<p>看一下安装方法，打开 <code>lua/plugins.lua</code> 文件，新增 <code>telescope</code> 相关的内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以升级自己</span></span><br><span class="line">    use(<span class="string">&quot;wbthomason/packer.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">-------------------------- plugins -------------------------------------------</span></span><br><span class="line">    <span class="comment">-- nvim-tree</span></span><br><span class="line">    use(&#123; <span class="string">&quot;kyazdani42/nvim-tree.lua&quot;</span>, requires = <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125;)</span><br><span class="line">    <span class="comment">-- bufferline</span></span><br><span class="line">    use(&#123; <span class="string">&quot;akinsho/bufferline.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span>, <span class="string">&quot;moll/vim-bbye&quot;</span> &#125;&#125;)</span><br><span class="line">    <span class="comment">-- lualine</span></span><br><span class="line">    use(&#123; <span class="string">&quot;nvim-lualine/lualine.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125; &#125;)</span><br><span class="line">    use(<span class="string">&quot;arkav/lualine-lsp-progress&quot;</span>)</span><br><span class="line">    <span class="comment">-- telescope （新增）</span></span><br><span class="line">    use &#123; <span class="string">&#x27;nvim-telescope/telescope.nvim&#x27;</span>, requires = &#123; <span class="string">&quot;nvim-lua/plenary.nvim&quot;</span> &#125; &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存，自动安装，安装完成按 <code>q</code> 退出。 如果报网络错误，可以重新运行 <code>:PackerSync</code> 。</p>
<p>安装完成后，需要调用 <code>:checkhealth telescope</code> 检查依赖情况，这里通常会提示 <code>ripgrep</code> 不存在，因为 <code>telescope</code> 依赖以下项目。（补充：我这边竟然两个都有了）</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https://github.com/BurntSushi/ripgrep">BurntSushi&#x2F;ripgrep</a></li>
<li><a href="https://link.juejin.cn/?target=https://github.com/sharkdp/fd">sharkdp&#x2F;fd</a></li>
</ul>
<p>需要根据你的系统选择对应的安装方法，由于我们这里使用了 WSL2 子系统 Ubuntu 18.04，所以最简单的安装方式是在命令行中使用下列命令安装。</p>
<h2 id="安装-repgrep"><a href="#安装-repgrep" class="headerlink" title="安装 repgrep"></a>安装 repgrep</h2><p>添加 <code>ppa</code> 后安装 <code>ripgrep</code> ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:x4121/ripgrep</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt install ripgrep</span><br></pre></td></tr></table></figure>

<p>依次运行上边代码即可安装完成。</p>
<h2 id="安装-fd"><a href="#安装-fd" class="headerlink" title="安装 fd"></a>安装 fd</h2><p><code>fd</code> 的话，我找到最简单的安装方法是使用 <code>npm</code> 直接全局安装，注意 <code>npm</code> 需要 <code>Node.js</code> 环境。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g fd-find</span><br></pre></td></tr></table></figure>

<p>全部安装后，可以开始配置 <code>Telescope</code> 了。</p>
<h2 id="配置-Telescope"><a href="#配置-Telescope" class="headerlink" title="配置 Telescope"></a>配置 Telescope</h2><p>再次运行 <code>:checkhealth telescope</code>，如图，依赖都已经安装完成：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/92f2feaad2c74b19a12bdc2927bd4951tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="9-1.png"></p>
<p>无需理会这里提示的 <code>nvim-treesitter</code> 没有找到，我们后边代码高亮章节才会安装。</p>
<p>至此，<code>telescope</code> 就安装完成了，可以运行命令 <code>:Telescope find_files</code> 打开搜索文件窗口，快速打开文件。</p>
<p>除此之外，还有一个常用的功能是全局查找，<code>:Telescope live_grep</code> 可以打开搜索窗口，输入内容后，结果会实时显示。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/7b4be58055014d08980d51509497871dtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="9-2.gif"></p>
<p>接下来将这两个常用功能定义为快捷键，打开 <code>lua/keybindings.lua</code>，根据你的使用习惯增加键盘映射。</p>
<h2 id="快捷键配置"><a href="#快捷键配置" class="headerlink" title="快捷键配置"></a>快捷键配置</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Telescope</span></span><br><span class="line"><span class="comment">-- 查找文件</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-p&gt;&quot;</span>, <span class="string">&quot;:Telescope find_files&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="comment">-- 全局搜索</span></span><br><span class="line">map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;C-f&gt;&quot;</span>, <span class="string">&quot;:Telescope live_grep&lt;CR&gt;&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>这里我定义了 <code>Ctrl + p</code> 为 <code>:Telescope find_files</code>命令，和 <code>VSCode</code> 一样。 但 <code>Neovim</code> 中没办法设置 <code>Ctrl + shift + f</code> 快捷键，所以我设置了 <code>Ctrl + f</code> 为 <code>:Telescope live_grep</code> 全局查找。</p>
<p>默认情况下打开窗口就会进入输入模式，这个时候和在普通编辑器一样，可以按 <code>ESC</code> 键进入 <code>Normal</code> 模式，然后 <code>j/k</code> 在文件列表里上下浏览， 按 <code>i</code> 或 <code>a</code> 回到 <code>Insert</code> 模式，按 <code>ESC</code> 退出。</p>
<p>除了默认的快捷键以外，<code>Telescope</code> 还支持在打开的窗口中自定义快捷键，打开 <code>lua/keybindings.lua</code> 继续添加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Telescope 列表中 插入模式快捷键</span></span><br><span class="line">pluginKeys.telescopeList = &#123;</span><br><span class="line">  i = &#123;</span><br><span class="line">    <span class="comment">-- 上下移动</span></span><br><span class="line">    [<span class="string">&quot;&lt;C-j&gt;&quot;</span>] = <span class="string">&quot;move_selection_next&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;&lt;C-k&gt;&quot;</span>] = <span class="string">&quot;move_selection_previous&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;&lt;Down&gt;&quot;</span>] = <span class="string">&quot;move_selection_next&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;&lt;Up&gt;&quot;</span>] = <span class="string">&quot;move_selection_previous&quot;</span>,</span><br><span class="line">    <span class="comment">-- 历史记录</span></span><br><span class="line">    [<span class="string">&quot;&lt;C-n&gt;&quot;</span>] = <span class="string">&quot;cycle_history_next&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;&lt;C-p&gt;&quot;</span>] = <span class="string">&quot;cycle_history_prev&quot;</span>,</span><br><span class="line">    <span class="comment">-- 关闭窗口</span></span><br><span class="line">    [<span class="string">&quot;&lt;C-c&gt;&quot;</span>] = <span class="string">&quot;close&quot;</span>,</span><br><span class="line">    <span class="comment">-- 预览窗口上下滚动</span></span><br><span class="line">    [<span class="string">&quot;&lt;C-u&gt;&quot;</span>] = <span class="string">&quot;preview_scrolling_up&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;&lt;C-d&gt;&quot;</span>] = <span class="string">&quot;preview_scrolling_down&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意，这个要配置在<code>pluginKeys</code>的声明后面，在<code>return</code>之前</strong></p>
<p>这样在插入模式下按 <code>Ctrl + j</code> &#x2F; <code>Ctrl +k</code> 就可以在文件列表中上下切换了，不再需要切回 <code>Normal</code> 模式了。</p>
<p>当然这个快捷键还没有生效，因为我们还没有创建 <code>telescope</code> 的配置文件。</p>
<h2 id="配置-telescope-插件"><a href="#配置-telescope-插件" class="headerlink" title="配置 telescope 插件"></a>配置 telescope 插件</h2><p>新建配置文件 <code>lua/plugin-config/telescope.lua</code>，代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, telescope = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;telescope&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 telescope&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">telescope.setup(&#123;</span><br><span class="line">  defaults = &#123;</span><br><span class="line">    <span class="comment">-- 打开弹窗后进入的初始模式，默认为 insert，也可以是 normal</span></span><br><span class="line">    initial_mode = <span class="string">&quot;insert&quot;</span>,</span><br><span class="line">    <span class="comment">-- 窗口内快捷键</span></span><br><span class="line">    mappings = <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).telescopeList,</span><br><span class="line">  &#125;,</span><br><span class="line">  pickers = &#123;</span><br><span class="line">    <span class="comment">-- 内置 pickers 配置</span></span><br><span class="line">    find_files = &#123;</span><br><span class="line">      <span class="comment">-- 查找文件换皮肤，支持的参数有： dropdown, cursor, ivy</span></span><br><span class="line">      <span class="comment">-- theme = &quot;dropdown&quot;, </span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  extensions = &#123;</span><br><span class="line">     <span class="comment">-- 扩展插件配置</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>简单解释一下上边代码，在 <code>mappings</code> 部分引入了我们刚才在 <code>lua/keybindings.lua</code> 中定义的快捷键 <code>telescopeList</code>，这样定义才会生效。</p>
<p>我们可以尝试把查找文件的 picker 也就是 <code>Ctrl + p</code> 打开的窗口换一个皮肤，比如 <code>dropdown</code> 这个皮肤是把窗口垂直排列了，内置的皮肤还有 <code>cursor</code> 让窗口在光标位置打开， <code>ivy</code> 则是全屏覆盖的。建议你自己手动试试，看看喜欢哪种效果。</p>
<p>Telescope 非常强大，内置了很多的 pickers，比如 <code>:Telescope buffers</code> 命令可以列出打开的 buffers， <code>:Telescope git_files</code> 列出 git 文件，<code>:Telescope man_pages</code> 列出帮助等等。</p>
<p>你可以在命令补全里看到这些支持的 pickers。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/ea6b3e7dc16d4b6cbc426df12ba36b73tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="9-4.gif"></p>
<p>更多内置 pickers 可以参考 <a href="https://link.juejin.cn/?target=https://github.com/nvim-telescope/telescope.nvim%23pickers">官网说明</a>。</p>
<p>最后别忘了在 <strong>入口文件</strong> 中引入配置文件才能生效。 打开 <code>init.lua</code>，增加代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.telescope&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:wq</code> 保存退出，重启后安装生效。</p>
<p>除了内置的还可以安装第三方扩展，下边就演示一下如何安装扩展。</p>
<h2 id="Telescope-扩展安装"><a href="#Telescope-扩展安装" class="headerlink" title="Telescope 扩展安装"></a>Telescope 扩展安装</h2><p>Telescope 支持非常多的第三方扩展，列表见下边链接：</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/nvim-telescope/telescope.nvim/wiki/Extensions">github.com&#x2F;nvim-telesc…</a></p>
<p>下边通过一个简单的扩展，演示如何安装扩展。</p>
<p>要安装的扩展叫做 <a href="https://link.juejin.cn/?target=https://github.com/LinArcX/telescope-env.nvim">telescope-env.nvim</a> 用于列出系统环境变量，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/f735982ddd12419eaeda8a8e9fedac62tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="9-3.png"></p>
<p>打开 <code>lua/plugins.lua</code> 文件，新增 <code>telescope-env.nvim</code> 相关的内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- telescope extensions</span></span><br><span class="line">use <span class="string">&quot;LinArcX/telescope-env.nvim&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存，自动安装，安装完成后，打开 <code>lua/plugin-config/telescope.lua</code> 文件，在文件最后新增：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- telescope extensions</span></span><br><span class="line"><span class="built_in">pcall</span>(telescope.load_extension, <span class="string">&quot;env&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>重启后，就可以调用 <code>:Telescope env</code> 命令，打开环境变量列表了。</p>
<p>Telescope 就这么多内容了，下一节课是 <strong>基建篇</strong> 的最后一节，我们会看看如何给 Neovim 增加一个漂亮的启动页和项目列表。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="10-如何自定义启动页与项目列表？"><a href="#10-如何自定义启动页与项目列表？" class="headerlink" title="10.如何自定义启动页与项目列表？"></a>10.如何自定义启动页与项目列表？</h1><p>本节课会介绍如何给 Neovim 增加一个自定义启动画面，并列出常用功能，如图所示：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/70bf0cddda5e47d59c27e59b2164ed5etplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="10-3.png"></p>
<p>当我们在命令行中输入 <code>nvim</code> 不带任何路径并敲击回车的时候，就会打开这个界面，通常我们会在这个界面中配置最常用功能，比如打开最近编辑过的文件，快速打开项目文件夹，快速修改快捷键等。</p>
<p>最重要的是，我们要自定一个酷酷的 Banner ，表示这是我们独一无二的版本，接下来我会教你如何定义。 首先需要安装 <a href="https://link.juejin.cn/?target=https://github.com/glepnir/dashboard-nvim">dashboard-nvim</a> 插件</p>
<h2 id="安装-dashboard-nvim-插件"><a href="#安装-dashboard-nvim-插件" class="headerlink" title="安装 dashboard-nvim 插件"></a>安装 dashboard-nvim 插件</h2><p>修改 <code>lua/plugins.lua</code> 文件中添加 <code>glepnir/dashboard-nvim</code> 插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-- Packer 可以升级自己</span></span><br><span class="line">    use(<span class="string">&quot;wbthomason/packer.nvim&quot;</span>)</span><br><span class="line">    <span class="comment">-------------------------- plugins -------------------------------------------</span></span><br><span class="line">    <span class="comment">-- nvim-tree</span></span><br><span class="line">    use(&#123;<span class="string">&quot;kyazdani42/nvim-tree.lua&quot;</span>, requires = <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125;)</span><br><span class="line">    <span class="comment">-- bufferline</span></span><br><span class="line">    use(&#123;<span class="string">&quot;akinsho/bufferline.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span>, <span class="string">&quot;moll/vim-bbye&quot;</span> &#125;&#125;)</span><br><span class="line">    <span class="comment">-- lualine</span></span><br><span class="line">    use(&#123;<span class="string">&quot;nvim-lualine/lualine.nvim&quot;</span>, requires = &#123; <span class="string">&quot;kyazdani42/nvim-web-devicons&quot;</span> &#125; &#125;)</span><br><span class="line">    use(<span class="string">&quot;arkav/lualine-lsp-progress&quot;</span>)</span><br><span class="line">    <span class="comment">-- telescope</span></span><br><span class="line">    use (&#123;<span class="string">&quot;nvim-telescope/telescope.nvim&quot;</span>, requires = &#123; <span class="string">&quot;nvim-lua/plenary.nvim&quot;</span> &#125; &#125;)</span><br><span class="line">    <span class="comment">-- telescope extensions</span></span><br><span class="line">    use <span class="string">&quot;LinArcX/telescope-env.nvim&quot;</span></span><br><span class="line">    <span class="comment">-- dashboard-nvim (新增)</span></span><br><span class="line">    use(<span class="string">&quot;glepnir/dashboard-nvim&quot;</span>)</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存，自动安装，安装完整按 <code>q</code> 退出。 如果报错网络错误，可以重新运行 <code>:PackerSync</code> 。</p>
<p>接着第二步创建配置文件 <code>lua/plugin-config/dashboard.lua</code>，添加如下内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim.g.dashboard_default_executive = <span class="string">&quot;telescope&quot;</span></span><br><span class="line">vim.g.dashboard_custom_footer = &#123; <span class="string">&quot;https://github.com/nshen/learn-neovim-lua&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">vim.g.dashboard_custom_section = &#123;</span><br><span class="line">  a = &#123; description = &#123; <span class="string">&quot;  Projects              &quot;</span> &#125;, command = <span class="string">&quot;Telescope projects&quot;</span> &#125;,</span><br><span class="line">  b = &#123; description = &#123; <span class="string">&quot;  Recently files        &quot;</span> &#125;, command = <span class="string">&quot;Telescope oldfiles&quot;</span> &#125;,</span><br><span class="line">  c = &#123; description = &#123; <span class="string">&quot;  Edit keybindings      &quot;</span> &#125;, command = <span class="string">&quot;edit ~/.config/nvim/lua/keybindings.lua&quot;</span> &#125;,</span><br><span class="line">  d = &#123; description = &#123; <span class="string">&quot;  Edit Projects         &quot;</span> &#125;, command = <span class="string">&quot;edit ~/.local/share/nvim/project_nvim/project_history&quot;</span>, &#125;,</span><br><span class="line">  <span class="comment">-- e = &#123; description = &#123; &quot;  Edit .bashrc          &quot; &#125;, command = &quot;edit ~/.bashrc&quot; &#125;,</span></span><br><span class="line">  <span class="comment">-- f = &#123; description = &#123; &quot;  Edit init.lua         &quot; &#125;, command = &quot;edit ~/.config/nvim/init.lua&quot; &#125;,</span></span><br><span class="line">  <span class="comment">-- g = &#123; description = &#123;&#x27;  Find file          &#x27;&#125;, command = &#x27;Telescope find_files&#x27;&#125;,</span></span><br><span class="line">  <span class="comment">-- h = &#123; description = &#123;&#x27;  Find text          &#x27;&#125;, command = &#x27;Telescope live_grep&#x27;&#125;,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vim.g.dashboard_custom_header = &#123;</span><br><span class="line">  <span class="string">[[ ███╗   ██╗███████╗ ██████╗ ██╗   ██╗██╗███╗   ███╗]]</span>,</span><br><span class="line">  <span class="string">[[ ████╗  ██║██╔════╝██╔═══██╗██║   ██║██║████╗ ████║]]</span>,</span><br><span class="line">  <span class="string">[[ ██╔██╗ ██║█████╗  ██║   ██║██║   ██║██║██╔████╔██║]]</span>,</span><br><span class="line">  <span class="string">[[ ██║╚██╗██║██╔══╝  ██║   ██║╚██╗ ██╔╝██║██║╚██╔╝██║]]</span>,</span><br><span class="line">  <span class="string">[[ ██║ ╚████║███████╗╚██████╔╝ ╚████╔╝ ██║██║ ╚═╝ ██║]]</span>,</span><br><span class="line">  <span class="string">[[ ╚═╝  ╚═══╝╚══════╝ ╚═════╝   ╚═══╝  ╚═╝╚═╝     ╚═╝]]</span>,</span><br><span class="line">  <span class="string">[[                                                   ]]</span>,</span><br><span class="line">  <span class="string">[[                [ version : 1.0.0 ]                ]]</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中 <code>g:dashboard_default_executive</code> 用于选择默认的模糊查询工具，dashboard 支持以下三种：</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https://github.com/liuchengxu/vim-clap">vim-clap</a></li>
<li><a href="https://link.juejin.cn/?target=https://github.com/junegunn/fzf.vim">fzf.vim</a></li>
<li><a href="https://link.juejin.cn/?target=https://github.com/nvim-lua/telescope.nvim">telescope.nvim</a></li>
</ul>
<p>我们选择了上一节课刚刚安装的 <code>telescope.nvim</code>，dashboard 会使用 telescope 弹窗显示结果。</p>
<p><code>vim.g.dashboard_custom_footer</code> 用于自定义底部显示的文字，我这里显示了本小册的完整的代码地址。</p>
<p><code>vim.g.dashboard_custom_header</code> 是最重要的部分，用于自定义顶部显示的 ascii 图片，<a href="https://link.juejin.cn/?target=https://github.com/glepnir/dashboard-nvim/wiki/Ascii-Header-Text">官方 wiki</a> 上有很多推荐图片。</p>
<p>注意：<code>dashboard</code>插件目前已经使用lua重写，配置文件因而变化了，不要照抄</p>
<p><strong>更新了，别用上面的了：2022年11月27日22:00:18</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, db = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;dashboard&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 dashboard&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">db.custom_footer = &#123;</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;https://mindcons.cn     &quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.custom_center = &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">    desc = <span class="string">&quot;Projects                            &quot;</span>,</span><br><span class="line">    action = <span class="string">&quot;Telescope projects&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">    desc = <span class="string">&quot;Recently files                      &quot;</span>,</span><br><span class="line">    action = <span class="string">&quot;Telescope oldfiles&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">    desc = <span class="string">&quot;Edit keybindings                    &quot;</span>,</span><br><span class="line">    action = <span class="string">&quot;edit ~/.config/nvim/lua/keybindings.lua&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">    desc = <span class="string">&quot;Edit Projects                       &quot;</span>,</span><br><span class="line">    action = <span class="string">&quot;edit ~/.local/share/nvim/project_nvim/project_history&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- &#123;</span></span><br><span class="line">  <span class="comment">--   icon = &quot;  &quot;,</span></span><br><span class="line">  <span class="comment">--   desc = &quot;Edit .bashrc                        &quot;,</span></span><br><span class="line">  <span class="comment">--   action = &quot;edit ~/.bashrc&quot;,</span></span><br><span class="line">  <span class="comment">-- &#125;,</span></span><br><span class="line">  <span class="comment">-- &#123;</span></span><br><span class="line">  <span class="comment">--   icon = &quot;  &quot;,</span></span><br><span class="line">  <span class="comment">--   desc = &quot;Change colorscheme                  &quot;,</span></span><br><span class="line">  <span class="comment">--   action = &quot;ChangeColorScheme&quot;,</span></span><br><span class="line">  <span class="comment">-- &#125;,</span></span><br><span class="line">  <span class="comment">-- &#123;</span></span><br><span class="line">  <span class="comment">--   icon = &quot;  &quot;,</span></span><br><span class="line">  <span class="comment">--   desc = &quot;Edit init.lua                       &quot;,</span></span><br><span class="line">  <span class="comment">--   action = &quot;edit ~/.config/nvim/init.lua&quot;,</span></span><br><span class="line">  <span class="comment">-- &#125;,</span></span><br><span class="line">  <span class="comment">-- &#123;</span></span><br><span class="line">  <span class="comment">--   icon = &quot;  &quot;,</span></span><br><span class="line">  <span class="comment">--   desc = &quot;Find file                           &quot;,</span></span><br><span class="line">  <span class="comment">--   action = &quot;Telescope find_files&quot;,</span></span><br><span class="line">  <span class="comment">-- &#125;,</span></span><br><span class="line">  <span class="comment">-- &#123;</span></span><br><span class="line">  <span class="comment">--   icon = &quot;  &quot;,</span></span><br><span class="line">  <span class="comment">--   desc = &quot;Find text                           &quot;,</span></span><br><span class="line">  <span class="comment">--   action = &quot;Telescopecope live_grep&quot;,</span></span><br><span class="line">  <span class="comment">-- &#125;,</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db.custom_header = &#123;</span><br><span class="line">  <span class="string">[[                                                   ]]</span>,</span><br><span class="line">  <span class="string">[[ ███╗   ██╗███████╗ ██████╗ ██╗   ██╗██╗███╗   ███╗]]</span>,</span><br><span class="line">  <span class="string">[[ ████╗  ██║██╔════╝██╔═══██╗██║   ██║██║████╗ ████║]]</span>,</span><br><span class="line">  <span class="string">[[ ██╔██╗ ██║█████╗  ██║   ██║██║   ██║██║██╔████╔██║]]</span>,</span><br><span class="line">  <span class="string">[[ ██║╚██╗██║██╔══╝  ██║   ██║╚██╗ ██╔╝██║██║╚██╔╝██║]]</span>,</span><br><span class="line">  <span class="string">[[ ██║ ╚████║███████╗╚██████╔╝ ╚████╔╝ ██║██║ ╚═╝ ██║]]</span>,</span><br><span class="line">  <span class="string">[[ ╚═╝  ╚═══╝╚══════╝ ╚═════╝   ╚═══╝  ╚═╝╚═╝     ╚═╝]]</span>,</span><br><span class="line">  <span class="string">[[                                                   ]]</span>,</span><br><span class="line">  <span class="string">[[                [ version : 1.0.0 ]                ]]</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>比如卖个萌可以设置成宝可梦：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim.g.dashboard_custom_header = &#123;</span><br><span class="line">    <span class="string">[[          ▀████▀▄▄              ▄█ ]]</span>,</span><br><span class="line">    <span class="string">[[            █▀    ▀▀▄▄▄▄▄    ▄▄▀▀█ ]]</span>,</span><br><span class="line">    <span class="string">[[    ▄        █          ▀▀▀▀▄  ▄▀  ]]</span>,</span><br><span class="line">    <span class="string">[[   ▄▀ ▀▄      ▀▄              ▀▄▀  ]]</span>,</span><br><span class="line">    <span class="string">[[  ▄▀    █     █▀   ▄█▀▄      ▄█    ]]</span>,</span><br><span class="line">    <span class="string">[[  ▀▄     ▀▄  █     ▀██▀     ██▄█   ]]</span>,</span><br><span class="line">    <span class="string">[[   ▀▄    ▄▀ █   ▄██▄   ▄  ▄  ▀▀ █  ]]</span>,</span><br><span class="line">    <span class="string">[[    █  ▄▀  █    ▀██▀    ▀▀ ▀▀  ▄▀  ]]</span>,</span><br><span class="line">    <span class="string">[[   █   █  █      ▄▄           ▄▀   ]]</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/c7b923da434a4a8889a5c11b6c471a3atplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="10-2.png"></p>
<p>也可以跟我一样使用文字，你可以搜索一下 ascii 图片生成器，生成自己专属图片，我的文字是使用 <a href="https://link.juejin.cn/?target=http://patorjk.com/software/taag/%23p=display&f=ANSI%20Shadow&t=neovim">patorjk.com</a> 生成的。进入后输入文字，然后点击左下角的 <code>Select &amp; Copy</code> 即可复制到剪贴板。</p>
<p>接下来<code>vim.g.dashboard_custom_section</code> 列出常用功能， 它的基本格式为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim.g.dashboard_custom_section = &#123;</span><br><span class="line">  key = &#123; description = &#123; <span class="string">&quot;图标  标题              &quot;</span> &#125;, command = <span class="string">&quot;命令&quot;</span> &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如想要增加一条查找文件，就可以：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = &#123; description = &#123;<span class="string">&#x27;  Find file          &#x27;</span>&#125;, command = <span class="string">&#x27;Telescope find_files&#x27;</span>&#125;,</span><br></pre></td></tr></table></figure>

<p>这里的图标需要 Nerdfont 字体支持，所以会显示成问号，复制到 Neovim 中就可以正常显示了，你可以到这个网站 <a href="https://link.juejin.cn/?target=https://www.nerdfonts.com/cheat-sheet">nerdfonts.com&#x2F;cheat-sheet</a> 搜索想要的图标，并复制过来。</p>
<p>你可以调用任何你想要的命令，比如增加一个换肤功能，调用 <code>Telescope colorscheme</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = &#123; description = &#123; <span class="string">&quot;  Change Theme           &quot;</span>&#125;, command = <span class="string">&#x27;Telescope colorscheme&#x27;</span>&#125;,</span><br></pre></td></tr></table></figure>

<p>我只列举了 4 个，其中 <code>Telescope oldfiles</code> 用于打开最近编辑的文件。 <code>edit ~/.config/nvim/lua/keybindings.lua</code> 用于编辑快捷键， 因为你一定会经常调整快捷键。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = &#123; description = &#123; <span class="string">&quot;  Projects              &quot;</span> &#125;, command = <span class="string">&quot;Telescope projects&quot;</span> &#125;,</span><br><span class="line">b = &#123; description = &#123; <span class="string">&quot;  Recently files        &quot;</span> &#125;, command = <span class="string">&quot;Telescope oldfiles&quot;</span> &#125;,</span><br><span class="line">c = &#123; description = &#123; <span class="string">&quot;  Edit keybindings      &quot;</span> &#125;, command = <span class="string">&quot;edit ~/.config/nvim/lua/keybindings.lua&quot;</span> &#125;,</span><br><span class="line">d = &#123; description = &#123; <span class="string">&quot;  Edit Projects         &quot;</span> &#125;, command = <span class="string">&quot;edit ~/.local/share/nvim/project_nvim/project_history&quot;</span>, &#125;,</span><br></pre></td></tr></table></figure>

<p>剩下的 <code>Telescope projects</code> 并不是 telescope 内置的命令。 而是 telescope 的一个插件，需要安装 <a href="https://link.juejin.cn/?target=https://github.com/ahmedkhalf/project.nvim">ahmedkhalf&#x2F;project.nvim</a> 后才能使用。</p>
<p>（补充：记得在init.lua中导入）</p>
<h2 id="安装-project-nvim-插件"><a href="#安装-project-nvim-插件" class="headerlink" title="安装 project.nvim 插件"></a>安装 project.nvim 插件</h2><p>打开 <code>lua/plugins.lua</code>，别忘了你现在已经可以用 <code>Ctrl + p</code> 模糊搜索找到它了， 在文件中添加 <code>ahmedkhalf/project.nvim</code> 插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- project</span></span><br><span class="line">use(<span class="string">&quot;ahmedkhalf/project.nvim&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存，自动安装，安装完整按 <code>q</code> 退出。 如果报错网络错误，可以重新运行 <code>:PackerSync</code> 。</p>
<p>根据 <code>project.nvim</code> 的文档，首先要确保我们之前设置的 <code>lua/plugin-config/nvim-tree.lua</code> 配置文件中有下边这一段代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nvim_tree.setup(&#123;</span><br><span class="line">  <span class="comment">--- 上略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">-- project plugin 需要这样设置</span></span><br><span class="line">  update_cwd = <span class="literal">true</span>,</span><br><span class="line">  update_focused_file = &#123;</span><br><span class="line">    enable = <span class="literal">true</span>,</span><br><span class="line">    update_cwd = <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- 下略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码让 <code>nvim-tree</code> 支持切换目录。 之后可以创建 <code>lua/plugin-config/project.lua</code> 配置文件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, project = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;project_nvim&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">    vim.notify(<span class="string">&quot;没有找到 project_nvim&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- nvim-tree 支持</span></span><br><span class="line">vim.g.nvim_tree_respect_buf_cwd = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">project.setup(&#123;</span><br><span class="line">  detection_methods = &#123; <span class="string">&quot;pattern&quot;</span> &#125;,</span><br><span class="line">  patterns = &#123; <span class="string">&quot;.git&quot;</span>, <span class="string">&quot;_darcs&quot;</span>, <span class="string">&quot;.hg&quot;</span>, <span class="string">&quot;.bzr&quot;</span>, <span class="string">&quot;.svn&quot;</span>, <span class="string">&quot;Makefile&quot;</span>, <span class="string">&quot;package.json&quot;</span>, <span class="string">&quot;.sln&quot;</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, telescope = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;telescope&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 telescope&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">pcall</span>(telescope.load_extension, <span class="string">&quot;projects&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>pcall</code> 的部分应该非常熟悉了，如果没有找到 <code>project_nvim</code>， 那么就不继续执行。</p>
<p><code>detection_methods</code> 设置检测方式，这里设置为 <code>pattern</code>，也就是按照下边的 patterns 参数来检测，当文件夹里有这些文件时，就会被当作一个 project 文件夹，自动保存在配置文件中。</p>
<p>保存后，最后一步别忘了在 <strong>入口文件</strong> 中引入这两个配置文件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.dashboard&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.project&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>重启后 <code>Telescope projects</code> 即可生效，当我们命令行中输入 <code>nvim</code> 回车后进入启动画面，j、k 切换选项，再次回车即可执行对应命令。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/c78f2231dc744f218ad60bcf702910e2tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="10-1.gif"></p>
<p>但有时候会发现 project 列表并不是我常用的项目列表，列出了很多没用的项目，这时候就需要手动编辑 <code>project_history</code> 列表了，但这个列表保存在哪里呢？</p>
<p>运行命令 <code>:lua print(require(&quot;project_nvim.utils.path&quot;).historyfile)</code> 就可以看到 <code>project_history</code> 文件的路径了。</p>
<p>我这里显示的是 <code>~/.local/share/nvim/project_nvim/project_history</code> 这个文件，我们可以直接手动修改这个文件，仅保存常用的项目。</p>
<p>好了，目前文本编辑器已经差不多了，下一节就进入 <strong>代码篇</strong> 了，我们会专注在代码相关的功能上。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="11-Neovim-语法高亮的安装与配置"><a href="#11-Neovim-语法高亮的安装与配置" class="headerlink" title="11.Neovim 语法高亮的安装与配置"></a>11.Neovim 语法高亮的安装与配置</h1><p>我们正式进入 <strong>代码篇</strong> 了，本节课会为 <code>Neovim</code> 增加代码高亮功能。提到代码高亮，首先要提到的是 <a href="https://link.juejin.cn/?target=https://tree-sitter.github.io/tree-sitter/">Tree-sitter</a> 项目， Tree-sitter 是一个解析器生成器工具和增量解析库，它可以在源文件编辑的同时高效的实时生成语法树.</p>
<p>接着出现的是 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter">nvim-treesitter</a> 项目，<code>nvim-treesitter</code> 是 <code>Neovim</code> 下的 <code>Tree-sitter</code> 配置和抽象层，它的目标是给 <code>Neovim</code> 提供一个简单的 <code>Tree-sitter</code> 接口，并且提供多个基于 <code>Tree-sitter</code> 的基础功能模块，它可以让你在 nvim 中高效的实现 <strong>代码高亮</strong>，<strong>增量选择</strong> 等基础功能。</p>
<p>下图是 <code>nvim-treesitter</code> 官方提供代码高亮对比图，左侧为传统的代码高亮模式，右侧为基于 <code>Tree-sitter</code> 的代码高亮：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/b9147a820eb84e2fbdab023ecf03d27ftplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="nvim-treesitter.png"></p>
<p>不同语言的效果截图详见官网 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter/wiki/Gallery">Gallery</a> 。</p>
<p><code>nvim-treesitter</code> 支持的语言非常多，常见编程语言都支持，列表见 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter%23supported-languages">Supported languages</a> 。</p>
<p>首先看一下如何安装 <code>nvim-treesitter</code> 。</p>
<h2 id="安装-nvim-treesitter"><a href="#安装-nvim-treesitter" class="headerlink" title="安装 nvim-treesitter"></a>安装 nvim-treesitter</h2><p><code>nvim-treesitter</code> 同我们之前安装的插件没有什么不同，可以直接使用我们之前介绍的 <code>Packer.nvim</code> 安装。</p>
<p>修改 <code>lua/plugins.lua</code> 文件中添加 <code>nvim-treesitter/nvim-treesitter</code> 插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">packer.startup(&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">    <span class="comment">-------------------------- plugins -------------------------------------------</span></span><br><span class="line">    .... 略</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- treesitter （新增）</span></span><br><span class="line">    use(&#123; <span class="string">&quot;nvim-treesitter/nvim-treesitter&quot;</span>, run = <span class="string">&quot;:TSUpdate&quot;</span> &#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>这里的 <code>run = &quot;:TSUpdate&quot;</code> 是 <code>Packer.nvim</code> 的一个 <code>Post-install hook</code>，表示当组件安装或更新完成时会执行 <code>:TSUpdate</code> 命令。</p>
<p>需要这句是因为特定的 <code>nvim-treesitter</code> 插件版本只与特定的 <code>language parser</code> 版本匹配。所以每次我们需要更新了这个插件的时候，当然我们也必须要同步更新所有已经安装的 <code>language parsers</code>。</p>
<p>同其他插件一样，<code>:w</code> 保存后自动安装，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/ffb638437139499288d8231417f5e668tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-1.gif"></p>
<p>当我们安装完插件后，注意看上图底部的状态栏，默认会自动下载安装一个 <code>c</code> 的 <code>parser</code> 。等待完成，按 q 退出。如果报网络错误，重新运行 <code>:PackerSync</code>。</p>
<p><code>nvim-treesitter</code> 代码高亮之所以效果这么好，就是因为可以针对不同的语言，安装不同的 <code>language parser</code>， 下面我们看一下如何根据你的需要来安装。</p>
<h2 id="手动安装-Language-parser"><a href="#手动安装-Language-parser" class="headerlink" title="手动安装 Language parser"></a>手动安装 Language parser</h2><p>你可以运行 <code>:TSInstallInfo</code> 命令查看 language parsers 列表与安装状态，如下图所示，只有 c 语言是安装好的：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/6b61350cb44b4ff49a605b8cbcdc4166tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-1.png"></p>
<p>如果我们要安装指定的 <code>Language parser</code>，则我们需要调用命令：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:TSInstall <span class="symbol">&lt;language_to_install&gt;</span></span><br></pre></td></tr></table></figure>

<p>比如我们要安装 <code>JavaScript</code> 语言，则应该调用 <code>:TSInstall javascript</code>。</p>
<p>当我们调用 <code>TSInstall</code> 命令的时候，插件会我们生成一个 <code>&lt;language&gt;.so</code> 语法文件，放在插件的 <code>parser</code> 文件夹内，比如我的系统中完整目录在：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/nn/.local/share/nvim/site/pack/packer/start/nvim-treesitter/parser</span><br></pre></td></tr></table></figure>

<p>进入目录会发现我们刚安装的 <code>javascript.so</code> 和 <code>c.so</code>，每个文件只有几百 KB 大小。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/258f0df0ab224a46b8106cb2ab2ffdfbtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-2.png"></p>
<p>如果这个时候运行 <code>:TSInstallInfo</code> 则 <code>javascript</code> 也会对应打上勾勾。</p>
<p>对应的 <code>:TSUninstall &lt;language_to_uninstall&gt;</code> 命令用于卸载 language parser 。</p>
<p>其实我们可以不必手动安装 <code>language parsers</code> ，可以在 <code>nvim-treesitter</code> 的配置文件中指定自动安装，下边开始配置 <code>nvim-treesitter</code>。</p>
<h2 id="配置-nvim-treesitter"><a href="#配置-nvim-treesitter" class="headerlink" title="配置 nvim-treesitter"></a>配置 nvim-treesitter</h2><p>创建 <code>lua/plugin-config/nvim-treesitter.lua</code> 文件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, treesitter = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;nvim-treesitter.configs&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">    vim.notify(<span class="string">&quot;没有找到 nvim-treesitter&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">treesitter.setup(&#123;</span><br><span class="line">  <span class="comment">-- 安装 language parser</span></span><br><span class="line">  <span class="comment">-- :TSInstallInfo 命令查看支持的语言</span></span><br><span class="line">  ensure_installed = &#123; <span class="string">&quot;json&quot;</span>, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;css&quot;</span>, <span class="string">&quot;vim&quot;</span>, <span class="string">&quot;lua&quot;</span>, <span class="string">&quot;javascript&quot;</span>, <span class="string">&quot;typescript&quot;</span>, <span class="string">&quot;tsx&quot;</span> &#125;,</span><br><span class="line">  <span class="comment">-- 启用代码高亮模块</span></span><br><span class="line">  highlight = &#123;</span><br><span class="line">    enable = <span class="literal">true</span>,</span><br><span class="line">    additional_vim_regex_highlighting = <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>ensure_installed</code> 就是自动安装 parsers，不必提前手动安装，只要这里列出，下次重启后就会自动安装，当然如果设置过多那么首次重启会卡一下，而且网络不好的话每个下载失败都会报错。</p>
<p>你可以和上述代码一样为<code>ensure_installed</code> 制定一个列表，也可以是直接设置为 <code>&quot;all&quot;</code> 或 <code>&quot;maintained&quot;</code> ，表示一次下载所有的 parsers。下次重启后就会下载对应的语法文件了。 这里建议你还是自定义用到的语言列表，其次是设置成 <code>maintained</code> 如果设置成 <code>maintained</code> ，那么我这里的下载量大概在 45MB 左右，给你作为参考。</p>
<p><code>highlight</code> 是 <code>nvim-treesitter</code> 的语法高亮模块，设置 <code>enable</code> 为 <code>true</code> 则开启语法高亮功能，由于使用基于 <code>treesitter</code> 的语法高亮，所以将<code>additional_vim_regex_highlighting</code> 设置为 <code>false</code> 关闭 vim 的正则语法高亮。</p>
<p>保存后别忘了在 <strong>入口文件</strong> 中引入该配置文件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;basic&quot;</span>)</span><br><span class="line"><span class="comment">-- Packer插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="comment">-- 主题设置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;colorscheme&quot;</span>)</span><br><span class="line"><span class="comment">-- 插件配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-tree&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.bufferline&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.lualine&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.telescope&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.dashboard&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.project&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-treesitter&quot;</span>) <span class="comment">-- （新增）</span></span><br></pre></td></tr></table></figure>

<p>重启后，如果一切正常即可看到代码高亮效果，调用 <code>:TSBufToggle highlight</code> 命令可以切换打开关闭代码高亮功能，如图。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/b2b1436bb09941eb897ede9256e0c488tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-3.gif"></p>
<p>然而这个代码高亮颜色，和我们之前安装的 <code>colorscheme</code> 支持程度有关，不同的主题配色显示会不一样，你可以在 <code>nvim-treesitter</code> 的 <code>wiki</code> 里查看不同到皮肤的显示效果，网址如下：</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter/wiki/Colorschemes">github.com&#x2F;nvim-treesi…</a></p>
<p>然而下图演示了很多网友都遇到过的一个经典的 bug ，我本来配置好好的 Neovim 环境，在某次更新插件后，突然也出现了这个 bug，后来发现很多人都遇到了这个情况，如图 ：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/c907598933cc4dfea2fc32655987b3b0tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-2.gif"></p>
<p>经我查询发现，这是由于我们安装的某个 <code>colorscheme</code> 和 <code>treesitter</code> 不兼容导致的。 我之前安装的 <code>zephy-nvim</code> 配色原本是兼容的，但在某次的更新后突然出现了不兼容的状况，所以出现了上述bug。</p>
<p>解决办法也非常简单，直接卸载这个配色即可，卸载的办法就是在 <code>plugins.lua</code> 中把该行插件注释掉，然后保存，则会自动删除掉那个插件。</p>
<p>所以我还是推荐使用下载量比较大，比较流行的主题配色，通常不会出现 bug ，比如我们的 <code>tokyonight</code> 主题。如果你也出现了这种情况，试着找一找是哪个皮肤的问题。</p>
<p>除了代码高亮功能外，<code>nvim-treesitter</code> 还提供其他 3 个内置模块功能，可以根据你的需要添加，下边介绍增量选择模块。</p>
<h2 id="补充-2"><a href="#补充-2" class="headerlink" title="补充"></a>补充</h2><p>可能会提示C99Mode之类的错误，这是编译的模式问题</p>
<p>临时更新gcc版本</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_23418145/article/details/121162908">(3条消息) centos7升级gcc 解决make时c99错误_Telda_W的博客-CSDN博客</a></p>
<h2 id="增量选择模块"><a href="#增量选择模块" class="headerlink" title="增量选择模块"></a>增量选择模块</h2><p>什么是增量选择 (incremental selection) ？ 当你的光标在一个语法结点上时，可以设置一个增加键和一个减少键，敲击这两个，在表现上为不断外扩和收缩选中代码。</p>
<p>见图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/2fab0f9a0abe4385a20735a6b14f4255tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-4.gif"></p>
<p>如果你需要这个功能，需要打开 <code>lua/plugin-config/nvim-treesitter.lua</code> 文件，在 <code>highlight</code> 模块下方，增加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 启用增量选择模块</span></span><br><span class="line">incremental_selection = &#123;</span><br><span class="line">  enable = <span class="literal">true</span>,</span><br><span class="line">  keymaps = &#123;</span><br><span class="line">    init_selection = <span class="string">&quot;&lt;CR&gt;&quot;</span>,</span><br><span class="line">    node_incremental = <span class="string">&quot;&lt;CR&gt;&quot;</span>,</span><br><span class="line">    node_decremental = <span class="string">&quot;&lt;BS&gt;&quot;</span>,</span><br><span class="line">    scope_incremental = <span class="string">&quot;&lt;TAB&gt;&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>注意到上边代码，为了减少记忆额外快捷键的负担，我将增加和减少结点的快捷键设置成了 <strong>回车</strong> 和 <strong>退格</strong> 。通过不断的按 Enter 选择区域会从里层不断外扩， Backspace 则相反不断内收。</p>
<p>除了增量选择模块，<code>nvim-treesitter</code> 还内置了一个比较实用的代码缩进模块，用于简单的代码缩进调整，下边介绍一下。</p>
<h2 id="代码缩进模块"><a href="#代码缩进模块" class="headerlink" title="代码缩进模块"></a>代码缩进模块</h2><p>启用该模块后，可以使用 <code>=</code> 操作符对代码缩进，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/36c87fe145764f25bf13a2e313176468tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-5.gif"></p>
<p>在上边的演示中，我是先选中要缩进的代码，然后按 <code>=</code> 键，即可对选中代码缩进。</p>
<p>如果要对整个文件进行缩进，可以使用 <code>gg=G</code> 组合键，因为 <code>gg</code> 是跳到首行，<code>G</code> 是跳到尾行，<code>gg=G</code> 就是从首行一直缩进到尾行，相当于 <code>ggvG</code> 选中整个文件然后用 <code>=</code> 格式化。</p>
<p>如果你经常使用这个组合键，那么你可以考虑像我们之前一样，添加一个快捷键到 <code>lua/keybindings.lua</code>，这里不再详述。</p>
<p>想要启用代码缩进功能模块，需要打开 <code>lua/plugin-config/nvim-treesitter.lua</code> 文件，在 <code>incremental_selection</code> 模块下方，增加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 启用代码缩进模块 (=)</span></span><br><span class="line">indent = &#123;</span><br><span class="line">  enable = <span class="literal">true</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p><code>nvim-treesitter</code> 还内置了一个基于 <code>Tree-sitter</code> 的代码折叠功能模块，下边介绍一下。</p>
<h2 id="代码折叠模块"><a href="#代码折叠模块" class="headerlink" title="代码折叠模块"></a>代码折叠模块</h2><p>代码折叠可以使代码更清晰，更易于阅读，基于 <code>Tree-sitter</code> 的代码折叠可以精确的折叠 <code>&#123;&#125;</code> 中的内容。演示如下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/d426c6a54d464b3a80bf5982aec20b75tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-6.gif"></p>
<p>在上边的演示中，我使用了 <code>zc</code> 组合键来折叠 <code>&#123;&#125;</code> 中的内容，还可以使用 <code>zo</code> 组合键来打开对应的折叠。</p>
<p>如果你需要这个功能，那么打开 <code>lua/plugin-config/nvim-treesitter.lua</code>，在文件的最下方插入代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启 Folding 模块</span></span><br><span class="line">vim.opt.foldmethod = <span class="string">&quot;expr&quot;</span></span><br><span class="line">vim.opt.foldexpr = <span class="string">&quot;nvim_treesitter#foldexpr()&quot;</span></span><br><span class="line"><span class="comment">-- 默认不要折叠</span></span><br><span class="line"><span class="comment">-- https://stackoverflow.com/questions/8316139/how-to-set-the-default-to-unfolded-when-you-open-a-file</span></span><br><span class="line">vim.opt.foldlevel = <span class="number">99</span></span><br></pre></td></tr></table></figure>

<p>注意这次是插入在文件的最下方，因为这个功能严格意义上不是一个模块，因为它对应的是 windows 而不是一个 buffer。</p>
<p>最后，你可以运行 <code>:TSModuleInfo</code> 命令来查看你的模块是否开启成功，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/243d083c59a047b2bb680454e20d2ac6tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="11-3.png"></p>
<p><code>nvim-treesitter</code> 内置功能大概就这么多，但其 <a href="https://link.juejin.cn/?target=https://github.com/nvim-treesitter/nvim-treesitter/wiki/Extra-modules-and-plugins">官方 wiki </a>中还列出了许多第三方的功能模块和插件，你也可以去了解一下。</p>
<p>下一节课会介绍 Neovim 内置 LSP 的基础配置，赶快来吧。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="12-Neovim-内置-LSP-的基础配置"><a href="#12-Neovim-内置-LSP-的基础配置" class="headerlink" title="12.Neovim 内置 LSP 的基础配置"></a>12.Neovim 内置 LSP 的基础配置</h1><p>想要在 <code>Neovim</code> 中配置代码补全、代码悬停、代码提示等等功能，首先要了解什么是 LSP (Language Server Protocol) 语言服务协议?</p>
<p>在 LSP 出现之前，传统的 IDE 都要为其支持的每个语言实现类似的代码补全、文档提示、跳转到定义等功能，不同的 IDE 做了很多重复的工作，并且兼容性也不是很好。 LSP 的出现将编程工具解耦成了 <strong>Language Server</strong> 与 <strong>Language Client</strong> 两部分。定义了编辑器与语言服务器之间交互协议。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/11556d465ae2488a81ced76c51a36bd0tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-1.png"></p>
<p>Client 专注于显示样式实现， Server 负责提供语言支持，包括常见的自动补全、跳转到定义、查找引用、悬停文档提示等功能。</p>
<p>而我们所说的 Neovim 内置 LSP 就是说 Neovim 内置了一套 Language Client 端的实现，这样我们就可以连接到和 VSCode 相同的第三方 language servers ，实现高质量的语法补全等功能。</p>
<p>下边我们就来看看如何开启 Neovim 的内置 LSP 功能。</p>
<h2 id="开启-Neovim-内置-LSP"><a href="#开启-Neovim-内置-LSP" class="headerlink" title="开启 Neovim 内置 LSP"></a>开启 Neovim 内置 LSP</h2><p>通过命令 <code>:h lsp</code> 查看 LSP 文档的 QUICKSTART 部分写了 4 步：</p>
<ol>
<li>安装 nvim-lspconfig</li>
<li>安装对应 language server</li>
<li>配置对应语言 require(‘lspconfig’).xx.setup{…}</li>
<li>:lua print(vim.inspect(vim.lsp.buf_get_clients())) 查看 LSP 连接状态</li>
</ol>
<p>首先第一步就是要配置客户端，之所以要安装 <a href="https://link.juejin.cn/?target=https://github.com/neovim/nvim-lspconfig">nvim-lspconfig</a> ，是因为 <code>nvim-lspconfig</code> 提供了一堆常见服务的配置方式。</p>
<p>第二步就是安装语言服务器，比如要安装 TypeScript Language Server，就可以到对应的 <a href="https://link.juejin.cn/?target=https://github.com/typescript-language-server/typescript-language-server">主页</a> 上查找安装方式，发现可以用 npm 命令 <code>npm install -g typescript-language-server</code> 进行安装。</p>
<p>值得庆幸的是，现在有了 <a href="https://link.juejin.cn/?target=https://github.com/williamboman/nvim-lsp-installer">nvim-lsp-installer</a> 项目，可以帮助我们管理，并自动安装 Language Server。</p>
<p>所以我们把这两个插件一并安装起来，打开 <code>lua/plugins.lua</code> 添加 <code>nvim-lspconfig</code> 和 <code>nvim-lsp-installer</code> 组件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">--------------------- LSP --------------------</span></span><br><span class="line">    use(<span class="string">&quot;williamboman/nvim-lsp-installer&quot;</span>)</span><br><span class="line">    <span class="comment">-- Lspconfig</span></span><br><span class="line">    use(&#123; <span class="string">&quot;neovim/nvim-lspconfig&quot;</span> &#125;)</span><br><span class="line"></span><br><span class="line">...略</span><br></pre></td></tr></table></figure>

<p>同其他插件一样，<code>:w</code> 保存后自动安装，如果报错网络错误，可以重新运行 <code>:PackerSync</code>。</p>
<p>插件安装安装完成后，我们先看一下如何用 <code>nvim-lsp-installer</code> 来安装 language servers。</p>
<h2 id="安装-LSP-Servers"><a href="#安装-LSP-Servers" class="headerlink" title="安装 LSP Servers"></a>安装 LSP Servers</h2><p>我们先来看一下最简单的方式，运行 <code>:LspInstallInfo</code> 命令，会打开一个图形化界面，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/1091ea7c9b4a4baf8c48b7e06c179beftplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-2.png"></p>
<p>看到上图界面表示安装成功了，<code>Available servers</code> 中列出了可以安装的 servers，这时你可以使用 <code>j / k</code> 移动光标到你要安装的 server，点击键盘 <code>i</code> 安装，i 表示 install。</p>
<p>安装完成后会列出该 LSP Server 的版本和安装的目录等信息，过程演示如下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/cf4bb32fa64549d184d5eb98fbcd8e9ctplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-1.gif"></p>
<p>在该界面还有一些其他的快捷键，比如：</p>
<ul>
<li>大写的 <code>X</code> 是卸载该 server</li>
<li><code>u</code> 是更新 server</li>
<li>大写 <code>U</code> 更新所有 servers</li>
<li><code>c</code> 检查 server 新版本</li>
<li>大写 <code>C</code> 检查所有 servers 的新版本</li>
<li><code>ESC</code> 关闭窗口</li>
<li><code>?</code> 显示其他帮助信息</li>
</ul>
<p>几乎所有 Language Server 的管理都可以在这个界面搞定。下边 LSP 的配置部分。</p>
<h2 id="配置-LSP-Server"><a href="#配置-LSP-Server" class="headerlink" title="配置 LSP Server"></a>配置 LSP Server</h2><p>因为会创建很多文件，所以我们首先创建一个新的目录 <code>lua/lsp/</code> 专门存放 lsp 相关的配置，这样可以使配置文件组织更加清晰。</p>
<p>然后创建第一个文件 <code>lua/lsp/setup.lua</code>，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> lsp_installer = <span class="built_in">require</span>(<span class="string">&quot;nvim-lsp-installer&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 安装列表</span></span><br><span class="line"><span class="comment">-- &#123; key: 语言 value: 配置文件 &#125;</span></span><br><span class="line"><span class="comment">-- key 必须为下列网址列出的名称</span></span><br><span class="line"><span class="comment">-- https://github.com/williamboman/nvim-lsp-installer#available-lsps</span></span><br><span class="line"><span class="keyword">local</span> servers = &#123;</span><br><span class="line">  sumneko_lua = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.lua&quot;</span>), <span class="comment">-- lua/lsp/config/lua.lua</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">-- 自动安装 Language Servers</span></span><br><span class="line"><span class="keyword">for</span> name, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(servers) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">local</span> server_is_found, server = lsp_installer.get_server(name)</span><br><span class="line">  <span class="keyword">if</span> server_is_found <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> server:is_installed() <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Installing &quot;</span> .. name)</span><br><span class="line">      server:install()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">lsp_installer.on_server_ready(<span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = servers[server.name]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span> == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_setup <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">config</span>.on_setup(server)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        server:setup(&#123;&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>简单解释一下上述代码和配置文件的目录结构。首先我们创建了一个 <code>servers</code> 字典变量，用来存放所有的 LSP Server 的配置。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> servers = &#123;</span><br><span class="line">  sumneko_lua = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.lua&quot;</span>), <span class="comment">-- lua/lsp/config/lua.lua</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里的 key <code>sumneko_lua</code> 不是随意设置的，而是 <code>nvim-lsp-installer</code> 中 lua 语言的 server name，你可以在 <a href="https://link.juejin.cn/?target=https://github.com/williamboman/nvim-lsp-installer%23available-lsps">这个网址</a> 中查到合法的值。</li>
<li>这里的 value <code>require(&quot;lsp.config.lua&quot;)</code> 表示该 Server 对应的配置文件 <code>lua/lsp/config/lua.lua</code> 内容，这个文件需要我们自己创建，这个我们稍后创建。</li>
</ul>
<p>接下来的这段代码，是遍历 <code>servers</code> 字典，检查每个 server 是否已经安装，如果没有安装，就调用 <code>install()</code> 方法来安装。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> name, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(servers) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">local</span> server_is_found, server = lsp_installer.get_server(name)</span><br><span class="line">  <span class="keyword">if</span> server_is_found <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> server:is_installed() <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;Installing &quot;</span> .. name)</span><br><span class="line">      server:install()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>也就是说，如果你还没有按照之前的方法手动安装过 lua server ，那么这里会自动帮你安装上。</p>
<p>下边这段代码，是 <code>lsp_installer</code> 的回调函数，这个函数会在每个 LSP Server 准备好时调用。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">lsp_installer.on_server_ready(<span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = servers[server.name]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span> == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_setup <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">config</span>.on_setup(server)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        server:setup(&#123;&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>在回调函数中，我会先查看我们的 <code>servers</code> 字典中有没有这个 server 的配置文件，如果没有，就什么都不执行。 然后我会查看配置文件中，是否有 <code>on_setup</code> 函数，如果有，就执行这个函数，否则就用默认无配置参数。</p>
<p>之后我会在每个 Language Server 配置文件中导出一个 <code>on_setup</code> 函数，用于初始化该 Server，这样做是因为我发现每个 Server 初始化方法并不完全相同， 用同一套初始化流程并不能满足不同语言定制的需要，所以我将初始化方法抽离出来，让每个 Server 的配置文件来负责初始化。</p>
<p>我们第一个要创建的 Language Server 配置文件就是之前 require 的 lua 文件。</p>
<h2 id="配置-Lua-Server"><a href="#配置-Lua-Server" class="headerlink" title="配置 Lua Server"></a>配置 Lua Server</h2><p>创建文件 <code>lua/lsp/config/lua.lua</code>，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md#sumneko_lua</span></span><br><span class="line"><span class="keyword">local</span> runtime_path = vim.split(<span class="built_in">package</span>.<span class="built_in">path</span>, <span class="string">&#x27;;&#x27;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(runtime_path, <span class="string">&#x27;lua/?.lua&#x27;</span>)</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(runtime_path, <span class="string">&#x27;lua/?/init.lua&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> opts = &#123;</span><br><span class="line">    settings = &#123;</span><br><span class="line">        Lua = &#123;</span><br><span class="line">            runtime = &#123;</span><br><span class="line">                <span class="comment">-- Tell the language server which version of Lua you&#x27;re using (most likely LuaJIT in the case of Neovim)</span></span><br><span class="line">                version = <span class="string">&#x27;LuaJIT&#x27;</span>,</span><br><span class="line">                <span class="comment">-- Setup your lua path</span></span><br><span class="line">                <span class="built_in">path</span> = runtime_path,</span><br><span class="line">            &#125;,</span><br><span class="line">            diagnostics = &#123;</span><br><span class="line">                <span class="comment">-- Get the language server to recognize the `vim` global</span></span><br><span class="line">                globals = &#123; <span class="string">&#x27;vim&#x27;</span> &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            workspace = &#123;</span><br><span class="line">                <span class="comment">-- Make the server aware of Neovim runtime files</span></span><br><span class="line">                library = vim.api.nvim_get_runtime_file(<span class="string">&#x27;&#x27;</span>, <span class="literal">true</span>),</span><br><span class="line">                checkThirdParty = <span class="literal">false</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="comment">-- Do not send telemetry data containing a randomized but unique identifier</span></span><br><span class="line">            telemetry = &#123;</span><br><span class="line">                enable = <span class="literal">false</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    flags = &#123;</span><br><span class="line">        debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, bufnr)</span></span></span><br><span class="line">        <span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">        client.resolved_capabilities.document_formatting = <span class="literal">false</span></span><br><span class="line">        client.resolved_capabilities.document_range_formatting = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(...)</span></span></span><br><span class="line">            vim.api.nvim_buf_set_keymap(bufnr, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 绑定快捷键</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="string">&#x27;keybindings&#x27;</span>).mapLSP(buf_set_keymap)</span><br><span class="line">        <span class="comment">-- 保存时自动格式化</span></span><br><span class="line">        vim.cmd(<span class="string">&#x27;autocmd BufWritePre &lt;buffer&gt; lua vim.lsp.buf.formatting_sync()&#x27;</span>)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看目录等信息</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">        server:setup(opts)</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单解释一下上述代码。先看最后 5 行代码，之前说过我们会让每个 Language Server 配置文件都导出一个 <code>on_setup</code> 函数，用于初始化该 Language Server。 这个函数会接收一个 <code>server</code> 参数， 我们通常会在这个函数中调用 <code>server:setup</code> 方法，并传入我们定制的 <code>opts</code> 参数来初始化语言服务。</p>
<p>在这个 <code>opts</code> 参数里通常会有两个关键项需要你来定制： <code>settings</code> 和 <code>on_attach</code>。</p>
<ul>
<li><code>settings</code> 主要用来配置语言服务，我们一般会在 <code>nvim-lspconfig</code> 项目的 <a href="https://link.juejin.cn/?target=https://github.com/neovim/nvim-lspconfig/blob/master/doc/server_configurations.md">服务器配置项页面</a> 找到对应语言的示例配置。</li>
<li><code>on_attach</code> 是一个回调函数，当语言服务成功绑定到一个 buffer 上时会调用这个函数，所以通常我们会在这个函数里做一些比如快捷键绑定，自动命令，或者设置 buffer 的某些特性等操作。</li>
</ul>
<p>上边代码 <code>on_attach</code> 中调用了 <code>keybindings</code> 文件的 <code>mapLSP</code> 方法。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`<span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)`</span><br></pre></td></tr></table></figure>

<p>这样做的目的是为了把定义快捷键的代码抽离出来，都放在<code>lua/keybindings.lua</code> 这一个位置来统一管理，那么看一下都定义了哪些快捷键。</p>
<h2 id="定义-LSP-快捷键"><a href="#定义-LSP-快捷键" class="headerlink" title="定义 LSP 快捷键"></a>定义 LSP 快捷键</h2><p>现在打开 <code>lua/keybindings.lua</code> 文件，在 pluginKeys 变量声明的后边添加 <code>mapLSP</code> 方法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- lsp 回调函数快捷键设置</span></span><br><span class="line">pluginKeys.mapLSP = <span class="function"><span class="keyword">function</span><span class="params">(mapbuf)</span></span></span><br><span class="line">  <span class="comment">-- rename</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;rn&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.rename()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- code action</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;ca&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.code_action()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- go xx</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gd&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.definition()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gh&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.hover()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gD&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.declaration()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gi&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.implementation()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gr&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.references()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- diagnostic</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gp&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.diagnostic.open_float()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gk&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.diagnostic.goto_prev()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gj&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.diagnostic.goto_next()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;f&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.formatting()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 没用到</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;leader&gt;q&#x27;, &#x27;&lt;cmd&gt;lua vim.diagnostic.setloclist()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&quot;n&quot;, &quot;&lt;C-k&gt;&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.signature_help()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;wa&#x27;, &#x27;&lt;cmd&gt;lua vim.lsp.buf.add_workspace_folder()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;wr&#x27;, &#x27;&lt;cmd&gt;lua vim.lsp.buf.remove_workspace_folder()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;wl&#x27;, &#x27;&lt;cmd&gt;lua print(vim.inspect(vim.lsp.buf.list_workspace_folders()))&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;D&#x27;, &#x27;&lt;cmd&gt;lua vim.lsp.buf.type_definition()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>注意这里的快捷键是所有语言服务器通用的，也就是说未来添加任何语言，都会调用到这里的 mapLSP 方法。</p>
<p>大部分都设置为 g 开头，为方便记忆，表示 go XX，比如 <code>gd</code> 跳转到定义， 然后 <code>gh</code> 显示提示等。</p>
<p>建议根据你自己的习惯修改，这是我目前的配置，未来也可能随时会有修改。</p>
<p>最后一步，别忘了在 <strong>入口文件</strong> 中引入 <code>lua/lsp/setup.lua</code> 才能生效。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;basic&quot;</span>)</span><br><span class="line"><span class="comment">-- Packer插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="comment">-- 主题设置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;colorscheme&quot;</span>)</span><br><span class="line"><span class="comment">-- 插件配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-tree&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.bufferline&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.lualine&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.telescope&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.dashboard&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.project&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-treesitter&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 内置LSP (新增)</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.setup&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:wq</code> 保存后重启，如果没有报错的话，就应该生效了，下边测试一下基本操作。</p>
<h2 id="测试-LSP-常见功能"><a href="#测试-LSP-常见功能" class="headerlink" title="测试 LSP 常见功能"></a>测试 LSP 常见功能</h2><ul>
<li><code>gd</code> 跳转到定义，可以跨文件跳转，从 lua.lua 中 <code>mapLSP</code> 关键字上点击 <code>gd</code>，可以跳转到 keybindings.lua 的方法定义处，如图。</li>
</ul>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/cf8d42e048e649abad87ae3695b7ca94tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-2.gif"></p>
<ul>
<li>随便敲代码会提示错误。</li>
</ul>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/8a7c8b650b6e45aca2ed5dfd875a9282tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-3.gif"></p>
<p>注意顶部的标签页也显示了错误图标，这是因为我们之前在 <code>lua/plugin-config/bufferline.lua</code> 插件的设置中，有这么一段代码</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 使用 nvim 内置 LSP  后续课程会配置</span></span><br><span class="line">diagnostics = <span class="string">&quot;nvim_lsp&quot;</span>,</span><br><span class="line"><span class="comment">-- 可选，显示 LSP 报错图标</span></span><br><span class="line"><span class="comment">---@diagnostic disable-next-line: unused-local</span></span><br><span class="line">diagnostics_indicator = <span class="function"><span class="keyword">function</span><span class="params">(count, level, diagnostics_dict, context)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="string">&quot; &quot;</span></span><br><span class="line">    <span class="keyword">for</span> e, n <span class="keyword">in</span> <span class="built_in">pairs</span>(diagnostics_dict) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> sym = e == <span class="string">&quot;error&quot;</span> <span class="keyword">and</span> <span class="string">&quot; &quot;</span> <span class="keyword">or</span> (e == <span class="string">&quot;warning&quot;</span> <span class="keyword">and</span> <span class="string">&quot; &quot;</span> <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">    s = s .. n .. sym</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span>,</span><br></pre></td></tr></table></figure>

<ul>
<li>修改变量名，用我自定义的快捷键 <code>&lt;leader&gt;rn</code> 修改变量名，然后回车。</li>
</ul>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/e4882f8ad7904517949855b836adcf68tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-4.gif"></p>
<ul>
<li>代码悬停，在关键字上敲击 <code>gh</code> (go hover) 显示提示。</li>
</ul>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/0b46efee9ea94cb5836256252181d506tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="12-5.gif"></p>
<p>一切都很酷，唯独还没有 <strong>代码自动补全</strong> 功能，因为 Neovim 默认并没有提供自动补全框架，所以我们还需要另外配置，这将是我们下一节课的内容。</p>
<blockquote>
<p>配置中如遇任何问题，可到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a> 参考最终源码</p>
</blockquote>
<h1 id="13-基于-LSP-的代码补全与自定义代码段"><a href="#13-基于-LSP-的代码补全与自定义代码段" class="headerlink" title="13.基于 LSP 的代码补全与自定义代码段"></a>13.基于 LSP 的代码补全与自定义代码段</h1><p>Neovim 本身不支持代码补全，需要通过插件实现，我这里使用最流行的 <a href="https://link.juejin.cn/?target=https://github.com/hrsh7th/nvim-cmp">nvim-cmp</a> 插件。</p>
<p>在安装自动代码补全之前，需要了解几个概念：</p>
<ol>
<li><p>补全引擎</p>
<p>补全引擎就是为 Neovim 提供代码补全核心功能的插件，比如 <a href="https://link.juejin.cn/?target=https://github.com/hrsh7th/nvim-cmp">nvim-cmp</a>。</p>
</li>
<li><p>补全源</p>
<p>补全源就是补全引擎需要的数据来源，最常见的来源是来自 Language Server 提供的数据，它会知道某个类有哪些属性和方法等。</p>
</li>
<li><p>snippet 引擎</p>
<p>snippet 引擎就是自定义代码段的引擎，常见的有 <code>vsnip</code>、<code>luasnip</code> 等</p>
</li>
</ol>
<p>三个词组一个句子，可以说：</p>
<p>nvim-cmp 是使用 Lua 编写的 <strong>补全引擎</strong> 插件。可以配置多种外部的<strong>补全源</strong>，支持 <code>vsnip</code>、<code>luasnip</code>、<code>snippy</code>、 <code>ultisnips</code> 4 种 <strong>snippet 引擎</strong> 。</p>
<h2 id="安装补全相关插件"><a href="#安装补全相关插件" class="headerlink" title="安装补全相关插件"></a>安装补全相关插件</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">-- 补全引擎</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/nvim-cmp&quot;</span>)</span><br><span class="line">        <span class="comment">-- snippet 引擎</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/vim-vsnip&quot;</span>)</span><br><span class="line">        <span class="comment">-- 补全源</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-vsnip&quot;</span>)</span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-nvim-lsp&quot;</span>) <span class="comment">-- &#123; name = nvim_lsp &#125;</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-buffer&quot;</span>) <span class="comment">-- &#123; name = &#x27;buffer&#x27; &#125;,</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-path&quot;</span>) <span class="comment">-- &#123; name = &#x27;path&#x27; &#125;</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-cmdline&quot;</span>) <span class="comment">-- &#123; name = &#x27;cmdline&#x27; &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 常见编程语言代码段</span></span><br><span class="line">        use(<span class="string">&quot;rafamadriz/friendly-snippets&quot;</span>)</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>简单解释一下上述代码，我们好像这一次装了好多插件，其实只有 <code>hrsh7th/nvim-cmp</code> 是补全引擎插件本身，其他 <code>cmp-xxx</code> 基本都是插件补全来源，也就是说当你输入一个变量的时候，可以从多个来源显示补全的内容。</p>
<p>像 <code>hrsh7th/cmp-nvim-lsp</code> 就是 Neovim 内置 LSP 提供的补全内容，<code>hrsh7th/cmp-buffer</code> 补全当前 buffer 的内容， <code>hrsh7th/cmp-cmdline</code> 是命令行的补全，<code>hrsh7th/cmp-path</code> 则是用来补全路径，如果配置了这个，当输入一个路径的时候会补全路径，如图</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/1215c8e0d1cc418893b7fc2780393f86tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="13-1.gif"></p>
<p><code>hrsh7th/vim-vsnip</code> 就是一个 snippet 引擎，也就是自定义代码段，文档中提到了 4 种，都是支持的</p>
<p>snippet engine</p>
<ul>
<li>vsnip</li>
<li>luasnip</li>
<li>ultisnips</li>
<li>snippy</li>
</ul>
<p><code>rafamadriz/friendly-snippets</code> 包含了大部分常用语言的代码段，非常强大，可以到他的 github 主页查看详细内容。</p>
<p>不多说 <code>:wq</code> 保存后重启，如遇问题可 <code>:PackerSync</code> 再次安装。</p>
<h2 id="配置自动补全"><a href="#配置自动补全" class="headerlink" title="配置自动补全"></a>配置自动补全</h2><p>新建文件 <code>lua/lsp/cmp.lua</code> ，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cmp = <span class="built_in">require</span>(<span class="string">&quot;cmp&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmp.setup(&#123;</span><br><span class="line">  <span class="comment">-- 指定 snippet 引擎</span></span><br><span class="line">  snippet = &#123;</span><br><span class="line">    expand = <span class="function"><span class="keyword">function</span><span class="params">(args)</span></span></span><br><span class="line">      <span class="comment">-- For `vsnip` users.</span></span><br><span class="line">      vim.fn[<span class="string">&quot;vsnip#anonymous&quot;</span>](args.body)</span><br><span class="line"></span><br><span class="line">      <span class="comment">-- For `luasnip` users.</span></span><br><span class="line">      <span class="comment">-- require(&#x27;luasnip&#x27;).lsp_expand(args.body)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">-- For `ultisnips` users.</span></span><br><span class="line">      <span class="comment">-- vim.fn[&quot;UltiSnips#Anon&quot;](args.body)</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">-- For `snippy` users.</span></span><br><span class="line">      <span class="comment">-- require&#x27;snippy&#x27;.expand_snippet(args.body)</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- 补全源</span></span><br><span class="line">  sources = cmp.<span class="built_in">config</span>.sources(&#123;</span><br><span class="line">    &#123; name = <span class="string">&quot;nvim_lsp&quot;</span> &#125;,</span><br><span class="line">    <span class="comment">-- For vsnip users.</span></span><br><span class="line">    &#123; name = <span class="string">&quot;vsnip&quot;</span> &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- For luasnip users.</span></span><br><span class="line">    <span class="comment">-- &#123; name = &#x27;luasnip&#x27; &#125;,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--For ultisnips users.</span></span><br><span class="line">    <span class="comment">-- &#123; name = &#x27;ultisnips&#x27; &#125;,</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- -- For snippy users.</span></span><br><span class="line">    <span class="comment">-- &#123; name = &#x27;snippy&#x27; &#125;,</span></span><br><span class="line">  &#125;, &#123; &#123; name = <span class="string">&quot;buffer&quot;</span> &#125;, &#123; name = <span class="string">&quot;path&quot;</span> &#125; &#125;),</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- 快捷键设置</span></span><br><span class="line">  mapping = <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).cmp(cmp),</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- / 查找模式使用 buffer 源</span></span><br><span class="line">cmp.setup.cmdline(<span class="string">&quot;/&quot;</span>, &#123;</span><br><span class="line">  sources = &#123;</span><br><span class="line">    &#123; name = <span class="string">&quot;buffer&quot;</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- : 命令行模式中使用 path 和 cmdline 源.</span></span><br><span class="line">cmp.setup.cmdline(<span class="string">&quot;:&quot;</span>, &#123;</span><br><span class="line">  sources = cmp.<span class="built_in">config</span>.sources(&#123;</span><br><span class="line">    &#123; name = <span class="string">&quot;path&quot;</span> &#125;,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    &#123; name = <span class="string">&quot;cmdline&quot;</span> &#125;,</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上述代码中，设置了 3 件事，指定了 snippet 引擎，补全来源，和设置了快捷键。</p>
<p>我这里选择了 <code>vsnip</code> 作为 snippet 引擎，是因为它是 <code>nvim-cmp</code> 同一个作者开发的，应该稳定性会好些，而且貌似很强大可支持 VSCode 相同代码格式。</p>
<p>补全来源最重要的是 <code>nvim_lsp</code>，这个是 Neovim 内置的 LSP 提供的补全内容，如果你使用了 LSP，那么这个补全源就是必须的，然后 <code>vsnip</code> 也是重要的补全来源之一，buffer 和 path 根据需要放在第二组补全源里。</p>
<p>快捷键的设置跟以前一样, 这里调用了 <code>keybindings</code> 的 <code>cmp</code> 方法。</p>
<p>打开 <code>lua/keybindings.lua</code> 在 pluginKeys 变量下边增加 <code>cmp</code> 方法：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- nvim-cmp 自动补全</span></span><br><span class="line">pluginKeys.cmp = <span class="function"><span class="keyword">function</span><span class="params">(cmp)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="comment">-- 出现补全</span></span><br><span class="line">        [<span class="string">&quot;&lt;A-.&gt;&quot;</span>] = cmp.mapping(cmp.mapping.complete(), &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;),</span><br><span class="line">        <span class="comment">-- 取消</span></span><br><span class="line">        [<span class="string">&quot;&lt;A-,&gt;&quot;</span>] = cmp.mapping(&#123;</span><br><span class="line">            i = cmp.mapping.abort(),</span><br><span class="line">            c = cmp.mapping.<span class="built_in">close</span>()</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="comment">-- 上一个</span></span><br><span class="line">        [<span class="string">&quot;&lt;C-k&gt;&quot;</span>] = cmp.mapping.select_prev_item(),</span><br><span class="line">        <span class="comment">-- 下一个</span></span><br><span class="line">        [<span class="string">&quot;&lt;C-j&gt;&quot;</span>] = cmp.mapping.select_next_item(),</span><br><span class="line">        <span class="comment">-- 确认</span></span><br><span class="line">        [<span class="string">&quot;&lt;CR&gt;&quot;</span>] = cmp.mapping.confirm(&#123;</span><br><span class="line">            <span class="built_in">select</span> = <span class="literal">true</span>,</span><br><span class="line">            behavior = cmp.ConfirmBehavior.Replace</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="comment">-- 如果窗口内容太多，可以滚动</span></span><br><span class="line">        [<span class="string">&quot;&lt;C-u&gt;&quot;</span>] = cmp.mapping(cmp.mapping.scroll_docs(<span class="number">-4</span>), &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;),</span><br><span class="line">        [<span class="string">&quot;&lt;C-d&gt;&quot;</span>] = cmp.mapping(cmp.mapping.scroll_docs(<span class="number">4</span>), &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;),</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上边代码主要定义了以下快捷键，你可以根据需要修改：</p>
<ul>
<li><code>&lt;A-.&gt;</code> alt + . 出现补全弹窗</li>
<li><code>&lt;A-,&gt;</code> alt + , 取消补全弹窗</li>
</ul>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/d6bcf9c1e1864c19aa354658eecd29d9tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="13-2.gif"></p>
<ul>
<li><code>&lt;C-k&gt;</code> 上一个</li>
<li><code>&lt;C-j&gt;</code> 下一个</li>
</ul>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/57104fd6e72c4c7f8e7a52cfac0f48cctplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="13-3.gif"></p>
<ul>
<li><code>&lt;CR&gt;</code> 回车确认</li>
<li><code>&lt;C-u&gt;</code> 滚动上</li>
<li><code>&lt;C-d&gt;</code> 滚动下</li>
</ul>
<p>如果窗口内容太多，可以用 <code>Ctrl + u</code> &#x2F; <code>Ctrl + d </code>滚动，很少见，就不再演示了。</p>
<p>如果常用自定义代码段的话，就有一个需求是在各个预定义的参数位置快速跳转，不太好形容，看图就懂了：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/b19f94ff636746f791b63cbac676ca6ftplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="13-4.gif"></p>
<p><code>nvim-cmp</code> 官网的 wiki 中有一个例子，使用 <code>Tab</code> 键和 <code>Shift + Tab</code> 键兼容跳转，叫做 <a href="https://link.juejin.cn/?target=https://github.com/hrsh7th/nvim-cmp/wiki/Example-mappings%23super-tab-like-mapping">Super-Tab like mapping</a></p>
<p>我不太喜欢 Tab 键有多种功能，我参考其代码增加了单独的 <code>&lt;C-l&gt;</code> 和 <code>&lt;C-h&gt;</code> 键做跳转。</p>
<p>你如果也需要这样的功能，可以在 <code>lua/keybindings.lua</code> 修改刚才的 cmp 函数，增加如下代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- nvim-cmp 自动补全</span></span><br><span class="line">pluginKeys.cmp = <span class="function"><span class="keyword">function</span><span class="params">(cmp)</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> feedkey = <span class="function"><span class="keyword">function</span><span class="params">(key, mode)</span></span></span><br><span class="line">    vim.api.nvim_feedkeys(vim.api.nvim_replace_termcodes(key, <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>), mode, <span class="literal">true</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">local</span> has_words_before = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> line, col = <span class="built_in">unpack</span>(vim.api.nvim_win_get_cursor(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> col ~= <span class="number">0</span> <span class="keyword">and</span> vim.api.nvim_buf_get_lines(<span class="number">0</span>, line - <span class="number">1</span>, line, <span class="literal">true</span>)[<span class="number">1</span>]:<span class="built_in">sub</span>(col, col):<span class="built_in">match</span>(<span class="string">&quot;%s&quot;</span>) == <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 自定义代码段跳转到下一个参数</span></span><br><span class="line">    [<span class="string">&quot;&lt;C-l&gt;&quot;</span>] = cmp.mapping(<span class="function"><span class="keyword">function</span><span class="params">(_)</span></span></span><br><span class="line">      <span class="keyword">if</span> vim.fn[<span class="string">&quot;vsnip#available&quot;</span>](<span class="number">1</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        feedkey(<span class="string">&quot;&lt;Plug&gt;(vsnip-expand-or-jump)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>, &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;s&quot;</span>&#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 自定义代码段跳转到上一个参数</span></span><br><span class="line">    [<span class="string">&quot;&lt;C-h&gt;&quot;</span>] = cmp.mapping(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">      <span class="keyword">if</span> vim.fn[<span class="string">&quot;vsnip#jumpable&quot;</span>](<span class="number">-1</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        feedkey(<span class="string">&quot;&lt;Plug&gt;(vsnip-jump-prev)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>, &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;s&quot;</span>&#125;),</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Super Tab</span></span><br><span class="line">    [<span class="string">&quot;&lt;Tab&gt;&quot;</span>] = cmp.mapping(<span class="function"><span class="keyword">function</span><span class="params">(fallback)</span></span></span><br><span class="line">      <span class="keyword">if</span> cmp.visible() <span class="keyword">then</span></span><br><span class="line">        cmp.select_next_item()</span><br><span class="line">      <span class="keyword">elseif</span> vim.fn[<span class="string">&quot;vsnip#available&quot;</span>](<span class="number">1</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        feedkey(<span class="string">&quot;&lt;Plug&gt;(vsnip-expand-or-jump)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">      <span class="keyword">elseif</span> has_words_before() <span class="keyword">then</span></span><br><span class="line">        cmp.complete()</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        fallback() <span class="comment">-- The fallback function sends a already mapped key. In this case, it&#x27;s probably `&lt;Tab&gt;`.</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>, &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;s&quot;</span>&#125;),</span><br><span class="line"></span><br><span class="line">    [<span class="string">&quot;&lt;S-Tab&gt;&quot;</span>] = cmp.mapping(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">      <span class="keyword">if</span> cmp.visible() <span class="keyword">then</span></span><br><span class="line">        cmp.select_prev_item()</span><br><span class="line">      <span class="keyword">elseif</span> vim.fn[<span class="string">&quot;vsnip#jumpable&quot;</span>](<span class="number">-1</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        feedkey(<span class="string">&quot;&lt;Plug&gt;(vsnip-jump-prev)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>, &#123;<span class="string">&quot;i&quot;</span>, <span class="string">&quot;s&quot;</span>&#125;)</span><br><span class="line">    <span class="comment">-- end of super Tab</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>最后一步，别忘了在 <strong>入口文件</strong> 中引入 <code>lua/lsp/cmp.lua</code> 才能生效。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 基础配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;basic&quot;</span>)</span><br><span class="line"><span class="comment">-- Packer插件管理</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugins&quot;</span>)</span><br><span class="line"><span class="comment">-- 快捷键映射</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="comment">-- 主题设置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;colorscheme&quot;</span>)</span><br><span class="line"><span class="comment">-- 插件配置</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-tree&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.bufferline&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.lualine&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.telescope&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.dashboard&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.project&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.nvim-treesitter&quot;</span>)</span><br><span class="line"><span class="comment">-- 内置LSP</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.setup&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.cmp&quot;</span>) <span class="comment">--  (新增)</span></span><br></pre></td></tr></table></figure>

<p><code>:wq</code> 保存后重启，如果没有报错的话，就应该生效了。</p>
<p>好了，自动补全也已经搞定了，可以写代码了。但是显示上还不是很完美，下节课会对目前 LSP 相关功能做一些美化，准备好就来吧。</p>
<h1 id="14-LSP-功能增强与-UI-美化"><a href="#14-LSP-功能增强与-UI-美化" class="headerlink" title="14.LSP 功能增强与 UI 美化"></a>14.LSP 功能增强与 UI 美化</h1><p>当我们敲击了错误代码的时候，左侧会显示该行的状态，如下图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/eee31ba7cf8c4e2c874faf73dedb9b8btplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-2.png"></p>
<p>红色那行 <code>E</code> 表示错误，很好理解， 那 <code>W</code> 是什么呢？ 其实 <code>W</code> 是 Warn 的缩写，很不直观，我们把它替换成图标。</p>
<h2 id="左列符号图标"><a href="#左列符号图标" class="headerlink" title="左列符号图标"></a>左列符号图标</h2><p>新建文件 <code>lua/lsp/ui.lua</code> ，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim.diagnostic.<span class="built_in">config</span>(&#123;</span><br><span class="line">  virtual_text = <span class="literal">true</span>,</span><br><span class="line">  signs = <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">-- 在输入模式下也更新提示，设置为 true 也许会影响性能</span></span><br><span class="line">  update_in_insert = <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">local</span> signs = &#123; Error = <span class="string">&quot; &quot;</span>, Warn = <span class="string">&quot; &quot;</span>, Hint = <span class="string">&quot; &quot;</span>, Info = <span class="string">&quot; &quot;</span> &#125;</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">type</span>, icon <span class="keyword">in</span> <span class="built_in">pairs</span>(signs) <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">local</span> hl = <span class="string">&quot;DiagnosticSign&quot;</span> .. <span class="built_in">type</span></span><br><span class="line">  vim.fn.sign_define(hl, &#123; text = icon, texthl = hl, numhl = hl &#125;)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>简单解释一下，<code>virtual_text</code> 是右侧显示的文字，<code>signs</code> 就是左侧的图标，让它们都显示出来。</p>
<p>默认的情况下，右侧提示文字只在切换回 normal 模式下才会更新，<code>update_in_insert</code> 可以让输入模式下也更新，但注意这里也许会影响性能。</p>
<p>再下边一大段的 for 循环就是定义图标了。</p>
<p>同时别忘了在 <strong>入口文件</strong> 中引入这个文件，打开 <code>init.lua</code>，加入：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 内置LSP</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.setup&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.cmp&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.ui&quot;</span>) <span class="comment">-- 新增</span></span><br></pre></td></tr></table></figure>

<p>替换完图标后效果如下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/7ab8d0cc9bed4984ad44202450d1726dtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-1.png"></p>
<p>这里加入一个非常重要的小提示，群里的同学问过。当一行代码很长的时候，右侧的提示文字就会显示不全，看不到提示的是什么，这个时候怎么办？ 回顾一下我们之前在 <code>keybindings.lua</code> 的 mapLSP 函数定义过这么几个快捷键。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- diagnostic</span></span><br><span class="line">mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gp&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.diagnostic.open_float()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gk&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.diagnostic.goto_prev()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gj&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.diagnostic.goto_next()&lt;CR&gt;&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>这个 <code>gp</code> 就是以弹窗的方式显示改行提示，非常实用。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/4e9a404e501b4d5bb64ae765cc200c70tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-1.gif"></p>
<p>接着我们看一下自动补全的样式。</p>
<h2 id="自动补全样式修改"><a href="#自动补全样式修改" class="headerlink" title="自动补全样式修改"></a>自动补全样式修改</h2><p>默认情况下，当我们敲入字母的时候，会弹出补全弹窗，左侧列出备选内容，右侧列出备选的变量类型：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/2255dea199674bdb84fd21d1ece4ed83tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-2.gif"></p>
<p>现在右侧是以文字的方式显示变量类型的，变量类型字母长度不同导致不是很美观，如果你喜欢，我们可以让右侧变量类型都以一个图标的方式显示，这样就没有对齐强迫症的问题了，也更节省空间了。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/ff6ebaaf12cf4257b1e46c92c2324148tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-3.gif"></p>
<p>当然如果你觉得只有图标不是很明显，也可以图标字母同时显示。</p>
<p>还可以在补全弹窗里添加更多的内容显示，比如一个比较常见的改进，当我们配置了很多不同补全来源的时候，我们可以右侧增加一列显示补全源来自哪里。</p>
<p>最终配置的效果如下：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/dd2f71ac067a4608b3559b7b6220f7fbtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-4.gif"></p>
<p>打开 <code>lua/plugins.lua</code> 新增一个插件： <a href="https://link.juejin.cn/?target=https://github.com/onsails/lspkind-nvim">lspkind-nvim</a>。这个插件封装了很多常见的小图标，非常方便，不用我们手动再创建了。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">--------------------- LSP --------------------</span></span><br><span class="line">        <span class="comment">-- lspconfig</span></span><br><span class="line">        use(&#123;<span class="string">&quot;neovim/nvim-lspconfig&quot;</span>, <span class="string">&quot;williamboman/nvim-lsp-installer&quot;</span>&#125;)</span><br><span class="line">        <span class="comment">-- 补全引擎</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/nvim-cmp&quot;</span>)</span><br><span class="line">        <span class="comment">-- snippet 引擎</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/vim-vsnip&quot;</span>)</span><br><span class="line">        <span class="comment">-- 补全源</span></span><br><span class="line">        use (<span class="string">&quot;hrsh7th/cmp-vsnip&quot;</span>)</span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-nvim-lsp&quot;</span>) <span class="comment">-- &#123; name = nvim_lsp &#125;</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-buffer&quot;</span>) <span class="comment">-- &#123; name = &#x27;buffer&#x27; &#125;,</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-path&quot;</span>) <span class="comment">-- &#123; name = &#x27;path&#x27; &#125;</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-cmdline&quot;</span>) <span class="comment">-- &#123; name = &#x27;cmdline&#x27; &#125;</span></span><br><span class="line">        <span class="comment">-- 常见编程语言代码段</span></span><br><span class="line">        use(<span class="string">&quot;rafamadriz/friendly-snippets&quot;</span>)</span><br><span class="line">        <span class="comment">-- ui (新增)</span></span><br><span class="line">        use(<span class="string">&quot;onsails/lspkind-nvim&quot;</span>)</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存自动安装， 安装完毕后要添加配置信息。</p>
<p>打开 <code>lua/lsp/ui.lua</code>，在下边增加代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- lspkind</span></span><br><span class="line"><span class="keyword">local</span> lspkind = <span class="built_in">require</span>(<span class="string">&#x27;lspkind&#x27;</span>)</span><br><span class="line">lspkind.init(&#123;</span><br><span class="line">    <span class="comment">-- default: true</span></span><br><span class="line">    <span class="comment">-- with_text = true,</span></span><br><span class="line">    <span class="comment">-- defines how annotations are shown</span></span><br><span class="line">    <span class="comment">-- default: symbol</span></span><br><span class="line">    <span class="comment">-- options: &#x27;text&#x27;, &#x27;text_symbol&#x27;, &#x27;symbol_text&#x27;, &#x27;symbol&#x27;</span></span><br><span class="line">    mode = <span class="string">&#x27;symbol_text&#x27;</span>,</span><br><span class="line">    <span class="comment">-- default symbol map</span></span><br><span class="line">    <span class="comment">-- can be either &#x27;default&#x27; (requires nerd-fonts font) or</span></span><br><span class="line">    <span class="comment">-- &#x27;codicons&#x27; for codicon preset (requires vscode-codicons font)</span></span><br><span class="line">    <span class="comment">--</span></span><br><span class="line">    <span class="comment">-- default: &#x27;default&#x27;</span></span><br><span class="line">    preset = <span class="string">&#x27;codicons&#x27;</span>,</span><br><span class="line">    <span class="comment">-- override preset symbols</span></span><br><span class="line">    <span class="comment">--</span></span><br><span class="line">    <span class="comment">-- default: &#123;&#125;</span></span><br><span class="line">    symbol_map = &#123;</span><br><span class="line">      Text = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Method = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Function = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Constructor = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Field = <span class="string">&quot;ﰠ&quot;</span>,</span><br><span class="line">      Variable = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Class = <span class="string">&quot;ﴯ&quot;</span>,</span><br><span class="line">      Interface = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Module = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Property = <span class="string">&quot;ﰠ&quot;</span>,</span><br><span class="line">      Unit = <span class="string">&quot;塞&quot;</span>,</span><br><span class="line">      Value = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Enum = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Keyword = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Snippet = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Color = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      File = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Reference = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Folder = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      EnumMember = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Constant = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Struct = <span class="string">&quot;פּ&quot;</span>,</span><br><span class="line">      Event = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      Operator = <span class="string">&quot;&quot;</span>,</span><br><span class="line">      TypeParameter = <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> M =&#123;&#125;</span><br><span class="line"><span class="comment">-- 为 cmp.lua 提供参数格式</span></span><br><span class="line">M.formatting = &#123;</span><br><span class="line">    <span class="built_in">format</span> = lspkind.cmp_format(&#123;</span><br><span class="line">      mode = <span class="string">&#x27;symbol_text&#x27;</span>,</span><br><span class="line">      <span class="comment">--mode = &#x27;symbol&#x27;, -- show only symbol annotations</span></span><br><span class="line"></span><br><span class="line">      maxwidth = <span class="number">50</span>, <span class="comment">-- prevent the popup from showing more than provided characters (e.g 50 will not show more than 50 characters)</span></span><br><span class="line">      <span class="comment">-- The function below will be called before any actual modifications from lspkind</span></span><br><span class="line">      <span class="comment">-- so that you can provide more controls on popup customization. (See [#30](https://github.com/onsails/lspkind-nvim/pull/30))</span></span><br><span class="line">      before = <span class="function"><span class="keyword">function</span> <span class="params">(entry, vim_item)</span></span></span><br><span class="line">        <span class="comment">-- Source 显示提示来源</span></span><br><span class="line">        vim_item.menu = <span class="string">&quot;[&quot;</span> .. <span class="built_in">string</span>.<span class="built_in">upper</span>(entry.source.name) .. <span class="string">&quot;]&quot;</span></span><br><span class="line">        <span class="keyword">return</span> vim_item</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>

<p>简单解释一下上述代码，首先引入刚刚安装的 <code>lspkind</code> 插件，调用 <code>lspkind.init</code> 方法初始化。</p>
<p>初始化参数中的 <code>symbol_map</code> 就是变量类型和其对应的自定义图标，由于图标是 Nerdfont 的，所以只在命令行中可见。</p>
<p>接下来我们导出一个 <code>M</code>，这在 lua 中是很常见的写法。 导出后在其他文件中就可以 <code>require(&#39;lsp.ui&#39;).formatting</code> 取到该值了。</p>
<p>接着我们回到 <code>lua/lsp/cmp.lua</code> 文件中，在 <code>cmp.setup()</code> 的初始化参数中添加一个 <code>formatting</code> 值，如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">cmp.setup(&#123;</span><br><span class="line">  <span class="comment">-- 指定 snippet 引擎</span></span><br><span class="line">  snippet = &#123;...&#125;,</span><br><span class="line">  <span class="comment">-- 来源</span></span><br><span class="line">  sources = cmp.<span class="built_in">config</span>.sources(&#123; ... &#125;),</span><br><span class="line">  <span class="comment">-- 快捷键</span></span><br><span class="line">  mapping = <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).cmp(cmp),</span><br><span class="line">  <span class="comment">-- 使用lspkind-nvim显示类型图标 (新增)</span></span><br><span class="line">  formatting = <span class="built_in">require</span>(<span class="string">&#x27;lsp.ui&#x27;</span>).formatting</span><br><span class="line">&#125;)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存重启后即可生效。下面再加一个 <code>indent-blankline.nvim</code> 插件好了。</p>
<h2 id="配置-indent-blankline-nvim-插件"><a href="#配置-indent-blankline-nvim-插件" class="headerlink" title="配置 indent_blankline.nvim 插件"></a>配置 indent_blankline.nvim 插件</h2><p><a href="https://link.juejin.cn/?target=https://github.com/lukas-reineke/indent-blankline.nvim">indent_blankline.nvim</a> 是什么线？看一下官网截图就明白了。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/711f6de379514183b8e8d39b7b790923tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="image.png"></p>
<p>看到那条竖线了吗，它会随着光标的移动提醒我们在哪个上下文中。如果你需要他的话，打开 <code>plugins.lua</code>，增加插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- indent-blankline</span></span><br><span class="line">use(<span class="string">&quot;lukas-reineke/indent-blankline.nvim&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>同之前一样 <code>:w</code> 保存即可自动安装。</p>
<p>安装后新建配置文件：<code>lua/plugin-config/indent-blankline.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, ident_blankline = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;indent_blankline&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 indent_blankline&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">ident_blankline.setup(&#123;</span><br><span class="line">  <span class="comment">-- 空行占位</span></span><br><span class="line">  space_char_blankline = <span class="string">&quot; &quot;</span>,</span><br><span class="line">  <span class="comment">-- 用 treesitter 判断上下文</span></span><br><span class="line">  show_current_context = <span class="literal">true</span>,</span><br><span class="line">  show_current_context_start = <span class="literal">true</span>,</span><br><span class="line">  context_patterns = &#123;</span><br><span class="line">    <span class="string">&quot;class&quot;</span>,</span><br><span class="line">    <span class="string">&quot;function&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>,</span><br><span class="line">    <span class="string">&quot;element&quot;</span>,</span><br><span class="line">    <span class="string">&quot;^if&quot;</span>,</span><br><span class="line">    <span class="string">&quot;^while&quot;</span>,</span><br><span class="line">    <span class="string">&quot;^for&quot;</span>,</span><br><span class="line">    <span class="string">&quot;^object&quot;</span>,</span><br><span class="line">    <span class="string">&quot;^table&quot;</span>,</span><br><span class="line">    <span class="string">&quot;block&quot;</span>,</span><br><span class="line">    <span class="string">&quot;arguments&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- :echo &amp;filetype</span></span><br><span class="line">  filetype_exclude = &#123;</span><br><span class="line">    <span class="string">&quot;dashboard&quot;</span>,</span><br><span class="line">    <span class="string">&quot;packer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;terminal&quot;</span>,</span><br><span class="line">    <span class="string">&quot;help&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log&quot;</span>,</span><br><span class="line">    <span class="string">&quot;markdown&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TelescopePrompt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lsp-installer&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lspinfo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;toggleterm&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- 竖线样式</span></span><br><span class="line">  <span class="comment">-- char = &#x27;¦&#x27;</span></span><br><span class="line">  <span class="comment">-- char = &#x27;┆&#x27;</span></span><br><span class="line">  <span class="comment">-- char = &#x27;│&#x27;</span></span><br><span class="line">  <span class="comment">-- char = &quot;⎸&quot;,</span></span><br><span class="line">  <span class="built_in">char</span> = <span class="string">&quot;▏&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是该插件会在任何界面都添加这种竖线，但是在我们之前的首页 dashboard 中就不该加入这种竖线。这个时候我们就要在 <code>filetype_exclude</code> 中排除 “dashboard” 这个界面。上边代码中我已经排除了好多界面，但如果你还在哪个不该出现竖线的窗口中看到了竖线，要怎么办呢？</p>
<p>方法为： 当光标在该界面内时输入 <code>:echo &amp;filetype</code> 回车，这时下边状态栏会输出该文件的类型，把他加入到上边的 <code>filetype_exclude</code> 变量中排除就好了。</p>
<p>对了，要生效可别忘了在 <strong>入口文件</strong> 中引入：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;plugin-config.indent-blankline&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>重启后生效。</p>
<p>如果上边的修改只算小修小改，那么下边要介绍的 lspsaga.nvim 插件算是对 LSP 功能的大整修了。</p>
<h2 id="配置-lspsaga-nvim"><a href="#配置-lspsaga-nvim" class="headerlink" title="配置 lspsaga.nvim"></a>配置 lspsaga.nvim</h2><p>lspsaga.nvim 插件原地址为：</p>
<blockquote>
<p><a href="https://link.juejin.cn/?target=https://github.com/glepnir/lspsaga.nvim">github.com&#x2F;glepnir&#x2F;lsp…</a></p>
</blockquote>
<p>但近一年插件原作者消失了，也没有维护，目前比较流行的是这个 Fork 版本：</p>
<blockquote>
<p><a href="https://link.juejin.cn/?target=https://github.com/tami5/lspsaga.nvim">github.com&#x2F;tami5&#x2F;lspsa…</a></p>
</blockquote>
<p>我们就安装这个，打开 <code>lua/plugins.lua</code> 增加插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">packer.startup(&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span><span class="params">(use)</span></span></span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">--------------------- LSP --------------------</span></span><br><span class="line">        <span class="comment">-- lspconfig</span></span><br><span class="line">        use(&#123;<span class="string">&quot;neovim/nvim-lspconfig&quot;</span>, <span class="string">&quot;williamboman/nvim-lsp-installer&quot;</span>&#125;)</span><br><span class="line">        <span class="comment">-- 补全引擎</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/nvim-cmp&quot;</span>)</span><br><span class="line">        <span class="comment">-- snippet 引擎</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/vim-vsnip&quot;</span>)</span><br><span class="line">        <span class="comment">-- 补全源</span></span><br><span class="line">        use (<span class="string">&quot;hrsh7th/cmp-vsnip&quot;</span>)</span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-nvim-lsp&quot;</span>) <span class="comment">-- &#123; name = nvim_lsp &#125;</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-buffer&quot;</span>) <span class="comment">-- &#123; name = &#x27;buffer&#x27; &#125;,</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-path&quot;</span>) <span class="comment">-- &#123; name = &#x27;path&#x27; &#125;</span></span><br><span class="line">        use(<span class="string">&quot;hrsh7th/cmp-cmdline&quot;</span>) <span class="comment">-- &#123; name = &#x27;cmdline&#x27; &#125;</span></span><br><span class="line">        <span class="comment">-- 常见编程语言代码段</span></span><br><span class="line">        use(<span class="string">&quot;rafamadriz/friendly-snippets&quot;</span>)</span><br><span class="line">        <span class="comment">-- ui</span></span><br><span class="line">        use(<span class="string">&quot;onsails/lspkind-nvim&quot;</span>)</span><br><span class="line">        use(<span class="string">&quot;tami5/lspsaga.nvim&quot;</span> ) <span class="comment">-- 新增</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存自动安装，安装完毕后，打开 <code>lua/lsp/ui.lua</code> ，在 <code>lspkind</code> 配置后边加入代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> lspsaga = <span class="built_in">require</span> <span class="string">&#x27;lspsaga&#x27;</span></span><br><span class="line">lspsaga.setup &#123; <span class="comment">-- defaults ...</span></span><br><span class="line">  <span class="built_in">debug</span> = <span class="literal">false</span>,</span><br><span class="line">  use_saga_diagnostic_sign = <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">-- diagnostic sign</span></span><br><span class="line">  error_sign = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  warn_sign = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  hint_sign = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  infor_sign = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  diagnostic_header_icon = <span class="string">&quot;   &quot;</span>,</span><br><span class="line">  <span class="comment">-- code action title icon</span></span><br><span class="line">  code_action_icon = <span class="string">&quot; &quot;</span>,</span><br><span class="line">  code_action_prompt = &#123;</span><br><span class="line">    enable = <span class="literal">true</span>,</span><br><span class="line">    sign = <span class="literal">true</span>,</span><br><span class="line">    sign_priority = <span class="number">40</span>,</span><br><span class="line">    virtual_text = <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  finder_definition_icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">  finder_reference_icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">  max_preview_lines = <span class="number">10</span>,</span><br><span class="line">  finder_action_keys = &#123;</span><br><span class="line">    <span class="comment">-- open = &quot;o&quot;,</span></span><br><span class="line">    <span class="built_in">open</span> = <span class="string">&quot;&lt;CR&gt;&quot;</span>,</span><br><span class="line">    vsplit = <span class="string">&quot;s&quot;</span>,</span><br><span class="line">    split = <span class="string">&quot;i&quot;</span>,</span><br><span class="line">    <span class="comment">-- quit = &quot;q&quot;,</span></span><br><span class="line">    quit = <span class="string">&quot;&lt;ESC&gt;&quot;</span>,</span><br><span class="line">    scroll_down = <span class="string">&quot;&lt;C-f&gt;&quot;</span>,</span><br><span class="line">    scroll_up = <span class="string">&quot;&lt;C-b&gt;&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  code_action_keys = &#123;</span><br><span class="line">    <span class="comment">-- quit = &quot;q&quot;,</span></span><br><span class="line">    quit = <span class="string">&quot;&lt;ESC&gt;&quot;</span>,</span><br><span class="line">    exec = <span class="string">&quot;&lt;CR&gt;&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  rename_action_keys = &#123;</span><br><span class="line">    <span class="comment">-- quit = &quot;&lt;C-c&gt;&quot;,</span></span><br><span class="line">    quit = <span class="string">&quot;&lt;ESC&gt;&quot;</span>,</span><br><span class="line">    exec = <span class="string">&quot;&lt;CR&gt;&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  definition_preview_icon = <span class="string">&quot;  &quot;</span>,</span><br><span class="line">  border_style = <span class="string">&quot;single&quot;</span>,</span><br><span class="line">  rename_prompt_prefix = <span class="string">&quot;➤&quot;</span>,</span><br><span class="line">  rename_output_qflist = &#123;</span><br><span class="line">    enable = <span class="literal">false</span>,</span><br><span class="line">    auto_open_qflist = <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  server_filetype_map = &#123;&#125;,</span><br><span class="line">  diagnostic_prefix_format = <span class="string">&quot;%d. &quot;</span>,</span><br><span class="line">  diagnostic_message_format = <span class="string">&quot;%m %c&quot;</span>,</span><br><span class="line">  highlight_prefix = <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里基本上都是默认配置，我只修改了几个快捷键，注释的部分是原快捷键。</p>
<p>lspsaga 厉害之处是，安装后会有一系列新命令来替换原有功能，比如我们在之前看见过这个 rename 的操作。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/e4882f8ad7904517949855b836adcf68tplv-k3u1fbpfcp-zoom-in-crop-mark1304000-165085841752924.awebp" alt="12-4.gif"></p>
<p>对比 <code>Lspsaga rename</code> 的效果：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/be7fe068042e433384b0172af1d12089tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-5.gif"></p>
<p>你需要做的就是找到之前定义的快捷键，根据需要将原本的功能替换为 Lspsaga 提供的新命令。</p>
<p>这是我目前的设置，请参考，找到 <code>lua/keybindings.lua</code> 将之前的 mapLSP 函数替换为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- lsp 回调函数快捷键设置</span></span><br><span class="line">pluginKeys.mapLSP = <span class="function"><span class="keyword">function</span><span class="params">(mapbuf)</span></span></span><br><span class="line">  <span class="comment">-- rename</span></span><br><span class="line">  <span class="comment">--[[</span></span><br><span class="line"><span class="comment">  Lspsaga 替换 rn</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;&lt;leader&gt;rn&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.rename()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  --]]</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;rn&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga rename&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- code action</span></span><br><span class="line">  <span class="comment">--[[</span></span><br><span class="line"><span class="comment">  Lspsaga 替换 ca</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;&lt;leader&gt;ca&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.code_action()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  --]]</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;ca&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga code_action&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- go xx</span></span><br><span class="line">  <span class="comment">--[[</span></span><br><span class="line"><span class="comment">    mapbuf(&#x27;n&#x27;, &#x27;gd&#x27;, &#x27;&lt;cmd&gt;Lspsaga preview_definition&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line"><span class="comment">  --]]</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gd&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.definition()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">--[[</span></span><br><span class="line"><span class="comment">  Lspsaga 替换 gh</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;gh&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.hover()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  --]]</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gh&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga hover_doc&lt;cr&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">--[[</span></span><br><span class="line"><span class="comment">  Lspsaga 替换 gr</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;gr&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.references()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  --]]</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gr&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga lsp_finder&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">--[[</span></span><br><span class="line"><span class="comment">  Lspsaga 替换 gp, gj, gk</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;gp&quot;, &quot;&lt;cmd&gt;lua vim.diagnostic.open_float()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;gj&quot;, &quot;&lt;cmd&gt;lua vim.diagnostic.goto_next()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  mapbuf(&quot;n&quot;, &quot;gk&quot;, &quot;&lt;cmd&gt;lua vim.diagnostic.goto_prev()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line"><span class="comment">  --]]</span></span><br><span class="line">  <span class="comment">-- diagnostic</span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gp&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga show_line_diagnostics&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gj&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga diagnostic_jump_next&lt;cr&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gk&quot;</span>, <span class="string">&quot;&lt;cmd&gt;Lspsaga diagnostic_jump_prev&lt;cr&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;f&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.formatting()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 未用</span></span><br><span class="line">  <span class="comment">-- mapbuf(&quot;n&quot;, &quot;gD&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.declaration()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&quot;n&quot;, &quot;gi&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.implementation()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;leader&gt;q&#x27;, &#x27;&lt;cmd&gt;lua vim.diagnostic.setloclist()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&quot;n&quot;, &quot;&lt;C-k&gt;&quot;, &quot;&lt;cmd&gt;lua vim.lsp.buf.signature_help()&lt;CR&gt;&quot;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;wa&#x27;, &#x27;&lt;cmd&gt;lua vim.lsp.buf.add_workspace_folder()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;wr&#x27;, &#x27;&lt;cmd&gt;lua vim.lsp.buf.remove_workspace_folder()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;wl&#x27;, &#x27;&lt;cmd&gt;lua print(vim.inspect(vim.lsp.buf.list_workspace_folders()))&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line">  <span class="comment">-- mapbuf(&#x27;n&#x27;, &#x27;&lt;space&gt;D&#x27;, &#x27;&lt;cmd&gt;lua vim.lsp.buf.type_definition()&lt;CR&gt;&#x27;, opt)</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上述代码我主要将以下 LSP 内置命令，替换成了对应了 Lspsaga 版本的命令。</p>
<ul>
<li><code>&lt;leader&gt;rn</code></li>
<li><code>&lt;leader&gt;ca</code></li>
<li><code>gh</code></li>
<li><code>gd</code></li>
<li><code>gr</code></li>
<li><code>gp</code></li>
<li><code>gj</code></li>
<li><code>gk</code></li>
</ul>
<p>下边演示一下 <code>gd</code> <code>gp</code> <code>gh</code> 的效果，篇幅所限就不过多演示了。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/6447fa9aa245443ea820d674fa5cd9e6tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="14-6.gif"></p>
<p>当然，你也可以不替换掉命令，而是增加一条新的命令，因为 Lspsaga 还在开发中目前还不是很稳定，如果你遇到问题，可以还原成原来的命令。</p>
<p>美化的部分就到这了，代码改得乱糟糟的？没关系，下一节课我们会看一下如何设置专门的代码格式化插件，让你的代码更加美观。</p>
<h1 id="15-代码格式化的两种方案"><a href="#15-代码格式化的两种方案" class="headerlink" title="15.代码格式化的两种方案"></a>15.代码格式化的两种方案</h1><p>为什么我的代码格式化不管用了呢？ 记得我们在之前在 <code>lua/keybindings.lua</code> 中设置过 <code>&lt;leader&gt;f</code> 为快捷键呀：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;f&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.formatting()&lt;CR&gt;&quot;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/image-20221128084851696.png" alt="image-20221128084851696"></p>
<p>需要更改下方法的名称</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;f&quot;</span>, <span class="string">&quot;&lt;cmd&gt;lua vim.lsp.buf.format(&#123; async = true &#125;)&lt;CR&gt;&quot;</span>, opt)</span><br></pre></td></tr></table></figure>





<p>这是因为我们使用的 Lua Language Server 并没有实现格式化功能。</p>
<blockquote>
<p>顺便说一下，代码格式化 和 代码缩进 是不同的，在 tree-sitter 章节我们实现的代码缩进只能缩进首字母的位置 如果代码中间出现格式问题，tree-sitter 就无能为力了</p>
</blockquote>
<p>如果需要添加代码格式化功能，基本上有两种方案:</p>
<ul>
<li>第一种是使用专门的格式化插件；</li>
<li>第二种是给 Language Server 注入格式化功能。</li>
</ul>
<p>先看第一种方法，我们可以安装 <a href="https://link.juejin.cn/?target=https://github.com/mhartington/formatter.nvim">formatter.nvim</a> 插件，Formatter.nvim 插件是很简单易用的格式化插件， 支持很多常见编程语言，例如 JavaScript、Rust、JSON、Bash、Lua、C、Ruby、Python、Golang 等等。</p>
<h2 id="安装-Formatter-nvim"><a href="#安装-Formatter-nvim" class="headerlink" title="安装 Formatter.nvim"></a>安装 Formatter.nvim</h2><p>这一步别跳过</p>
<p>打开 <code>lua/plugins.lua</code> , 增加代码格式化组件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">-- 代码格式化 (新增)</span></span><br><span class="line">use(<span class="string">&quot;mhartington/formatter.nvim&quot;</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>我们以 Lua 语言为例，看看如何配置一个语言格式化功能。</p>
<p>第一步需要知道你使用的编程语言有哪些 Code Formatter。 像 Lua 比较常见的应该是 StyLua 或者是 lua-fmt，前端开发的话通常就是用 Prettier 来格式化。</p>
<p>如果不知道也没关系，可以直接到 Formatter <a href="https://link.juejin.cn/?target=https://github.com/mhartington/formatter.nvim/blob/master/CONFIG.md">配置文件示例</a> 中搜索关键字，比如我 <code>Ctrl + f</code> 搜索 <code>lua</code> 就搜到了 stylua 的配置方法。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/c8ec4db29bdf4972b2a5e000c1be6afatplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="15-1.png"></p>
<p>于是我们就可以去查一下 StyLua 是什么，以及如何安装 <a href="https://link.juejin.cn/?target=https://github.com/JohnnyMorganz/StyLua">StyLua</a>。</p>
<p><code>Centos</code>下安装<code>Stylua</code>，要先安装<code>Rust</code>，再用它的包管理器安装</p>
<p><a target="_blank" rel="noopener" href="https://www.modb.pro/db/214854">Linux 安装 Rust - 墨天轮 (modb.pro)</a></p>
<p>经过调研，我们发现 StyLua 非常简单，有固定语言风格，只提供 6 条配置项，并且可以放在项目根目录的 <code>.stylua.toml</code> 中指定。</p>
<p>这样我们就可以给我们的配置文件目录 <code>~/.config/nvim/.stylua.toml</code> 加上这个文件：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">column_width</span> = <span class="number">120</span></span><br><span class="line"><span class="attr">line_endings</span> = <span class="string">&quot;Unix&quot;</span></span><br><span class="line"><span class="attr">indent_type</span> = <span class="string">&quot;Spaces&quot;</span></span><br><span class="line"><span class="attr">quote_style</span> = <span class="string">&#x27;AutoPreferSingle&#x27;</span></span><br><span class="line"><span class="attr">indent_width</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">call_parentheses</span> = <span class="string">&quot;Always&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后我们就会拥有一个统一格式的代码库了，酷。</p>
<p>接下来就要看一下如何安装 StyLua 了，根据 GitHub 主页介绍， Ubuntu 的话还是建议使用 cargo 安装，cargo 是 rust 语言的包管理器，安装 rust 语言后就可以使用了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo install stylua</span><br></pre></td></tr></table></figure>

<p>Mac 系统直接使用 brew 安装即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install stylua</span><br></pre></td></tr></table></figure>

<p>安装完成运行 <code>stylua -V</code>，输出版本号表示成功。</p>
<p>还可以在 neovim 中运行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:echo executable(&quot;stylua&quot;)</span><br></pre></td></tr></table></figure>

<p>如果输出 1 表示安装成功，0 则失败。</p>
<h2 id="配置-Formatter-nvim"><a href="#配置-Formatter-nvim" class="headerlink" title="配置 Formatter.nvim"></a>配置 Formatter.nvim</h2><p>接下来创建 formatter.nvim 的配置文件 <code>lua/lsp/formatter.lua</code> 输入内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, formatter = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;formatter&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 formatter&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">formatter.setup(&#123;</span><br><span class="line">  filetype = &#123;</span><br><span class="line">    lua = &#123;</span><br><span class="line">      <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          exe = <span class="string">&quot;stylua&quot;</span>,</span><br><span class="line">          args = &#123;</span><br><span class="line">            <span class="comment">-- &quot;--config-path &quot;</span></span><br><span class="line">            <span class="comment">--   .. os.getenv(&quot;XDG_CONFIG_HOME&quot;)</span></span><br><span class="line">            <span class="comment">--   .. &quot;/stylua/stylua.toml&quot;,</span></span><br><span class="line">            <span class="string">&quot;-&quot;</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="built_in">stdin</span> = <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- format on save</span></span><br><span class="line">vim.api.nvim_exec(</span><br><span class="line">  <span class="string">[[</span></span><br><span class="line"><span class="string">    augroup FormatAutogroup</span></span><br><span class="line"><span class="string">    autocmd!</span></span><br><span class="line"><span class="string">    autocmd BufWritePost *.lua FormatWrite</span></span><br><span class="line"><span class="string">    augroup END</span></span><br><span class="line"><span class="string">]]</span>,</span><br><span class="line">  <span class="literal">true</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>简单解释，代码与之前类似，先取得 formatter 组件，如果不存在则 <code>return</code> ，不继续执行。</p>
<p>接下来 <code>setup</code> 的参数中根据 <code>filetype</code> 不同，对应不同语言，我们这里只配置了 lua，其他编程语言也类似，直接复制 <a href="https://link.juejin.cn/?target=https://github.com/mhartington/formatter.nvim/blob/master/CONFIG.md">配置文件示例</a> 中的代码即可。</p>
<p>通常需要关注的只有，两个参数：</p>
<ul>
<li>exe: 就是你的 Formatter 的程序，对应我们的就是 stylua。</li>
<li>args: 是 Formatter 接收的参数列表，是一个 Lua table 类型，类似 JavaScript 的 Object。</li>
</ul>
<p>我这里把 args 中的参数注释掉了，表示使用默认目录下的 <code>.stylua.toml</code> 就好，不要到系统目录找了。</p>
<p>接下来我们增加了一段使用了 <code>vim.api.nvim_exec</code> 调用了一段 vim 自动命令脚本，表示当我们保存文件时，会自动调用 <code>stylua</code> 格式化代码。</p>
<p>Neovim 会在 0.7 版本增加自动命令的 Lua API，目前 0.6 的话还是要通过调用 vim 脚本的方式实现。</p>
<p>最后别忘了在 <strong>入口文件</strong> 引入我们新增的插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.setup&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.cmp&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.ui&quot;</span>)</span><br><span class="line"><span class="comment">-- 新增</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.formatter&quot;</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>重启之后我们可以使用新增的 <code>:Format</code> 命令来自动格式化代码了。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/21f394596272493fac4cc3561f29d404tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="15-2.gif"></p>
<p>如果你决定使用这个插件了，那么可以考虑把之前的 <code>&lt;leader&gt;f</code> 快捷键配置成 <code>:Format</code> 命令就可以了。</p>
<p>或者你可以再考虑一下，看一下我们的第二种方案： <a href="https://link.juejin.cn/?target=https://github.com/jose-elias-alvarez/null-ls.nvim">null-ls.nvim</a> 。</p>
<h2 id="安装-null-ls-nvim"><a href="#安装-null-ls-nvim" class="headerlink" title="安装 null-ls.nvim"></a>安装 null-ls.nvim</h2><p>null-ls 非常强大，可以作为一个通用 Language Server 来给编辑器注入代码补全，格式化，提示，code actions 等新功能。</p>
<p>简单来说就是你在编辑的同一个 buffer 时，不只可以挂一个 Language Server，还可以多挂一个通用的 null-ls Server 作为补充，这样无论我们使用哪个 Server 都可以共享 null-ls 提供的功能。</p>
<p>null-ls 不仅可以做为代码格式化的工具，他更像一个 Lua 语言与 Language Server 的桥梁，它可以通过注入的方式给编辑器带来更多有趣的功能呢，本章只用到了 formatting 功能，后续章节还会继续扩展。</p>
<p>我们先来安装，打开<code>lua/plugins.lua</code> 文件，增加代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码格式化</span></span><br><span class="line"><span class="comment">-- use(&quot;mhartington/formatter.nvim&quot;)</span></span><br><span class="line">use(&#123; <span class="string">&quot;jose-elias-alvarez/null-ls.nvim&quot;</span>, requires = <span class="string">&quot;nvim-lua/plenary.nvim&quot;</span> &#125;)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存自动安装，我同时注释掉 formatter.nvim 所在行，这样就卸载了 formatter.nvim， 安装成功后重启，开始配置。</p>
<h2 id="配置-null-ls-nvim"><a href="#配置-null-ls-nvim" class="headerlink" title="配置 null-ls.nvim"></a>配置 null-ls.nvim</h2><p>继续添加配置文件 <code>lua/lsp/null-ls.lua</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, null_ls = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;null-ls&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 null-ls&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> formatting = null_ls.builtins.formatting</span><br><span class="line"></span><br><span class="line">null_ls.setup(&#123;</span><br><span class="line">  <span class="built_in">debug</span> = <span class="literal">false</span>,</span><br><span class="line">  sources = &#123;</span><br><span class="line">    <span class="comment">-- Formatting ---------------------</span></span><br><span class="line">    <span class="comment">--  brew install shfmt</span></span><br><span class="line">    formatting.shfmt,</span><br><span class="line">    <span class="comment">-- StyLua</span></span><br><span class="line">    formatting.stylua,</span><br><span class="line">    <span class="comment">-- frontend</span></span><br><span class="line">    formatting.prettier.with(&#123; <span class="comment">-- 只比默认配置少了 markdown</span></span><br><span class="line">      filetypes = &#123;</span><br><span class="line">        <span class="string">&quot;javascript&quot;</span>,</span><br><span class="line">        <span class="string">&quot;javascriptreact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typescript&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typescriptreact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vue&quot;</span>,</span><br><span class="line">        <span class="string">&quot;css&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scss&quot;</span>,</span><br><span class="line">        <span class="string">&quot;less&quot;</span>,</span><br><span class="line">        <span class="string">&quot;html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;yaml&quot;</span>,</span><br><span class="line">        <span class="string">&quot;graphql&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">-- formatting.fixjson,</span></span><br><span class="line">    <span class="comment">-- formatting.black.with(&#123; extra_args = &#123; &quot;--fast&quot; &#125; &#125;),</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- 保存自动格式化</span></span><br><span class="line">  on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client)</span></span></span><br><span class="line">    vim.cmd(<span class="string">[[ command! Format execute &#x27;lua vim.lsp.buf.format(&#123;async = true&#125;)&#x27;]]</span>)</span><br><span class="line">    <span class="comment">-- if client.resolved_capabilities.document_formatting then</span></span><br><span class="line">    <span class="comment">--   vim.cmd(&quot;autocmd BufWritePre &lt;buffer&gt; lua vim.lsp.buf.formatting_sync()&quot;)</span></span><br><span class="line">    <span class="comment">-- end</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>简单解释一下代码，首先查找 null-ls 插件是否存在，如果不存在则提示并 return，不再继续执行。 然后注意看下边的 <code>null_ls.setup</code> 配置中一大串代码只是在配置一个参数 <code>sources</code>， null-ls 有很多内置源，需要哪个就把哪个列在这里就好了。本节只配置了几个常见的 Formatting 源。null-ls 不只内置有 Formatting 源，还有其他共功能的源可配置，也许后续章节会涉及，本节我们专注在代码格式化功能上。</p>
<p>null-ls 支持的 Formatting 源非常非常的多，你可以在其 GitHub 目录中查看：</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/jose-elias-alvarez/null-ls.nvim/tree/main/lua/null-ls/builtins/formatting">&#x2F;lua&#x2F;null-ls&#x2F;builtins&#x2F;formatting</a></p>
<p>上述目录中所有的源，在配置文件中都在 <code>null_ls.builtins.formatting</code> 命名空间下，需要哪个列上去就好了。</p>
<p>最后别忘了在 <strong>入口文件</strong> 中引入该文件，同时注释掉 formatter 插件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 内置 LSP</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.setup&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.cmp&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.ui&quot;</span>)</span><br><span class="line"><span class="comment">-- require(&quot;lsp.formatter&quot;)</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;lsp.null-ls&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>当你重启并成功安装 null-ls.nvim 后，可以运行命令 <code>:LspInfo</code> 查看绑定的 Language Server 信息。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/0f387a5f86924396850a43389108aa4dtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="15-3.png"></p>
<p>没错，有两个 LSP 了，null-ls 作为通用 LSP，可以在任何 filetypes 中运行。</p>
<p>我们可以运行 <code>:NullLsInfo</code> 查看源的激活情况，如图：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/8bc58d767fdc4f68a6a9b54171d3357ftplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="image.png"></p>
<p>我这里显示 2 个 Active source(s) ，一个是我们刚刚配置的 stylua 源给 formatting 方法使用，还有一个 code_ation 源与本节无关，我们后续章节有机会再说。</p>
<p>现在篇首不可用的 format 快捷键应该已经好用了，或者直接运行命令 <code>:lua vim.lsp.buf.formatting_sync()</code> 也是可以的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>至此，我们两种方式实现代码格式化的功能就都完成了，前一个是简单易用，后一个则是功能强大，应该用哪一种，还是由你来定。</p>
<p>下一节开始我会尝试配置具体的编程语言，但个人能力有限，我并不是每门语言都了解，也不太可能所有语言都照顾到。所以还是欢迎各路大佬留言分享你的配置，我会尽量参考大家的配置，最终更新到这本小册里，有意见也可以到我的 GitHub <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">nshen&#x2F;learn-neovim-lua</a> 上留言，再次谢谢大家了。</p>
<h1 id="16-Neovim-前端开发的必要配置"><a href="#16-Neovim-前端开发的必要配置" class="headerlink" title="16.Neovim 前端开发的必要配置"></a>16.Neovim 前端开发的必要配置</h1><p>这一节我们来看看如何配置前端开发环境的，应该会有非常多的东西需要安装，开始吧。</p>
<blockquote>
<p>有小伙伴发现我已经转到 Mac OS 了，是的，因为购买小册的很多开发者都是在苹果电脑上开发的，强烈要求我使用 Mac 也配置一下， 其实 Neovim 在配置上并没有什么区别，主要还是终端上的不同，但如果你在 Mac 上遇到了什么问题，也欢迎留言告诉我，之后我也会看看是否需要补一节 Mac 环境搭建的文章。</p>
</blockquote>
<p>我们先从前端语法高亮开始，还记得如何安装 Treesitter 语法高亮吗，不记得的话可以回去 <a target="_blank" rel="noopener" href="https://juejin.cn/book/7051157342770954277/section/7071998517543174155">Neovim 语法高亮的安装与配置</a> 复习一下。</p>
<h2 id="Tree-sitter-配置"><a href="#Tree-sitter-配置" class="headerlink" title="Tree-sitter 配置"></a>Tree-sitter 配置</h2><p>运行 <code>:TSInstallInfo</code> 或者 <code>:TSModuleInfo</code> 查看语法安装的情况。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/1de6d20a6a0e47cb8c6cf39f89000cf6tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-1.png"></p>
<p>Treesitter 有一个直接安装语法高亮的命令 <code>TSInstall：</code> 把能找到的 <strong>前端相关</strong> 的都装上：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:TSInstall css scss json html vue javascript typescript</span><br></pre></td></tr></table></figure>

<p>记得终端挂上代理，有网络问题的不只你一个哦。</p>
<p>安装成功则代码高亮都没问题了，下一步配置 LSP，我们先看看是否已经安装好了，如果没有的话，就安装一下。</p>
<h2 id="html-与-cssls-LSP-配置"><a href="#html-与-cssls-LSP-配置" class="headerlink" title="html 与 cssls LSP 配置"></a>html 与 cssls LSP 配置</h2><p>先安装 <code>html</code> 和 <code>cssls</code>， 还记得怎么安装吗？运行 <code>:LspInstallInfo</code>，<code>j</code> &#x2F; <code>k</code> 移动光标， 选中之后按 <code>i</code> 即可安装。大写的 <code>X</code> 是卸载。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/a829d05b58084a528e72770fd3735637tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-2.png"></p>
<p>安装完成后进入 <code>lua/lsp/setup.lua</code> 中引入 html 和 css 的配置文件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 安装列表</span></span><br><span class="line"><span class="comment">-- &#123; key: 服务器名， value: 配置文件 &#125;</span></span><br><span class="line"><span class="comment">-- key 必须为下列网址列出的 server name</span></span><br><span class="line"><span class="comment">-- https://github.com/williamboman/nvim-lsp-installer#available-lsps</span></span><br><span class="line"><span class="keyword">local</span> servers = &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">-- 新增</span></span><br><span class="line">  html = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.html&quot;</span>),</span><br><span class="line">  cssls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.css&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着创建 <code>lua/lsp/config/html.lua</code> 配置文件。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    server:setup(&#123;</span><br><span class="line">      capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).update_capabilities(vim.lsp.protocol.make_client_capabilities()),</span><br><span class="line">      flags = &#123;</span><br><span class="line">        debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, bufnr)</span></span></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(...)</span></span></span><br><span class="line">          vim.api.nvim_buf_set_keymap(bufnr, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 绑定快捷键</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)</span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里与我们之前的配置类似， capabilities 参数是为了给 cmp_nvim 提供 HTML 补全能力。</p>
<p>保存重启后应该就没问题了，我们找一个前端工程(注意目录中要有 package.json )，创建一个 html 文件试试。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/347ead4bd3e24f6f9f6be2fc6ac1914ctplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-3.gif"></p>
<p>酷，没问题，试一试代码格式化呢。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/052b92c3192644d29a27ba10f630490btplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-4.gif"></p>
<p>居然出现了选项，可以输入 1 或 2 后回车进行格式化，并且格式化的样子都不同。为什么会这样呢？ 我们可以运行 <code>:LspInfo</code> 查看一下。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/53c419b8841143e9ae00c3b0410d69eatplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-5.png"></p>
<p>原来我们绑定的两个 LSP ，由于 html server 本身有格式化代码能力，null-ls 又可以使用 prettier 进行格式化 HTML，所以这里出现了选项。</p>
<p>经常会有这种情况出现，如果你不想选择，只使用专门的 prettier 来格式化的话，那么可以在 html.lua 配置中加入。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">client.resolved_capabilities.document_formatting = <span class="literal">false</span></span><br><span class="line">client.resolved_capabilities.document_range_formatting = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>注意，0.8.1版本的neovim用这个方法</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 禁用格式化功能，交给专门插件插件处理    </span></span><br><span class="line">client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span></span><br></pre></td></tr></table></figure>



<p>最终配置如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    server:setup(&#123;</span><br><span class="line">      capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).update_capabilities(vim.lsp.protocol.make_client_capabilities()),</span><br><span class="line">      flags = &#123;</span><br><span class="line">        debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, bufnr)</span></span></span><br><span class="line">        <span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">        <span class="comment">-- client.resolved_capabilities.document_formatting = false</span></span><br><span class="line">        <span class="comment">-- client.resolved_capabilities.document_range_formatting = false</span></span><br><span class="line">        client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">        client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(...)</span></span></span><br><span class="line">          vim.api.nvim_buf_set_keymap(bufnr, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 绑定快捷键</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)</span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>注意：</strong></p>
<p>上面了更新了，可以直接看作者仓库<code>v2</code>分支（当前最新），看作者现在用的配置是啥样</p>
<p>以下两个文件只是看一下，暂时不用管</p>
<p>作者是提取了公共配置，新建<code>lsp/common-config.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = &#123;&#125;</span><br><span class="line"></span><br><span class="line">M.keyAttach = <span class="function"><span class="keyword">function</span><span class="params">(bufnr)</span></span></span><br><span class="line">  <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(mode, lhs, rhs)</span></span></span><br><span class="line">    vim.keymap.set(mode, lhs, rhs, &#123; noremap = <span class="literal">true</span>, silent = <span class="literal">true</span>, buffer = bufnr &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">-- 绑定快捷键</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">M.disableFormat = <span class="function"><span class="keyword">function</span><span class="params">(client)</span></span></span><br><span class="line">  <span class="keyword">if</span> vim.fn.has(<span class="string">&quot;nvim-0.8&quot;</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">    client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    client.resolved_capabilities.document_formatting = <span class="literal">false</span></span><br><span class="line">    client.resolved_capabilities.document_range_formatting = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- M.capabilities = require(&quot;cmp_nvim_lsp&quot;).update_capabilities(vim.lsp.protocol.make_client_capabilities())</span></span><br><span class="line">M.capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).default_capabilities()</span><br><span class="line"></span><br><span class="line">M.flags = &#123;</span><br><span class="line">  debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>

<p><code>config/html.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = &#123;&#125;</span><br><span class="line"></span><br><span class="line">M.keyAttach = <span class="function"><span class="keyword">function</span><span class="params">(bufnr)</span></span></span><br><span class="line">  <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(mode, lhs, rhs)</span></span></span><br><span class="line">    vim.keymap.set(mode, lhs, rhs, &#123; noremap = <span class="literal">true</span>, silent = <span class="literal">true</span>, buffer = bufnr &#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="comment">-- 绑定快捷键</span></span><br><span class="line">  <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">M.disableFormat = <span class="function"><span class="keyword">function</span><span class="params">(client)</span></span></span><br><span class="line">  <span class="keyword">if</span> vim.fn.has(<span class="string">&quot;nvim-0.8&quot;</span>) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">    client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    client.resolved_capabilities.document_formatting = <span class="literal">false</span></span><br><span class="line">    client.resolved_capabilities.document_range_formatting = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- M.capabilities = require(&quot;cmp_nvim_lsp&quot;).update_capabilities(vim.lsp.protocol.make_client_capabilities())</span></span><br><span class="line">M.capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).default_capabilities()</span><br><span class="line"></span><br><span class="line">M.flags = &#123;</span><br><span class="line">  debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>





<p>同样的方式配置 css ， 创建 <code>lua/lsp/config/css.lua</code>。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    server:setup(&#123;</span><br><span class="line">      capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).update_capabilities(vim.lsp.protocol.make_client_capabilities()),</span><br><span class="line">      settings = &#123;</span><br><span class="line">        css = &#123;</span><br><span class="line">          validate = <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        less = &#123;</span><br><span class="line">          validate = <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        scss = &#123;</span><br><span class="line">          validate = <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      flags = &#123;</span><br><span class="line">        debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, bufnr)</span></span></span><br><span class="line">        <span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">        <span class="comment">--- client.resolved_capabilities.document_formatting = false</span></span><br><span class="line">        <span class="comment">--- client.resolved_capabilities.document_range_formatting = false</span></span><br><span class="line">        client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">        client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(...)</span></span></span><br><span class="line">          vim.api.nvim_buf_set_keymap(bufnr, ...)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- 绑定快捷键</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)</span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个 css 文件测试一下，看看代码补全和格式化效果。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/5debd17f29974a748b7c5c5102536addtplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-6.gif"></p>
<p>酷，没问题，下边看一下 Emmet 的配置。</p>
<h2 id="Emmet-LSP-配置"><a href="#Emmet-LSP-配置" class="headerlink" title="Emmet LSP 配置"></a>Emmet LSP 配置</h2><p>现在的 HTML 打标签有点不智能，增加 Emmet 支持，Emmet 有一套简单的语法可以快速打出 HTML 结构标签，如下图所示：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/f9258b313ac845d28b3f9d12c9741f17tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-7.gif"></p>
<p>创建 <code>lua/lsp/config/emmet.lua</code> 文件如下。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    server:setup(&#123;&#125;)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在 <code>lua/lsp/config/setup.lua</code> 中引入该配置：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> servers = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">-- （新增）</span></span><br><span class="line">  emmet_ls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.emmet&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>别忘了 <code>:LspInstallInfo</code> 找到并安装 <code>emmetls</code> Language Server。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/5960cfc5f7084963adb5aa660cfe0ecftplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-8.png"></p>
<p>重启即可之后生效。 接着我们要配置一下 jsonls ，让 Language Server 知道 <code>package.json</code>。</p>
<h2 id="jsonls-配置"><a href="#jsonls-配置" class="headerlink" title="jsonls 配置"></a>jsonls 配置</h2><p>首先在 <code>plugins.lua</code> 中增加一个插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- JSON 增强</span></span><br><span class="line">use(<span class="string">&quot;b0o/schemastore.nvim&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>这是 JSON Schema Store 的插件，算是 JSON 增强插件，用于提供 JSON Schema 的支持，JSON Schema Store 包含了流行的 JSON 格式的语法提示，当然也包括我们的 <code>package.json</code>。</p>
<p>有兴趣的可以去官网了解，官网： schemastore.org</p>
<p>新建 <code>lua/lsp/config/json.lua</code> 内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    server:setup(&#123;</span><br><span class="line">      settings = &#123;</span><br><span class="line">        json = &#123;</span><br><span class="line">          schemas = <span class="built_in">require</span>(<span class="string">&quot;schemastore&quot;</span>).json.schemas(),</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).update_capabilities(vim.lsp.protocol.make_client_capabilities()),</span><br><span class="line">      flags = &#123;</span><br><span class="line">        debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, _)</span></span></span><br><span class="line">        <span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">        <span class="comment">--- client.resolved_capabilities.document_formatting = false</span></span><br><span class="line">        <span class="comment">--- client.resolved_capabilities.document_range_formatting = false</span></span><br><span class="line">        client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">        client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span>         </span><br><span class="line">      <span class="keyword">end</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意我在 settings 中引入了之前安装的 <code>schemastore</code> 插件，这样就可以获取到 JSON Schema 了。</p>
<p>然后在 <code>lua/lsp/config/setup.lua</code> 中引入该配置：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> servers = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">-- （新增）</span></span><br><span class="line">  jsonls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.json&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启后生效，新建一个 package.json 试试效果：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/26ba566dc89044a6a8ee999b2c3d6ca6tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-9.gif"></p>
<p>最后安装的是最重要的， TypeScript Language Server。</p>
<h2 id="配置-tsserver"><a href="#配置-tsserver" class="headerlink" title="配置 tsserver"></a>配置 tsserver</h2><p>首先安装 tsserver ，运行 <code>:LspInstallInfo</code>，<code>j</code> &#x2F; <code>k</code> 移动光标， 选中 <code>tsserver</code> 之后按 <code>i</code> 即可安装。</p>
<p>安装好 Language Server，我们还要安装一个 TypeScript 增强插件，打开 <code>lua/plugins.lua</code> 增加一个插件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use(&#123; <span class="string">&quot;jose-elias-alvarez/nvim-lsp-ts-utils&quot;</span>, requires = <span class="string">&quot;nvim-lua/plenary.nvim&quot;</span> &#125;)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 保存自动安装，安装成功后，创建 <code>lua/lsp/config/ts.lua</code> 文件，开始配置 tsserver，代码如下。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> keybindings = <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> ts_utils = <span class="built_in">require</span>(<span class="string">&quot;nvim-lsp-ts-utils&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> opts = &#123;</span><br><span class="line">  flags = &#123;</span><br><span class="line">    debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).update_capabilities(vim.lsp.protocol.make_client_capabilities()),</span><br><span class="line">  on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, bufnr)</span></span></span><br><span class="line">    <span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">    <span class="comment">--- client.resolved_capabilities.document_formatting = false</span></span><br><span class="line">    <span class="comment">--- client.resolved_capabilities.document_range_formatting = false</span></span><br><span class="line">    client.server_capabilities.documentFormattingProvider = <span class="literal">false</span></span><br><span class="line">    client.server_capabilities.documentRangeFormattingProvider = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(...)</span></span></span><br><span class="line">      vim.api.nvim_buf_set_keymap(bufnr, ...)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 绑定快捷键</span></span><br><span class="line">    keybindings.mapLSP(buf_set_keymap)</span><br><span class="line">    <span class="comment">-- TypeScript 增强</span></span><br><span class="line">    ts_utils.setup(&#123;</span><br><span class="line">      <span class="built_in">debug</span> = <span class="literal">false</span>,</span><br><span class="line">      disable_commands = <span class="literal">false</span>,</span><br><span class="line">      enable_import_on_completion = <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">-- import all</span></span><br><span class="line">      import_all_timeout = <span class="number">5000</span>, <span class="comment">-- ms</span></span><br><span class="line">      <span class="comment">-- lower numbers = higher priority</span></span><br><span class="line">      import_all_priorities = &#123;</span><br><span class="line">        same_file = <span class="number">1</span>, <span class="comment">-- add to existing import statement</span></span><br><span class="line">        local_files = <span class="number">2</span>, <span class="comment">-- git files or files with relative path markers</span></span><br><span class="line">        buffer_content = <span class="number">3</span>, <span class="comment">-- loaded buffer content</span></span><br><span class="line">        buffers = <span class="number">4</span>, <span class="comment">-- loaded buffer names</span></span><br><span class="line">      &#125;,</span><br><span class="line">      import_all_scan_buffers = <span class="number">100</span>,</span><br><span class="line">      import_all_select_source = <span class="literal">false</span>,</span><br><span class="line">      <span class="comment">-- if false will avoid organizing imports</span></span><br><span class="line">      always_organize_imports = <span class="literal">true</span>,</span><br><span class="line">      <span class="comment">-- filter diagnostics</span></span><br><span class="line">      filter_out_diagnostics_by_severity = &#123;&#125;,</span><br><span class="line">      filter_out_diagnostics_by_code = &#123;&#125;,</span><br><span class="line">      <span class="comment">-- inlay hints</span></span><br><span class="line">      auto_inlay_hints = <span class="literal">true</span>,</span><br><span class="line">      inlay_hints_highlight = <span class="string">&quot;Comment&quot;</span>,</span><br><span class="line">      <span class="comment">-- update imports on file move</span></span><br><span class="line">      update_imports_on_move = <span class="literal">false</span>,</span><br><span class="line">      require_confirmation_on_move = <span class="literal">false</span>,</span><br><span class="line">      watch_dir = <span class="literal">nil</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">-- required to fix code action ranges and filter diagnostics</span></span><br><span class="line">    ts_utils.setup_client(client)</span><br><span class="line">    <span class="comment">-- 绑定增强插件快捷键</span></span><br><span class="line">    keybindings.mapTsLSP(buf_set_keymap)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    server:setup(opts)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码比之前长了不少，主要是多了 ts_utils 初始化，里边都是默认配置，我并没有改动，我只是在 ts_utils 初始化后调用了 <code>keybindings.mapTsLSP(buf_set_keymap)</code> 绑定了新的快捷键。</p>
<p>打开 <code>lua/keybindings.lua</code> ，添加 mapTsLSP 方法:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- typescript 快捷键</span></span><br><span class="line">pluginKeys.mapTsLSP = <span class="function"><span class="keyword">function</span><span class="params">(mapbuf)</span></span></span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gs&quot;</span>, <span class="string">&quot;:TSLspOrganize&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gr&quot;</span>, <span class="string">&quot;:TSLspRenameFile&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  mapbuf(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;gi&quot;</span>, <span class="string">&quot;:TSLspImportAll&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里给我们的 TypeScript 开发增加了 3 个新功能。</p>
<p>我们先在 <code>lua/lsp/config/setup.lua</code> 中引入我们的 tsserver 配置文件：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tsserver = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.ts&quot;</span>),</span><br></pre></td></tr></table></figure>

<p>经过增强，终于有了 import 相关的命令了，比如 <code>:TSLspOrganize</code> 会删除不用的 import 语句并重新排序。</p>
<p>先找个前端项目试一下，我故意引入了很多没用到的东西，然后敲击 gs 即可瞬间整理完毕。</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/b455f6f96ef3434e9fdc033d85c5d7d9tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-10.gif"></p>
<p>除了这个还有 <code>:TSLspRenameFile</code> 用于改变文件名，同时其他文件中引用该文件的文件名也会被修改。</p>
<p><code>:TSLspImportAll</code> 将会导入当前文件的所有依赖，并且会自动排序。 我就不再演示了。</p>
<p>接下来就剩下 ESlint 和 Pretier 的配置了。</p>
<h2 id="ESLint-和-Prettier-配置"><a href="#ESLint-和-Prettier-配置" class="headerlink" title="ESLint 和 Prettier 配置"></a>ESLint 和 Prettier 配置</h2><p>ESLint 的文字提示，和 Prettier 的格式化，我都是通过上一节介绍的 null-ls 插件来实现的。</p>
<p>记得我们在之前的配置中用了 null-ls 的内置代码格式化源：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> formatting = null_ls.builtins.formatting</span><br><span class="line">...</span><br><span class="line"><span class="comment">-- StyLua</span></span><br><span class="line">formatting.stylua,</span><br></pre></td></tr></table></figure>

<p>其实 null-ls 除了内置 Formatting，还有内置很多的 Diagnostics 和 Code Actions</p>
<p>Diagnostic 就是类似代码行旁边的红字错误提示。</p>
<p>Code Action 就是这行可以触发的行为，比如有些 ESLint 错误是可以自动 Fix 的，这时候这行代码就有一个 Code Action，后边我再演示。</p>
<p>先打开 <code>lua/lsp/null-ls.lua</code>，改为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, null_ls = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;null-ls&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 null-ls&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> formatting = null_ls.builtins.formatting</span><br><span class="line"><span class="keyword">local</span> diagnostics = null_ls.builtins.diagnostics</span><br><span class="line"><span class="keyword">local</span> code_actions = null_ls.builtins.code_actions</span><br><span class="line"></span><br><span class="line">null_ls.setup(&#123;</span><br><span class="line">  <span class="built_in">debug</span> = <span class="literal">false</span>,</span><br><span class="line">  sources = &#123;</span><br><span class="line">    <span class="comment">-- Formatting ---------------------</span></span><br><span class="line">    <span class="comment">--  brew install shfmt</span></span><br><span class="line">    formatting.shfmt,</span><br><span class="line">    <span class="comment">-- StyLua</span></span><br><span class="line">    formatting.stylua,</span><br><span class="line">    <span class="comment">-- frontend</span></span><br><span class="line">    formatting.prettier.with(&#123; <span class="comment">-- 比默认少了 markdown</span></span><br><span class="line">      filetypes = &#123;</span><br><span class="line">        <span class="string">&quot;javascript&quot;</span>,</span><br><span class="line">        <span class="string">&quot;javascriptreact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typescript&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typescriptreact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vue&quot;</span>,</span><br><span class="line">        <span class="string">&quot;css&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scss&quot;</span>,</span><br><span class="line">        <span class="string">&quot;less&quot;</span>,</span><br><span class="line">        <span class="string">&quot;html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;yaml&quot;</span>,</span><br><span class="line">        <span class="string">&quot;graphql&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      extra_filetypes = &#123; <span class="string">&quot;njk&quot;</span> &#125;,</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">-- Diagnostics  ---------------------</span></span><br><span class="line">    diagnostics.eslint.with(&#123;</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">-- code actions ---------------------</span></span><br><span class="line">    code_actions.gitsigns,</span><br><span class="line">    code_actions.eslint.with(&#123;</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- #&#123;m&#125;: message</span></span><br><span class="line">  <span class="comment">-- #&#123;s&#125;: source name (defaults to null-ls if not specified)</span></span><br><span class="line">  <span class="comment">-- #&#123;c&#125;: code (if available)</span></span><br><span class="line">  <span class="comment">-- 提示格式： [eslint] xxx</span></span><br><span class="line">  diagnostics_format = <span class="string">&quot;[#&#123;s&#125;] #&#123;m&#125;&quot;</span>,</span><br><span class="line">  on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client)</span></span></span><br><span class="line">    <span class="comment">-- 自定义 :Format 命令</span></span><br><span class="line">    vim.cmd(<span class="string">[[ command! Format execute &#x27;lua vim.lsp.buf.formatting()&#x27;]]</span>)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>注意我们上边配置的都是 <code>prefer_local</code> 也就是说要求<strong>项目本地依赖</strong> prettier 和 eslint，也就是说项目目录要有 <code>package.json</code> 并且 <code>npm install -D prettier eslint</code> 安装过依赖，才成功会格式化。</p>
<p>按照上述配置后，就应该会显示 ESLint 错误了。 我们来实验一下。</p>
<p>ESLint recommended 规则里有一条叫作 <code>no-var</code> 规则，就是不推荐使用 var 来声明变量。</p>
<p>所以我们故意用 var 来声明一个变量：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/98d218fd8651439d98b1106100d39aa3tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-11.png"></p>
<p>看到右边的红字了吗，这就是 Diagostics，并且是按照我们上边代码设置的规则显示的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diagnostics_format = &quot;[#&#123;s&#125;] #&#123;m&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>现在我们看看 Code Action 能否自动修复掉，在该行代码上敲击我们之前定义的快捷键 <code>&lt;leader&gt;ca</code> 就会调用 Code Action 了，请看动图演示：</p>
<p><img src="/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/0471d897dcd94fdaa2bb0904dbf76127tplv-k3u1fbpfcp-zoom-in-crop-mark1304000.awebp" alt="16-12.gif"></p>
<p>第一次运行 CA 的时候，他会提示我修复 no-var 规则，改成了 let 声明变量，然后他又发现并没有给变量 a 重新赋值过，我再一次运行 CA 的时候，他会提示我这里应该用常量。最后修复完成变成了 <code>const a = 10</code>。</p>
<p>Okay。全部完成了，本节比较长，如果你没有跟上的话，可以参考我 GitHub 上的代码：</p>
<p><a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">github.com&#x2F;nshen&#x2F;learn…</a></p>
<p>欢迎点赞，或直接 Fork 我的代码，也欢迎留言分享你的配置。</p>
<p>下一节我会尝试配置其他编程语言 ，我了解的语言非常有限，我知道小册读者里有很多隐藏大佬，非常希望你能到 GitHub 上提出 PR 加入你熟悉的语言配置，我会更新在小册中，帮助到更多人，下节见。</p>
<h1 id="17-NeoVim-Rust开发配置与断点调试"><a href="#17-NeoVim-Rust开发配置与断点调试" class="headerlink" title="17.NeoVim Rust开发配置与断点调试"></a>17.NeoVim Rust开发配置与断点调试</h1><p>本节我们学习如何配置 Rust 开发环境，并了解在 Neovim 中如何进行断点调试。</p>
<p>先快速安装一下 Rust 编程语言。</p>
<h2 id="Rust-编程语言安装"><a href="#Rust-编程语言安装" class="headerlink" title="Rust 编程语言安装"></a>Rust 编程语言安装</h2><p>首先安装 rust，打开终端输入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 https://sh.rustup.rs -sSf | sh</span></span><br></pre></td></tr></table></figure>

<p>这个命令会下载一个脚本并自动开始安装 rustup，按照提示选择全新安装，也许会提示你输入管理员密码，安装成功会出现:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rust is installed now. Great!</span><br></pre></td></tr></table></figure>

<p>这时可以查看版本号，验证是否安装成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rustc -V</span><br><span class="line">rustc 1.60.0 (7737e0b5c 2022-04-04)</span><br><span class="line"></span><br><span class="line">$ cargo -V</span><br><span class="line">cargo 1.60.0 (d1fd9fe2c 2022-03-01)</span><br></pre></td></tr></table></figure>

<p>接下来安装 <a href="https://link.juejin.cn/?target=https://github.com/rust-lang/rust-analyzer">rust-analyzer</a> , rust-analyzer 可以算是社区驱动的 Language Server 实现了。</p>
<p>MacOS 下安装比较简单，运行命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install rust-analyzer</span><br></pre></td></tr></table></figure>

<p>其他系统请参考 <a href="https://link.juejin.cn/?target=https://rust-analyzer.github.io/manual.html%23installation">官方文档</a> 或参考其他教程。</p>
<p>至此 rust 语言环境就准备完成了，可以使用 cargo 创建一个 rust 项目了，打开命令行运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cargo new hello-rust</span><br><span class="line"><span class="built_in">cd</span> hello-rust</span><br><span class="line">cargo run</span><br></pre></td></tr></table></figure>

<p>如果输出 <code>Hello, world!</code> 就表示成功了，可以开始配置 Neovim 的 Rust 语法高亮和代码提示了。</p>
<h2 id="Rust-语法高亮与代码提示配置"><a href="#Rust-语法高亮与代码提示配置" class="headerlink" title="Rust 语法高亮与代码提示配置"></a>Rust 语法高亮与代码提示配置</h2><p>首先第一步安装基于 tree-sitter 的 rust 语法高亮。</p>
<p>运行 <code>TSInstall rust</code> 重启 Neovim 后，打开 <code>main.rs</code> 文件，应该可以看到语法高亮了。</p>
<p>接着我们配置 LSP，打开 <code>lua/lsp/setup.lua</code>，在 servers 变量中增加 rust 的配置文件，注意这里的 key 必须为 <code>rust_analyzer</code>，值为配置文件的路径，可以随意改变。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> servers = &#123;</span><br><span class="line">  sumneko_lua = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.lua&quot;</span>), <span class="comment">-- lua/lsp/config/lua.lua</span></span><br><span class="line">  bashls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.bash&quot;</span>),</span><br><span class="line">  pyright = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.pyright&quot;</span>),</span><br><span class="line">  html = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.html&quot;</span>),</span><br><span class="line">  cssls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.css&quot;</span>),</span><br><span class="line">  emmet_ls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.emmet&quot;</span>),</span><br><span class="line">  jsonls = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.json&quot;</span>),</span><br><span class="line">  tsserver = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.ts&quot;</span>),</span><br><span class="line">  <span class="comment">-- 新增</span></span><br><span class="line">  rust_analyzer = <span class="built_in">require</span>(<span class="string">&quot;lsp.config.rust&quot;</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建对应的 LSP 配置文件 <code>lua/lsp/config/rust.lua</code>，配置如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> opts = &#123;</span><br><span class="line">  capabilities = <span class="built_in">require</span>(<span class="string">&quot;cmp_nvim_lsp&quot;</span>).update_capabilities(vim.lsp.protocol.make_client_capabilities()),</span><br><span class="line">  flags = &#123;</span><br><span class="line">    debounce_text_changes = <span class="number">150</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client, bufnr)</span></span></span><br><span class="line">    <span class="comment">-- 禁用格式化功能，交给专门插件插件处理</span></span><br><span class="line">    client.resolved_capabilities.document_formatting = <span class="literal">false</span></span><br><span class="line">    client.resolved_capabilities.document_range_formatting = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">buf_set_keymap</span><span class="params">(...)</span></span></span><br><span class="line">      vim.api.nvim_buf_set_keymap(bufnr, ...)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 绑定快捷键</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapLSP(buf_set_keymap)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    <span class="comment">-- Initialize the LSP via rust-tools instead</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;rust-tools&quot;</span>).setup(&#123;</span><br><span class="line">      <span class="comment">-- The &quot;server&quot; property provided in rust-tools setup function are the</span></span><br><span class="line">      <span class="comment">-- settings rust-tools will provide to lspconfig during init.</span></span><br><span class="line">      <span class="comment">-- We merge the necessary settings from nvim-lsp-installer (server:get_default_options())</span></span><br><span class="line">      <span class="comment">-- with the user&#x27;s own settings (opts).</span></span><br><span class="line">      server = vim.tbl_deep_extend(<span class="string">&quot;force&quot;</span>, server:get_default_options(), opts),</span><br><span class="line">    &#125;)</span><br><span class="line">    server:attach_buffers()</span><br><span class="line">    <span class="comment">-- Only if standalone support is needed</span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;rust-tools&quot;</span>).start_standalone_if_required()</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们在返回的 on_setup 函数中引入了一个 <a href="https://link.juejin.cn/?target=https://github.com/simrat39/rust-tools.nvim">rust-tools</a> 插件，这个插件是一个 Rust 增强插件，在 LSP 之上增加了更多的命令，有兴趣可以去其主页深入了解。 <code>vim.tbl_deep_extend</code> 函数可以合并两个 table，<code>force</code> 参数表示如果 key 值相同，则用第二个参数的值。 用在这里表示把默认值和我们的自定义值合并，优先使用我们的自定义 opts 的值。</p>
<p>别忘了在 <code>lua/plugins.lua</code> 文件中安装 rust-tools 插件，否则会报错：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Rust 增强</span></span><br><span class="line">use(<span class="string">&quot;simrat39/rust-tools.nvim&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>保存重启 Neovim 后，打开 main.rs 发现语法提示已经搭建好了。</p>
<p><img src="/4de70a3cbd074b61ba545532168c595etplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-1.gif"></p>
<p>接下来配置代码格式化。</p>
<h2 id="代码格式化配置"><a href="#代码格式化配置" class="headerlink" title="代码格式化配置"></a>代码格式化配置</h2><p>现在很多项目使用 <a href="https://link.juejin.cn/?target=https://github.com/rust-lang/rustfmt">rust-lang&#x2F;rustfmt</a> 来统一 Rust 代码风格。</p>
<p>我们先安装这一工具，打开命令行运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rustup component add rustfmt</span><br></pre></td></tr></table></figure>

<p>运行 <code>rustfmt --version</code> 可显示版本号，表示安装成功。</p>
<p><img src="/29a4fa72d43c43b1af083b04b2ea0437tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-2.png"></p>
<p>既然是主流工具，那么 null-ls 一定是支持的。</p>
<p>打开 <code>lua/lsp/null-ls.lua</code> 文件， 在 sources 里增加 rustfmt 。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- rustfmt</span></span><br><span class="line">formatting.rustfmt,</span><br></pre></td></tr></table></figure>

<p>目前完整 <code>lua/lsp/null-ls.lua</code> 配置如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, null_ls = <span class="built_in">pcall</span>(<span class="built_in">require</span>, <span class="string">&quot;null-ls&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">status</span> <span class="keyword">then</span></span><br><span class="line">  vim.notify(<span class="string">&quot;没有找到 null-ls&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> formatting = null_ls.builtins.formatting</span><br><span class="line"><span class="keyword">local</span> diagnostics = null_ls.builtins.diagnostics</span><br><span class="line"><span class="keyword">local</span> code_actions = null_ls.builtins.code_actions</span><br><span class="line"></span><br><span class="line">null_ls.setup(&#123;</span><br><span class="line">  <span class="built_in">debug</span> = <span class="literal">false</span>,</span><br><span class="line">  sources = &#123;</span><br><span class="line">    <span class="comment">-- Formatting ---------------------</span></span><br><span class="line">    <span class="comment">--  brew install shfmt</span></span><br><span class="line">    formatting.shfmt,</span><br><span class="line">    <span class="comment">-- StyLua</span></span><br><span class="line">    formatting.stylua,</span><br><span class="line">    <span class="comment">-- frontend</span></span><br><span class="line">    formatting.prettier.with(&#123; <span class="comment">-- 比默认少了 markdown</span></span><br><span class="line">      filetypes = &#123;</span><br><span class="line">        <span class="string">&quot;javascript&quot;</span>,</span><br><span class="line">        <span class="string">&quot;javascriptreact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typescript&quot;</span>,</span><br><span class="line">        <span class="string">&quot;typescriptreact&quot;</span>,</span><br><span class="line">        <span class="string">&quot;vue&quot;</span>,</span><br><span class="line">        <span class="string">&quot;css&quot;</span>,</span><br><span class="line">        <span class="string">&quot;scss&quot;</span>,</span><br><span class="line">        <span class="string">&quot;less&quot;</span>,</span><br><span class="line">        <span class="string">&quot;html&quot;</span>,</span><br><span class="line">        <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="string">&quot;yaml&quot;</span>,</span><br><span class="line">        <span class="string">&quot;graphql&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">-- rustfmt</span></span><br><span class="line">    formatting.rustfmt,</span><br><span class="line">    <span class="comment">-- Python</span></span><br><span class="line">    <span class="comment">-- pip install black</span></span><br><span class="line">    <span class="comment">-- asdf reshim python</span></span><br><span class="line">    formatting.black.with(&#123; extra_args = &#123; <span class="string">&quot;--fast&quot;</span> &#125; &#125;),</span><br><span class="line">    <span class="comment">-----------------------------------------------------</span></span><br><span class="line">    <span class="comment">-- Ruby</span></span><br><span class="line">    <span class="comment">-- gem install rubocop</span></span><br><span class="line">    formatting.rubocop,</span><br><span class="line">    <span class="comment">-----------------------------------------------------</span></span><br><span class="line">    <span class="comment">-- Diagnostics  ---------------------</span></span><br><span class="line">    diagnostics.eslint.with(&#123;</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="comment">-- code actions ---------------------</span></span><br><span class="line">    code_actions.gitsigns,</span><br><span class="line">    code_actions.eslint.with(&#123;</span><br><span class="line">      prefer_local = <span class="string">&quot;node_modules/.bin&quot;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- #&#123;m&#125;: message</span></span><br><span class="line">  <span class="comment">-- #&#123;s&#125;: source name (defaults to null-ls if not specified)</span></span><br><span class="line">  <span class="comment">-- #&#123;c&#125;: code (if available)</span></span><br><span class="line">  diagnostics_format = <span class="string">&quot;[#&#123;s&#125;] #&#123;m&#125;&quot;</span>,</span><br><span class="line">  on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client)</span></span></span><br><span class="line">    vim.cmd(<span class="string">[[ command! Format execute &#x27;lua vim.lsp.buf.formatting()&#x27;]]</span>)</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/a3e35fa50f3046cea3a9954ff7350720tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-3.gif"></p>
<p>注意到上述的配置中，我参考交流群里群友的讨论，也增加了 Ruby 和 Python 格式化配置。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Python</span></span><br><span class="line"><span class="comment">-- pip install black</span></span><br><span class="line"><span class="comment">-- asdf reshim python</span></span><br><span class="line">formatting.black.with(&#123; extra_args = &#123; <span class="string">&quot;--fast&quot;</span> &#125; &#125;),</span><br><span class="line"><span class="comment">-----------------------------------------------------</span></span><br><span class="line"><span class="comment">-- Ruby</span></span><br><span class="line"><span class="comment">-- gem install rubocop</span></span><br><span class="line">formatting.rubocop,</span><br></pre></td></tr></table></figure>

<p>也欢迎各位大佬到我们 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">小册的 GitHub 代码库</a> 中发PR，持续改进配置。</p>
<p>由此可见，其他语言也应该都是类似的方式配置代码格式化，先用该语言的<strong>包管理器</strong>安装专门的<strong>格式化工具</strong>，然后在 null-ls 里面启用即可。</p>
<p>本节原本打算到此就结束了，但程序开发离不开代码调试，简单的程序可以通过打 log 的方式调试，复杂的程序还是需要用打断点，用逐步运行的方式来调试的。</p>
<p>我一直纠结写不写断点调试相关的东西。因为不得不承认的是，Neovim 中 debug 的体验并不是很好，比如想要调试基于 Node.js 程序的话，最新版本的 VSCode 中内置了 JavaScript Debug Terminal，基本上不用配置就可以直接捕获到断点信息。而用 Neovim 调试的话，还在使用已经被微软抛弃了一年的 <a href="https://link.juejin.cn/?target=https://github.com/microsoft/vscode-node-debug2">vscode-node-debug2</a> 库来调试。</p>
<p>而且调试也都是要基于 VSCode 的 DAP (Debug Adapter Protocol) 协议的，所以我还是比较倾向于直接使用 VSCode 来调试程序，但如果你是个爱折腾的人，不妨也可以跟我一起了解一下在 Neovim 中如何调试程序。</p>
<h2 id="配置-Debug-断点调试"><a href="#配置-Debug-断点调试" class="headerlink" title="配置 Debug 断点调试"></a>配置 Debug 断点调试</h2><p>想要在 Neovim 中打断点来调试应用程序，需要基于 DAP (Debug Adapter Protocol) 协议，这是一个跨平台的调试协议，可以在不同的平台上调试不同的程序。</p>
<p>在 Neovim 中基于 DAP 的插件有两个选择，一个是 <a href="https://link.juejin.cn/?target=https://github.com/puremourning/vimspector">vimspector</a> ，另一个是 <a href="https://link.juejin.cn/?target=https://github.com/mfussenegger/nvim-dap">nvim-dap</a>。</p>
<p>vimspector 是比较老牌的调试工具，主要为 Vim 8.2 以上的版本开发，同时也兼容 Neovim 0.43 以上的版本。 而 nvim-dap 是一个比较新的调试工具，不支持 Vim，是专门为 Neovim 开发的，使用了很多 Neovim 的 API，我觉得目前还不是很完善，需要搭配几个其他的插件才能很好地使用，而且几个插件都是由不同开发者开发的，其中一个插件更新，有可能会导致其他插件的不兼容，经常需要耗费精力来调整配置。</p>
<p>我们这里先尝试一下 vimspector，打开 <code>lua/plugins.lua</code> 文件，添加下面的代码：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- vimspector</span></span><br><span class="line">use(<span class="string">&quot;puremourning/vimspector&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 后自动安装，安装完成后，重启 Neovim 后会增加许多 Vimspector 开头的命令， 如果没有 Vimspector 开头的命令， 一般是 python 3 环境的问题，可以尝试运行：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip3 install <span class="attr">--upgrade</span> pynvim</span><br></pre></td></tr></table></figure>

<p>正常的话会如下动图所示，我们找到 <code>VimspectorInstall</code> 命令:</p>
<p><img src="/b9e9d262b13148ed947aeb57c279e617tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-4.gif"></p>
<p>上图这些就是 vimspector 支持的 debug 端适配器，在 vimspector 里适配器叫做 gadget，由于我们 debug rust 程序，所以应该安装 CodeLLDB 这个 gadget，选中 <code>VimspectorInstall CodeLLDB</code> ，回车安装。</p>
<p>这个命令实际上是调用的一段 python 脚本，所以需要 python3 环境支持，如果环境和网络都没有问题的话，等待一段时间如果安装成功会显示：</p>
<blockquote>
<p>Vimspector gadget installation complete!</p>
</blockquote>
<p>表示安装成功，但鉴于国内的网络环境，一般不太会那么顺利，所以建议进入到 vimspector 安装目录直接调用 python 脚本进行安装，那里会有更多的报错信息。</p>
<p>vimspector 的安装目录默认在 <code>~/.local/share/nvim/site/pack/packer/start/vimspector</code> ，在这个目录里会有一个 <code>install_gadget.py</code> 的脚本。</p>
<p>如果你的网络环境比较好的话，可以挂好全局代理，一次全部安装，下次就不用再进这个目录了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install_gadget.py --all</span><br></pre></td></tr></table></figure>

<p>也可以这样只安装 rust：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install_gadget.py --enable-rust</span><br></pre></td></tr></table></figure>

<p>如果到这里全部成功了的话，就可以开始配置 vimspector 了， 新建一个文件 <code>lua/dap/vimspector/init.lua</code>，内容为：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapVimspector()</span><br></pre></td></tr></table></figure>

<p>vimspector 并不需要配置，只需要定义一些快捷键就可以了，这里创建的配置文件，只有一行代码，就是定义快捷键。</p>
<p>之所以要有这个文件，就是方便<strong>入口文件</strong>引用。</p>
<p>打开 <code>lua/init.lua</code> 添加 vimspector 配置文件的引用：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;dap.vimspector&quot;</span>) <span class="comment">-- lua/dap/vimspector/init.lua</span></span><br></pre></td></tr></table></figure>

<p>像这样直接引用目录的话，会自动引用目录下的 <code>init.lua</code> 文件。</p>
<p>然后打开 <code>lua/keybindings.lua</code> 文件，增加 vimspector 快捷键设置：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pluginKeys.mapVimspector = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  <span class="comment">-- 开始</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dd&quot;</span>, <span class="string">&quot;:call vimspector#Launch()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 结束</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;Leader&gt;de&quot;</span>, <span class="string">&quot;:call vimspector#Reset()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 继续</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;Leader&gt;dc&quot;</span>, <span class="string">&quot;:call vimspector#Continue()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 设置断点</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;Leader&gt;dt&quot;</span>, <span class="string">&quot;:call vimspector#ToggleBreakpoint()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;Leader&gt;dT&quot;</span>, <span class="string">&quot;:call vimspector#ClearBreakpoints()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">--  stepOver, stepOut, stepInto</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dj&quot;</span>, <span class="string">&quot;&lt;Plug&gt;VimspectorStepOver&quot;</span>, opt)</span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dk&quot;</span>, <span class="string">&quot;&lt;Plug&gt;VimspectorStepOut&quot;</span>, opt)</span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dl&quot;</span>, <span class="string">&quot;&lt;Plug&gt;VimspectorStepInto&quot;</span>, opt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>重启 Neovim ，如果幸运没有报错的话，就可以开始 debug 了。</p>
<p>打开我们之前创建的 <code>hello-rust</code> 项目，找到 main.rs ，我从 <a href="https://link.juejin.cn/?target=https://course.rs/first-try/hello-world.html">course.rs</a> 教程上 copy 了一段 Rust 代码，如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">greet_world</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">southern_germany</span> = <span class="string">&quot;Grüß Gott!&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">chinese</span> = <span class="string">&quot;世界，你好&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">english</span> = <span class="string">&quot;World, hello&quot;</span>;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">regions</span> = [southern_germany, chinese, english];</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">region</span> <span class="keyword">in</span> regions.<span class="title function_ invoke__">iter</span>() &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;&#125;&quot;</span>, &amp;region);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="title function_ invoke__">greet_world</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先我们需要 build 一下这个项目 <code>cargo build</code>，接着我们要在项目根目录创建一个 <code>.vimspector.json</code> 文件，内容如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;launch&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;adapter&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CodeLLDB&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;configuration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceRoot&#125;/target/debug/hello-rust&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;breakpoints&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;exception&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;cpp_catch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;cpp_throw&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;objc_catch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;objc_throw&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;swift_catch&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;swift_throw&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这个文件的 program 值指向我们刚才 build 出的 <code>debug/hello-rust</code> ，adapter 值是 CodeLLDB， breakpoints 这部分设置是默认的异常抛出处理方法，可以去掉，如果去掉的话每次debug 都会问你抛出异常如何处理。</p>
<p>接下来演示一下如何 debug：</p>
<ol>
<li><code>&lt;leader&gt;dt</code> 创建断点</li>
<li><code>&lt;leader&gt;dd</code> 启动 debug</li>
<li><code>&lt;leader&gt;dj</code> step over</li>
<li><code>&lt;leader&gt;de</code> 结束 debug</li>
</ol>
<p><img src="/3a3e0884eb0a43e49cfbb9ce121864b6tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-5.gif"></p>
<p>debug 界面中小黄点是断点，黄色箭头是当前运行到的行，和其他软件的 debug 界面应该差不多。</p>
<p><img src="/6094e1b46f2e43bb856ffc08906e6616tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-6.png"></p>
<p>这里就不再赘述了，接下来看一下专门为 Neovim 打造的 nvim-dap 怎么样。</p>
<h2 id="nvim-dap-配置"><a href="#nvim-dap-配置" class="headerlink" title="nvim-dap 配置"></a>nvim-dap 配置</h2><p>打开 <code>lua/plugins.lua</code> 文件，增加如下内容：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use(<span class="string">&quot;mfussenegger/nvim-dap&quot;</span>)</span><br><span class="line">use(<span class="string">&quot;theHamsta/nvim-dap-virtual-text&quot;</span>)</span><br><span class="line">use(<span class="string">&quot;rcarriga/nvim-dap-ui&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><code>:w</code> 安装完成后， 创建 <code>lua/dap/nvim-dap/init.lua</code> 文件，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> dap = <span class="built_in">require</span>(<span class="string">&quot;dap&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> dapui = <span class="built_in">require</span>(<span class="string">&quot;dapui&quot;</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;nvim-dap-virtual-text&quot;</span>).setup(&#123;</span><br><span class="line">  commented = <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义各种图标</span></span><br><span class="line"></span><br><span class="line">vim.fn.sign_define(<span class="string">&quot;DapBreakpoint&quot;</span>, &#123;</span><br><span class="line">  text = <span class="string">&quot;🛑&quot;</span>,</span><br><span class="line">  texthl = <span class="string">&quot;LspDiagnosticsSignError&quot;</span>,</span><br><span class="line">  linehl = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  numhl = <span class="string">&quot;&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">vim.fn.sign_define(<span class="string">&quot;DapStopped&quot;</span>, &#123;</span><br><span class="line">  text = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  texthl = <span class="string">&quot;LspDiagnosticsSignInformation&quot;</span>,</span><br><span class="line">  linehl = <span class="string">&quot;DiagnosticUnderlineInfo&quot;</span>,</span><br><span class="line">  numhl = <span class="string">&quot;LspDiagnosticsSignInformation&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">vim.fn.sign_define(<span class="string">&quot;DapBreakpointRejected&quot;</span>, &#123;</span><br><span class="line">  text = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  texthl = <span class="string">&quot;LspDiagnosticsSignHint&quot;</span>,</span><br><span class="line">  linehl = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  numhl = <span class="string">&quot;&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">dapui.setup(&#123;</span><br><span class="line">  icons = &#123; expanded = <span class="string">&quot;▾&quot;</span>, collapsed = <span class="string">&quot;▸&quot;</span> &#125;,</span><br><span class="line">  mappings = &#123;</span><br><span class="line">    <span class="comment">-- Use a table to apply multiple mappings</span></span><br><span class="line">    expand = &#123; <span class="string">&quot;o&quot;</span>, <span class="string">&quot;&lt;CR&gt;&quot;</span>, <span class="string">&quot;&lt;2-LeftMouse&gt;&quot;</span> &#125;,</span><br><span class="line">    <span class="built_in">open</span> = <span class="string">&quot;o&quot;</span>,</span><br><span class="line">    <span class="built_in">remove</span> = <span class="string">&quot;d&quot;</span>,</span><br><span class="line">    edit = <span class="string">&quot;e&quot;</span>,</span><br><span class="line">    repl = <span class="string">&quot;r&quot;</span>,</span><br><span class="line">    toggle = <span class="string">&quot;t&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  sidebar = &#123;</span><br><span class="line">    <span class="comment">-- You can change the order of elements in the sidebar</span></span><br><span class="line">    elements = &#123;</span><br><span class="line">      <span class="comment">-- Provide as ID strings or tables with &quot;id&quot; and &quot;size&quot; keys</span></span><br><span class="line">      &#123;</span><br><span class="line">        id = <span class="string">&quot;scopes&quot;</span>,</span><br><span class="line">        size = <span class="number">0.25</span>, <span class="comment">-- Can be float or integer &gt; 1</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123; id = <span class="string">&quot;breakpoints&quot;</span>, size = <span class="number">0.25</span> &#125;,</span><br><span class="line">      &#123; id = <span class="string">&quot;stacks&quot;</span>, size = <span class="number">0.25</span> &#125;,</span><br><span class="line">      &#123; id = <span class="string">&quot;watches&quot;</span>, size = <span class="number">00.25</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    size = <span class="number">40</span>,</span><br><span class="line">    position = <span class="string">&quot;left&quot;</span>, <span class="comment">-- Can be &quot;left&quot;, &quot;right&quot;, &quot;top&quot;, &quot;bottom&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  tray = &#123;</span><br><span class="line">    elements = &#123; <span class="string">&quot;repl&quot;</span> &#125;,</span><br><span class="line">    size = <span class="number">10</span>,</span><br><span class="line">    position = <span class="string">&quot;bottom&quot;</span>, <span class="comment">-- Can be &quot;left&quot;, &quot;right&quot;, &quot;top&quot;, &quot;bottom&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  floating = &#123;</span><br><span class="line">    max_height = <span class="literal">nil</span>, <span class="comment">-- These can be integers or a float between 0 and 1.</span></span><br><span class="line">    max_width = <span class="literal">nil</span>, <span class="comment">-- Floats will be treated as percentage of your screen.</span></span><br><span class="line">    border = <span class="string">&quot;single&quot;</span>, <span class="comment">-- Border style. Can be &quot;single&quot;, &quot;double&quot; or &quot;rounded&quot;</span></span><br><span class="line">    mappings = &#123;</span><br><span class="line">      <span class="built_in">close</span> = &#123; <span class="string">&quot;q&quot;</span>, <span class="string">&quot;&lt;Esc&gt;&quot;</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  windows = &#123; indent = <span class="number">1</span> &#125;,</span><br><span class="line">  render = &#123;</span><br><span class="line">    max_type_length = <span class="literal">nil</span>, <span class="comment">-- Can be integer or nil.</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;) <span class="comment">-- use default</span></span><br><span class="line">dap.listeners.after.event_initialized[<span class="string">&quot;dapui_config&quot;</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  dapui.<span class="built_in">open</span>()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">dap.listeners.before.event_terminated[<span class="string">&quot;dapui_config&quot;</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  dapui.<span class="built_in">close</span>()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">dap.listeners.before.event_exited[<span class="string">&quot;dapui_config&quot;</span>] = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  dapui.<span class="built_in">close</span>()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 绑定 nvim-dap 快捷键</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;keybindings&quot;</span>).mapDAP()</span><br></pre></td></tr></table></figure>

<p>同时在 <strong>入口文件</strong> init.lua 中注释掉 vimspector，增加 nvim-dap 的引用：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- require(&quot;dap.vimspector&quot;)</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;dap.nvim-dap&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>因为 rust-tools 正在尝试集成 Dap 调试, 所以接着我们还需要给 rust-tools 传入 Dap adapter 的配置信息。</p>
<p>打开 <code>lua/lsp/config/rust.lua</code>，注意看新增一行 dap 的配置：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  on_setup = <span class="function"><span class="keyword">function</span><span class="params">(server)</span></span></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;rust-tools&quot;</span>).setup(&#123;</span><br><span class="line">      server = vim.tbl_deep_extend(<span class="string">&quot;force&quot;</span>, server:get_default_options(), opts),</span><br><span class="line">      <span class="comment">-- ( 新增)</span></span><br><span class="line">      dap = <span class="built_in">require</span>(<span class="string">&quot;dap.nvim-dap.rust&quot;</span>),</span><br><span class="line">    &#125;)</span><br><span class="line">    server:attach_buffers()</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">&quot;rust-tools&quot;</span>).start_standalone_if_required()</span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时创建 <code>lua/dap/nvim-dap/rust.lua</code> 文件，内容如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 注意：这里要修改为你的绝对路径</span></span><br><span class="line"><span class="keyword">local</span> extension_path =</span><br><span class="line">  <span class="string">&quot;/Users/nn/.local/share/nvim/site/pack/packer/start/vimspector/gadgets/macos/download/CodeLLDB/v1.6.10/root/extension/&quot;</span></span><br><span class="line"><span class="keyword">local</span> codelldb_path = extension_path .. <span class="string">&quot;adapter/codelldb&quot;</span></span><br><span class="line"><span class="keyword">local</span> liblldb_path = extension_path .. <span class="string">&quot;lldb/lib/liblldb.dylib&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  adapter = <span class="built_in">require</span>(<span class="string">&quot;rust-tools.dap&quot;</span>).get_codelldb_adapter(codelldb_path, liblldb_path),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个文件提供 rust-tools 需要的适配器的路径信息，仔细看一下路径，就是我们上边用 vimspector 安装的 CodeLLDB 的路径，默认在 vimspector 插件目录下， 这个路径非常重要，需要<strong>修改成 CodeLLDB 在你系统中的绝对路径</strong> ，不同操作系统目录也会不同，请实际去目录中查看。</p>
<p>接着我们去设置快捷键，在 <code>lua/keybindings.lua</code> 中增加：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- nvim-dap</span></span><br><span class="line">pluginKeys.mapDAP = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  <span class="comment">-- 开始</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dd&quot;</span>, <span class="string">&quot;:RustDebuggables&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 结束 (dapui无法自动关闭可能是bug，手动关闭能想到的一切)</span></span><br><span class="line">  map(</span><br><span class="line">    <span class="string">&quot;n&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&lt;leader&gt;de&quot;</span>,</span><br><span class="line">    <span class="string">&quot;:lua require&#x27;dap&#x27;.close()&lt;CR&gt;&quot;</span></span><br><span class="line">      .. <span class="string">&quot;:lua require&#x27;dap&#x27;.terminate()&lt;CR&gt;&quot;</span></span><br><span class="line">      .. <span class="string">&quot;:lua require&#x27;dap.repl&#x27;.close()&lt;CR&gt;&quot;</span></span><br><span class="line">      .. <span class="string">&quot;:lua require&#x27;dapui&#x27;.close()&lt;CR&gt;&quot;</span></span><br><span class="line">      .. <span class="string">&quot;:lua require(&#x27;dap&#x27;).clear_breakpoints()&lt;CR&gt;&quot;</span></span><br><span class="line">      .. <span class="string">&quot;&lt;C-w&gt;o&lt;CR&gt;&quot;</span>,</span><br><span class="line">    opt</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">-- 继续</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dc&quot;</span>, <span class="string">&quot;:lua require&#x27;dap&#x27;.continue()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 设置断点</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dt&quot;</span>, <span class="string">&quot;:lua require(&#x27;dap&#x27;).toggle_breakpoint()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dT&quot;</span>, <span class="string">&quot;:lua require(&#x27;dap&#x27;).clear_breakpoints()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">--  stepOver, stepOut, stepInto</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dj&quot;</span>, <span class="string">&quot;:lua require&#x27;dap&#x27;.step_over()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dk&quot;</span>, <span class="string">&quot;:lua require&#x27;dap&#x27;.step_out()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dl&quot;</span>, <span class="string">&quot;:lua require&#x27;dap&#x27;.step_into()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line">  <span class="comment">-- 弹窗</span></span><br><span class="line">  map(<span class="string">&quot;n&quot;</span>, <span class="string">&quot;&lt;leader&gt;dh&quot;</span>, <span class="string">&quot;:lua require&#x27;dapui&#x27;.eval()&lt;CR&gt;&quot;</span>, opt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>方便起见，我这里设置的快捷键与 vimspector 的快捷键一模一样，增加了一个 <code>&lt;leader&gt;dh</code> 弹窗查看变量值，由于与vimsector 快捷键一样，我们可以用同样的方式测试一下。</p>
<ol>
<li><code>&lt;leader&gt;dt</code> 创建断点 （大红点）</li>
<li><code>&lt;leader&gt;dd</code> 启动 debug</li>
<li><code>&lt;leader&gt;dj</code> step over</li>
<li><code>&lt;leader&gt;de</code> 结束 debug</li>
</ol>
<p><img src="/529e1cb26fa04935965cf8f759f6771dtplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="17-7.gif"></p>
<p>Okay，本节就到此结束了，下一节是最后一节了，会对整个小册作个总结，把剩下没有讲到组件做一个简单的介绍，并把网友常问的问题进行一个整理，方便后边的同学参考，谢谢支持。</p>
<p>欢迎到 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">小册的 GitHub 代码库</a> 中发PR，持续改进配置。</p>
<h1 id="18-结语与常见问题解答"><a href="#18-结语与常见问题解答" class="headerlink" title="18.结语与常见问题解答"></a>18.结语与常见问题解答</h1><p>首先恭喜你终于完成了此小册的所有配置，如果你坚持读到这里，那么你应该已经了解 Neovim 的配置原理，并且已经有了一个相对可用的开发环境了。</p>
<p>Neovim 是一个不断发展的开发工具，围绕其的插件也在不断更新，但它始终只是一个开发工具，不必神话它，你如果觉得实在麻烦，大可用回 <code>VSCode</code>，目前我也是两者都在使用之中。</p>
<p>但如果你骨子里就是一个爱折腾的人，想做那一小撮最靓的极客，那么这里只是你的第一步，你可以更加深入学习 Lua 语言的特性，苦读 Neovim 的 API 文档，寻找并尝试更多的插件，研究开源社区中其他配置版本各种各样的思路，来扩展和更新我们的版本，或者苦练手速，熟记更大量的快捷键，早日成为真正的大师。</p>
<p>在这里先回顾一下本小册的配置思路，我觉得是非常易懂易扩展的。</p>
<h2 id="配置回顾"><a href="#配置回顾" class="headerlink" title="配置回顾"></a>配置回顾</h2><p>我们将 <code>init.lua</code> 作为<strong>入口文件</strong>，这里列出了所有用到的配置文件，如果这里没有列出来，那么一定是还没有生效的。这样当你需要添加或删除一个功能的时候，可以非常方便的这里调整。</p>
<p>由于脚本是从上至下顺序执行的，所以这里的引入顺序很重要。第一个引入的文件是 <code>basic.lua</code>，用于重置 Neovim 的<strong>基础配置</strong>，更加符合人类的使用习惯。</p>
<p>接着我们将所有<strong>快捷键</strong>的设置全部都放在 <code>keybindings.lua</code> 中，任何快捷键的调整，包含第三方插件的快捷键，都可以在这一个地方统一调整。</p>
<p>在这个文件中，我们先调用 <code>vim.api.nvim_set_keymap</code> 设置了<strong>常见的快捷键</strong>。对于不能立刻设置，需要等待<strong>特定时机</strong>设置的快捷键，我们在 return 的 pluginKeys Table 中定义了对应的函数，在指定的时机，任意位置都可以调用<code>require(&quot;keybindings).xxx()</code> ，这样就可以绑定对应的快捷键了。</p>
<p>接着我们用 <code>plugins.lua</code> <strong>管理插件的安装卸载</strong>，并且设置了自动命令，修改并保存此文件会自动安装对应插件。如果未来你需要<strong>添加插件</strong>，第一个应该想到就是到这个文件中添加。</p>
<p>通常每个插件对应一个配置文件，我们将<strong>插件的配置文件</strong>统一放在了 <code>plugin-config/</code> 文件夹中， 在这个文件夹里的文件，添加删除是常事，所以我们用 <code>pcall</code> 捕获了 <code>require</code> 插件错误，这样如果这个配置文件被引用了，但 这个插件并没安装成功，或已经被删除了，也不会让 Neovim 崩溃。</p>
<p>然后我们创建的单独的 <code>lsp/</code> 文件夹用于放置 <strong>LSP 相关的的配置</strong>，在 <code>lsp/setup.lua</code> 中，我们用 <code>nvim-lsp-installer</code> 来管理 Language Server 的安装卸载，手动加载 <code>lsp/confg/</code> 子目录的各种语言配置文件来增加不同的编程语言。</p>
<p>在 <code>lsp/cmp.lua</code> 中配置了<strong>自动补全</strong>功能，在 <code>lsp/formatter.lua</code> 中配置了专门的<strong>代码格式化</strong>插件，之后我们又改成了 <code>lsp/null-ls.lua</code> 来代替 LSP 的格式化方法。</p>
<p>最后我们又创建了 <code>dap/</code> 文件夹用于保存<strong>断点调试</strong>相关的配置，两个流行的插件分别在 <code>dap/vimspector/</code> 中， 和 <code>dap/nvim-dap/</code> 文件中，我们将两个工具设置了相同的一套快捷键，建议在 init.lua 中任选一种使用。</p>
<h2 id="还有哪些没有讲到？"><a href="#还有哪些没有讲到？" class="headerlink" title="还有哪些没有讲到？"></a>还有哪些没有讲到？</h2><p>Neovim 是一个开放的世界，不断会有新的插件出现，我们不可能把所有的插件都研究一遍，而且大部分插件基本上不需要配置，使用默认的配置就够了。这里介绍一没有说到的插件，并提供配置文件相信你可以自己搞得定。</p>
<p><strong>nvim-autopairs</strong> 插件可以自动补充后一半的括号，见图：</p>
<p><img src="/08c35600af6644d396c05d732c993908tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="18-4.gif"></p>
<p>配置文件 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/blob/main/lua/plugin-config/nvim-autopairs.lua">nvim-autopairs.lua</a>，在入口文件引入即可。</p>
<p><strong>Comment.nvim</strong> 快速注释代码</p>
<p><img src="/074a6ccdba1c4219a41e385b014ef5edtplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="18-5.gif"></p>
<p>我在 <code>keybindings.lua</code> 定义了 gcc 快捷键作为行注释，gbc 快捷键作为块注释</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 代码注释插件</span></span><br><span class="line"><span class="comment">-- see ./lua/plugin-config/comment.lua</span></span><br><span class="line">pluginKeys.comment = &#123;</span><br><span class="line">  <span class="comment">-- Normal 模式快捷键</span></span><br><span class="line">  toggler = &#123;</span><br><span class="line">    line = <span class="string">&quot;gcc&quot;</span>, <span class="comment">-- 行注释</span></span><br><span class="line">    block = <span class="string">&quot;gbc&quot;</span>, <span class="comment">-- 块注释</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">-- Visual 模式</span></span><br><span class="line">  opleader = &#123;</span><br><span class="line">    line = <span class="string">&quot;gc&quot;</span>,</span><br><span class="line">    bock = <span class="string">&quot;gb&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/blob/main/lua/plugin-config/comment.lua">comment.lua</a>，在入口文件引入即可。</p>
<p><strong>surround.nvim</strong></p>
<p>surround.nvim 插件会增加几个快捷键，我常用的有：</p>
<ul>
<li><code>ds&lt;char&gt;</code></li>
<li><code>cs&lt;from&gt;&lt;to&gt;</code></li>
<li><code>ys&#123;motion&#125;&#123;char&#125;</code></li>
</ul>
<p><img src="/d61ed1e201d34834b0576d173d5e9b2dtplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="18-6.gif"></p>
<p>配置文件 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/blob/main/lua/plugin-config/surround.lua">surround.lua</a>，在入口文件引入即可。</p>
<h3 id="输入法自动切换"><a href="#输入法自动切换" class="headerlink" title="输入法自动切换"></a>输入法自动切换</h3><p>我们希望进入 Normal 模式时自动切换为英文输入法，而进入到 Insert 模式时切换回之前输入时所用的输入法。</p>
<p>我们可以增加一条自动命令：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> myAutoGroup = vim.api.nvim_create_augroup(<span class="string">&quot;myAutoGroup&quot;</span>, &#123; clear = <span class="literal">true</span>, &#125;)</span><br><span class="line"><span class="keyword">local</span> autocmd = vim.api.nvim_create_autocmd</span><br><span class="line"><span class="comment">-- 自动切换输入法</span></span><br><span class="line">autocmd(<span class="string">&quot;InsertLeave&quot;</span>, &#123;</span><br><span class="line">  group = myAutoGroup,</span><br><span class="line">  callback = <span class="built_in">require</span>(<span class="string">&quot;utils.im-select&quot;</span>).macInsertLeave,</span><br><span class="line">&#125;)</span><br><span class="line">autocmd(<span class="string">&quot;InsertEnter&quot;</span>, &#123;</span><br><span class="line">  group = myAutoGroup,</span><br><span class="line">  callback = <span class="built_in">require</span>(<span class="string">&quot;utils.im-select&quot;</span>).macInsertEnter,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>InserLeave 和 InsertEnter 时调用一个 im-select 脚本，这个脚本会自动切换输入法。</p>
<p>注意上述代码是 Mac 系统调用的 macInsertLeave &#x2F; macInsertEnter , Windows 系统应改为 winInsertLeave &#x2F; winInsertEnter。</p>
<p><code>lua/utils/im-select.lua</code> 代码如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> M = &#123;&#125;</span><br><span class="line"></span><br><span class="line">M.defaultIM = <span class="string">&quot;com.apple.keylayout.ABC&quot;</span></span><br><span class="line">M.currentIM = M.defaultIM</span><br><span class="line"></span><br><span class="line">M.macInsertLeave = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  M.currentIM = vim.fn.system(&#123; <span class="string">&quot;im-select&quot;</span> &#125;)</span><br><span class="line">  vim.cmd(<span class="string">&quot;:silent :!im-select&quot;</span> .. <span class="string">&quot; &quot;</span> .. M.defaultIM)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.macInsertEnter = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">if</span> M.currentIM <span class="keyword">then</span></span><br><span class="line">    vim.cmd(<span class="string">&quot;:silent :!im-select&quot;</span> .. <span class="string">&quot; &quot;</span> .. M.currentIM)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    vim.cmd(<span class="string">&quot;:silent :!im-select&quot;</span> .. <span class="string">&quot; &quot;</span> .. M.defaultIM)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.windowsInsertLeave = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  vim.cmd(<span class="string">&quot;:silent :!~/.config/nvim/im-select.exe 1033&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">M.windowsInsertEnter = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">  vim.cmd(<span class="string">&quot;:silent :!~/.config/nvim/im-select.exe 2052&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>

<p>注意这个脚本需要依赖 <a href="https://link.juejin.cn/?target=https://github.com/daipeihust/im-select">im-select</a>。</p>
<p>mac 系统安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew tap daipeihust/tap &amp;&amp; brew install im-select</span><br></pre></td></tr></table></figure>

<p>Windows 系统下载 <a href="https://link.juejin.cn/?target=https://github.com/daipeihust/im-select/raw/master/im-select-win/out/x86/im-select.exe">im-select.exe</a> 到 nvim 目录下，并且在设置中添加英语语言，具体方法为:</p>
<blockquote>
<p>Windows设置 &gt; 时间和语言 &gt; 语言下，找到首选语言，点 + 号添加语言，选择英语（美国），只需要基本包即可，手写识别、语音识别可以不需要。</p>
</blockquote>
<p>完整代码请参考 小册 GitHub 仓库:</p>
<ul>
<li><a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/blob/main/lua/utils/im-select.lua">&#x2F;lua&#x2F;utils&#x2F;im-select.lua</a></li>
<li><a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/blob/main/lua/autocmds.lua">&#x2F;lua&#x2F;autocmds.lua</a></li>
</ul>
<h2 id="常见疑难问题解答"><a href="#常见疑难问题解答" class="headerlink" title="常见疑难问题解答"></a>常见疑难问题解答</h2><p>我在编写小册的过程中收到了很多反馈，以下问题是问得最多的，我将其整理出来：</p>
<h3 id="如何卸载插件"><a href="#如何卸载插件" class="headerlink" title="如何卸载插件?"></a>如何卸载插件?</h3><p>打开 <code>lua/plugins.lua</code> 文件，找到要卸载的插件，注释掉，<code>:w</code> 保存文件，被询问是否删除，输入 y 回车即可。</p>
<p><img src="/4e3e4bcc62de4a49b1fbeb333a2c9bcctplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="18-1.gif"></p>
<h3 id="为什么插件明明安装成功了，配置文件却莫名报错找不到插件？"><a href="#为什么插件明明安装成功了，配置文件却莫名报错找不到插件？" class="headerlink" title="为什么插件明明安装成功了，配置文件却莫名报错找不到插件？"></a>为什么插件明明安装成功了，配置文件却莫名报错找不到插件？</h3><p>通常是安装插件时遇到网络错误，导致实际上并没有真正的安装成功，参考上一个问题先卸载，再重新安装。</p>
<h3 id="插件全部安装失败，如何解决？"><a href="#插件全部安装失败，如何解决？" class="headerlink" title="插件全部安装失败，如何解决？"></a>插件全部安装失败，如何解决？</h3><p>插件安装失败通常都是因为国内网络环境的问题，基本上有两种方式解决：</p>
<p>第一种就是挂全局代理，或者在代理软件上复制终端命令到系统相应位置，在 windows wsl2 挂代理有些复杂，可以到这里参考 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/discussions/45">我的配置</a>。</p>
<p>第二种就是使用镜像站点，取消下边注释中任意一行后保存，重新安装。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 自定义源</span></span><br><span class="line">  git = &#123;</span><br><span class="line">    <span class="comment">-- default_url_format = &quot;https://hub.fastgit.xyz/%s&quot;,</span></span><br><span class="line">    <span class="comment">-- default_url_format = &quot;https://mirror.ghproxy.com/https://github.com/%s&quot;,</span></span><br><span class="line">    <span class="comment">-- default_url_format = &quot;https://gitcode.net/mirrors/%s&quot;,</span></span><br><span class="line">    <span class="comment">-- default_url_format = &quot;https://gitclone.com/github.com/%s&quot;,</span></span><br><span class="line">    <span class="comment">-- default_url_format = &quot;git@github.com:%s&quot; -- 换用 git 协议</span></span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>完整代码参考： <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua/blob/18fe3947671088bc70a7ef75d6d2ca82c7ac0444/lua/plugins.lua%23L150-L156">&#x2F;lua&#x2F;plugins.lua#L150-L156</a></p>
<h3 id="总有一个插件更新失败"><a href="#总有一个插件更新失败" class="headerlink" title="总有一个插件更新失败"></a>总有一个插件更新失败</h3><p>参考上边如何卸载插件，先卸载，再重新安装即可。</p>
<h3 id="Mac-系统没有-Alt-键，Option-键也不管用，如何设置-Command-快捷键？"><a href="#Mac-系统没有-Alt-键，Option-键也不管用，如何设置-Command-快捷键？" class="headerlink" title="Mac 系统没有 Alt 键，Option 键也不管用，如何设置 Command 快捷键？"></a>Mac 系统没有 Alt 键，Option 键也不管用，如何设置 Command 快捷键？</h3><p>在我们的配置中，Mac 系统的 Option 键对应的是 Windows 系统的 Alt 键，如果你的 Option 键没有反应，通常需要设置一下你的终端，将 Option 键设置为 Meta 键。</p>
<p>Item2 设置方式为 <code>Preference -&gt; Profiles -&gt; Default --&gt; Keys --&gt; Left Option key --&gt; 选中 Esc+</code></p>
<p><img src="/29c2446988a84cad857f4ddd2eb02040tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="18-2.png"></p>
<p>Alacritty 设置方式参考 <a href="https://link.juejin.cn/?target=https://github.com/nshen/dotfiles/blob/main/.alacritty.yml">我的配置文件中</a> <code># Alt Meta key</code> 的部分</p>
<p>另外 Neovim 中 是无法识别到 Command 键的。</p>
<h3 id="windows-的-ubuntu-子系统下安装插件报错-could-not-find-executable-quot-unzip-quot-in-path"><a href="#windows-的-ubuntu-子系统下安装插件报错-could-not-find-executable-quot-unzip-quot-in-path" class="headerlink" title="windows 的 ubuntu 子系统下安装插件报错 could not find executable &quot;unzip&quot; in path?"></a>windows 的 ubuntu 子系统下安装插件报错 <code>could not find executable &quot;unzip&quot; in path</code>?</h3><p>因为缺少压缩解压软件，需要安装 zip unzip。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zip unzip</span><br></pre></td></tr></table></figure>

<h3 id="在-Windows-10-中如何将-Neovim-中的内容复制到系统剪贴板？"><a href="#在-Windows-10-中如何将-Neovim-中的内容复制到系统剪贴板？" class="headerlink" title="在 Windows 10 中如何将 Neovim 中的内容复制到系统剪贴板？"></a>在 Windows 10 中如何将 Neovim 中的内容复制到系统剪贴板？</h3><p>我们可以创建一个简单的脚本 <code>fix-yank.lua</code> 并在入口文件中引入，如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim.cmd(<span class="string">[[</span></span><br><span class="line"><span class="string">augroup fix_yank</span></span><br><span class="line"><span class="string">    autocmd!</span></span><br><span class="line"><span class="string">    autocmd TextYankPost * if v:event.operator ==# &#x27;y&#x27; | call system(&#x27;/mnt/c/Windows/System32/clip.exe&#x27;, @0) | endif</span></span><br><span class="line"><span class="string">augroup END</span></span><br><span class="line"><span class="string">]]</span>)</span><br></pre></td></tr></table></figure>

<p>上述代码意思大概是每次 y 复制后把内容传给 windows 自带的 clip.exe 中，达到复制的目的。</p>
<h3 id="在-Windows-10-中如何将系统剪切板中的内容粘贴到-Neovim-中？"><a href="#在-Windows-10-中如何将系统剪切板中的内容粘贴到-Neovim-中？" class="headerlink" title="在 Windows 10 中如何将系统剪切板中的内容粘贴到 Neovim 中？"></a>在 Windows 10 中如何将系统剪切板中的内容粘贴到 Neovim 中？</h3><p>可以打开 Terminal，选择 <code>设置 --&gt; 操作 --&gt; 粘贴</code> 设置粘贴的快捷键.</p>
<p><img src="/34dce465c24747198f0272da519f41b3tplv-k3u1fbpfcp-zoom-in-crop-mark3024000.awebp" alt="18-3.webp"></p>
<p>如有更多问题欢迎留言，我会继续更新。</p>
<p>另外记得关注我们 <a href="https://link.juejin.cn/?target=https://github.com/nshen/learn-neovim-lua">GitHub 上小册的配套代码</a> 未来代码还会持续的改进。</p>
<p>关注我的 <a target="_blank" rel="noopener" href="https://juejin.cn/user/1873223543167326">掘金个人主页</a> ，未来我也会在上边写一些 Neovim 相关的文章。</p>
<p>最后再次感谢支持，江湖再见！</p>
<h1 id="从-nvim-lsp-installer-升级到-mason-nvim"><a href="#从-nvim-lsp-installer-升级到-mason-nvim" class="headerlink" title="从 nvim-lsp-installer 升级到 mason.nvim"></a>从 nvim-lsp-installer 升级到 mason.nvim</h1><p><a target="_blank" rel="noopener" href="https://github.com/williamboman/nvim-lsp-installer/discussions/876">Introducing mason.nvim · Discussion #876 · williamboman&#x2F;nvim-lsp-installer · GitHub</a></p>
<p>mason.nvim 是 nvim-lsp-installer 的下一代版本，现有的 nvim-lsp-installer 将不再维护，所以我们还是有必要升级一下的，本文将分享一下我的升级过程。</p>
<p>好了开始正文，最近每次我们使用 <code>:LspInstallInfo</code> 打开 <strong>nvim-lsp-installer</strong> 的时候都会在最上边看到两行网址。</p>
<p><img src="/a7984f06abad4a6ab1c4a469a0423c7ftplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="image.png"></p>
<p>在这个<a href="https://link.juejin.cn/?target=https://github.com/williamboman/nvim-lsp-installer/discussions/876">网址中</a> 作者介绍了 <strong>mason.nvim</strong> 项目的情况，简单来讲就是未来会用 <strong>mason.nvim</strong> 取代 <strong>nvim-lsp-installer</strong>，并且支持更多的 server 安装，不仅仅是LSP Server 还支持 DAP servers、 linters、formatters 等等超过 150 个包，100+ 种编程语言，并且升级也是非常简单的，下面就开始吧。</p>
<ol>
<li>第一步卸载所有已经安装的Lsp servers，这是因为 mason.nvim 与 nvim-lsp-installer 的文件结构不兼容。确保卸载以释放磁盘空间。建议跟我上边一样截个图先，记住都装过什么，一会儿还要再装回来。运行<code>:LspUninstallAll</code> 命令卸载。</li>
</ol>
<p><img src="/5e1956478b2149dabf21b8c42d4d597atplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="image.png"></p>
<p>上图的目录就是之前安装 lsp servers 的目录，y 回车会清空这个目录。</p>
<ol>
<li>打开 <code>lua/plugins.lua</code> 替换 <strong>nvim-lsp-installer</strong> 插件为 <strong>mason.nvim</strong> 和 <strong>mason-lspconfig.nvim</strong></li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    use(&#123; <span class="string">&quot;williamboman/mason.nvim&quot;</span> &#125;)</span><br><span class="line">    use(&#123; <span class="string">&quot;williamboman/mason-lspconfig.nvim&quot;</span> &#125;)</span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p><img src="/7c2754b162f340b894e7da85603bb1datplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="image.png"></p>
<p>保存自动安装，或者运行 <code>:PackerSync</code></p>
<ol>
<li>找到 <code>lua/lsp/setup.lua</code> 删掉最上边的 nvim-lsp-installer 的配置部分</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">----------------------------------------删掉这部分</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;nvim-lsp-installer&quot;</span>).setup(&#123;</span><br><span class="line">  <span class="comment">-- 自动安装 Language Servers</span></span><br><span class="line">  automatic_installation = <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">----------------------------------------删掉这部分</span></span><br><span class="line">复制代码</span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- :h mason-default-settings</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;mason&quot;</span>).setup(&#123;</span><br><span class="line">  ui = &#123;</span><br><span class="line">    icons = &#123;</span><br><span class="line">      package_installed = <span class="string">&quot;✓&quot;</span>,</span><br><span class="line">      package_pending = <span class="string">&quot;➜&quot;</span>,</span><br><span class="line">      package_uninstalled = <span class="string">&quot;✗&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- mason-lspconfig uses the `lspconfig` server names in the APIs it exposes - not `mason.nvim` package names</span></span><br><span class="line"><span class="comment">-- https://github.com/williamboman/mason-lspconfig.nvim/blob/main/doc/server-mapping.md</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;mason-lspconfig&quot;</span>).setup(&#123;</span><br><span class="line">  <span class="comment">-- 确保安装，根据需要填写</span></span><br><span class="line">  ensure_installed = &#123;</span><br><span class="line">    <span class="string">&quot;sumneko_lua&quot;</span>,</span><br><span class="line">    <span class="string">&quot;tsserver&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cssls&quot;</span>,</span><br><span class="line">    <span class="string">&quot;emmet_ls&quot;</span>,</span><br><span class="line">    <span class="string">&quot;html&quot;</span>,</span><br><span class="line">    <span class="string">&quot;jsonls&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>保存即可，mason 默认将 lsp 安装到新的位置 <code>~/.local/share/nvim/mason</code></p>
<p><img src="/e7be2dac858d4aecad27c7eeedcb826dtplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="image.png"></p>
<p>重启！</p>
<p><img src="/331ca16e29f14ca8812d94e0fbfd6fddtplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="image.png"></p>
<p>输入命令 <code>:Mason</code> 哒哒！</p>
<p><img src="/029c7c3dde994fb19dd306b7ba8c8947tplv-k3u1fbpfcp-zoom-in-crop-mark4536000.awebp" alt="image.png"></p>
<p>和之前用法基本一致，多了 1，2，3，4，5 是上边TAB快捷键，按 <code>2</code> 即可切换到 LSP，可以在这里选择需要安装的，按 <code>i</code> 进行安装。</p>
<p>本文结束🙏</p>
<p>作者：nshen<br>链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7154005621887631396">https://juejin.cn/post/7154005621887631396</a><br>来源：稀土掘金<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<h1 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h1><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><h3 id="保存文件"><a href="#保存文件" class="headerlink" title="保存文件"></a>保存文件</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"></span><br><span class="line">map(<span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;&lt;C-s&gt;&#x27;</span>, <span class="string">&#x27;:w&lt;CR&gt;&#x27;</span>, opt)</span><br><span class="line">map(<span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;&lt;C-s&gt;&#x27;</span>, <span class="string">&#x27;&lt;ESC&gt;:w&lt;CR&gt;a&#x27;</span>, opt)</span><br></pre></td></tr></table></figure>

<p>进入终端模式</p>
<p>保存当前打开过的所有buffer，下次再进来时都打开</p>
<p>鼠标框选</p>
<h3 id="null-ls-lua"><a href="#null-ls-lua" class="headerlink" title="null-ls.lua"></a>null-ls.lua</h3><p>vue文件的格式化</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 保存自动格式化</span></span><br><span class="line">    on_attach = <span class="function"><span class="keyword">function</span><span class="params">(client)</span></span></span><br><span class="line">        <span class="comment">-- vim.cmd([[ command! Format execute &#x27;lua vim.lsp.buf.format(&#123; async = true &#125;)&#x27;]])</span></span><br><span class="line">        <span class="comment">--if client.resolved_capabilities.document_formatting then</span></span><br><span class="line">        <span class="keyword">if</span> client.server_capabilities.documentFormattingProvider <span class="keyword">then</span></span><br><span class="line">            vim.cmd(<span class="string">&#x27;autocmd BufWritePre &lt;buffer&gt; lua vim.lsp.buf.format(&#123;async = true&#125;)&#x27;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/07/25/web/%E5%85%B6%E4%BB%96/%E8%BF%90%E7%BB%B4/Neovim/%E3%80%8ANeovim%20%E9%85%8D%E7%BD%AE%E5%AE%9E%E6%88%98%EF%BC%9A%E4%BB%8E0%E5%88%B01%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84IDE%E3%80%8B/" data-id="cldol83iu00833cx6ccl1bz7n" data-title="Neovim 配置实战：从0到1打造自己的IDE" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-web/框架/Vue/Vue3.0/Vue3基本使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2022-07-25T12:30:40.000Z" itemprop="datePublished">2022-07-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Vue/">Vue</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">Vue3基本使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文承接《Vue2基本使用》</p>
</blockquote>
<h1 id="8-Vue3"><a href="#8-Vue3" class="headerlink" title="8.Vue3"></a>8.<code>Vue3</code></h1><h2 id="8-1-Vue3快速上手"><a href="#8-1-Vue3快速上手" class="headerlink" title="8.1.Vue3快速上手"></a>8.1.<code>Vue3</code>快速上手</h2><h3 id="8-1-1-Vue3简介"><a href="#8-1-1-Vue3简介" class="headerlink" title="8.1.1.Vue3简介"></a>8.1.1.<code>Vue3</code>简介</h3><ul>
<li>2020年9月18日，<code>Vue.js</code>发布3.0版本，代号：<code>One Piece</code>（海贼王）</li>
<li>耗时2年多，<span style="color:red">2600+次提交、<a target="_blank" rel="noopener" href="https://github.com/vuejs/rfcs">30+个RFC</a>、600+次PR、99位贡献者</span></li>
<li><code>github</code>上的<code>tags</code>地址：<a target="_blank" rel="noopener" href="https://github.com/vuejs/core/tree/v3.2.36">https://github.com/vuejs/core/tree/v3.2.36</a></li>
</ul>
<h3 id="8-1-2-Vue3带来了什么"><a href="#8-1-2-Vue3带来了什么" class="headerlink" title="8.1.2.Vue3带来了什么"></a>8.1.2.<code>Vue3</code>带来了什么</h3><h4 id="8-1-2-1-性能的提升"><a href="#8-1-2-1-性能的提升" class="headerlink" title="8.1.2.1.性能的提升"></a>8.1.2.1.性能的提升</h4><ul>
<li>打包大小减少<code>41%</code></li>
<li>初次渲染快<code>55%</code>，更新渲染快<code>133%</code></li>
<li>内存减少<code>54%</code></li>
<li>…</li>
</ul>
<h4 id="8-1-2-2-源码的升级"><a href="#8-1-2-2-源码的升级" class="headerlink" title="8.1.2.2.源码的升级"></a>8.1.2.2.源码的升级</h4><ul>
<li>使用<code>Proxy</code>代替<code>defineProperty</code>实现响应式</li>
<li>重写虚拟<code>dom</code>的实现和<code>tree-shaking</code></li>
<li>…</li>
</ul>
<h4 id="8-1-2-3-拥抱TypeScript"><a href="#8-1-2-3-拥抱TypeScript" class="headerlink" title="8.1.2.3.拥抱TypeScript"></a>8.1.2.3.拥抱<code>TypeScript</code></h4><ul>
<li><code>Vue3</code>可以更好的支持<code>tree-shaking</code></li>
</ul>
<h4 id="8-1-2-4-新特性"><a href="#8-1-2-4-新特性" class="headerlink" title="8.1.2.4.新特性"></a>8.1.2.4.新特性</h4><ul>
<li><code>Composition API</code>（组合式<code>API</code>）<ul>
<li><code>setup</code>配置</li>
<li><code>ref</code>和<code>reactive</code></li>
<li><code>watch</code>和<code>watchEffect</code></li>
<li><code>provide</code>和<code>inject</code></li>
<li>…</li>
</ul>
</li>
<li>新的内置组件<ul>
<li><code>Fragment</code></li>
<li><code>Teleport</code></li>
<li><code>Suspense</code></li>
</ul>
</li>
<li>其他改变<ul>
<li>新的生命周期钩子</li>
<li><code>data</code>选项应始终被声明为一个函数</li>
<li>移除<code>keyCode</code>支持作为<code>v-on</code>的修饰符</li>
<li>…</li>
</ul>
</li>
</ul>
<h2 id="8-2-创建Vue3工程"><a href="#8-2-创建Vue3工程" class="headerlink" title="8.2.创建Vue3工程"></a>8.2.创建<code>Vue3</code>工程</h2><h3 id="8-2-1-使用vue-cli创建"><a href="#8-2-1-使用vue-cli创建" class="headerlink" title="8.2.1.使用vue-cli创建"></a>8.2.1.使用<code>vue-cli</code>创建</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create">https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 查看@vue/cli版本，确保@vue/cli版本在4.5.0以上</span></span><br><span class="line">vue --version</span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">vue -V</span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装或升级@vue/cli</span></span><br><span class="line">npm install @vue/cli -g</span><br><span class="line"><span class="comment">## 或者</span></span><br><span class="line">npm install @vue/cli -D</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建</span></span><br><span class="line">vue create vue3_project</span><br><span class="line"><span class="comment">## 或者</span></span><br><span class="line">npx vue create vue3_project</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动</span></span><br><span class="line"><span class="built_in">cd</span> vue_project3</span><br><span class="line">npm run serve</span><br></pre></td></tr></table></figure>



<h3 id="8-2-2-使用vite创建"><a href="#8-2-2-使用vite创建" class="headerlink" title="8.2.2.使用vite创建"></a>8.2.2.使用<code>vite</code>创建</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/guide/installation.html#vite">https://v3.cn.vuejs.org/guide/installation.html#vite</a></p>
<p>什么是<code>vite</code>？新一代前端构建工具</p>
<p>优势：</p>
<ul>
<li><p>开发环境中，无需打包操作，可快速的冷启动</p>
</li>
<li><p>轻量快速的热重载（<code>HMR</code>）</p>
</li>
<li><p>真正的按需编译，不再等待整个应用编译完成</p>
</li>
<li><p>传统构建与<code>vite</code>构建对比图</p>
<img src="bundler.37740380.png" alt="基于打包器的开发服务器" style="zoom:30%;" />

<img src="esm.3070012d.png" alt="基于 ESM 的开发服务器" style="zoom:35%;" /></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># npm 6.x</span></span><br><span class="line">npm init vite@latest my-vue-app --template vue</span><br><span class="line"></span><br><span class="line"><span class="comment"># npm 7+, 需要额外的双横线：</span></span><br><span class="line">npm init vite@latest my-vue-app -- --template vue</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> my-vue-app</span><br><span class="line">npm install</span><br><span class="line">npm run dev</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="8-2-3-分析工程结构"><a href="#8-2-3-分析工程结构" class="headerlink" title="8.2.3.分析工程结构"></a>8.2.3.分析工程结构</h3><p>分析的是<code>vue-cli</code>方式创建的目录结构</p>
<h4 id="src-main-js"><a href="#src-main-js" class="headerlink" title="src/main.js"></a><code>src/main.js</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">createApp</span>(<span class="title class_">App</span>).<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>import &#123; createApp &#125; from &#39;vue&#39;</code></p>
<ul>
<li>引入的不再是<code>Vue</code>构造函数了，而是一个名为<code>createApp</code>的工厂函数（无需通过<code>new</code>关键字调用）</li>
</ul>
</li>
<li><p><code>createApp(App).mount(&#39;#app&#39;)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(app)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建应用实例对象，<code>app</code>类似于<code>vue2</code>中的<code>vm</code>，但<code>app</code>比<code>vm</code>更轻</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607054736154.png" alt="image-20220607054736154"></p>
</li>
<li><p>注意，并不兼容之前的<code>new Vue</code>的写法，<code>import Vue from &#39;vue&#39;</code>时，<code>Vue</code>时<code>undefined</code></p>
</li>
</ul>
</li>
</ul>
<h4 id="App-vue"><a href="#App-vue" class="headerlink" title="App.vue"></a><code>App.vue</code></h4><ul>
<li><code>template</code>中可以没有根标签</li>
</ul>
<h3 id="8-2-4-安装vue3对应的开发者工具"><a href="#8-2-4-安装vue3对应的开发者工具" class="headerlink" title="8.2.4.安装vue3对应的开发者工具"></a>8.2.4.安装<code>vue3</code>对应的开发者工具</h3><p>直接去官网：<a target="_blank" rel="noopener" href="https://devtools.vuejs.org/guide/installation.html">https://devtools.vuejs.org/guide/installation.html</a></p>
<h2 id="8-3-常用Composition-API"><a href="#8-3-常用Composition-API" class="headerlink" title="8.3.常用Composition API"></a>8.3.常用<code>Composition API</code></h2><p>官方文档：</p>
<h3 id="8-3-1-拉开序幕的setup"><a href="#8-3-1-拉开序幕的setup" class="headerlink" title="8.3.1.拉开序幕的setup"></a>8.3.1.拉开序幕的<code>setup</code></h3><ul>
<li><p>理解：<code>Vue3</code>中的一个新的配置项，值为一个函数</p>
</li>
<li><p><code>setup</code>是所有<code>Composition API</code>（组合<code>API</code>）表演的舞台</p>
</li>
<li><p>组件中所用到的：数据，方法等等，均要配置在<code>setup</code>中</p>
</li>
<li><p><code>setup</code>函数的两种返回值</p>
<ul>
<li><p>若返回一个对象，则对象中的属性、方法，在模板中均可以直接使用。（重点关注）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>我是App组件<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名： &#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>姓名： &#123;&#123;age&#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line">	<span class="language-xml"><span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;sayHello&quot;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	<span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="attr">name</span>: <span class="string">&#x27;App&#x27;</span>,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		<span class="title function_">setup</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			<span class="keyword">let</span> name = <span class="string">&#x27;sai&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			<span class="keyword">let</span> age = <span class="number">18</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			<span class="keyword">function</span> <span class="title function_">sayHello</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">				<span class="title function_">alert</span>(<span class="string">`你好呀，<span class="subst">$&#123;name&#125;</span>,今年我<span class="subst">$&#123;age&#125;</span>岁了`</span>)</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			<span class="keyword">return</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">				name,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">				age,</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">				sayHello</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">			&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">		&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">	&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607064823164.png" alt="image-20220607064823164"></p>
</li>
<li><p>若返回一个渲染函数，则可以自定义渲染内容（了解）</p>
<ul>
<li>模板里的内容会被渲染函数的返回内容覆盖</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;!-- 内容会被覆盖 --&gt;</span><br><span class="line">	&lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123;h&#125; from &#x27;vue&#x27;</span><br><span class="line">	export default &#123;</span><br><span class="line">		name: &#x27;App&#x27;,</span><br><span class="line">		setup() &#123;</span><br><span class="line">			// return () =&gt; &#123;</span><br><span class="line">			// 	return h(&#x27;h1&#x27;, &#x27;sai&#x27;)</span><br><span class="line">			// &#125;</span><br><span class="line"></span><br><span class="line">			// 简写</span><br><span class="line">			return () =&gt; h(&#x27;h1&#x27;, &#x27;sai&#x27;)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>注意点：</p>
<ul>
<li>尽量不要和<code>vue2.x</code>配置混用<ul>
<li><code>vue2.x</code>配置（<code>data</code>、<code>methods</code>、<code>computed</code>…）中可以访问到<code>setup</code>中的属性和方法</li>
<li>但在<code>setup</code>中不能访问到<code>vue2.x</code>配置（<code>data</code>、<code>methods</code>、<code>computed</code>…）</li>
<li>如果有重名，<code>setup</code>优先</li>
</ul>
</li>
<li><code>setup</code>不能是一个<code>async</code>函数，因为返回值不再是<code>return</code>的对象，而是<code>promise</code>，模板中看不到对象中的属性（后期学到了<code>Suspence</code>，其实是可以的）</li>
</ul>
</li>
</ul>
<h3 id="8-3-2-ref函数"><a href="#8-3-2-ref函数" class="headerlink" title="8.3.2.ref函数"></a>8.3.2.<code>ref</code>函数</h3><p><code>vue2</code>中的<code>ref</code>是一个标签属性，<code>vue3</code>中多了一个同名的函数</p>
<h4 id="8-3-2-1ref函数处理基本数据类型"><a href="#8-3-2-1ref函数处理基本数据类型" class="headerlink" title="8.3.2.1ref函数处理基本数据类型"></a>8.3.2.1<code>ref</code>函数处理基本数据类型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;姓名：&#123;&#123;name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;年龄：&#123;&#123;age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let name = &#x27;sai&#x27;</span><br><span class="line">    let age = 18</span><br><span class="line"></span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">      name = &#x27;sai_change&#x27;</span><br><span class="line">      age = 19</span><br><span class="line">      console.log(name, age)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      name,</span><br><span class="line">      age,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个案例中，我们修改了数据，但是页面上并没有更新</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607090829602.png" alt="image-20220607090829602"></p>
<p>因为<code>vue</code>并没有监视到数据的变化，上述方式定义的数据并不是响应式数据</p>
<p>如何把普通的数据，变成一个能被<code>vue</code>监测到的响应式数据呢？</p>
<p>借助<code>ref</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let name = ref(&#x27;sai&#x27;)</span><br><span class="line">    let age = ref(18)</span><br><span class="line"></span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">      name = &#x27;sai_change&#x27;</span><br><span class="line">      age = 19</span><br><span class="line">      console.log(name, age)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      name,</span><br><span class="line">      age,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>那么直接能这样改吗？不能！！！上述代码执行后，点击修改按钮页面仍然没有变化</p>
<p>为啥咧？因为我们改的地方不对！！</p>
<p>我们先注释掉修改的两行代码，直接打印被<code>ref</code>包裹的<code>name</code>和<code>age</code></p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607092144979.png" alt="image-20220607092144979"></p>
<ul>
<li><p><code>RefImpl</code>：<code>Refenrence Implement</code>（引用的实现），表示一个引用实现对象</p>
</li>
<li><p><code>RefImpl</code>对象也是通过<code>Object.defineProperty</code>实现数据响应式的</p>
<ul>
<li>类比于<code>vue2</code>的<code>_data</code>身上的属性，为了便于读写，给了<code>vm</code>一份属性</li>
<li><code>RefImpl</code>对象的原型对象上定义着<code>getter</code>和<code>setter</code>，然后又给了<code>RefImpl</code>对象一份属性</li>
</ul>
</li>
<li><p>读写数据会根据原型链查找<code>getter</code>和<code>setter</code></p>
<ul>
<li><p>读数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2&gt;姓名：&#123;&#123;name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">&lt;h2&gt;年龄：&#123;&#123;age&#125;&#125;&lt;/h2&gt;</span><br></pre></td></tr></table></figure>

<p>插值语法中，不用写成<code>name.value</code>和<code>age.value</code>，<code>vue</code>在解析模板读取数据时，如果变量是一个<code>RefImpl</code>引用实现对象，则会自动读取其<code>value</code>的属性值</p>
<ul>
<li>读数据，会调用引用实现对象的原型对象的<code>getter</code></li>
</ul>
</li>
<li><p>写数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let name = ref(&#x27;sai&#x27;)</span><br><span class="line">    let age = ref(18)</span><br><span class="line"></span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">      name.value = &#x27;sai_change&#x27;</span><br><span class="line">      age.value = 19</span><br><span class="line">      console.log(name, age)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      name,</span><br><span class="line">      age,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>写数据，会调用引用实现对象的原型对象的<code>setter</code></p>
</li>
<li><p><code>setter</code>内部封装更新页面的逻辑</p>
</li>
<li><p>此时页面更新了</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607094215557.png" alt="image-20220607094215557"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="8-3-2-2-ref函数处理对象数据类型"><a href="#8-3-2-2-ref函数处理对象数据类型" class="headerlink" title="8.3.2.2.ref函数处理对象数据类型"></a>8.3.2.2.<code>ref</code>函数处理对象数据类型</h4><p>先梳理一下<code>ref</code>函数处理基本数据类型的逻辑</p>
<ul>
<li>通过<code>ref</code>函数包裹基本数据类型，返回一个引用实现对象，可以通过<code>value</code>属性，取得包裹的数据的值</li>
<li>响应式实现方式，通过<code>Object.defineProperty</code>在其原型对象上定义<code>getter</code>和<code>setter</code></li>
</ul>
<p>按照类似的逻辑，<code>ref</code>函数处理对象类型的数据，也应该是这样的</p>
<ul>
<li><p>使用<code>ref</code>包裹对象类型的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;姓名： &#123;&#123;person.name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;年龄： &#123;&#123;person.age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    let person = ref(&#123;</span><br><span class="line">      name: &#x27;sai&#x27;,</span><br><span class="line">      age: 18</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      person,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607100950658.png" alt="image-20220607100950658"></p>
</li>
<li><p>根据<code>vue2</code>的经验，<code>vue3</code>应该会对对象的每个属性，都设置<code>getter</code>和<code>setter</code>，所以我们修改<code>age</code>属性时，应该是<code>person.value.age.value=19</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;姓名： &#123;&#123;person.name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;年龄： &#123;&#123;person.age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line"></span><br><span class="line">    let person = ref(&#123;</span><br><span class="line">      name: &#x27;sai&#x27;,</span><br><span class="line">      age: 18</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">        // 修改数据</span><br><span class="line">        person.value.name.value = &#x27;sai_modify&#x27;</span><br><span class="line">        person.value.age.value = 19</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return &#123;</span><br><span class="line">      person,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>但是，此时修改不了</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607101141197.png" alt="image-20220607101141197"></p>
</li>
<li><p>为啥咧</p>
<ul>
<li><p>打印下<code>person</code>引用实现对象，以及<code>value</code>属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">modifyInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 修改数据</span></span><br><span class="line">  <span class="comment">// person.value.name.value = &#x27;sai_modify&#x27;</span></span><br><span class="line">  <span class="comment">// person.value.age.value = 19</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(person)</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(person.<span class="property">value</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607101407849.png" alt="image-20220607101407849"></p>
</li>
<li><p>可以看到，<code>ref</code>函数处理对象数据类型，用的是<code>ES6</code>中的<code>Proxy</code>，关于<code>Proxy</code>下一小节详细讲解</p>
</li>
</ul>
</li>
</ul>
<h4 id="8-3-2-3-小结：ref函数"><a href="#8-3-2-3-小结：ref函数" class="headerlink" title="8.3.2.3.小结：ref函数"></a>8.3.2.3.小结：<code>ref</code>函数</h4><ul>
<li>作用：定义一个响应式的数据</li>
<li>语法：<code>const xxx = ref(initValue)</code><ul>
<li>创建一个包含响应式数据的引用对象（<code>reference</code>对象）</li>
<li><code>JS</code>中操作数据：<code>xxx.value</code></li>
<li>模板中读取数据，不需要<code>.value</code>，直接<code>&lt;div&gt;&#123;&#123;xxx&#125;&#125;&lt;/div&gt;</code></li>
</ul>
</li>
<li>备注：<ul>
<li>接收的数据可以是基本数据类型，也可以是对象数据类型</li>
<li>基本数据类型：响应式依然靠的是<code>Object.defineProperty</code>的<code>get</code>与<code>set</code></li>
<li>对象数据类型：内部<code>求助</code>了<code>Vue3</code>中的一个新函数——<code>reactive</code>函数</li>
</ul>
</li>
</ul>
<h3 id="8-3-3-reactive函数"><a href="#8-3-3-reactive函数" class="headerlink" title="8.3.3.reactive函数"></a>8.3.3.<code>reactive</code>函数</h3><p>将源对象交给<code>reactive</code>处理，返回的是一个代理对象</p>
<h4 id="8-3-3-1-返回的是Proxy对象"><a href="#8-3-3-1-返回的是Proxy对象" class="headerlink" title="8.3.3.1.返回的是Proxy对象"></a>8.3.3.1.返回的是<code>Proxy</code>对象</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;姓名： &#123;&#123;person.name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;年龄： &#123;&#123;person.age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;reactive&#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let person = reactive(&#123;</span><br><span class="line">      name: &#x27;sai&#x27;,</span><br><span class="line">      age: 18</span><br><span class="line">    &#125;)</span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">      console.log(person) // 这里不用.value，直接使用即可</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      person,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607110312006.png" alt="image-20220607110312006"></p>
<p>将源数据改成了<code>Proxy</code>类型的对象</p>
<h4 id="8-3-3-2-修改对象数据类型"><a href="#8-3-3-2-修改对象数据类型" class="headerlink" title="8.3.3.2.修改对象数据类型"></a>8.3.3.2.修改对象数据类型</h4><p>此时可以直接修改对象类型的数据了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;姓名： &#123;&#123;person.name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;年龄： &#123;&#123;person.age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;reactive&#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let person = reactive(&#123;</span><br><span class="line">      name: &#x27;sai&#x27;,</span><br><span class="line">      age: 18</span><br><span class="line">    &#125;)</span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">      // 修改数据</span><br><span class="line">      person.name = &#x27;sai_modify&#x27;</span><br><span class="line">      person.age = 19</span><br><span class="line">      console.log(person)</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      person,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607111003887.png" alt="image-20220607111003887"></p>
<h4 id="8-3-3-3-修改嵌套的对象数据"><a href="#8-3-3-3-修改嵌套的对象数据" class="headerlink" title="8.3.3.3.修改嵌套的对象数据"></a>8.3.3.3.修改嵌套的对象数据</h4><p>即使对象嵌套的很深，<code>reactive</code>函数也可以监测到其变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;姓名： &#123;&#123;person.name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;年龄： &#123;&#123;person.age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;h2&gt;测试数据： &#123;&#123;person.a.b.c&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123;reactive&#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;App&#x27;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let person = reactive(&#123;</span><br><span class="line">      name: &#x27;sai&#x27;,</span><br><span class="line">      age: 18,</span><br><span class="line">      a: &#123;</span><br><span class="line">        b: &#123;</span><br><span class="line">          c: &#x27;test&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    function modifyInfo() &#123;</span><br><span class="line">      person.name = &#x27;sai_modify&#x27;</span><br><span class="line">      person.age = 19</span><br><span class="line">      person.a.b.c = &#x27;test_modify&#x27;</span><br><span class="line">      console.log(person)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      person,</span><br><span class="line">      modifyInfo</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220607111533470.png" alt="image-20220607111533470"></p>
<h4 id="8-3-3-4-修改数组数据类型"><a href="#8-3-3-4-修改数组数据类型" class="headerlink" title="8.3.3.4.修改数组数据类型"></a>8.3.3.4.修改数组数据类型</h4><p>被<code>reactive</code>包裹的数组，可以直接通过索引来修改数组类型的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;我是App组件&lt;/h1&gt;</span><br><span class="line">  &lt;h2&gt;爱好：&#123;&#123;hobby&#125;&#125;&lt;/h2&gt;</span><br><span class="line">  &lt;button @click=&quot;modifyInfo&quot;&gt;修改信息&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import &#123;reactive&#125; from &#x27;vue&#x27;</span><br><span class="line"></span><br><span class="line">    export default &#123;</span><br><span class="line">        name: &#x27;App&#x27;,</span><br><span class="line">        setup() &#123;</span><br><span class="line">            let hobby = reactive([&#x27;eat&#x27;,&#x27;drink&#x27;])</span><br><span class="line"></span><br><span class="line">            function modifyInfo() &#123;</span><br><span class="line">                hobby[0] = &#x27;sleep&#x27;</span><br><span class="line">                console.log(hobby)</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            return &#123;</span><br><span class="line">                hobby,</span><br><span class="line">                modifyInfo</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>修改后的效果：</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220617065538228.png" alt="image-20220617065538228"></p>
<h4 id="小结：reactive函数"><a href="#小结：reactive函数" class="headerlink" title="小结：reactive函数"></a>小结：<code>reactive</code>函数</h4><ul>
<li>作用：定义一个对象类型的响应式数据（基本数据类型不要用它，要用<code>ref</code>函数）</li>
<li>语法：<code>const 代理对象 =  reactive(源对象)</code>，接收一个对象（或数组），返回一个代理对象（<code>Proxy</code>的实例对象，简称<code>Proxy</code>对象）</li>
<li><code>reactive</code>定义的响应式数据是<code>深层次的</code></li>
<li>内部基于<code>ES6</code>的<code>Proxy</code>实现，通过代理对象操作源对象的内部数据</li>
</ul>
<h3 id="8-3-4-Vue3中的响应式原理"><a href="#8-3-4-Vue3中的响应式原理" class="headerlink" title="8.3.4.Vue3中的响应式原理"></a>8.3.4.<code>Vue3</code>中的响应式原理</h3><h4 id="8-3-4-1-Vue2的响应式"><a href="#8-3-4-1-Vue2的响应式" class="headerlink" title="8.3.4.1.Vue2的响应式"></a>8.3.4.1.<code>Vue2</code>的响应式</h4><ul>
<li><p>实现原理：</p>
<ul>
<li><p>对象类型：通过<code>Object.defineProperty()</code>对属性的读取、修改进行拦截（数据劫持）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(data, <span class="string">&#x27;count&#x27;</span>, &#123;</span><br><span class="line">  <span class="title function_">get</span>(<span class="params"></span>) &#123;&#125;,</span><br><span class="line">  <span class="title function_">set</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>数组类型：通过重写更新数组的一系列方法来进行拦截。（对数组的变更方法进行了包裹）</p>
</li>
</ul>
</li>
<li><p>存在问题：</p>
<ul>
<li><p>对象类型：新增属性、删除属性，界面不会更新</p>
<ul>
<li><p>新增的属性，要通过<code>this.$set</code>或<code>Vue.set</code>才会变成响应式的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.$set(<span class="variable language_">this</span>.<span class="property">person</span>, <span class="string">&#x27;sex&#x27;</span>, <span class="string">&#x27;女&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除的属性，要通过<code>this.$delete</code>或<code>Vue.delete</code>才会变成响应式的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.$delete(<span class="variable language_">this</span>.<span class="property">person</span>, <span class="string">&#x27;name&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>数组类型：直接通过下标修改数组，界面不会自动更新</p>
<ul>
<li><p>要通过<code>this.$set</code>或<code>Vue.set</code>才会变成响应式的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.$set(<span class="variable language_">this</span>.<span class="property">person</span>.<span class="property">hobby</span>, <span class="number">0</span>, <span class="string">&#x27;逛街&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者调用<code>splice</code>方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">person</span>.<span class="property">hobby</span>.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="string">&#x27;逛街&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="8-3-4-2-Vue3的响应式"><a href="#8-3-4-2-Vue3的响应式" class="headerlink" title="8.3.4.2.Vue3的响应式"></a>8.3.4.2.<code>Vue3</code>的响应式</h4><ul>
<li>实现原理：<ul>
<li>通过<code>Proxy</code>（代理）：拦截对象中任意属性的变化，包括：属性值的读写、属性的添加、删除等</li>
<li>通过<code>Reflect</code>（反射）：对被代理对象的属性进行操作</li>
<li><code>MDN</code>文档中描述的<code>Proxy</code>和<code>Reflect</code><ul>
<li><code>Proxy</code>：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy/Proxy</a></li>
<li><code>Refelct</code>：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect</a></li>
</ul>
</li>
</ul>
</li>
<li>验证对象的操作</li>
<li>验证数组的操作</li>
<li>模拟<code>Vue2</code>的响应式</li>
<li>模拟<code>Vue3</code>的响应式<ul>
<li>验证<code>Proxy</code>基本语法<ul>
<li>读取：<code>get</code></li>
<li>修改和新增：<code>set</code></li>
<li>删除：<code>deleteProperty</code></li>
</ul>
</li>
<li>验证<code>Reflect</code>基本语法<ul>
<li>获取属性值</li>
<li>修改属性值</li>
<li>删除属性</li>
<li><code>ECMA</code>正在尝试把<code>Object</code>上的方法，移植到<code>Reflect</code>身上<ul>
<li><code>Obeject.defineProperty</code><ul>
<li>基本使用</li>
<li>一旦有异常就会挂掉，除非用<code>try catch</code>捕获到</li>
</ul>
</li>
<li><code>Reflect.defineProperty</code><ul>
<li>基本使用</li>
<li>会有布尔类型的返回值，异常处理比较方便</li>
<li>对于框架封装来说，使用<code>Reflect</code>相对会好一点</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>使用<code>Reflect</code>配合<code>Proxy</code></li>
</ul>
</li>
</ul>
<h3 id="8-3-5-reactive对比ref"><a href="#8-3-5-reactive对比ref" class="headerlink" title="8.3.5.reactive对比ref"></a>8.3.5.<code>reactive</code>对比<code>ref</code></h3><ul>
<li>从定义数据角度对比<ul>
<li><code>ref</code>用来定义：基本数据类型</li>
<li><code>reactive</code>用来定义：对象（或数组）类型数据</li>
<li>备注：<code>ref</code>也可以用来定义对象（或数组）类型数据，它内部会自动通过<code>reactive</code>转为代理对象</li>
</ul>
</li>
<li>从原理角度对比<ul>
<li><code>ref</code>通过<code>Object.defineProperty()</code>的<code>get</code>与<code>set</code>来实现响应式（数据劫持）</li>
<li><code>reactive</code>通过使用<code>Proxy</code>来实现响应式（数据劫持），并通过<code>Reflect</code>操作源对象内部的数据</li>
</ul>
</li>
<li>从使用角度对比<ul>
<li><code>ref</code>定义的数据：操作数据需要<code>.value</code>，读取数据时模板中直接读取不需要<code>.value</code></li>
</ul>
</li>
</ul>
<h3 id="8-3-6-setup的两个注意点"><a href="#8-3-6-setup的两个注意点" class="headerlink" title="8.3.6.setup的两个注意点"></a>8.3.6.<code>setup</code>的两个注意点</h3><h4 id="8-3-6-1-setup执行的时机"><a href="#8-3-6-1-setup执行的时机" class="headerlink" title="8.3.6.1.setup执行的时机"></a>8.3.6.1.<code>setup</code>执行的时机</h4><ul>
<li>在<code>beforeCreate</code>之前执行一次，<code>this</code>是<code>undefined</code></li>
</ul>
<h4 id="8-3-6-2-setup的参数"><a href="#8-3-6-2-setup的参数" class="headerlink" title="8.3.6.2.setup的参数"></a>8.3.6.2.<code>setup</code>的参数</h4><h5 id="参数验证"><a href="#参数验证" class="headerlink" title="参数验证"></a>参数验证</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">set</span>(<span class="params">a, b, c</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a, b, c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图片</p>
<h5 id="props参数"><a href="#props参数" class="headerlink" title="props参数"></a><code>props</code>参数</h5><p>值为对象，包含：组件外部传递过来，且在组件内部声明接收了的属性</p>
<ul>
<li><p><code>vue2</code>中的<code>props</code></p>
<ul>
<li><p>如果使用<code>props</code>接收了，传的数据挂载在<code>vc</code>实例上</p>
</li>
<li><p>如果没有使用<code>props</code>接收，传的数据挂载在<code>$attrs</code>上</p>
</li>
</ul>
</li>
<li><p><code>vue3</code>中的<code>props</code></p>
<p><code>App.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;Demo msg=&#x27;hello&#x27; addredd=&#x27;beijing&#x27;/&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import Demo from &#x27;./components/Demo&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        name: &#x27;App&#x27;,</span><br><span class="line">        components: &#123;</span><br><span class="line">            Demo</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<p><code>Demo.vue</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">props</span>: [<span class="string">&#x27;msg&#x27;</span>, <span class="string">&#x27;address&#x27;</span>],</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(props)<span class="comment">// 会把接收到的所有props的值，整理成`Proxy`类型的对象</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="context参数"><a href="#context参数" class="headerlink" title="context参数"></a><code>context</code>参数</h5><ul>
<li><p>上下文对象，身上有三个属性使我们关心的</p>
</li>
<li><p><code>attrs</code></p>
<ul>
<li><code>vue2</code>的<code>$attrs</code><ul>
<li>父组件给子组件传了数据，子组件如果没有使用<code>props</code>接收，则会放在<code>this.$attrs</code>对象上</li>
</ul>
</li>
<li><code>vue3</code>的<code>attrs</code><ul>
<li>如果没有使用<code>props</code>接收到的数据，会放在<code>attrs</code>属性上，相当于<code>vue2</code>的<code>this.$attrs</code></li>
</ul>
</li>
</ul>
</li>
<li><p><code>emit</code></p>
<ul>
<li>如果给子组件绑定了自定义事件，<code>vue3</code>中需要使用<code>emits</code>数组配置项，在子组件中来接收命名，否则控制台会有警告</li>
</ul>
</li>
<li><p><code>slots</code></p>
<ul>
<li><p><code>vue2</code>中的插槽</p>
<ul>
<li>子组件的对象标签中，写了新的标签内容，会以虚拟<code>dom</code>的形式，挂载在父组件的<code>$slot</code>属性上（不论子组件有没有使用插槽来接收）</li>
</ul>
</li>
<li><p><code>vue3</code>中的插槽</p>
<ul>
<li>子组件的对象标签中，写了新的标签内容，会以虚拟<code>dom</code>的形式，<code>slots</code>属性上（不论子组件有没有使用插槽来接收）</li>
<li><code>vue3</code>中的具名插槽的写法，请使用<code>v-slot:name</code>，不要使用<code>vue2</code>的<code>slot=&quot;name&quot;</code>这种写法</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="小结：setup的两个注意点"><a href="#小结：setup的两个注意点" class="headerlink" title="小结：setup的两个注意点"></a>小结：<code>setup</code>的两个注意点</h4><ul>
<li><p><code>setup</code>执行的时机</p>
<ul>
<li>在<code>beforeCreate</code>之前执行一次，<code>this</code>是<code>undefined</code></li>
</ul>
</li>
<li><p><code>setup</code>的参数</p>
<ul>
<li><p><code>props</code>参数：值为对象，包含：组件外部传递过来，且组件内部声明接收了的属性</p>
</li>
<li><p><code>context</code>参数：上下文对象</p>
<ul>
<li><p><code>attrs</code>：值为对象，包含：组件外部传递过来，但没有在<code>props</code>配置中声明的属性，相当于<code>this.$attrs</code></p>
</li>
<li><p><code>slot</code>：收到的插槽内容，相当于<code>this.$slots</code></p>
</li>
<li><p><code>emit</code>：分发自定义事件的函数，相当于<code>this.$emit</code></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="8-3-7-计算属性与监视"><a href="#8-3-7-计算属性与监视" class="headerlink" title="8.3.7.计算属性与监视"></a>8.3.7.计算属性与监视</h3><h4 id="8-3-7-1-computed函数"><a href="#8-3-7-1-computed函数" class="headerlink" title="8.3.7.1.computed函数"></a>8.3.7.1.<code>computed</code>函数</h4><ul>
<li><p>与<code>vue2.x</code>中<code>computed</code>配置功能一致</p>
</li>
<li><p>写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;h2&gt;</span><br><span class="line">        &#123;&#123;person.fullName&#125;&#125;</span><br><span class="line">    &lt;/h2&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123;reactive, computed&#125; from &#x27;vue&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        setup() &#123;</span><br><span class="line">            // 数据</span><br><span class="line">            let person = reactive(&#123;</span><br><span class="line">                firstName: &#x27;张&#x27;,</span><br><span class="line">                lastName: &#x27;三&#x27;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            // 计算属性简写</span><br><span class="line">            // 注意可以直接给Proxy类型的person对象上，添加计算属性，也是响应式的</span><br><span class="line">            person.fullName1 = computed(() =&gt; &#123; </span><br><span class="line">                return person.firstName + &#x27;-&#x27; + person.lastName</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            // 计算属性完整写法</span><br><span class="line">            person.fullName2 = computed(&#123;</span><br><span class="line">                get() &#123;</span><br><span class="line">                    return person.firstName + &#x27;-&#x27; + person.lastName</span><br><span class="line">                &#125;,</span><br><span class="line">                set(value) &#123;</span><br><span class="line">                    const nameArr = value.split(&#x27;-&#x27;)</span><br><span class="line">                    person.firstName = nameArr[0]</span><br><span class="line">                    person.lastName = nameArr[1]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            return &#123;</span><br><span class="line">                person            &#125;</span><br><span class="line">    	&#125;  </span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-3-7-2-watch函数"><a href="#8-3-7-2-watch函数" class="headerlink" title="8.3.7.2.watch函数"></a>8.3.7.2.<code>watch</code>函数</h4><ul>
<li><p>与<code>vue2.x</code>中<code>watch</code>配置功能一致，接收三个参数</p>
<ul>
<li>监视的是谁</li>
<li>监视的回调</li>
<li>监视的配置</li>
</ul>
</li>
<li><p>两个注意点</p>
<ul>
<li>监视<code>reactive</code>定义的响应式数据时，<code>oldValue</code>无法正确获取、强制开启了深度监视（<code>deep</code>配置失效）</li>
<li>监视<code>reactive</code>定义的响应式数据中某个属性时，<code>deep</code>配置有效</li>
</ul>
</li>
<li><p>监视<code>ref</code>定义的响应式数据</p>
<p>写监视的对象时，监视的应该是一个结构，而不是具体的值</p>
<ul>
<li>如果是基本数据类型，不需要添加<code>.value</code>；</li>
<li>如果使用<code>ref</code>包裹了对象类型数据，监视时需要添加<code>.value</code><ul>
<li><code>RefImp</code>对象的<code>value</code>此时不再是一个具体的值，而是一个<code>Proxy</code>对象，再怎么修改这个对象里面的值，这个对象的内存地址也不会变，自然也就监视不到变化了</li>
<li>所以真正的要监视的，应该是通过<code>.value</code>获取到的<code>Proxy</code>对象</li>
<li>或者也可以不加<code>.value</code>，但是要添加深度监视配置项</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(sum, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;sum变化了&#x27;</span>, newVlaue, oldValue)</span><br><span class="line">&#125;, &#123;<span class="attr">immediate</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>监视多个<code>ref</code>定义的响应式数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>([sum, msg], <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;sum或msg变化了&#x27;</span>, newValue, oldValue)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>输出的也是数组：</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220618143803425.png" alt="image-20220618143803425"></p>
</li>
<li><p>监视<code>reactive</code>定义的响应式数据</p>
<ul>
<li><p>若<code>watch</code>监视的是<code>reactive</code>定义的响应式数据，则无法正确获得<code>oldValue</code>，<code>newValue</code>和<code>oldValue</code>都是<code>Proxy</code>类型的对象</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220618144135227.png" alt="image-20220618144135227"></p>
<p>如果一定要获取<code>oldValue</code>，则用<code>ref</code>定义源数据</p>
</li>
<li><p>若<code>watch</code>监视的是<code>reactive</code>定义的响应式数据，则强制开启了深度监视（默认开启了），并且关闭不再生效</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(person, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;person变化了&#x27;</span>, newValue, oldValue)</span><br><span class="line">&#125;,&#123;<span class="attr">immediate</span>: <span class="literal">true</span>, <span class="attr">deep</span>: <span class="literal">false</span>&#125;) <span class="comment">// 此处的deep配置不再奏效</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>监视<code>reactive</code>定义的响应式数据中的某个属性，第一个参数要写成一个函数，此时的<code>deep</code>配置项是有效的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(<span class="function">() =&gt;</span> person.<span class="property">age</span>, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;preson的age变化了&#x27;</span>, newValue, oldValue)</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>一般监视的属性是一个对象时，才会开启深度监视（获取不到<code>oldValue</code>）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>(<span class="function">() =&gt;</span> person.<span class="property">job</span>, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;preson的job变化了&#x27;</span>, newValue, oldValue)</span><br><span class="line">&#125;, &#123;<span class="attr">immediate</span>: <span class="literal">true</span>, <span class="attr">deep</span>: <span class="literal">true</span>&#125;) <span class="comment">// job中还有salary属性，可以开启深度监视</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>监视<code>reactive</code>定义的响应式数据中的某些属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">watch</span>([<span class="function">() =&gt;</span> person.<span class="property">job</span>, <span class="function">() =&gt;</span> person.<span class="property">name</span>], <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;preson的job或name变化了&#x27;</span>, newValue, oldValue)</span><br><span class="line">&#125;, &#123;<span class="attr">immediate</span>: <span class="literal">true</span>, <span class="attr">deep</span>: <span class="literal">true</span>&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-3-7-3-watchEffect函数"><a href="#8-3-7-3-watchEffect函数" class="headerlink" title="8.3.7.3.watchEffect函数"></a>8.3.7.3.<code>watchEffect</code>函数</h4><ul>
<li><p><code>watch</code>的套路是：既要指明监视的属性，也要指明监视的回调</p>
</li>
<li><p><code>watchEffect</code>的套路是，不用指明监视的是哪个属性，监视的回调中用到哪个属性，那就监视哪个属性</p>
</li>
<li><p><code>watchEffect</code>有点像<code>computed</code>：</p>
<ul>
<li><p>但<code>computed</code>注重计算出来的值（回调函数的返回值），所以必须要写返回值</p>
</li>
<li><p>而<code>watchEffect</code>更注重的是过程（回调函数的函数体），多以不用写返回值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// watchEffect所指定的回调中，用到的数据只要发生了变化，则直接重新执行回调</span></span><br><span class="line"><span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> x1 = sum.<span class="property">value</span></span><br><span class="line">    <span class="keyword">const</span> x2 = person.<span class="property">age</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;watchEffect配置的回调执行了&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="8-3-8-生命周期"><a href="#8-3-8-生命周期" class="headerlink" title="8.3.8.生命周期"></a>8.3.8.生命周期</h3><ul>
<li><code>vue3</code>中可以继续使用<code>vue2</code>中的生命周期钩子，但有两个被更名：<ul>
<li><code>beforeDestroy</code>改名为<code>beforeUnmount</code></li>
<li><code>destroyed</code>改名为<code>unmounted</code></li>
</ul>
</li>
<li><code>vue3</code>中也提供了<code>Compsition API</code>形式的生命周期钩子，与<code>vue2</code>中钩子的对应关系如下：<ul>
<li><code>beforeCreate</code>&#x3D;&#x3D;&#x3D;&gt;<code>setup()</code></li>
<li><code>created</code>&#x3D;&#x3D;&#x3D;&gt;<code>setup()</code></li>
<li><code>beforeMount</code>&#x3D;&#x3D;&#x3D;&gt;<code>onBeforeMount</code></li>
<li><code>mounted</code>&#x3D;&#x3D;&#x3D;&gt;<code>onMounted</code></li>
<li><code>beforeUpdate</code>&#x3D;&#x3D;&#x3D;&gt;<code>onBeforeUpdate</code></li>
<li><code>updated</code>&#x3D;&#x3D;&#x3D;&gt;<code>onUpdated</code></li>
<li><code>beforeUnmount</code>&#x3D;&#x3D;&#x3D;&gt;<code>onBeforeUnmount</code></li>
<li><code>unmounted</code>&#x3D;&#x3D;&#x3D;&gt;<code>onUnmounted</code></li>
<li>备注：使用时需要引入</li>
</ul>
</li>
</ul>
<h3 id="8-3-9-自定义hook函数"><a href="#8-3-9-自定义hook函数" class="headerlink" title="8.3.9.自定义hook函数"></a>8.3.9.自定义<code>hook</code>函数</h3><ul>
<li>什么是<code>hook</code><ul>
<li>本质是一个函数，把<code>setup</code>函数中使用的<code>Composition API</code>进行了封装</li>
<li>类似<code>vue2</code>中的<code>mixin</code></li>
</ul>
</li>
<li>自定义<code>hook</code>的优势<ul>
<li>复用代码，让<code>setup</code>中的逻辑更清楚易懂</li>
</ul>
</li>
</ul>
<p>定义<code>hook</code></p>
<p><code>hook/usePoint.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;reactive, onMounted, onBeforeUnmount&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> point = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="attr">x</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">y</span>: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">savePoint</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        point.<span class="property">x</span> = event.<span class="property">pageX</span></span><br><span class="line">        point.<span class="property">y</span> = event.<span class="property">pageY</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(event.<span class="property">pageX</span>, event.<span class="property">pageY</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, savePoint)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">onBeforeUnmount</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>, savePoint)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> point</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用<code>hook</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;h2&gt;</span><br><span class="line">        当前点击鼠标时的坐标为：x：&#123;&#123;point.x&#125;&#125;，y：&#123;&#123;point.y&#125;&#125;</span><br><span class="line">    &lt;/h2&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import userPoint from &#x27;../hooks/usePoint&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        setup() &#123;</span><br><span class="line">            const point = usePoint()</span><br><span class="line">            return &#123;</span><br><span class="line">                point</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<h3 id="8-3-10-toRef"><a href="#8-3-10-toRef" class="headerlink" title="8.3.10.toRef"></a>8.3.10.<code>toRef</code></h3><p>使用<code>reactive</code>包裹深层次对象，在使用时需要写多个点，很麻烦，可以用<code>toRef</code>来替代这个操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;!-- 此时不需要person.name --&gt;</span><br><span class="line">	&lt;h2&gt;&#123;&#123;name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123;reactive, toRef&#125; from &#x27;vue&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        setup() &#123;</span><br><span class="line">            let person = &#123;</span><br><span class="line">                name: &#x27;sai&#x27;,</span><br><span class="line">                age:18,</span><br><span class="line">                job: &#123;</span><br><span class="line">                    j1: &#123;</span><br><span class="line">                        salary: 30</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            const name = toRef(person, &#x27;name&#x27;) // 返回的是一个引用实现对象，其value指向person.name，如果使用ref(person, &#x27;name&#x27;)，则是复制创建了一个新的引用实现对象，不存在引用关系了</span><br><span class="line">            const salary = toRef(person.job.j1, &#x27;salary&#x27;) // 第一个参数，传递一个对象</span><br><span class="line">            return &#123;</span><br><span class="line">                person, </span><br><span class="line">                name, // 需要单独使用的属性</span><br><span class="line">                salary // 简写形式，等价于salary: toRef(person.job.j1, &#x27;salary&#x27;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>小结：</p>
<ul>
<li><p>作用，创建一个<code>ref</code>对象，其<code>value</code>值指向另一个对象中的某个属性</p>
</li>
<li><p>语法：<code>const name = toRef(person, &#39;name&#39;)</code></p>
</li>
<li><p>应用：要将响应式对象中的某个属性，单独提供给外部使用时</p>
</li>
<li><p>扩展：<code>toRefs</code>与<code>toRef</code>功能一致，但可以批量创建多个<code>ref</code>对象，语法：<code>toRefs(person)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> x = <span class="title function_">toRefs</span>(person)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620064618982.png" alt="image-20220620064618982"></p>
<p>返回值是一个对象，<code>return</code>的时候需要解构赋值</p>
<p>返回对象的<code>key</code>，是源对象的<code>key</code>，</p>
<ul>
<li>若源对象<code>key</code>是基本数据类型，则<code>key</code>对应的属性值，是一个引用实现对象，模板中使用时不用加<code>.value</code>进行调用，</li>
<li>若源对象<code>key</code>的值仍是一个对象，则<code>key</code>对应的属性值，是一个<code>Proxy</code>实例对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    ...<span class="title function_">toRefs</span>(person)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="8-3-11-toRefs"><a href="#8-3-11-toRefs" class="headerlink" title="8.3.11.toRefs"></a>8.3.11.<code>toRefs</code></h3><p>toRefs函数的作用是将响应式对象中的所有属性转换为单独的响应式数据，对象成为普通对象，并且值是关联的。在这个过程中toRefs会做以下两件事：</p>
<ul>
<li>把一个响应式对象转换成普通对象</li>
<li>对该普通对象的每个属性都做一次ref操作，这样每个属性都是响应式的</li>
</ul>
<p>说明：</p>
<ul>
<li>reactive 对象取出的所有属性值都是非响应式的，而利用 toRefs 可以将一个响应式 reactive 对象的所有原始属性转换为响应式的 ref 属性。</li>
<li>reactive的响应式功能是赋值给对象，如果展开对象，会让数丢失响应的能力</li>
<li>使用toRefs可以保证对象展开的每个属性都是响应式的</li>
</ul>
<p>应用场景：</p>
<ul>
<li>展开响应式对象时，想使用响应式对象中的多个或者所有属性做为响应式数据。</li>
<li>当函数返回响应式对象时，toRefs非常有用，这样消费组件就可以在不丢失响应式的情况下对返回的对象进行分解使用。-</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;h2&gt;姓名：&#123;&#123;name&#125;&#125;&lt;/h2&gt;</span><br><span class="line">    &lt;h2&gt;年龄：&#123;&#123;age&#125;&#125;&lt;/h2&gt;</span><br><span class="line">    &lt;h2&gt;地址：&#123;&#123;addr.province&#125;&#125;-&#123;&#123;addr.city&#125;&#125;&lt;/h2&gt;</span><br><span class="line">    &lt;button @click=&quot;name=&#x27;zhangsan&#x27;&quot;&gt;修改名字&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import &#123; reactive, toRefs &#125; from &#x27;vue&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        setup() &#123;</span><br><span class="line">            const user = reactive(&#123;</span><br><span class="line">                name: &#x27;张三&#x27;,</span><br><span class="line">                age: 19,</span><br><span class="line">                addr: &#123;</span><br><span class="line">                    province: &#x27;河南&#x27;,</span><br><span class="line">                    city: &#x27;郑州&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            return &#123;</span><br><span class="line">                ...toRefs(user)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>







<h2 id="8-4-其它Composition-API"><a href="#8-4-其它Composition-API" class="headerlink" title="8.4.其它Composition API"></a>8.4.其它<code>Composition API</code></h2><h3 id="8-4-1-shallowReactive和shallowRef"><a href="#8-4-1-shallowReactive和shallowRef" class="headerlink" title="8.4.1.shallowReactive和shallowRef"></a>8.4.1.<code>shallowReactive</code>和<code>shallowRef</code></h3><ul>
<li><p><code>shallowReactive</code>：只处理对象最外层属性的响应式（浅响应式）</p>
</li>
<li><p><code>shallowRef</code>：只处理基本数据类型的响应式，不进行对象的响应式处理</p>
<ul>
<li><p>传的是基本类型，和<code>ref</code>一样</p>
</li>
<li><p>传的是对象类型数据，就不再求助于<code>reactive</code>了，就不再是响应式了</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620071743944.png" alt="image-20220620071743944"></p>
</li>
</ul>
</li>
<li><p>什么时候使用</p>
<ul>
<li>如果有一个对象数据，结构比较深，但变化时只是外层属性变化，使用<code>shallowReactive</code></li>
<li>如果有一个对象数据，后续功能不会修改该对象中的属性，而是生成新的对象来替换，使用<code>shallowRef</code></li>
</ul>
</li>
</ul>
<h3 id="8-4-2-readonly与shallowReadonly"><a href="#8-4-2-readonly与shallowReadonly" class="headerlink" title="8.4.2.readonly与shallowReadonly"></a>8.4.2.<code>readonly</code>与<code>shallowReadonly</code></h3><ul>
<li><p><code>readonly</code>：让一个响应式数据变为只读的（深只读）</p>
<ul>
<li><p><code>readonly</code>是一个函数，接收响应式数据作为参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;sai&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">18</span>,</span><br><span class="line">        <span class="attr">job</span>: &#123;</span><br><span class="line">            <span class="attr">j1</span>: &#123;</span><br><span class="line">                <span class="attr">salary</span>: <span class="number">30</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    person = <span class="title function_">readonly</span>(person)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        ...<span class="title function_">toRefs</span>(person)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>shallowReadonly</code>：让一个响应式数据变为只读的（浅只读）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">person = <span class="title function_">shallowReadonly</span>(person)</span><br></pre></td></tr></table></figure>

<p>上述例子中，若使用<code>shallowReadonly</code>函数进行处理，则第一层数据不允许修改，但是里面的<code>salary</code>还是可以修改的</p>
<p>对于<code>ref</code>包裹的响应式数据，没有必要用<code>shallowReadonly</code>，因为基本数据类型始终就是一层</p>
</li>
<li><p>应用场景：不希望数据被修改时</p>
<ul>
<li><code>person</code>的数据不是自己定义的，用的是别人的组件，接收的时候可以用<code>readonly</code>限制一下，防止误操作</li>
</ul>
</li>
</ul>
<h3 id="8-4-3-toRaw与markRaw"><a href="#8-4-3-toRaw与markRaw" class="headerlink" title="8.4.3.toRaw与markRaw"></a>8.4.3.<code>toRaw</code>与<code>markRaw</code></h3><ul>
<li><p><code>toRaw</code></p>
<ul>
<li><p>作用：将一个由<code>reactive</code>生成的响应式对象，变成普通对象（不能处理<code>ref</code>定义的响应式数据）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;sai&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showRawPerson</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> p = <span class="title function_">toRaw</span>(person)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用场景：用于读取响应式对象对应的普通对象，对这个普通对象的所有操作，不会引起页面更新</p>
</li>
</ul>
</li>
<li><p><code>makeRaw</code></p>
<ul>
<li>作用：标记一个对象，使其永远不会再成为响应式对象<ul>
<li>但是对于数据的更改仍然是生效的，只是<code>vue</code>不再做响应式处理了</li>
</ul>
</li>
<li>应用场景：<ul>
<li>有些值不应被设置为响应式的，例如复杂的第三方类库等</li>
<li>当渲染具有不可变数据源的大列表时，跳过响应式转换可以提高性能</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="8-4-4-customRef"><a href="#8-4-4-customRef" class="headerlink" title="8.4.4.customRef"></a>8.4.4.<code>customRef</code></h3><ul>
<li><p>作用：创建一个自定义的<code>ref</code>，并对其依赖项跟踪和更新触发，进行显示控制</p>
<ul>
<li>读数据找<code>get()</code>，写数据找<code>set()</code></li>
<li>在关键的地方调用<code>track</code>和<code>trigger</code></li>
</ul>
</li>
<li><p>实现防抖效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;input type=&quot;text&quot; v-model=&quot;keyword&quot;&gt;</span><br><span class="line">	&lt;h3&gt;</span><br><span class="line">        &#123;&#123;keyword&#125;&#125;</span><br><span class="line">    &lt;/h3&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123;ref, customRef&#125; from &#x27;vue&#x27;</span><br><span class="line">    export default &#123;</span><br><span class="line">        name: &#x27;Demo&#x27;,</span><br><span class="line">        setup() &#123;</span><br><span class="line">            // let keyword = ref(&#x27;hello&#x27;) // 使用vue准备好的内置的ref</span><br><span class="line">            // 自定义一个myRef</span><br><span class="line">            function myRef(value, delay) &#123;</span><br><span class="line">                let timer</span><br><span class="line">                // 通过customRef去实现自定义</span><br><span class="line">                return customRef((track, trigger) =&gt; &#123;</span><br><span class="line">                	return &#123;</span><br><span class="line">                        get() &#123;</span><br><span class="line">                            track() // 告诉vue这个value值是需要被“追踪”的</span><br><span class="line">                            return value</span><br><span class="line">                        &#125;,</span><br><span class="line">                        set(newValue) &#123;</span><br><span class="line">                            clearTimeout(timer)</span><br><span class="line">                            timer = setTimeout(() =&gt; &#123;</span><br><span class="line">								value = newValue	</span><br><span class="line">                                trigger() // 告诉vue去更新页面</span><br><span class="line">                            &#125;, delay)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            let keyword = myRef(&#x27;hello&#x27;, 500)</span><br><span class="line">            return &#123;</span><br><span class="line">                keyword</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="8-4-5-provide与inject"><a href="#8-4-5-provide与inject" class="headerlink" title="8.4.5.provide与inject"></a>8.4.5.<code>provide</code>与<code>inject</code></h3><p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620163000601.png" alt="image-20220620163000601"></p>
<ul>
<li><p>作用：实现<strong>祖组件</strong>与<strong>后代组件</strong>间通信</p>
<ul>
<li>虽然也可以用来父子组件通信，但那样直接用<code>props</code>即可</li>
</ul>
</li>
<li><p>套路：父组件有一个<code>provide</code>选项来提供数据，后代组件有一个<code>inject</code>选项来开始使用这些数据</p>
</li>
<li><p>具体写法：</p>
<ul>
<li><p>1.祖先组件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;provide&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line">...</span><br><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">let</span> person = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;sai&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">provide</span>(<span class="string">&#x27;person&#x27;</span>, person)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.孙子组件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;inject&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">const</span> person = <span class="title function_">inject</span>(<span class="string">&#x27;person&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;person&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="8-4-6-响应式数据的判断"><a href="#8-4-6-响应式数据的判断" class="headerlink" title="8.4.6.响应式数据的判断"></a>8.4.6.响应式数据的判断</h3><ul>
<li><code>isRef</code>：检查一个值，是否为一个<code>ref</code>对象</li>
<li><code>isReactive</code>：检查一个对象，是否是由<code>reactive</code>创建的响应式代理</li>
<li><code>isReadonly</code>：检查一个对象，是否是由<code>readonly</code>创建的只读代理</li>
<li><code>isProxy</code>：检查一个对象，是否是由<code>reactive</code>或者<code>readonly</code>方法创建的代理</li>
</ul>
<h2 id="8-5-Composition-API的优势"><a href="#8-5-Composition-API的优势" class="headerlink" title="8.5.Composition API的优势"></a>8.5.<code>Composition API</code>的优势</h2><h3 id="8-5-1-Options-API存在的问题"><a href="#8-5-1-Options-API存在的问题" class="headerlink" title="8.5.1.Options API存在的问题"></a>8.5.1.<code>Options API</code>存在的问题</h3><p>使用传统<code>Options API</code>，新增或者修改一个需求，就需要分别在<code>data</code>、<code>methods</code>、<code>computed</code>里修改</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620164219772.png" alt="image-20220620164219772"></p>
<p>如果一个组件里的功能特别多</p>
<ul>
<li>一个功能的数据、方法、计算属性都是拆散的</li>
<li>每个配置项里堆积了不同功能的代码</li>
<li>维护某一个功能代码时，就需要打开一个庞大的<code>data</code>找啊找，然后再打开一个庞大的<code>method</code>找啊找，可能还要去<code>computed</code>、<code>watch</code>、生命周期钩子里不断的查找修改</li>
</ul>
<h3 id="8-5-2-Composition-API的优势"><a href="#8-5-2-Composition-API的优势" class="headerlink" title="8.5.2.Composition API的优势"></a>8.5.2.<code>Composition API</code>的优势</h3><p>我们可以更加优雅的组织我们的代码，函数。让相关功能的代码更加有序的组织在一起</p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620165208346.png" alt="image-20220620165208346"></p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620164953100.png" alt="image-20220620164953100"></p>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620165019824.png" alt="image-20220620165019824"></p>
<h2 id="8-6-新的组件"><a href="#8-6-新的组件" class="headerlink" title="8.6.新的组件"></a>8.6.新的组件</h2><h3 id="8-6-1-Fragment"><a href="#8-6-1-Fragment" class="headerlink" title="8.6.1.Fragment"></a>8.6.1.<code>Fragment</code></h3><ul>
<li><p>在<code>vue2</code>中，组件必须有一个根标签</p>
</li>
<li><p>在<code>vue3</code>中，组件可以没有根标签，内部会将多个标签包含在一个<code>Fragment</code>虚拟元素中</p>
<ul>
<li>好处：减少标签层级，减小内存占用</li>
</ul>
<p><img src="/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/image-20220620170100495.png" alt="image-20220620170100495"></p>
</li>
</ul>
<h3 id="8-6-2-Teleport"><a href="#8-6-2-Teleport" class="headerlink" title="8.6.2.Teleport"></a>8.6.2.<code>Teleport</code></h3><ul>
<li><p><code>Teleport</code>是一种能够将我们的<strong>组件<code>html</code>结构</strong>移动到指定位置的技术</p>
</li>
<li><p>后代组件中，直接显示的弹窗，会被包裹在<code>dom</code>结构内，即使可以使用定位，但组件嵌套一多，写起来也麻烦</p>
<ul>
<li><code>移动位置</code>可写的值：<ul>
<li><code>body</code><ul>
<li>组件的嵌套再多，渲染的<code>dom</code>结构，也是直接在<code>body</code>下的</li>
</ul>
</li>
<li><code>css</code>选择器</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;teleport to=&#x27;移动位置&#x27;&gt;</span><br><span class="line">	&lt;div v-if=&#x27;isShow&#x27; class=&#x27;mask&#x27;&gt;</span><br><span class="line">        &lt;div class=&#x27;dialog&#x27;&gt;</span><br><span class="line">            &lt;h3&gt;</span><br><span class="line">                我是一个弹窗</span><br><span class="line">            &lt;/h3&gt;</span><br><span class="line">            &lt;button @click=&#x27;isShow=false&#x27;&gt;</span><br><span class="line">                关闭弹窗</span><br><span class="line">            &lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/teleport&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="8-6-3-Suspense"><a href="#8-6-3-Suspense" class="headerlink" title="8.6.3.Suspense"></a>8.6.3.<code>Suspense</code></h3><ul>
<li><p>等待异步组件时渲染一些后备内容，获得更好地用户体验</p>
<ul>
<li><code>Suspense</code>底层是用插槽实现的<ul>
<li><code>v-slot:defalut</code><ul>
<li>用于放置本应该展示的组件</li>
</ul>
</li>
<li><code>v-slot:fallback</code><ul>
<li>组件未加载时，展示的内容</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>使用步骤：</p>
<ul>
<li><p>1.异步引入组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;defineAsyncComponent&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="comment">// import Child from &#x27;./components/Child.vue&#x27; // 静态引入（同步引入）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Child</span> = <span class="title function_">defineAsyncComponent</span>(<span class="function">() =&gt;</span> <span class="title function_">import</span>(<span class="string">&#x27;./components/Child.vue&#x27;</span>)) <span class="comment">// 动态引入（异步引入）</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>2.使用<code>Suspence</code>包裹组件，并配置好<code>default</code>与<code>fallback</code></p>
<p><code>App.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&#x27;app&#x27;&gt;</span><br><span class="line">        &lt;h3&gt;</span><br><span class="line">        	我是App组件    </span><br><span class="line">    	&lt;/h3&gt;</span><br><span class="line">        &lt;Suspence&gt;</span><br><span class="line">    		&lt;template v-slot:default&gt;</span><br><span class="line">				&lt;Child/&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">			&lt;template v-slot:fallback&gt;</span><br><span class="line">				&lt;h3&gt;</span><br><span class="line">                    加载中...</span><br><span class="line">                &lt;/h3&gt;</span><br><span class="line">			&lt;/template&gt;</span><br><span class="line">    	&lt;/Suspence&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>同步引入情况下，会等到所有的组件引入加载完，才会展示</li>
<li>异步引入情况下，被设置成异步引入的组件，不会阻塞整个页面的加载</li>
</ul>
</li>
<li><p>之前说<code>setup</code>不能返回<code>Promise</code>，那是因为没有讲到这里，其实是可以的</p>
<p><code>Child.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;child&quot;&gt;</span><br><span class="line">		&lt;h3&gt;我是Child组件&lt;/h3&gt;</span><br><span class="line">		&#123;&#123;sum&#125;&#125;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">	export default &#123;</span><br><span class="line">		name: &#x27;Child&#x27;,</span><br><span class="line">		setup() &#123;</span><br><span class="line">			let sum = ref(0)</span><br><span class="line">			return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">				setTimeout(() =&gt; &#123;</span><br><span class="line">					resolve(sum)</span><br><span class="line">				&#125;, 1000)</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>或者写成<code>async</code>形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">	&lt;div class=&quot;child&quot;&gt;</span><br><span class="line">		&lt;h3&gt;我是Child组件&lt;/h3&gt;</span><br><span class="line">		&#123;&#123;sum&#125;&#125;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123;ref&#125; from &#x27;vue&#x27;</span><br><span class="line">	export default &#123;</span><br><span class="line">		name: &#x27;Child&#x27;,</span><br><span class="line">		async setup() &#123;</span><br><span class="line">			let sum = ref(0)</span><br><span class="line">			let p = new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">				setTimeout(() =&gt; &#123;</span><br><span class="line">					resolve(sum)</span><br><span class="line">				&#125;, 1000)</span><br><span class="line">			&#125;)</span><br><span class="line">            return await p</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>可以配合<code>Suspence</code>使用</p>
</li>
</ul>
</li>
</ul>
<h2 id="8-7-其他"><a href="#8-7-其他" class="headerlink" title="8.7.其他"></a>8.7.其他</h2><h3 id="8-7-1-全局API的转移"><a href="#8-7-1-全局API的转移" class="headerlink" title="8.7.1.全局API的转移"></a>8.7.1.全局<code>API</code>的转移</h3><ul>
<li><p><code>vue2</code>有许多全局<code>API</code>和配置</p>
<ul>
<li><p>例如：注册全局组件、注册全局指令等</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册全局组件</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;MyButton&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">data</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="attr">template</span>: <span class="string">`&lt;button @click=&quot;count++&gt;Clicked &#123;&#123;count&#125;&#125; times.&lt;/button&gt;`</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册全局指令</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">directive</span>(<span class="string">&#x27;focus&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">inserted</span>: <span class="function"><span class="params">el</span> =&gt;</span> el.<span class="title function_">focus</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>vue3</code>中对这些<code>API</code>做出了调整</p>
<ul>
<li><p>将全局的<code>API</code>，即<code>Vue.xxx</code>调整到应用实例<code>app</code>上</p>
<table>
<thead>
<tr>
<th>2.x全局API（Vue）</th>
<th>3.x实例API（app）</th>
</tr>
</thead>
<tbody><tr>
<td>Vue.config.xxx</td>
<td>app.config.xxx</td>
</tr>
<tr>
<td>Vue.config.productionTip</td>
<td>移除</td>
</tr>
<tr>
<td>Vue.component</td>
<td>app.component</td>
</tr>
<tr>
<td>Vue.directive</td>
<td>app.directive</td>
</tr>
<tr>
<td>Vue.mixin</td>
<td>app.mixin</td>
</tr>
<tr>
<td>Vue.use</td>
<td>app.use</td>
</tr>
<tr>
<td>Vue.prototype</td>
<td>app.config.globalProperties</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<h2 id="8-7-2-其他改变"><a href="#8-7-2-其他改变" class="headerlink" title="8.7.2.其他改变"></a>8.7.2.其他改变</h2><ul>
<li><p><code>data</code>选项应始终被声明为一个函数</p>
</li>
<li><p>过度类名的更改</p>
<ul>
<li><p><code>vue2</code>的写法</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.v-enter</span>, <span class="selector-class">.v-leave-to</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.v-leave</span>, <span class="selector-class">.v-enter-to</span> &#123;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>vue3</code>的写法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.<span class="property">v</span>-enter-<span class="keyword">from</span>, .<span class="property">v</span>-leave-to &#123;</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">.<span class="property">v</span>-leave-<span class="keyword">from</span>, .<span class="property">v</span>-enter-to &#123;</span><br><span class="line">    <span class="attr">opacity</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>移除<code>keyCode</code>作为<code>v-on</code>的修饰符，同时也不再支持<code>config.keyCodes</code></p>
</li>
<li><p>移除<code>v-on.native</code>修饰符</p>
<ul>
<li><p>父组件中绑定事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;my-component </span><br><span class="line">              v-on:close = &quot;handleComponentEvent&quot;</span><br><span class="line">              v-on:click = &quot;handleNativeClickEvent&quot;</span><br><span class="line">              /&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>子组件中声明自定义事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	export default &#123;</span><br><span class="line">        emits: [&#x27;close&#x27;] // 没指定的，会认为是原生事件</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>移除过滤器（<code>filter</code>）</p>
<ul>
<li>过滤器虽然看起来很方便，但它需要一个自定义语法，打破大括号内表达式“只是JavaScript”的假设，这不仅有学习成本，而且有实现成本</li>
<li>建议用方法调用或计算属性去替换过滤器</li>
</ul>
</li>
<li><p>其他</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://mindcons.cn/2022/07/25/web/%E6%A1%86%E6%9E%B6/Vue/Vue3.0/Vue3%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" data-id="cldol83iy00883cx6byac5bx4" data-title="Vue3基本使用" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/8/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/10/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CSS/">CSS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CSS%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8/">CSS预处理器</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/English/">English</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Express/">Express</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTML/">HTML</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Koa/">Koa</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node-js/">Node.js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/books/">books</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/electron/">electron</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/jQuery/">jQuery</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/lua/">lua</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/">webpack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B9%A6%E7%B1%8D/">书籍</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BD%8E%E4%BB%A3%E7%A0%81/">低代码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8F%AF%E8%A7%86%E5%8C%96/">可视化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E6%96%B9%E5%BC%8F/">学习方式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/">学习路线</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98/">案例实战</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB/">爬虫</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91/">移动端开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BB%84%E4%BB%B6%E5%BA%93/">组件库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS%E5%8A%A8%E7%94%BB/" rel="tag">CSS动画</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS%E5%B8%83%E5%B1%80/" rel="tag">CSS布局</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS%E9%80%89%E6%8B%A9%E5%99%A8/" rel="tag">CSS选择器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8/" rel="tag">CSS预处理器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementPlus/" rel="tag">ElementPlus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElementUI/" rel="tag">ElementUI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/English/" rel="tag">English</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Express/" rel="tag">Express</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Koa/" rel="tag">Koa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node-js/" rel="tag">Node.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vant/" rel="tag">Vant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue2/" rel="tag">Vue2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/books/" rel="tag">books</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/electron/" rel="tag">electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jQuery/" rel="tag">jQuery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lua/" rel="tag">lua</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-cli/" rel="tag">vue-cli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B9%A6%E7%B1%8D/" rel="tag">书籍</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BD%8E%E4%BB%A3%E7%A0%81/" rel="tag">低代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" rel="tag">可视化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E6%96%B9%E5%BC%8F/" rel="tag">学习方式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" rel="tag">学习路线</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag">小程序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" rel="tag">数据结构与算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98/" rel="tag">案例实战</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91/" rel="tag">移动端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%84%E4%BB%B6%E5%BA%93/" rel="tag">组件库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7%E5%BA%93/" rel="tag">自定义工具库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A4%E7%9F%A5/" rel="tag">认知</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E6%8A%80%E8%83%BD/" rel="tag">软技能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag">运维</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSS/" style="font-size: 18.33px;">CSS</a> <a href="/tags/CSS%E5%8A%A8%E7%94%BB/" style="font-size: 10px;">CSS动画</a> <a href="/tags/CSS%E5%B8%83%E5%B1%80/" style="font-size: 13.33px;">CSS布局</a> <a href="/tags/CSS%E9%80%89%E6%8B%A9%E5%99%A8/" style="font-size: 10px;">CSS选择器</a> <a href="/tags/CSS%E9%A2%84%E5%A4%84%E7%90%86%E5%99%A8/" style="font-size: 15px;">CSS预处理器</a> <a href="/tags/ElementPlus/" style="font-size: 10px;">ElementPlus</a> <a href="/tags/ElementUI/" style="font-size: 10px;">ElementUI</a> <a href="/tags/English/" style="font-size: 10px;">English</a> <a href="/tags/Express/" style="font-size: 10px;">Express</a> <a href="/tags/HTML/" style="font-size: 11.67px;">HTML</a> <a href="/tags/Koa/" style="font-size: 13.33px;">Koa</a> <a href="/tags/Linux/" style="font-size: 11.67px;">Linux</a> <a href="/tags/Node-js/" style="font-size: 11.67px;">Node.js</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/Vant/" style="font-size: 11.67px;">Vant</a> <a href="/tags/Vue/" style="font-size: 13.33px;">Vue</a> <a href="/tags/Vue2/" style="font-size: 10px;">Vue2</a> <a href="/tags/Vue3/" style="font-size: 10px;">Vue3</a> <a href="/tags/books/" style="font-size: 10px;">books</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/electron/" style="font-size: 10px;">electron</a> <a href="/tags/jQuery/" style="font-size: 10px;">jQuery</a> <a href="/tags/javascript/" style="font-size: 11.67px;">javascript</a> <a href="/tags/lua/" style="font-size: 10px;">lua</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/vue-cli/" style="font-size: 10px;">vue-cli</a> <a href="/tags/webpack/" style="font-size: 10px;">webpack</a> <a href="/tags/%E4%B9%A6%E7%B1%8D/" style="font-size: 16.67px;">书籍</a> <a href="/tags/%E4%BD%8E%E4%BB%A3%E7%A0%81/" style="font-size: 10px;">低代码</a> <a href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" style="font-size: 10px;">可视化</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E6%96%B9%E5%BC%8F/" style="font-size: 10px;">学习方式</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" style="font-size: 10px;">学习路线</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 10px;">小程序</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 10px;">数据结构与算法</a> <a href="/tags/%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98/" style="font-size: 20px;">案例实战</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 10px;">源码</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 10px;">爬虫</a> <a href="/tags/%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 10px;">移动端开发</a> <a href="/tags/%E7%BB%84%E4%BB%B6%E5%BA%93/" style="font-size: 11.67px;">组件库</a> <a href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B7%A5%E5%85%B7%E5%BA%93/" style="font-size: 10px;">自定义工具库</a> <a href="/tags/%E8%AE%A4%E7%9F%A5/" style="font-size: 10px;">认知</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式</a> <a href="/tags/%E8%BD%AF%E6%8A%80%E8%83%BD/" style="font-size: 20px;">软技能</a> <a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 10px;">运维</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">November 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">July 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/20/web/%E5%85%B6%E4%BB%96/lua/lua%E5%9F%BA%E7%A1%80/">lua基础</a>
          </li>
        
          <li>
            <a href="/2023/01/17/web/%E5%85%B6%E4%BB%96/python/%E7%88%AC%E8%99%AB%E5%9F%BA%E7%A1%80/">爬虫基础</a>
          </li>
        
          <li>
            <a href="/2023/01/13/web/%E8%BF%9B%E9%98%B6/%E6%95%B0%E6%8D%AE%E5%BA%93/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80/">数据库基础</a>
          </li>
        
          <li>
            <a href="/2023/01/12/web/%E6%A1%86%E6%9E%B6/React/React%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%92%8C%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86/React%E5%9F%BA%E7%A1%80/">React基本使用</a>
          </li>
        
          <li>
            <a href="/2023/01/09/web/%E5%85%B6%E4%BB%96/%E6%A0%87%E6%B3%A8/labelStudio%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BD%BF%E7%94%A8/">labelStudio安装及使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>